{
  long size=0;
  String volumeFileName=StorageProperties.storageRootDirectory + "/" + volumeId;
  String snapshotFileName=StorageProperties.storageRootDirectory + "/" + snapshotId;
  File volumeFile=new File(volumeFileName);
  File snapshotFile=new File(snapshotFileName);
  EntityWrapper<VolumeInfo> db=new EntityWrapper<VolumeInfo>();
  VolumeInfo volumeInfo=new VolumeInfo(volumeId);
  List<VolumeInfo> volumeInfos=db.query(volumeInfo);
  if (volumeInfos.size() > 0) {
    VolumeInfo foundVolumeInfo=volumeInfos.get(0);
  }
 else {
    db.rollback();
    throw new EucalyptusCloudException();
  }
  db.commit();
  assert(snapshotFile.exists() && volumeFile.exists());
  size+=shouldTransferVolume ? snapshotFile.length() + volumeFile.length() : snapshotFile.length();
  SnapshotProgressCallback callback=new SnapshotProgressCallback(snapshotId,size,StorageProperties.TRANSFER_CHUNK_SIZE);
  Map<String,String> httpParamaters=new HashMap<String,String>();
  HttpWriter httpWriter;
  if (shouldTransferVolume) {
    try {
      List<String> returnValues=blockManager.getSnapshotValues(volumeId);
      if (returnValues.size() > 0) {
        httpParamaters.put("SnapshotVgName",returnValues.get(0));
        httpParamaters.put("SnapshotLvName",returnValues.get(1));
      }
    }
 catch (    Exception ex) {
      LOG.error(ex);
    }
    httpWriter=new HttpWriter("PUT",volumeFile,callback,"snapshots",volumeId,"StoreSnapshot",null,httpParamaters);
    try {
      httpWriter.run();
    }
 catch (    Exception ex) {
      LOG.error(ex);
      return;
    }
  }
  try {
    List<String> returnValues=blockManager.getSnapshotValues(snapshotId);
    if (returnValues.size() > 0) {
      httpParamaters.put("SnapshotVgName",returnValues.get(0));
      httpParamaters.put("SnapshotLvName",returnValues.get(1));
    }
  }
 catch (  Exception ex) {
    LOG.error(ex);
  }
  httpWriter=new HttpWriter("PUT",snapshotFile,callback,"snapshots",snapshotId,"StoreSnapshot",null,httpParamaters);
  try {
    httpWriter.run();
  }
 catch (  Exception ex) {
    LOG.error(ex);
  }
}
