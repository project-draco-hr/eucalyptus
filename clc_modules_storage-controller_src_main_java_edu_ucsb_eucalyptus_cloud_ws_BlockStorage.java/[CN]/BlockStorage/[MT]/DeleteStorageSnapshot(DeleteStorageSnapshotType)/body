{
  DeleteStorageSnapshotResponseType reply=(DeleteStorageSnapshotResponseType)request.getReply();
  StorageProperties.updateWalrusUrl();
  if (!StorageProperties.enableSnapshots) {
    LOG.error("Snapshots have been disabled. Please check connection to Walrus.");
    return reply;
  }
  String snapshotId=request.getSnapshotId();
  EntityWrapper<SnapshotInfo> db=StorageProperties.getEntityWrapper();
  SnapshotInfo snapshotInfo=new SnapshotInfo(snapshotId);
  List<SnapshotInfo> snapshotInfos=db.query(snapshotInfo);
  reply.set_return(true);
  if (snapshotInfos.size() > 0) {
    SnapshotInfo foundSnapshotInfo=snapshotInfos.get(0);
    String status=foundSnapshotInfo.getStatus();
    db.commit();
    if (status.equals(StorageProperties.Status.available.toString()) || status.equals(StorageProperties.Status.failed.toString())) {
      SnapshotDeleter snapshotDeleter=new SnapshotDeleter(snapshotId);
      snapshotService.add(snapshotDeleter);
    }
 else {
      reply.set_return(false);
      throw new SnapshotInUseException(snapshotId);
    }
  }
 else {
    db.rollback();
  }
  return reply;
}
