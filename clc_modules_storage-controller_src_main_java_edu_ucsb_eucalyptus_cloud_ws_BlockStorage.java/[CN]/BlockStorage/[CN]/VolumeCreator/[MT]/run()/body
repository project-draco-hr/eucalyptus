{
  boolean success=true;
  if (snapshotId != null) {
    EntityWrapper<SnapshotInfo> db=StorageProperties.getEntityWrapper();
    try {
      SnapshotInfo snapshotInfo=new SnapshotInfo(snapshotId);
      List<SnapshotInfo> foundSnapshotInfos=db.query(snapshotInfo);
      if (foundSnapshotInfos.size() == 0) {
        db.commit();
        int sizeExpected;
        if (size <= 0) {
          sizeExpected=getSnapshotSize(snapshotId);
        }
 else {
          sizeExpected=size;
        }
        String snapDestination=blockManager.prepareSnapshot(snapshotId,sizeExpected);
        if (snapDestination != null) {
          getSnapshot(snapshotId,snapDestination);
        }
        db=StorageProperties.getEntityWrapper();
        snapshotInfo=new SnapshotInfo(snapshotId);
        snapshotInfo.setVolumeId(volumeId);
        snapshotInfo.setProgress("100");
        snapshotInfo.setStartTime(new Date());
        snapshotInfo.setStatus(StorageProperties.Status.available.toString());
        db.add(snapshotInfo);
        db.commit();
        size=blockManager.createVolume(volumeId,snapshotId,size);
      }
 else {
        SnapshotInfo foundSnapshotInfo=foundSnapshotInfos.get(0);
        if (!foundSnapshotInfo.getStatus().equals(StorageProperties.Status.available.toString())) {
          success=false;
          db.rollback();
          LOG.warn("snapshot " + foundSnapshotInfo.getSnapshotId() + " not available.");
        }
 else {
          db.commit();
          size=blockManager.createVolume(volumeId,snapshotId,size);
        }
      }
    }
 catch (    Exception ex) {
      success=false;
      LOG.error(ex);
    }
  }
 else {
    try {
      if (parentVolumeId != null) {
        blockManager.cloneVolume(volumeId,parentVolumeId);
      }
 else {
        blockManager.createVolume(volumeId,size);
      }
    }
 catch (    Exception ex) {
      success=false;
      LOG.error(ex,ex);
    }
  }
  EntityWrapper<VolumeInfo> db=StorageProperties.getEntityWrapper();
  VolumeInfo volumeInfo=new VolumeInfo(volumeId);
  try {
    VolumeInfo foundVolumeInfo=db.getUnique(volumeInfo);
    if (foundVolumeInfo != null) {
      if (success) {
        if (StorageProperties.shouldEnforceUsageLimits && StorageProperties.trackUsageStatistics) {
          int totalVolumeSize=(int)(blockStorageStatistics.getTotalSpaceUsed() / StorageProperties.GB);
          if ((totalVolumeSize + size) > StorageInfo.getStorageInfo().getMaxTotalVolumeSizeInGb() || (size > StorageInfo.getStorageInfo().getMaxVolumeSizeInGB())) {
            LOG.error("Volume size limit exceeeded");
            db.commit();
            checker.cleanFailedVolume(volumeId);
            return;
          }
        }
        foundVolumeInfo.setStatus(StorageProperties.Status.available.toString());
      }
 else {
        foundVolumeInfo.setStatus(StorageProperties.Status.failed.toString());
      }
      if (snapshotId != null) {
        foundVolumeInfo.setSize(size);
      }
    }
 else {
      throw new EucalyptusCloudException();
    }
    db.commit();
    if (success) {
      if (StorageProperties.trackUsageStatistics) {
        blockStorageStatistics.incrementVolumeCount((size * StorageProperties.GB));
      }
    }
  }
 catch (  EucalyptusCloudException ex) {
    db.rollback();
    LOG.error(ex);
  }
}
