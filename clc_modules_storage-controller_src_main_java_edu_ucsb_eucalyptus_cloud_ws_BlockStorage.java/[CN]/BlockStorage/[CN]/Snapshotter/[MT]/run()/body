{
  EucaSemaphore semaphore=EucaSemaphoreDirectory.getSolitarySemaphore(volumeId);
  try {
    try {
      semaphore.acquire();
    }
 catch (    InterruptedException ex) {
      throw new EucalyptusCloudException("semaphore could not be acquired");
    }
    Boolean shouldTransferSnapshots=StorageInfo.getStorageInfo().getShouldTransferSnapshots();
    List<String> returnValues=blockManager.createSnapshot(volumeId,snapshotId,shouldTransferSnapshots);
    semaphore.release();
    if (shouldTransferSnapshots) {
      if (returnValues.size() < 2) {
        throw new EucalyptusCloudException("Unable to transfer snapshot");
      }
      snapshotFileName=returnValues.get(0);
      transferSnapshot(returnValues.get(1));
      try {
        blockManager.finishVolume(snapshotId);
      }
 catch (      EucalyptusCloudException ex) {
        blockManager.cleanSnapshot(snapshotId);
        LOG.error(ex);
      }
    }
    SnapshotInfo snapInfo=new SnapshotInfo(snapshotId);
    SnapshotInfo snapshotInfo=null;
    EntityWrapper<SnapshotInfo> db=StorageProperties.getEntityWrapper();
    try {
      snapshotInfo=db.getUnique(snapInfo);
      snapshotInfo.setStatus(StorageProperties.Status.available.toString());
      snapshotInfo.setProgress("100");
    }
 catch (    EucalyptusCloudException e) {
      LOG.error(e);
    }
 finally {
      db.commit();
    }
    if (snapshotInfo != null)     try {
      final long snapshotSize=blockManager.getSnapshotSize(snapshotInfo.getSnapshotId());
      final String volumeUuid=Transactions.find(Volume.named(null,volumeId)).getNaturalId();
      ListenerRegistry.getInstance().fireEvent(SnapShotEvent.with(SnapShotEvent.forSnapShotCreate(snapshotSize,volumeUuid,volumeId),snapshotInfo.getNaturalId(),snapshotInfo.getSnapshotId(),snapshotInfo.getUserName()));
    }
 catch (    final Exception e) {
      LOG.error(e,e);
    }
  }
 catch (  Exception ex) {
    semaphore.release();
    try {
      blockManager.finishVolume(snapshotId);
    }
 catch (    EucalyptusCloudException e1) {
      blockManager.cleanSnapshot(snapshotId);
      LOG.error(e1);
    }
    SnapshotInfo snapInfo=new SnapshotInfo(snapshotId);
    EntityWrapper<SnapshotInfo> db=StorageProperties.getEntityWrapper();
    try {
      SnapshotInfo snapshotInfo=db.getUnique(snapInfo);
      snapshotInfo.setStatus(StorageProperties.Status.failed.toString());
    }
 catch (    EucalyptusCloudException e) {
      LOG.error(e);
    }
 finally {
      db.commit();
    }
    LOG.error(ex);
  }
}
