{
  EucaSemaphore semaphore=EucaSemaphoreDirectory.getSolitarySemaphore(volumeId);
  try {
    try {
      semaphore.acquire();
    }
 catch (    InterruptedException ex) {
      throw new EucalyptusCloudException("semaphore could not be acquired");
    }
    List<String> returnValues=blockManager.createSnapshot(volumeId,snapshotId);
    semaphore.release();
    if (returnValues.size() < 2) {
      throw new EucalyptusCloudException("Unable to transfer snapshot");
    }
    snapshotFileName=returnValues.get(0);
    transferSnapshot(returnValues.get(1));
    blockManager.finishVolume(snapshotId);
    SnapshotInfo snapInfo=new SnapshotInfo(snapshotId);
    EntityWrapper<SnapshotInfo> db=StorageProperties.getEntityWrapper();
    try {
      SnapshotInfo snapshotInfo=db.getUnique(snapInfo);
      snapshotInfo.setStatus(StorageProperties.Status.available.toString());
    }
 catch (    EucalyptusCloudException e) {
      LOG.error(e);
    }
 finally {
      db.commit();
    }
  }
 catch (  Exception ex) {
    semaphore.release();
    try {
      blockManager.finishVolume(snapshotId);
    }
 catch (    EucalyptusCloudException e1) {
      LOG.error(e1);
    }
    SnapshotInfo snapInfo=new SnapshotInfo(snapshotId);
    EntityWrapper<SnapshotInfo> db=StorageProperties.getEntityWrapper();
    try {
      SnapshotInfo snapshotInfo=db.getUnique(snapInfo);
      snapshotInfo.setStatus(StorageProperties.Status.failed.toString());
    }
 catch (    EucalyptusCloudException e) {
      LOG.error(e);
    }
 finally {
      db.commit();
    }
    LOG.error(ex);
  }
}
