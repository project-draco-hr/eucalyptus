{
  this.ctx=ctx;
  this.record=new TxRecord(ctx);
  final EntityManagerFactory anemf=(EntityManagerFactoryImpl)PersistenceContexts.getEntityManagerFactory(ctx);
  assertThat(anemf,notNullValue());
  try {
    this.record.logEvent(TxState.BEGIN,TxEvent.CREATE);
    this.em=anemf.createEntityManager();
    assertThat(this.em,notNullValue());
    this.transaction=this.em.getTransaction();
    assertThat(this.transaction,notNullValue());
    this.transaction.begin();
    this.sessionRef=new WeakReference<Session>((Session)this.em.getDelegate());
    this.record.logEvent(TxState.END,TxEvent.CREATE);
  }
 catch (  final Throwable ex) {
    Logs.exhaust().error(ex,ex);
    this.record.logEvent(TxState.FAIL,TxEvent.CREATE);
    this.rollback();
    throw new RuntimeException(PersistenceExceptions.throwFiltered(ex));
  }
}
