{
  if (event.getMessage() instanceof MappingHttpResponse) {
    MappingHttpResponse httpResponse=(MappingHttpResponse)event.getMessage();
    BaseMessage msg=(BaseMessage)httpResponse.getMessage();
    if (msg instanceof EucalyptusErrorMessageType) {
      EucalyptusErrorMessageType errorMessage=(EucalyptusErrorMessageType)msg;
      BaseMessage errMsg=OSGUtil.convertErrorMessage(errorMessage);
      if (errMsg instanceof ObjectStorageErrorMessageType) {
        ObjectStorageErrorMessageType walrusErrorMsg=(ObjectStorageErrorMessageType)errMsg;
        httpResponse.setStatus(walrusErrorMsg.getStatus());
        httpResponse.addHeader(HttpHeaders.Names.CONNECTION,HttpHeaders.Values.CLOSE);
        event.getFuture().addListener(ChannelFutureListener.CLOSE);
      }
      httpResponse.setMessage(errMsg);
    }
 else     if (msg instanceof ExceptionResponseType) {
      ExceptionResponseType errorMessage=(ExceptionResponseType)msg;
      BaseMessage errMsg=OSGUtil.convertErrorMessage(errorMessage);
      if (errMsg instanceof ObjectStorageErrorMessageType) {
        ObjectStorageErrorMessageType walrusErrorMsg=(ObjectStorageErrorMessageType)errMsg;
        httpResponse.setStatus(walrusErrorMsg.getStatus());
        httpResponse.addHeader(HttpHeaders.Names.CONNECTION,HttpHeaders.Values.CLOSE);
        event.getFuture().addListener(ChannelFutureListener.CLOSE);
      }
 else {
        httpResponse.setStatus(HttpResponseStatus.INTERNAL_SERVER_ERROR);
      }
      httpResponse.setMessage(errMsg);
    }
  }
}
