{
  String status=null;
  Integer size=0;
  String actualDeviceName="unknown";
  if (idStorageVolumeMap.containsKey(v.getDisplayName())) {
    StorageVolume vol=idStorageVolumeMap.get(v.getDisplayName());
    status=vol.getStatus();
    size=Integer.parseInt(vol.getSize());
    actualDeviceName=vol.getActualDeviceName();
  }
 else {
    v.setState(State.ANNIHILATED);
  }
  edu.ucsb.eucalyptus.msgs.Volume aVolume=null;
  AttachedVolume vmAttachedVol=null;
  try {
    VmInstance vm=VmInstances.lookupByVolumeId(v.getDisplayName());
    vmAttachedVol=vm.lookupVolumeAttachment(v.getDisplayName());
    v.setState(State.BUSY);
  }
 catch (  NoSuchElementException ex) {
    v.setMappedState(status);
  }
  if (v.getSize() <= 0) {
    v.setSize(new Integer(size));
  }
  if ("invalid".equals(v.getRemoteDevice()) || "unknown".equals(v.getRemoteDevice()) || v.getRemoteDevice() == null) {
    v.setRemoteDevice(actualDeviceName);
  }
  aVolume=v.morph(new edu.ucsb.eucalyptus.msgs.Volume());
  if (vmAttachedVol != null) {
    aVolume.setStatus(v.mapState());
    aVolume.getAttachmentSet().add(vmAttachedVol);
    for (    AttachedVolume attachedVolume : aVolume.getAttachmentSet()) {
      if (!attachedVolume.getDevice().startsWith("/dev/")) {
        attachedVolume.setDevice("/dev/" + attachedVolume.getDevice());
      }
    }
  }
  if ("invalid".equals(v.getRemoteDevice()) && !State.FAIL.equals(v.getState())) {
    aVolume.setStatus("creating");
  }
  return aVolume;
}
