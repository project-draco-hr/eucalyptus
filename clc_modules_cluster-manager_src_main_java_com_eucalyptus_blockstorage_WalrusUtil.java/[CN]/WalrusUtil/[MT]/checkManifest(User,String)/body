{
  XMLParser parser=new XMLParser(Hashes.base64decode(manifest));
  String encryptedKey=parser.getValue("//ec2_encrypted_key");
  String encryptedIV=parser.getValue("//ec2_encrypted_iv");
  String signature=parser.getValue("//signature");
  String image=parser.getXML("image");
  String machineConfiguration=parser.getXML("machine_configuration");
  String pad=(machineConfiguration + image);
  try {
    for (    Certificate cert : user.getCertificates()) {
      if (cert != null && cert instanceof X509Certificate && ImageUtil.verifyManifestSignature((X509Certificate)cert,signature,pad)) {
        return true;
      }
    }
    if (ImageUtil.verifyManifestSignature(SystemCredentials.lookup(Eucalyptus.class).getCertificate(),signature,pad)) {
      return true;
    }
    for (    User u : Accounts.listAllUsers()) {
      for (      Certificate cert : u.getCertificates()) {
        if (cert != null && cert instanceof X509Certificate && ImageUtil.verifyManifestSignature((X509Certificate)cert,signature,pad)) {
          return true;
        }
      }
    }
    return false;
  }
 catch (  AuthException e) {
    throw new EucalyptusCloudException("Invalid Manifest: Failed to verify signature because of missing (deleted?) user certificate.",e);
  }
}
