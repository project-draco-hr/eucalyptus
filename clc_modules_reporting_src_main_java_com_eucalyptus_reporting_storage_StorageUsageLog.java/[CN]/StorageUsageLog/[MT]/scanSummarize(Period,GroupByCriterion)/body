{
  final Map<String,SummaryInfo> infoMap=new HashMap<String,SummaryInfo>();
  Iterator<StorageUsageSnapshot> iter=scanLog(period);
  while (iter.hasNext()) {
    StorageUsageSnapshot snapshot=iter.next();
    long timestampMs=snapshot.getSnapshotKey().getTimestampMs().longValue();
    String critVal=getAttributeValue(criterion,snapshot.getSnapshotKey());
    if (infoMap.containsKey(critVal)) {
      SummaryInfo info=infoMap.get(critVal);
      StorageUsageData lastData=info.getLastData();
      long durationSecs=(timestampMs - info.getLastTimestamp()) / 1000;
      info.getSummary().updateValues(lastData.getVolumesMegs(),lastData.getSnapshotsMegs(),lastData.getObjectsMegs(),durationSecs);
      info.setLastTimestamp(timestampMs);
      info.setLastData(snapshot.getUsageData());
    }
 else {
      SummaryInfo info=new SummaryInfo(timestampMs,new StorageUsageSummary(),snapshot.getUsageData());
      infoMap.put(critVal,info);
    }
  }
  return convertOneCriterion(infoMap);
}
