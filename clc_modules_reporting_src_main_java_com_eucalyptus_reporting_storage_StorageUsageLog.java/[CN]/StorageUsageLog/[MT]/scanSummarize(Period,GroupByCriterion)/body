{
  final Map<String,SummaryInfo> infoMap=new HashMap<String,SummaryInfo>();
  Iterator<StorageUsageSnapshot> iter=scanLog(period);
  while (iter.hasNext()) {
    StorageUsageSnapshot snapshot=iter.next();
    long timestampMs=snapshot.getSnapshotKey().getTimestampMs().longValue();
    String critVal=getAttributeValue(criterion,snapshot.getSnapshotKey());
    SummaryInfo info=null;
    if (infoMap.containsKey(critVal)) {
      info=infoMap.get(critVal);
      long durationMs=timestampMs - info.getLastTimestamp();
      info.getSummary().addUsage(info.getLastData(),durationMs);
      info.setLastTimestamp(timestampMs);
      info.setLastData(snapshot.getUsageData());
    }
 else {
      info=new SummaryInfo(timestampMs,new StorageUsageSummary(),snapshot.getUsageData());
      infoMap.put(critVal,info);
    }
  }
  final Map<String,StorageUsageSummary> resultMap=new HashMap<String,StorageUsageSummary>();
  for (  String key : infoMap.keySet()) {
    resultMap.put(key,infoMap.get(key).getSummary());
  }
  return resultMap;
}
