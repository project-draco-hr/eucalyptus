{
  CheckImageResponseType reply=(CheckImageResponseType)request.getReply();
  reply.setSuccess(false);
  String bucketName=request.getBucket();
  String objectKey=request.getKey();
  Context ctx=Contexts.lookup();
  Account account=ctx.getAccount();
  final String correlationId=ctx.getCorrelationId();
  logWithContext("Processing CheckImage request for " + bucketName + "/"+ objectKey,Level.INFO,correlationId,account.getAccountNumber());
  EntityWrapper<BucketInfo> db=EntityWrapper.get(BucketInfo.class);
  BucketInfo bucketInfo=new BucketInfo(bucketName);
  BucketInfo bucket=null;
  try {
    bucket=db.getUniqueEscape(bucketInfo);
  }
 catch (  Exception t) {
    throw new WalrusException("Unable to get bucket",t);
  }
  if (bucket != null) {
    EntityWrapper<ObjectInfo> dbObject=db.recast(ObjectInfo.class);
    ObjectInfo searchObjectInfo=new ObjectInfo(bucketName,objectKey);
    List<ObjectInfo> objectInfos=dbObject.queryEscape(searchObjectInfo);
    if (objectInfos.size() > 0) {
      ObjectInfo objectInfo=objectInfos.get(0);
      if (ctx.hasAdministrativePrivileges() || (objectInfo.canRead(account.getAccountNumber()) && Lookups.checkPrivilege(PolicySpec.S3_GETOBJECT,PolicySpec.VENDOR_S3,PolicySpec.S3_RESOURCE_OBJECT,PolicySpec.objectFullName(bucketName,objectKey),objectInfo.getOwnerId()))) {
        db.commit();
        checkManifest(bucketName,objectKey,account);
        reply.setSuccess(true);
        return reply;
      }
 else {
        db.rollback();
        throw new AccessDeniedException("Key",objectKey);
      }
    }
 else {
      db.rollback();
      throw new NoSuchEntityException(objectKey);
    }
  }
 else {
    db.rollback();
    throw new NoSuchBucketException(bucketName);
  }
}
