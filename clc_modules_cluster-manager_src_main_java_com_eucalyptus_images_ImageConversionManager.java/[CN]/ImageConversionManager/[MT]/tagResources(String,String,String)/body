{
  final ImageInfo image=Images.lookupImage(imageId);
  final String imageOwnerId=image.getOwnerUserId();
  final List<VmInstance> instances=this.lookupInstances(imageId);
  if (tagState.containsKey(imageId) && state.equals(tagState.get(imageId))) {
    ;
  }
 else {
    resetTag(imageOwnerId,imageId,TAG_KEY_STATE,state);
    tagState.put(imageId,state);
  }
  for (  final VmInstance instance : instances) {
    final String instanceId=instance.getInstanceId();
    final String instanceOwnerId=instance.getOwnerUserId();
    if (tagState.containsKey(instanceId) && state.equals(tagState.get(instanceId))) {
      ;
    }
 else {
      resetTag(instanceOwnerId,instanceId,TAG_KEY_STATE,state);
      tagState.put(instanceId,state);
    }
  }
  if (statusMessage == null)   statusMessage="";
  if (tagMessage.containsKey(imageId) && statusMessage.equals(tagMessage.get(imageId))) {
    ;
  }
 else {
    resetTag(imageOwnerId,imageId,TAG_KEY_MESSAGE,statusMessage);
    tagMessage.put(imageId,statusMessage);
  }
  for (  final VmInstance instance : instances) {
    final String instanceId=instance.getInstanceId();
    final String instanceOwnerId=instance.getOwnerUserId();
    if (tagMessage.containsKey(instanceId) && statusMessage.equals(tagMessage.get(instanceId))) {
      ;
    }
 else {
      resetTag(instanceOwnerId,instanceId,TAG_KEY_MESSAGE,statusMessage);
      tagMessage.put(instanceId,statusMessage);
    }
  }
}
