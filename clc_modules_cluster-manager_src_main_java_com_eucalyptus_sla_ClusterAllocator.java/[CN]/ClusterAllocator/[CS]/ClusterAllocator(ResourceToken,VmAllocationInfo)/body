{
  this.vmAllocInfo=vmAllocInfo;
  if (vmToken != null) {
    try {
      this.cluster=Clusters.getInstance().lookup(vmToken.getCluster());
      this.messages=new StatefulMessageSet<State>(cluster,State.values());
      for (      NetworkToken networkToken : vmToken.getNetworkTokens())       this.setupNetworkMessages(networkToken);
      this.setupVmMessages(vmToken);
    }
 catch (    Throwable e) {
      LOG.debug(e,e);
      try {
        Clusters.getInstance().lookup(vmToken.getCluster()).getNodeState().releaseToken(vmToken);
      }
 catch (      Throwable e1) {
        LOG.debug(e1);
        LOG.trace(e1,e1);
      }
      for (      String addr : vmToken.getAddresses()) {
        try {
          Addresses.release(Addresses.getInstance().lookup(addr));
        }
 catch (        Throwable e1) {
          LOG.debug(e1);
          LOG.trace(e1,e1);
        }
      }
      try {
        if (vmToken.getPrimaryNetwork() != null) {
          Network net=Networks.getInstance().lookup(vmToken.getPrimaryNetwork().getName());
          for (          Integer i : vmToken.getPrimaryNetwork().getIndexes()) {
            net.returnNetworkIndex(i);
          }
        }
      }
 catch (      Throwable e1) {
        LOG.debug(e1);
        LOG.trace(e1,e1);
      }
      for (      String vmId : vmToken.getInstanceIds()) {
        try {
          VmInstance vm=VmInstances.getInstance().lookup(vmId);
          vm.setState(VmState.TERMINATED);
          vm.resetStopWatch();
          vm.setReason(SystemState.INSTANCE_FAILED + " " + e.getMessage());
          VmInstances.getInstance().disable(vmId);
        }
 catch (        Exception e1) {
          LOG.debug(e1,e1);
        }
      }
    }
  }
}
