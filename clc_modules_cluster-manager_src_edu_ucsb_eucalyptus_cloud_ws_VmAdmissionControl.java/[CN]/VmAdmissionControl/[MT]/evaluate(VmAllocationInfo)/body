{
  SLAs sla=new SLAs();
  List<ResourceToken> allocTokeList=null;
  boolean failed=false;
  try {
    allocTokeList=sla.doVmAllocation(vmAllocInfo);
    vmAllocInfo.getAllocationTokens().addAll(allocTokeList);
    try {
      sla.doNetworkAllocation(vmAllocInfo.getRequest().getUserId(),vmAllocInfo.getAllocationTokens(),vmAllocInfo.getNetworks());
    }
 catch (    NotEnoughResourcesAvailable notEnoughResourcesAvailable) {
      failed=true;
    }
  }
 catch (  FailScriptFailException e) {
    failed=true;
  }
catch (  NotEnoughResourcesAvailable notEnoughResourcesAvailable) {
    failed=true;
  }
  if (failed) {
    if (allocTokeList != null)     for (    ResourceToken token : allocTokeList)     Clusters.getInstance().lookup(token.getCluster()).getNodeState().releaseToken(token);
    throw new EucalyptusCloudException("Not enough resources available.");
  }
  return vmAllocInfo;
}
