{
  if (!(dest.startsWith("vm://") && !serviceToEndpoint.containsKey(dest)) || dest == null) {
    dest="vm://RequestQueue";
  }
 else   if (!dest.startsWith("vm://")) {
    dest=serviceToEndpoint.get(dest);
  }
  try {
    OutboundEndpoint endpoint=ServiceContext.getContext().getRegistry().lookupEndpointFactory().getOutboundEndpoint(dest);
    if (!endpoint.getConnector().isStarted()) {
      endpoint.getConnector().start();
    }
    MuleMessage muleMsg=new DefaultMuleMessage(msg);
    MuleSession muleSession=new DefaultMuleSession(muleMsg,((AbstractConnector)endpoint.getConnector()).getSessionHandler(),ServiceContext.getContext());
    MuleEvent muleEvent=new DefaultMuleEvent(muleMsg,endpoint,muleSession,false);
    LOG.debug("ServiceContext.dispatch(" + dest + ":"+ msg.getClass().getCanonicalName(),Exceptions.filterStackTrace(new RuntimeException(),3));
    dispatcherFactory.create(endpoint).dispatch(muleEvent);
  }
 catch (  Exception ex) {
    LOG.error(ex,ex);
    throw new EucalyptusCloudException("Failed to dispatch request to service " + dest + " for message type: "+ msg.getClass().getSimpleName()+ " because of an error: "+ ex.getMessage(),ex);
  }
}
