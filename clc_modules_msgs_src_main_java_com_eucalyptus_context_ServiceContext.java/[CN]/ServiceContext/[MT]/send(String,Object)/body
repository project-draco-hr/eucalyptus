{
  dest=ServiceContextManager.mapEndpointToService(dest);
  MuleEvent context=RequestContext.getEvent();
  Context ctx=null;
  if (msg instanceof BaseMessage) {
    ctx=Contexts.createWrapped(dest,(BaseMessage)msg);
    final String userId=((BaseMessage)msg).getEffectiveUserId();
    try {
      if (userId != null && !Principals.isFakeIdentify(userId) && ctx.hasAdministrativePrivileges()) {
        final User user=Accounts.lookupUserById(userId);
        ctx.setUser(user);
      }
    }
 catch (    final AuthException e) {
      throw new EucalyptusCloudException("User not found: " + userId);
    }
  }
  try {
    MuleMessage reply=ServiceContextManager.getClient().sendDirect(dest,null,new DefaultMuleMessage(msg));
    if (reply.getExceptionPayload() != null) {
      throw Exceptions.trace(new ServiceDispatchException(reply.getExceptionPayload().getRootException().getMessage(),reply.getExceptionPayload().getRootException()));
    }
 else {
      return (T)reply.getPayload();
    }
  }
 catch (  Exception e) {
    throw Exceptions.trace(new ServiceDispatchException("Failed to send message " + msg.getClass().getSimpleName() + " to service "+ dest+ " because: "+ e.getMessage(),e));
  }
 finally {
    if (ctx != null) {
      Contexts.clear(ctx);
    }
    RequestContext.setEvent(context);
  }
}
