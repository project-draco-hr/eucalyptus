{
  String identifier="";
  Context ctx=Contexts.lookup();
  if (!ctx.hasAdministrativePrivileges()) {
    Class<? extends BaseMessage> msgType=ctx.getRequest().getClass();
    Class<?> rscType=findResourceClass(allocator);
    Ats ats=findPolicyAnnotations(rscType,msgType);
    PolicyVendor vendor=ats.get(PolicyVendor.class);
    PolicyResourceType type=ats.get(PolicyResourceType.class);
    String action=getIamActionByMessageType();
    AuthContextSupplier userContext=ctx.getAuthContext();
    try {
      if (!Permissions.isAuthorized(vendor.value(),type.value(),identifier,null,action,userContext)) {
        throw new AuthException("Not authorized to create: " + type.value() + " by user: "+ ctx.getUserFullName());
      }
 else       if (!Permissions.canAllocate(vendor.value(),type.value(),identifier,action,ctx.getUser(),amount)) {
        throw new AuthQuotaException(type.value(),"Quota exceeded while trying to create: " + type.value() + " by user: "+ ctx.getUserFullName());
      }
    }
 catch (    AuthException ex) {
      throw ex;
    }
  }
  return allocator.apply(amount);
}
