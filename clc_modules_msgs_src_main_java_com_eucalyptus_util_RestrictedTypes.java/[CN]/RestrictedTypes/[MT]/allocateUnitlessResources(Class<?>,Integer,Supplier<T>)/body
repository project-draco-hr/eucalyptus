{
  String identifier="";
  Context ctx=Contexts.lookup();
  if (!ctx.hasAdministrativePrivileges()) {
    Class<? extends BaseMessage> msgType=ctx.getRequest().getClass();
    Ats ats=findPolicyAnnotations(rscType,msgType);
    PolicyVendor vendor=ats.get(PolicyVendor.class);
    PolicyResourceType type=ats.get(PolicyResourceType.class);
    String action=getIamActionByMessageType();
    AuthContextSupplier userContext=ctx.getAuthContext();
    if (!Permissions.isAuthorized(vendor.value(),type.value(),identifier,null,action,userContext)) {
      throw new AuthException("Not authorized to create: " + type.value() + " by user: "+ ctx.getUserFullName());
    }
 else     if (!Permissions.canAllocate(vendor.value(),type.value(),identifier,action,ctx.getUser(),(long)quantity)) {
      throw new AuthQuotaException(type.value(),"Quota exceeded while trying to create: " + type.value() + " by user: "+ ctx.getUserFullName());
    }
  }
  return runAllocator(quantity,allocator,(Predicate)Predicates.alwaysTrue());
}
