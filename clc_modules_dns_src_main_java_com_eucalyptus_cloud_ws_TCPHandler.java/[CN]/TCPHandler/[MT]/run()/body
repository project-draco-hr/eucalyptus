{
  try {
    int inputLength;
    DataInputStream inStream=new DataInputStream(socket.getInputStream());
    DataOutputStream outStream=new DataOutputStream(socket.getOutputStream());
    inputLength=inStream.readUnsignedShort();
    if (inputLength > DNSProperties.MAX_MESSAGE_SIZE) {
      LOG.error("Maximum message size exceeded. Ignoring request.");
    }
    byte[] inBytes=new byte[inputLength];
    inStream.readFully(inBytes);
    Message query;
    byte[] response=null;
    try {
      query=new Message(inBytes);
      ConnectionHandler.setRemoteInetAddress(socket.getInetAddress());
      try {
        response=generateReply(query,inBytes,inBytes.length,socket);
      }
 catch (      RuntimeException ex) {
        response=errorMessage(query,Rcode.SERVFAIL);
        throw ex;
      }
 finally {
        ConnectionHandler.removeRemoteInetAddress();
      }
      if (response == null)       return;
    }
 catch (    IOException exception) {
      LOG.error(exception);
    }
    outStream.writeShort(response.length);
    outStream.write(response);
  }
 catch (  IOException ex) {
    LOG.error(ex);
  }
}
