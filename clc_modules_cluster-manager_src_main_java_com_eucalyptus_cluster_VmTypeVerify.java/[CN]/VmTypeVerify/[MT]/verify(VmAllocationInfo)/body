{
  Context ctx;
  try {
    ctx=Contexts.lookup(vmAllocInfo.getCorrelationId());
  }
 catch (  NoSuchContextException ex) {
    LOG.debug(ex);
    try {
      ctx=Contexts.lookup(vmAllocInfo.getRequest().getCorrelationId());
    }
 catch (    NoSuchContextException ex1) {
      LOG.debug(ex);
      throw new EucalyptusCloudException("Failed to lookup context for correlationId=" + vmAllocInfo.getCorrelationId(),ex);
    }
  }
  User user=ctx.getUser();
  RunInstancesType request=vmAllocInfo.getRequest();
  String instanceType=request.getInstanceType();
  VmType v=VmTypes.getVmType((instanceType == null) ? "m1.small" : instanceType);
  if (v == null) {
    throw new EucalyptusCloudException("instance type does not exist: " + request.getInstanceType());
  }
  String action=PolicySpec.requestToAction(vmAllocInfo.getRequest());
  try {
    if (!Permissions.isAuthorized(PolicySpec.VENDOR_EC2,PolicySpec.EC2_RESOURCE_VMTYPE,instanceType,user.getAccount(),action,user)) {
      throw new EucalyptusCloudException("Not authorized to allocate vm type " + instanceType + " for "+ ctx.getUserFullName());
    }
  }
 catch (  AuthException ex) {
    LOG.error(ex,ex);
    throw new EucalyptusCloudException("Not authorized to allocate vm type " + instanceType + " for "+ ctx.getUserFullName());
  }
  vmAllocInfo.setVmTypeInfo(v.getAsVmTypeInfo());
  return vmAllocInfo;
}
