{
  Signature sig;
  boolean valid=false;
  try {
    PublicKey publicKey=SystemCredentialProvider.getCredentialProvider(Component.storage).getCertificate().getPublicKey();
    sig=Signature.getInstance("SHA1withRSA");
    sig.initVerify(publicKey);
    sig.update(credentials.getLoginData().getBytes());
    valid=sig.verify(Base64.decode(credentials.getSignature()));
  }
 catch (  Exception e) {
    LOG.warn("Authentication: certificate not found in keystore");
  }
 finally {
    if (!valid && credentials.getCertString() != null) {
      try {
        X509Certificate nodeCert=PEMFiles.getCert(Base64.decode(credentials.getCertString()));
        PublicKey publicKey=nodeCert.getPublicKey();
        sig=Signature.getInstance("SHA1withRSA");
        sig.initVerify(publicKey);
        sig.update(credentials.getLoginData().getBytes());
        valid=sig.verify(Base64.decode(credentials.getSignature()));
      }
 catch (      Exception e2) {
        LOG.warn("Authentication exception: " + e2.getMessage());
      }
    }
  }
  if (!valid) {
    throw new AuthenticationException("User authentication failed.");
  }
  User user=Users.lookupUser("admin");
  super.setCredential(credentials.getSignature());
  super.setPrincipal(user);
  super.getGroups().addAll(Groups.lookupGroups(super.getPrincipal()));
  return true;
}
