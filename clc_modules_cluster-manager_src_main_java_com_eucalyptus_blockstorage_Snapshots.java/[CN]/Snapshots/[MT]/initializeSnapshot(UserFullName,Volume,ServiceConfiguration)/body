{
  String newId=null;
  Snapshot snap=null;
  EntityWrapper<Snapshot> db=EntityWrapper.get(Snapshot.class);
  try {
    while (true) {
      newId=Crypto.generateId(userFullName.getUniqueId(),SnapshotManager.ID_PREFIX);
      try {
        db.getUnique(Snapshot.named(null,newId));
      }
 catch (      EucalyptusCloudException e) {
        snap=new Snapshot(userFullName,newId,vol.getDisplayName(),sc.getName(),sc.getPartition());
        snap.setVolumeSize(vol.getSize());
        db.add(snap);
        db.commit();
        return snap;
      }
    }
  }
 catch (  Exception ex) {
    db.rollback();
    throw new EucalyptusCloudException("Failed to initialize snapshot state because of: " + ex.getMessage(),ex);
  }
}
