{
  String newId=null;
  Snapshot snap=null;
  EntityTransaction db=Entities.get(Snapshot.class);
  try {
    while (true) {
      newId=Crypto.generateId(userFullName.getUniqueId(),SnapshotManager.ID_PREFIX);
      try {
        Entities.uniqueResult(Snapshot.named(null,newId));
      }
 catch (      NoSuchElementException e) {
        snap=new Snapshot(userFullName,newId,vol.getDisplayName(),vol.getSize(),sc.getName(),sc.getPartition());
        Entities.persist(snap);
        db.commit();
        return snap;
      }
    }
  }
 catch (  Exception ex) {
    db.rollback();
    throw new EucalyptusCloudException("Failed to initialize snapshot state because of: " + ex.getMessage(),ex);
  }
}
