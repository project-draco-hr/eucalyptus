{
  final ServiceConfiguration sc=Topology.lookup(Storage.class,Partitions.lookupByName(vol.getPartition()));
  try {
    Snapshot snapState=Transactions.save(snap,new Callback<Snapshot>(){
      @Override public void fire(      Snapshot s){
        try {
          CreateStorageSnapshotType scRequest=new CreateStorageSnapshotType(vol.getDisplayName(),snap.getDisplayName());
          CreateStorageSnapshotResponseType scReply=AsyncRequests.sendSync(sc,scRequest);
          s.setMappedState(scReply.getStatus());
        }
 catch (        Exception ex) {
          throw Exceptions.toUndeclared(ex);
        }
      }
    }
);
  }
 catch (  ConstraintViolationException ex) {
    throw new DuplicateMetadataException("Duplicate snapshot creation: " + snap + ": "+ ex.getMessage(),ex);
  }
catch (  ExecutionException ex) {
    LOG.error(ex.getCause(),ex.getCause());
    throw new EucalyptusCloudException(ex);
  }
  try {
    ListenerRegistry.getInstance().fireEvent(new StorageEvent(StorageEvent.EventType.EbsSnapshot,true,snap.getVolumeSize(),snap.getOwnerUserId(),snap.getOwnerUserName(),snap.getOwnerAccountNumber(),snap.getOwnerAccountName(),snap.getVolumeCluster(),snap.getVolumePartition()));
  }
 catch (  EventFailedException ex) {
    LOG.error(ex,ex);
  }
  return snap;
}
