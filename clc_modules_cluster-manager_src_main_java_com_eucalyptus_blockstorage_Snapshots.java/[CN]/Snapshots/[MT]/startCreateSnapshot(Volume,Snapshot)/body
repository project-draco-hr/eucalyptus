{
  final ServiceConfiguration sc=Partitions.lookupService(Storage.class,vol.getPartition());
  try {
    Snapshot snapState=Transactions.save(snap,new Callback<Snapshot>(){
      @Override public void fire(      Snapshot s){
        try {
          CreateStorageSnapshotType scRequest=new CreateStorageSnapshotType(vol.getDisplayName(),snap.getDisplayName());
          CreateStorageSnapshotResponseType scReply=ServiceDispatcher.lookup(sc).send(scRequest);
          s.setMappedState(scReply.getStatus());
        }
 catch (        EucalyptusCloudException ex) {
          throw new UndeclaredThrowableException(ex);
        }
      }
    }
);
  }
 catch (  ConstraintViolationException ex) {
    throw new DuplicateMetadataException("Duplicate snapshot creation: " + snap + ": "+ ex.getMessage(),ex);
  }
catch (  ExecutionException ex) {
    LOG.error(ex.getCause(),ex.getCause());
    throw new EucalyptusCloudException(ex);
  }
  try {
    ListenerRegistry.getInstance().fireEvent(new StorageEvent(StorageEvent.EventType.EbsSnapshot,true,snap.getVolumeSize(),snap.getOwnerUserId(),snap.getOwnerAccountNumber(),snap.getVolumeCluster(),snap.getVolumePartition()));
  }
 catch (  EventFailedException ex) {
    LOG.error(ex,ex);
  }
  return snap;
}
