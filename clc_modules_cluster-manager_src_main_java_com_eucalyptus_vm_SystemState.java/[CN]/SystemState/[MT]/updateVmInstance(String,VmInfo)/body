{
  VmState state=VmState.Mapper.get(runVm.getStateName());
  VmInstance vm=null;
  try {
    vm=VmInstances.getInstance().lookup(runVm.getInstanceId());
  }
 catch (  NoSuchElementException e) {
    try {
      vm=VmInstances.getInstance().lookupDisabled(runVm.getInstanceId());
      if (!VmState.BURIED.equals(vm.getRuntimeState()) && vm.getSplitTime() > BURY_TIME) {
        vm.setState(VmState.BURIED,Reason.BURIED);
      }
      return;
    }
 catch (    NoSuchElementException e1) {
      if ((VmState.PENDING.equals(state) || VmState.RUNNING.equals(state))) {
        SystemState.restoreInstance(originCluster,runVm);
      }
      return;
    }
  }
  long splitTime=vm.getSplitTime();
  VmState oldState=vm.getRuntimeState();
  vm.setServiceTag(runVm.getServiceTag());
  vm.setPlatform(runVm.getPlatform());
  vm.setBundleTaskState(runVm.getBundleTaskStateName());
  if (VmState.SHUTTING_DOWN.equals(vm.getRuntimeState()) && splitTime > SHUT_DOWN_TIME) {
    vm.setState(VmState.TERMINATED,Reason.EXPIRED);
  }
 else   if (VmState.STOPPING.equals(vm.getRuntimeState()) && splitTime > SHUT_DOWN_TIME) {
    vm.setState(VmState.STOPPED,Reason.EXPIRED);
  }
 else   if (VmState.STOPPING.equals(vm.getRuntimeState()) && VmState.SHUTTING_DOWN.equals(VmState.Mapper.get(runVm.getStateName()))) {
    vm.setState(VmState.STOPPED,Reason.APPEND,"STOPPED");
  }
 else   if (VmState.SHUTTING_DOWN.equals(vm.getRuntimeState()) && VmState.SHUTTING_DOWN.equals(VmState.Mapper.get(runVm.getStateName()))) {
    vm.setState(VmState.TERMINATED,Reason.APPEND,"DONE");
  }
 else   if ((VmState.PENDING.equals(state) || VmState.RUNNING.equals(state)) && (VmState.PENDING.equals(vm.getRuntimeState()) || VmState.RUNNING.equals(vm.getRuntimeState()))) {
    if (!VmInstance.DEFAULT_IP.equals(runVm.getNetParams().getIpAddress())) {
      vm.updateAddresses(runVm.getNetParams().getIpAddress(),runVm.getNetParams().getIgnoredPublicIp());
    }
    vm.setState(VmState.Mapper.get(runVm.getStateName()),Reason.APPEND,"UPDATE");
    vm.updateNetworkIndex(runVm.getNetParams().getNetworkIndex());
    vm.updateVolumeAttachments(runVm.getVolumes());
    try {
      Network network=Networks.getInstance().lookup(runVm.getOwnerId() + "-" + runVm.getGroupNames().get(0));
      network.extantNetworkIndex(vm.getClusterName(),vm.getNetworkIndex());
    }
 catch (    Exception e) {
    }
  }
}
