{
  try {
    String instanceId=runVm.getInstanceId();
    String reservationId=runVm.getReservationId();
    String ownerId=runVm.getOwnerId();
    String placement=cluster;
    byte[] userData=new byte[0];
    if (runVm.getUserData() != null && runVm.getUserData().length() > 1) {
      userData=Base64.decode(runVm.getUserData());
    }
    Integer launchIndex=0;
    try {
      launchIndex=Integer.parseInt(runVm.getLaunchIndex());
    }
 catch (    NumberFormatException e) {
    }
    VmKeyInfo keyInfo=null;
    SshKeyPair key=null;
    if (runVm.getKeyValue() != null || !"".equals(runVm.getKeyValue())) {
      try {
        EntityWrapper<SshKeyPair> db=EntityWrapper.get(SshKeyPair.class);
        try {
          SshKeyPair searchKey=new SshKeyPair(runVm.getOwnerId()){
{
              setPublicKey(runVm.getKeyValue());
            }
          }
;
          key=db.getUnique(searchKey);
          db.commit();
        }
 catch (        Throwable e) {
          db.rollback();
          throw new EucalyptusCloudException("Failed to find key pair associated with public key " + runVm.getKeyValue(),e);
        }
      }
 catch (      Throwable e) {
        key=SshKeyPair.NO_KEY;
      }
    }
 else {
      key=SshKeyPair.NO_KEY;
    }
    keyInfo=new VmKeyInfo(key.getDisplayName(),key.getPublicKey(),key.getFingerPrint());
    VmTypeInfo vmType=runVm.getInstanceType();
    List<Network> networks=new ArrayList<Network>();
    for (    String netName : runVm.getGroupNames()) {
      Network notwork=null;
      try {
        notwork=Networks.getInstance().lookup(runVm.getOwnerId() + "-" + netName);
        networks.add(notwork);
        try {
          NetworkToken netToken=Clusters.getInstance().lookup(runVm.getPlacement()).getState().extantAllocation(runVm.getOwnerId(),netName,runVm.getNetParams().getVlan());
          notwork.addTokenIfAbsent(netToken);
        }
 catch (        NetworkAlreadyExistsException e) {
          LOG.trace(e);
        }
        notwork.extantNetworkIndex(runVm.getPlacement(),runVm.getNetParams().getNetworkIndex());
      }
 catch (      NoSuchElementException e1) {
        try {
          try {
            notwork=SystemState.getUserNetwork(runVm.getOwnerId(),netName);
          }
 catch (          Exception ex) {
            LOG.error(ex);
            notwork=SystemState.getUserNetwork(runVm.getOwnerId(),"default");
          }
          networks.add(notwork);
          NetworkToken netToken=Clusters.getInstance().lookup(runVm.getPlacement()).getState().extantAllocation(runVm.getOwnerId(),netName,runVm.getNetParams().getVlan());
          notwork.addTokenIfAbsent(netToken);
          Networks.getInstance().registerIfAbsent(notwork,Networks.State.ACTIVE);
        }
 catch (        EucalyptusCloudException e) {
          LOG.error(e);
          ClusterConfiguration config=Clusters.getInstance().lookup(runVm.getPlacement()).getConfiguration();
          Callbacks.newClusterRequest(new TerminateCallback(runVm.getInstanceId())).dispatch(runVm.getPlacement());
        }
catch (        NetworkAlreadyExistsException e) {
          LOG.trace(e);
        }
      }
    }
    VmInstance vm=new VmInstance(reservationId,launchIndex,instanceId,ownerId,placement,userData,keyInfo,vmType,networks,Integer.toString(runVm.getNetParams().getNetworkIndex()));
    vm.clearPending();
    vm.setLaunchTime(runVm.getLaunchTime());
    vm.updatePublicAddress(VmInstance.DEFAULT_IP);
    vm.setKeyInfo(keyInfo);
    VmInstances.getInstance().register(vm);
  }
 catch (  NoSuchElementException e) {
    ClusterConfiguration config=Clusters.getInstance().lookup(runVm.getPlacement()).getConfiguration();
    Callbacks.newClusterRequest(new TerminateCallback(runVm.getInstanceId())).dispatch(runVm.getPlacement());
  }
catch (  Throwable t) {
    LOG.error(t,t);
  }
}
