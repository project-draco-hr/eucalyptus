{
  Map<String,ReservationInfoType> rsvMap=new HashMap<String,ReservationInfoType>();
  boolean dns=Components.lookup("dns").isLocal() && !(instancesSet.remove(DESCRIBE_NO_DNS) || instancesSet.remove(ALT_PREFIX + DESCRIBE_NO_DNS));
  for (  VmInstance v : VmInstances.getInstance().listValues()) {
    if ((!isAdmin && !userId.equals(v.getOwnerId()) || (!instancesSet.isEmpty() && !instancesSet.contains(v.getInstanceId()))))     continue;
    if (rsvMap.get(v.getReservationId()) == null) {
      ReservationInfoType reservation=new ReservationInfoType(v.getReservationId(),v.getOwnerId(),v.getNetworkNames());
      rsvMap.put(reservation.getReservationId(),reservation);
    }
    rsvMap.get(v.getReservationId()).getInstancesSet().add(v.getAsRunningInstanceItemType(dns));
  }
  if (isAdmin) {
    for (    VmInstance v : VmInstances.getInstance().listDisabledValues()) {
      if (VmState.BURIED.equals(v.getState()))       continue;
      if (!instancesSet.isEmpty() && !instancesSet.contains(v.getInstanceId()))       continue;
      if (rsvMap.get(v.getReservationId()) == null) {
        ReservationInfoType reservation=new ReservationInfoType(v.getReservationId(),v.getOwnerId(),v.getNetworkNames());
        rsvMap.put(reservation.getReservationId(),reservation);
      }
      rsvMap.get(v.getReservationId()).getInstancesSet().add(v.getAsRunningInstanceItemType(dns));
    }
  }
  return new ArrayList<ReservationInfoType>(rsvMap.values());
}
