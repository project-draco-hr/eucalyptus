{
  Context ctx=Contexts.lookup();
  boolean isAdmin=ctx.hasAdministrativePrivileges();
  ArrayList<String> instancesSet=request.getInstancesSet();
  String action=PolicySpec.requestToAction(request);
  User requestUser=ctx.getUser();
  Map<String,ReservationInfoType> rsvMap=new HashMap<String,ReservationInfoType>();
  for (  VmInstance v : VmInstances.listValues()) {
    Account instanceAccount=null;
    try {
      instanceAccount=Accounts.lookupUserById(v.getOwner().getUniqueId()).getAccount();
    }
 catch (    AuthException e) {
      throw new EucalyptusCloudException(e);
    }
    if ((!isAdmin && !Permissions.isAuthorized(PolicySpec.VENDOR_EC2,PolicySpec.EC2_RESOURCE_INSTANCE,v.getInstanceId(),instanceAccount,action,requestUser)) || (!instancesSet.isEmpty() && !instancesSet.contains(v.getInstanceId()))) {
      continue;
    }
    if (rsvMap.get(v.getReservationId()) == null) {
      ReservationInfoType reservation=new ReservationInfoType(v.getReservationId(),v.getOwner().getNamespace(),v.getNetworkNames());
      rsvMap.put(reservation.getReservationId(),reservation);
    }
    rsvMap.get(v.getReservationId()).getInstancesSet().add(v.getAsRunningInstanceItemType());
  }
  if (isAdmin) {
    for (    VmInstance v : VmInstances.listDisabledValues()) {
      if (VmState.BURIED.equals(v.getState()))       continue;
      if (!instancesSet.isEmpty() && !instancesSet.contains(v.getInstanceId()))       continue;
      if (rsvMap.get(v.getReservationId()) == null) {
        ReservationInfoType reservation=new ReservationInfoType(v.getReservationId(),v.getOwner(),v.getNetworkNames());
        rsvMap.put(reservation.getReservationId(),reservation);
      }
      rsvMap.get(v.getReservationId()).getInstancesSet().add(v.getAsRunningInstanceItemType());
    }
  }
  return new ArrayList<ReservationInfoType>(rsvMap.values());
}
