{
  final Context ctx=Contexts.lookup();
  final boolean isAdmin=ctx.hasAdministrativePrivileges();
  final ArrayList<String> instancesSet=request.getInstancesSet();
  final String action=PolicySpec.requestToAction(request);
  final User requestUser=ctx.getUser();
  final Map<String,ReservationInfoType> rsvMap=new HashMap<String,ReservationInfoType>();
  final EntityTransaction db=Entities.get(VmInstance.class);
  for (  final VmInstance v : VmInstances.listValues()) {
    if (!VmState.STOPPED.equals(v.getState()) && (v.getState().ordinal() > VmState.RUNNING.ordinal())) {
      final long time=(System.currentTimeMillis() - v.getLastUpdateTimestamp().getTime());
      if (time > VmInstances.SHUT_DOWN_TIME) {
        v.setState(VmState.TERMINATED,Reason.EXPIRED);
        continue;
      }
 else       if (time > VmInstances.SHUT_DOWN_TIME) {
        v.setState(VmState.BURIED,Reason.BURIED);
      }
    }
    Account instanceAccount=null;
    try {
      instanceAccount=Accounts.lookupUserById(v.getOwner().getUniqueId()).getAccount();
    }
 catch (    final AuthException e) {
      throw new EucalyptusCloudException(e);
    }
    if ((!isAdmin && !Permissions.isAuthorized(PolicySpec.VENDOR_EC2,PolicySpec.EC2_RESOURCE_INSTANCE,v.getInstanceId(),instanceAccount,action,requestUser)) || (!instancesSet.isEmpty() && !instancesSet.contains(v.getInstanceId()))) {
      continue;
    }
    if (rsvMap.get(v.getReservationId()) == null) {
      final ReservationInfoType reservation=new ReservationInfoType(v.getReservationId(),v.getOwner().getNamespace(),v.getNetworkNames());
      rsvMap.put(reservation.getReservationId(),reservation);
    }
    rsvMap.get(v.getReservationId()).getInstancesSet().add(VmInstance.Transform.INSTANCE.apply(v));
  }
  return new ArrayList<ReservationInfoType>(rsvMap.values());
}
