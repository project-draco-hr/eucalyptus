{
  Map<String,ReservationInfoType> rsvMap=new HashMap<String,ReservationInfoType>();
  for (  VmInstance v : VmInstances.getInstance().listValues()) {
    if ((!isAdmin && !userId.equals(v.getOwner()) || (!instancesSet.isEmpty() && !instancesSet.contains(v.getInstanceId()))))     continue;
    if (rsvMap.get(v.getReservationId()) == null) {
      ReservationInfoType reservation=new ReservationInfoType(v.getReservationId(),v.getOwner().getNamespace(),v.getNetworkNames());
      rsvMap.put(reservation.getReservationId(),reservation);
    }
    rsvMap.get(v.getReservationId()).getInstancesSet().add(v.getAsRunningInstanceItemType());
  }
  if (isAdmin) {
    for (    VmInstance v : VmInstances.getInstance().listDisabledValues()) {
      if (VmState.BURIED.equals(v.getState()))       continue;
      if (!instancesSet.isEmpty() && !instancesSet.contains(v.getInstanceId()))       continue;
      if (rsvMap.get(v.getReservationId()) == null) {
        ReservationInfoType reservation=new ReservationInfoType(v.getReservationId(),v.getOwner(),v.getNetworkNames());
        rsvMap.put(reservation.getReservationId(),reservation);
      }
      rsvMap.get(v.getReservationId()).getInstancesSet().add(v.getAsRunningInstanceItemType());
    }
  }
  return new ArrayList<ReservationInfoType>(rsvMap.values());
}
