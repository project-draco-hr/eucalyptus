{
  ClusterConfiguration config=super.add(partition,name,host,port);
  KeyPair clusterKp;
  X509Certificate clusterX509;
  KeyPair nodeKp;
  X509Certificate nodeX509;
  try {
    clusterKp=Certs.generateKeyPair();
    clusterX509=Certs.generateServiceCertificate(clusterKp,String.format(CLUSTER_KEY_FSTRING,config.getName()));
    nodeKp=Certs.generateKeyPair();
    nodeX509=Certs.generateServiceCertificate(nodeKp,String.format(NODE_KEY_FSTRING,config.getName()));
  }
 catch (  Exception ex) {
    LOG.error(ex,ex);
    throw new ServiceRegistrationException("Failed to generate credentials for cluster: " + config,ex);
  }
  File keyDir=ClusterBuilder.makeKeyDir(config);
  try {
    ClusterBuilder.writeClusterKeyFiles(config,keyDir,clusterKp,clusterX509,nodeKp,nodeX509);
    ClusterBuilder.storeClusterCredentials(config,clusterX509,nodeX509);
  }
 catch (  ServiceRegistrationException ex) {
    ClusterBuilder.removeKeyDirectory(keyDir);
    throw ex;
  }
catch (  Throwable ex) {
    ClusterBuilder.removeKeyDirectory(keyDir);
    LOG.error(ex,ex);
    throw new ServiceRegistrationException(String.format("Unexpected error caused cluster registration to fail for: partition=%s name=%s host=%s port=%d",partition,name,host,port),ex);
  }
  return config;
}
