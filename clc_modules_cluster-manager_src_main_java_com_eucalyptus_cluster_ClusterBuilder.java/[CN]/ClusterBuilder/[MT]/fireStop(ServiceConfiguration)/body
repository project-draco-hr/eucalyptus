{
  LOG.info("Tearing down cluster: " + config);
  Cluster cluster=Clusters.getInstance().lookup(config.getName());
  EntityWrapper<ClusterCredentials> credDb=Authentication.getEntityWrapper();
  try {
    List<ClusterCredentials> ccCreds=credDb.query(new ClusterCredentials(config.getName()));
    for (    ClusterCredentials ccert : ccCreds) {
      credDb.delete(ccert);
    }
    credDb.commit();
  }
 catch (  Exception e) {
    LOG.error(e,e);
    credDb.rollback();
  }
  EventRecord.here(ClusterBuilder.class,EventType.COMPONENT_SERVICE_STOPPED,config.getComponentId().name(),config.getName(),config.getUri()).info();
  Clusters.stop(cluster.getName());
  for (  Group g : Groups.listAllGroups()) {
    for (    Authorization auth : g.getAuthorizations()) {
      if (auth instanceof AvailabilityZonePermission && config.getName().equals(auth.getValue())) {
        g.removeAuthorization(auth);
      }
    }
  }
  String directory=SubDirectory.KEYS.toString() + File.separator + config.getName();
  File keyDir=new File(directory);
  if (keyDir.exists()) {
    for (    File f : keyDir.listFiles()) {
      if (f.delete()) {
        LOG.info("Removing cluster key file: " + f.getAbsolutePath());
      }
 else {
        LOG.info("Failed to remove cluster key file: " + f.getAbsolutePath());
      }
    }
    if (keyDir.delete()) {
      LOG.info("Removing cluster key directory: " + keyDir.getAbsolutePath());
    }
 else {
      LOG.info("Failed to remove cluster key directory: " + keyDir.getAbsolutePath());
    }
  }
  super.fireStop(config);
}
