{
  X509Certificate systemX509=SystemCredentialProvider.getCredentialProvider(Eucalyptus.class).getCertificate();
  FileWriter out=null;
  try {
    PEMFiles.write(keyDir.getAbsolutePath() + File.separator + "cluster-pk.pem",clusterKp.getPrivate());
    PEMFiles.write(keyDir.getAbsolutePath() + File.separator + "cluster-cert.pem",clusterX509);
    PEMFiles.write(keyDir.getAbsolutePath() + File.separator + "node-pk.pem",nodeKp.getPrivate());
    PEMFiles.write(keyDir.getAbsolutePath() + File.separator + "node-cert.pem",nodeX509);
    PEMFiles.write(keyDir.getAbsolutePath() + File.separator + "cloud-cert.pem",systemX509);
    out=new FileWriter(keyDir.getAbsolutePath() + File.separator + "vtunpass");
    out.write(SystemIds.tunnelPassword());
    out.flush();
    out.close();
  }
 catch (  Throwable ex) {
    LOG.error(ex,ex);
    ClusterBuilder.removeKeyDirectory(config);
    throw new ServiceRegistrationException("Failed to write cluster credentials to disk: " + config,ex);
  }
 finally {
    if (out != null)     try {
      out.close();
    }
 catch (    IOException e) {
      LOG.error(e,e);
    }
  }
}
