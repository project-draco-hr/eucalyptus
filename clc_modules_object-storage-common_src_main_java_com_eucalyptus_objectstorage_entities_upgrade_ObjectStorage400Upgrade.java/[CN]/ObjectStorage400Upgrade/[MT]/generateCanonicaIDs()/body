{
  EntityTransaction tran=Entities.get(AccountEntity.class);
  try {
    List<AccountEntity> accounts=Entities.query(new AccountEntity());
    if (accounts != null && accounts.size() > 0) {
      for (      AccountEntity account : accounts) {
        if (account.getCanonicalId() == null || account.getCanonicalId().equals("")) {
          account.populateCanonicalId();
          LOG.debug("Assigning canonical id " + account.getCanonicalId() + " for account "+ account.getAccountNumber());
        }
      }
    }
    tran.commit();
  }
 catch (  Exception e) {
    LOG.error("Failed to generate and assign canonical ids",e);
    tran.rollback();
    throw e;
  }
 finally {
    if (tran.isActive()) {
      tran.commit();
    }
  }
}
