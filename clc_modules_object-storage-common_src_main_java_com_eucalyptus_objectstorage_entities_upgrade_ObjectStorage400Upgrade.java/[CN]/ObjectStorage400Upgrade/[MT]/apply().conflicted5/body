{
  EntityTransaction walrusImageTran=Entities.get(ImageCacheInfo.class);
  try {
    List<ImageCacheInfo> images=Entities.query(new ImageCacheInfo());
    if (images != null && !images.isEmpty()) {
      EntityTransaction osgObjectTran=Entities.get(ObjectEntity.class);
      EntityTransaction walrusObjectTran=Entities.get(ObjectInfo.class);
      try {
        for (        ImageCacheInfo image : images) {
          Entities.persist(imageToOSGObjectTransformation().apply(image));
          Entities.persist(imageToWalrusObjectTransformation().apply(image));
          Entities.delete(image);
        }
        osgObjectTran.commit();
        walrusObjectTran.commit();
      }
 catch (      Exception e) {
        osgObjectTran.rollback();
        walrusObjectTran.rollback();
        throw e;
      }
 finally {
        if (osgObjectTran.isActive()) {
          osgObjectTran.commit();
        }
        if (walrusObjectTran.isActive()) {
          walrusObjectTran.commit();
        }
      }
    }
 else {
    }
    walrusImageTran.commit();
  }
 catch (  Exception e) {
    walrusImageTran.rollback();
    LOG.warn("Cannot flush cached images in Walrus due to an error. May have to be flushed manually");
  }
 finally {
    if (walrusImageTran.isActive()) {
      walrusImageTran.commit();
    }
  }
}
