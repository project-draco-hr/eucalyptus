{
  LOG.info("Updating alarm " + alarmEntity.getAlarmName() + " from "+ alarmEntity.getStateValue()+ " to "+ newState.getStateValue());
  alarmEntity.setStateUpdatedTimestamp(now);
  JSONObject historyDataJSON=new JSONObject();
  historyDataJSON.element("version","1.0");
  historyDataJSON.element("oldState",getJSONObjectFromState(alarmEntity.getStateValue(),alarmEntity.getStateReason(),alarmEntity.getStateReasonData()));
  historyDataJSON.element("newState",getJSONObjectFromState(newState.getStateValue(),newState.getStateReason(),newState.getStateReasonData()));
  String historyData=historyDataJSON.toString();
  AlarmManager.addAlarmHistoryItem(alarmEntity.getAccountId(),alarmEntity.getAlarmName(),historyData,HistoryItemType.StateUpdate," Alarm updated from " + alarmEntity.getStateValue() + " to "+ newState.getStateValue(),now);
  alarmEntity.setStateReason(newState.getStateReason());
  alarmEntity.setStateReasonData(newState.getStateReasonData());
  alarmEntity.setStateValue(newState.getStateValue());
  alarmEntity.setStateUpdatedTimestamp(now);
}
