{
  AddUserResponseType reply=request.getReply();
  reply.set_return(false);
  String userName=request.getUserName();
  String email=request.getEmail();
  String certCode=Hashes.getDigestBase64(userName,Hashes.Digest.SHA512,true).replaceAll("\\p{Punct}","");
  String confirmCode=Hashes.getDigestBase64(userName,Hashes.Digest.SHA512,true).replaceAll("\\p{Punct}","");
  String oneTimePass=Hashes.getDigestBase64(userName,Hashes.Digest.MD2,true).replaceAll("\\p{Punct}","");
  boolean admin=request.getAdmin();
  try {
    User u=null;
    if (email == null) {
      u=CredentialProvider.addUser(userName,admin);
    }
 else {
      u=CredentialProvider.addDisabledUser(userName,admin);
    }
    EntityWrapper<UserInfo> db=new EntityWrapper<UserInfo>();
    try {
      UserInfo newUser=null;
      if (email == null) {
        newUser=new UserInfo(userName,admin,confirmCode,certCode,oneTimePass);
      }
 else {
        newUser=new UserInfo(userName,email,admin,confirmCode,certCode,oneTimePass);
        u.setIsEnabled(false);
      }
      db.add(newUser);
      db.commit();
      reply.set_return(true);
    }
 catch (    Throwable t) {
      db.rollback();
      try {
        CredentialProvider.deleteUser(userName);
      }
 catch (      NoSuchUserException e) {
      }
      throw new EucalyptusCloudException("Error creating user: " + userName + ": "+ t.getMessage());
    }
  }
 catch (  UserExistsException e1) {
    throw new EucalyptusCloudException("User already exists: " + userName);
  }
  return reply;
}
