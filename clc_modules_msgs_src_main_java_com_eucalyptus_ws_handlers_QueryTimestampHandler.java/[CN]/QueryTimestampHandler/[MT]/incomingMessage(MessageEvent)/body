{
  if (event.getMessage() instanceof MappingHttpRequest) {
    MappingHttpRequest httpRequest=(MappingHttpRequest)event.getMessage();
    Map<String,String> parameters=httpRequest.getParameters();
    if (!parameters.containsKey(SecurityParameter.Timestamp.toString()) && !parameters.containsKey(SecurityParameter.Expires.toString())) {
      throw new AuthenticationException("One of the following parameters must be specified: " + SecurityParameter.Timestamp + " OR "+ SecurityParameter.Expires);
    }
    Calendar now=null;
    Calendar expires=null;
    String timestamp=null;
    String exp=null;
    try {
      now=Calendar.getInstance();
      expires=null;
      if (parameters.containsKey(SecurityParameter.Timestamp.toString())) {
        timestamp=parameters.remove(SecurityParameter.Timestamp.toString());
        try {
          expires=Timestamps.parseTimestamp(timestamp);
        }
 catch (        Exception e) {
          expires=Timestamps.parseTimestamp(URLDecoder.decode(timestamp));
        }
        now.add(Calendar.SECOND,StackConfiguration.CLOCK_SKEW_SEC);
        if (now.before(expires)) {
          throw new AuthenticationException("Message was generated in the future (times in UTC): Timestamp=" + timestamp);
        }
        expires.add(Calendar.SECOND,900 + StackConfiguration.CLOCK_SKEW_SEC);
      }
 else {
        exp=parameters.remove(SecurityParameter.Expires.toString());
        try {
          expires=Timestamps.parseTimestamp(exp);
        }
 catch (        Exception e) {
          expires=Timestamps.parseTimestamp(URLDecoder.decode(exp));
        }
        Calendar cacheExpire=(Calendar)now.clone();
        cacheExpire.add(Calendar.MINUTE,15);
        if (expires.after(cacheExpire))         LOG.warn("[security] Message expiration date " + expires + " is further in the future that replay cache expiration");
      }
    }
 catch (    Exception t) {
      LOG.debug(t,t);
      throw new AuthenticationException("Failure to parse timestamp: Timestamp=" + timestamp + " Expires="+ exp);
    }
    if (now.after(expires)) {
      expires.setTimeZone(TimeZone.getTimeZone("GMT"));
      String expiryTime=String.format("%4d-%02d-%02d'T'%02d:%02d:%02d",expires.get(Calendar.YEAR),expires.get(Calendar.MONTH) + 1,expires.get(Calendar.DAY_OF_MONTH) + 1,expires.get(Calendar.HOUR_OF_DAY),expires.get(Calendar.MINUTE),expires.get(Calendar.SECOND));
      throw new AuthenticationException("Message has expired (times in UTC): Timestamp=" + timestamp + " Expires="+ exp+ " Deadline="+ expiryTime);
    }
  }
}
