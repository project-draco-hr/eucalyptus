{
  Cache<PrincipalCacheKey,UserPrincipal> cache;
  final Pair<String,Cache<PrincipalCacheKey,UserPrincipal>> cachePair=cacheReference.get();
  final String cacheSpec=AuthenticationProperties.AUTHORIZATION_CACHE;
  if (cachePair == null || !cacheSpec.equals(cachePair.getLeft())) {
    final Pair<String,Cache<PrincipalCacheKey,UserPrincipal>> newCachePair=Pair.pair(cacheSpec,cache(cacheSpec));
    if (cacheReference.compareAndSet(cachePair,newCachePair) || cachePair == null) {
      cache=newCachePair.getRight();
    }
 else {
      cache=cachePair.getRight();
    }
  }
 else {
    cache=cachePair.getRight();
  }
  return cache;
}
