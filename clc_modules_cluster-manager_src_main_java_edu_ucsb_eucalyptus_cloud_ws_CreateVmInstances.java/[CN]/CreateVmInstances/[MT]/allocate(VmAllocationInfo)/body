{
  String reservationId=VmInstances.getId(vmAllocInfo.getReservationIndex(),0).replaceAll("i-","r-");
  int vmIndex=1;
  for (  ResourceToken token : vmAllocInfo.getAllocationTokens()) {
    for (    Integer networkIndex : token.getPrimaryNetwork().getIndexes()) {
      VmInstance vmInst=getVmInstance(vmAllocInfo,reservationId,token,vmIndex++,networkIndex);
      VmInstances.getInstance().register(vmInst);
      token.getInstanceIds().add(vmInst.getInstanceId());
    }
  }
  vmAllocInfo.setReservationId(reservationId);
  return vmAllocInfo;
}
