{
synchronized (EntityWrapper.class) {
    if (!emf.containsKey(persistenceContext)) {
      for (      PoolConfig p : PoolConfig.values()) {
        LOG.debug("-> db pool property: " + LogUtil.lineObject(p));
      }
      EntityManagerFactoryImpl createEntityManagerFactory=(EntityManagerFactoryImpl)Persistence.createEntityManagerFactory(persistenceContext);
      emf.put(persistenceContext,createEntityManagerFactory);
      LOG.info("-> Setting up persistence context for : " + persistenceContext);
      LOG.info("-> database host: " + System.getProperty("euca.db.host"));
      LOG.info("-> database port: " + System.getProperty("euca.db.port"));
      for (      PooledDataSource ds : (Set<PooledDataSource>)C3P0Registry.getPooledDataSources()) {
        if (pools.containsValue(persistenceContext))         break;
        if (!pools.containsKey(ds.getDataSourceName())) {
          pools.put(ds.getDataSourceName(),persistenceContext);
        }
      }
    }
    return emf.get(persistenceContext);
  }
}
