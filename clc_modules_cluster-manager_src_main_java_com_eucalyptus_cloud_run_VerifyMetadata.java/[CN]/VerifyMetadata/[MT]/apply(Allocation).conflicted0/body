{
  Context ctx=allocInfo.getContext();
  User user=ctx.getUser();
  String instanceType=allocInfo.getRequest().getInstanceType();
  String action=PolicySpec.requestToAction(allocInfo.getRequest());
  try {
    if (!ctx.hasAdministrativePrivileges() && !Permissions.isAuthorized(PolicySpec.VENDOR_EC2,PolicySpec.EC2_RESOURCE_VMTYPE,instanceType,user.getAccount(),action,user)) {
      throw new IllegalMetadataAccessException("Not authorized to allocate vm type " + instanceType + " for "+ ctx.getUserFullName());
    }
  }
 catch (  AuthException ex) {
    LOG.error(ex,ex);
    throw new IllegalMetadataAccessException("Not authorized to allocate vm type " + instanceType + " for "+ ctx.getUserFullName());
  }
  allocInfo.setVmType(VmTypes.getVmType(instanceType));
  return true;
}
