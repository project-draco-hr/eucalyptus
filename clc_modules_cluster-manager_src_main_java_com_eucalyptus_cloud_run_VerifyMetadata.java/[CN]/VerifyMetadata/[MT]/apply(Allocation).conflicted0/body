{
  if (allocInfo.getRequest().getKeyName() == null || "".equals(allocInfo.getRequest().getKeyName())) {
    if (Image.Platform.windows.name().equals(allocInfo.getBootSet().getMachine().getPlatform())) {
      throw new InvalidMetadataException("You must specify a keypair when running a windows vm: " + allocInfo.getRequest().getImageId());
    }
 else {
      allocInfo.setSshKeyPair(KeyPairs.noKey());
      return true;
    }
  }
  Context ctx=allocInfo.getContext();
  RunInstancesType request=allocInfo.getRequest();
  String keyName=request.getKeyName();
  if (!ctx.hasAdministrativePrivileges() && !Permissions.isAuthorized(PolicySpec.VENDOR_EC2,PolicySpec.EC2_RESOURCE_KEYPAIR,keyName,ctx.getAccount(),PolicySpec.requestToAction(request),ctx.getUser())) {
    throw new IllegalMetadataAccessException("Not authorized to use keypair " + keyName + " by "+ ctx.getUser().getName());
  }
  allocInfo.setSshKeyPair(KeyPairs.lookup(ctx.getUserFullName(),keyName));
  return true;
}
