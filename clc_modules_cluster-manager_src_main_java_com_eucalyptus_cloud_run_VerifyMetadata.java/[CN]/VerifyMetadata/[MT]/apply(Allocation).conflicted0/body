{
  if (allocInfo.getRequest().getKeyName() == null || "".equals(allocInfo.getRequest().getKeyName())) {
    if (ImageMetadata.Platform.windows.equals(allocInfo.getBootSet().getMachine().getPlatform())) {
      throw new InvalidMetadataException("You must specify a keypair when running a windows vm: " + allocInfo.getRequest().getImageId());
    }
 else {
      allocInfo.setSshKeyPair(KeyPairs.noKey());
      return true;
    }
  }
  Context ctx=allocInfo.getContext();
  RunInstancesType request=allocInfo.getRequest();
  String keyName=request.getKeyName();
  SshKeyPair key=KeyPairs.lookup(ctx.getUserFullName().asAccountFullName(),keyName);
  if (!ctx.hasAdministrativePrivileges() && !RestrictedTypes.filterPrivileged().apply(key)) {
    throw new IllegalMetadataAccessException("Not authorized to use keypair " + keyName + " by "+ ctx.getUser().getName());
  }
  allocInfo.setSshKeyPair(key);
  return true;
}
