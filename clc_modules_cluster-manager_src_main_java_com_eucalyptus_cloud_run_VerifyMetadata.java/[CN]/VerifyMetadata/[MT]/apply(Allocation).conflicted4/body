{
  Context ctx=allocInfo.getContext();
  NetworkGroups.lookup(ctx.getUserFullName(),NetworkGroups.defaultNetworkName());
  Set<String> networkNames=Sets.newHashSet(allocInfo.getRequest().getGroupSet());
  if (networkNames.isEmpty()) {
    networkNames.add(NetworkGroups.defaultNetworkName());
  }
  for (  String groupName : networkNames) {
    if (!ctx.hasAdministrativePrivileges() && !Permissions.isAuthorized(PolicySpec.VENDOR_EC2,PolicySpec.EC2_RESOURCE_SECURITYGROUP,groupName,ctx.getAccount(),PolicySpec.requestToAction(allocInfo.getRequest()),ctx.getUser())) {
      throw new IllegalMetadataAccessException("Not authorized to use network group " + groupName + " for "+ ctx.getUser().getName());
    }
  }
  Map<String,NetworkGroup> networkRuleGroups=Maps.newHashMap();
  for (  String groupName : networkNames) {
    NetworkGroup group=NetworkGroups.lookup(ctx.getUserFullName(),groupName);
    networkRuleGroups.put(groupName,group);
  }
  Set<String> missingNets=Sets.difference(networkNames,networkRuleGroups.keySet());
  if (!missingNets.isEmpty()) {
    throw new NoSuchMetadataException("Failed to find security group info for: " + missingNets);
  }
 else {
    allocInfo.setNetworkRules(networkRuleGroups);
  }
  return true;
}
