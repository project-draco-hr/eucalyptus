{
  EntityWrapper<UserInfo> db=new EntityWrapper<UserInfo>();
  UserInfo user=null;
  try {
    user=db.getUnique(new UserInfo(vmAllocInfo.getRequest().getUserId()));
  }
 catch (  EucalyptusCloudException e) {
    db.rollback();
    throw new EucalyptusInvalidRequestException("Invalid user information",e);
  }
  if (SSHKeyPair.NO_KEY_NAME.equals(vmAllocInfo.getRequest().getKeyName()) || vmAllocInfo.getRequest().getKeyName() == null) {
    vmAllocInfo.setKeyInfo(new VmKeyInfo());
    return vmAllocInfo;
  }
  SSHKeyPair keypair=null;
  for (  SSHKeyPair k : user.getKeyPairs())   if (k.getName().equals(vmAllocInfo.getRequest().getKeyName()))   keypair=k;
  if (keypair == null) {
    db.rollback();
    throw new EucalyptusInvalidRequestException("Failed to find keypair: " + vmAllocInfo.getRequest().getKeyName());
  }
  vmAllocInfo.setKeyInfo(new VmKeyInfo(keypair.getName(),keypair.getPublicKey(),keypair.getFingerPrint()));
  db.commit();
  return vmAllocInfo;
}
