{
  SetRESTObjectAccessControlPolicyResponseType reply=(SetRESTObjectAccessControlPolicyResponseType)request.getReply();
  Context ctx=Contexts.lookup();
  Account account=ctx.getAccount();
  AccessControlPolicy accessControlPolicy=request.getAccessControlPolicy();
  if (accessControlPolicy == null) {
    throw new AccessDeniedException("Key",request.getKey());
  }
  AccessControlList accessControlList=accessControlPolicy.getAccessControlList();
  fixCanonicalIds(accessControlList,false,request.getKey());
  String bucketName=request.getBucket();
  String objectKey=request.getKey();
  EntityWrapper<BucketInfo> db=EntityWrapper.get(BucketInfo.class);
  BucketInfo bucketInfo=new BucketInfo(bucketName);
  List<BucketInfo> bucketList=db.queryEscape(bucketInfo);
  if (bucketList.size() > 0) {
    BucketInfo bucket=bucketList.get(0);
    BucketLogData logData=bucket.getLoggingEnabled() ? request.getLogData() : null;
    EntityWrapper<ObjectInfo> dbObject=db.recast(ObjectInfo.class);
    ObjectInfo searchObjectInfo=new ObjectInfo(bucketName,objectKey);
    searchObjectInfo.setVersionId(request.getVersionId());
    if (request.getVersionId() == null) {
      searchObjectInfo.setLast(true);
    }
    searchObjectInfo.setDeleted(false);
    List<ObjectInfo> objectInfos=dbObject.queryEscape(searchObjectInfo);
    if (objectInfos.size() > 0) {
      ObjectInfo objectInfo=objectInfos.get(0);
      if (!ctx.hasAdministrativePrivileges() && !(objectInfo.canWriteACP(account.getAccountNumber()) && (objectInfo.isGlobalWriteACP() || Lookups.checkPrivilege(PolicySpec.S3_PUTOBJECTACL,PolicySpec.VENDOR_S3,PolicySpec.S3_RESOURCE_OBJECT,PolicySpec.objectFullName(bucketName,objectKey),null)))) {
        db.rollback();
        throw new AccessDeniedException("Key",objectKey,logData);
      }
      String invalidValue=this.findInvalidGrant(accessControlList.getGrants());
      if (invalidValue != null) {
        db.rollback();
        throw new WalrusException("InvalidArgument","Invalid canned-acl or grant list permission: " + invalidValue,"Key",objectKey,HttpResponseStatus.BAD_REQUEST);
      }
      List<GrantInfo> grantInfos=new ArrayList<GrantInfo>();
      objectInfo.resetGlobalGrants();
      objectInfo.addGrants(objectInfo.getOwnerId(),bucket.getOwnerId(),grantInfos,accessControlList);
      objectInfo.setGrants(grantInfos);
      if (WalrusProperties.enableTorrents) {
        if (!objectInfo.isGlobalRead()) {
          EntityWrapper<TorrentInfo> dbTorrent=db.recast(TorrentInfo.class);
          TorrentInfo torrentInfo=new TorrentInfo(bucketName,objectKey);
          List<TorrentInfo> torrentInfos=dbTorrent.queryEscape(torrentInfo);
          if (torrentInfos.size() > 0) {
            TorrentInfo foundTorrentInfo=torrentInfos.get(0);
            TorrentClient torrentClient=Torrents.getClient(bucketName + objectKey);
            if (torrentClient != null) {
              torrentClient.bye();
            }
            dbTorrent.delete(foundTorrentInfo);
          }
        }
      }
 else {
        LOG.warn("Bittorrent support has been disabled. Please check pre-requisites");
      }
      if (logData != null) {
        updateLogData(bucket,logData);
        logData.setObjectSize(objectInfo.getSize());
        reply.setLogData(logData);
      }
      reply.setCode("204");
      reply.setDescription("OK");
    }
 else {
      db.rollback();
      throw new NoSuchEntityException(objectKey,logData);
    }
  }
 else {
    db.rollback();
    throw new NoSuchBucketException(bucketName);
  }
  db.commit();
  return reply;
}
