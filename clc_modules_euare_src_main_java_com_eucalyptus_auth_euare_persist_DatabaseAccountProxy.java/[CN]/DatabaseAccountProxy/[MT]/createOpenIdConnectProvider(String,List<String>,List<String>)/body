{
  Debugging.logError(LOG,null,"in Database layer: createOpenIdConnectProvider()");
  final OIDCIssuerIdentifier issuerIdentifier;
  final String issuerUrl;
  try {
    issuerIdentifier=OIDCUtils.parseIssuerIdentifier(url);
    issuerUrl=issuerIdentifier.getHost() + issuerIdentifier.getPath();
    if (issuerUrl.length() > 255) {
      throw new AuthException(AuthException.INVALID_OPENID_PROVIDER_URL);
    }
  }
 catch (  final IllegalArgumentException e) {
    throw new AuthException(AuthException.INVALID_OPENID_PROVIDER_URL);
  }
  try {
    lookupOpenIdConnectProvider(issuerUrl);
    throw new AuthException(AuthException.OPENID_PROVIDER_ALREADY_EXISTS);
  }
 catch (  final AuthException ex) {
    if (!AuthException.OPENID_PROVIDER_NO_SUCH_ENTITY.equals(ex.getMessage())) {
      throw ex;
    }
  }
  try (final TransactionResource db=Entities.transactionFor(AccountEntity.class)){
    final AccountEntity account=DatabaseAuthUtils.getUnique(AccountEntity.class,AccountEntity_.name,this.delegate.getName());
    final OpenIdProviderEntity newOpenIdProvider=OpenIdProviderEntity.create(account,issuerIdentifier.getHost(),issuerIdentifier.getPort(),issuerIdentifier.getPath());
    newOpenIdProvider.getClientIDs().addAll(clientIDList);
    newOpenIdProvider.getThumbprints().addAll(thumbprintList);
    final OpenIdProviderEntity persistedOpenIdProvider=Entities.persist(newOpenIdProvider);
    db.commit();
    return new DatabaseOpenIdProviderProxy(persistedOpenIdProvider);
  }
 catch (  Exception e) {
    Debugging.logError(LOG,e,"Failed to add openid connect provider: " + url + " in "+ this.delegate.getName());
    throw new AuthException(AuthException.OPENID_PROVIDER_CREATE_FAILURE,e);
  }
}
