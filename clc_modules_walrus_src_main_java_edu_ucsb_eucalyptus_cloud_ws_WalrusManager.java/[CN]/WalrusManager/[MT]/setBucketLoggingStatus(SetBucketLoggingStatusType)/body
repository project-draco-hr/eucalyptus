{
  SetBucketLoggingStatusResponseType reply=(SetBucketLoggingStatusResponseType)request.getReply();
  String bucket=request.getBucket();
  String targetBucket=request.getLoggingEnabled().getTargetBucket();
  String targetPrefix=request.getLoggingEnabled().getTargetPrefix();
  List<Grant> targetGrantsList=null;
  TargetGrants targetGrants=request.getLoggingEnabled().getTargetGrants();
  if (targetGrants != null)   targetGrantsList=targetGrants.getGrants();
  if (targetPrefix == null)   targetPrefix="";
  EntityWrapper<BucketInfo> db=WalrusControl.getEntityWrapper();
  BucketInfo bucketInfo, targetBucketInfo;
  try {
    bucketInfo=db.getUnique(new BucketInfo(bucket));
  }
 catch (  EucalyptusCloudException ex) {
    db.rollback();
    throw new NoSuchBucketException(bucket);
  }
  try {
    targetBucketInfo=db.getUnique(new BucketInfo(targetBucket));
  }
 catch (  EucalyptusCloudException ex) {
    db.rollback();
    throw new NoSuchBucketException(bucket);
  }
  if (!targetBucketInfo.hasLoggingPerms()) {
    db.rollback();
    throw new InvalidTargetBucketForLoggingException(targetBucket);
  }
  bucketInfo.setTargetBucket(targetBucket);
  bucketInfo.setTargetPrefix(targetPrefix);
  bucketInfo.setLoggingEnabled(true);
  if (targetGrantsList != null) {
    targetBucketInfo.addGrants(targetGrantsList);
  }
  db.commit();
  return reply;
}
