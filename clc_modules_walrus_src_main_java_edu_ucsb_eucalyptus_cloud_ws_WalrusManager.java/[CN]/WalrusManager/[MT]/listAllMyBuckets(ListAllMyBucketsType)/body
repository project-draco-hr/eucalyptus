{
  ListAllMyBucketsResponseType reply=(ListAllMyBucketsResponseType)request.getReply();
  String userId=request.getUserId();
  if (userId == null) {
    throw new AccessDeniedException("no such user");
  }
  EntityWrapper<BucketInfo> db=new EntityWrapper<BucketInfo>();
  BucketInfo searchBucket=new BucketInfo();
  searchBucket.setOwnerId(userId);
  searchBucket.setHidden(false);
  List<BucketInfo> bucketInfoList=db.query(searchBucket);
  ArrayList<BucketListEntry> buckets=new ArrayList<BucketListEntry>();
  for (  BucketInfo bucketInfo : bucketInfoList) {
    if (request.isAdministrator()) {
      EntityWrapper<WalrusSnapshotInfo> dbSnap=db.recast(WalrusSnapshotInfo.class);
      WalrusSnapshotInfo walrusSnapInfo=new WalrusSnapshotInfo();
      walrusSnapInfo.setSnapshotBucket(bucketInfo.getBucketName());
      List<WalrusSnapshotInfo> walrusSnaps=dbSnap.query(walrusSnapInfo);
      if (walrusSnaps.size() > 0)       continue;
    }
    buckets.add(new BucketListEntry(bucketInfo.getBucketName(),DateUtils.format(bucketInfo.getCreationDate().getTime(),DateUtils.ISO8601_DATETIME_PATTERN) + ".000Z"));
  }
  try {
    CanonicalUserType owner=new CanonicalUserType(CredentialProvider.getQueryId(userId),userId);
    ListAllMyBucketsList bucketList=new ListAllMyBucketsList();
    reply.setOwner(owner);
    bucketList.setBuckets(buckets);
    reply.setBucketList(bucketList);
  }
 catch (  Exception ex) {
    db.rollback();
    LOG.error(ex);
    throw new AccessDeniedException("User: " + userId + " not found");
  }
  db.commit();
  return reply;
}
