{
  GetBucketLocationResponseType reply=(GetBucketLocationResponseType)request.getReply();
  String bucketName=request.getBucket();
  String userId=request.getUserId();
  EntityWrapper<BucketInfo> db=WalrusControl.getEntityWrapper();
  BucketInfo bucketInfo=new BucketInfo(bucketName);
  List<BucketInfo> bucketList=db.query(bucketInfo);
  if (bucketList.size() > 0) {
    BucketInfo bucket=bucketList.get(0);
    if (bucket.canRead(userId)) {
      BucketLogData logData=bucket.getLoggingEnabled() ? request.getLogData() : null;
      if (logData != null) {
        updateLogData(bucket,logData);
        reply.setLogData(logData);
      }
      String location=bucket.getLocation();
      if (location == null) {
        location="NotSupported";
      }
      reply.setLocationConstraint(location);
    }
 else {
      db.rollback();
      throw new AccessDeniedException("Bucket",bucketName);
    }
  }
 else {
    db.rollback();
    throw new NoSuchBucketException(bucketName);
  }
  db.commit();
  return reply;
}
