{
  GetObjectAccessControlPolicyResponseType reply=(GetObjectAccessControlPolicyResponseType)request.getReply();
  String bucketName=request.getBucket();
  String objectKey=request.getKey();
  Context ctx=Contexts.lookup();
  Account account=ctx.getAccount();
  String ownerId=null;
  EntityWrapper<BucketInfo> db=EntityWrapper.get(BucketInfo.class);
  BucketInfo bucketInfo=new BucketInfo(bucketName);
  List<BucketInfo> bucketList=db.query(bucketInfo);
  BucketLogData logData;
  AccessControlListType accessControlList=new AccessControlListType();
  if (bucketList.size() > 0) {
    BucketInfo bucket=bucketList.get(0);
    logData=bucket.getLoggingEnabled() ? request.getLogData() : null;
    EntityWrapper<ObjectInfo> dbObject=db.recast(ObjectInfo.class);
    ObjectInfo searchObjectInfo=new ObjectInfo(bucketName,objectKey);
    if (bucket.isVersioningEnabled()) {
      if (request.getVersionId() == null)       searchObjectInfo.setLast(true);
    }
    String versionId=request.getVersionId() != null ? request.getVersionId() : WalrusProperties.NULL_VERSION_ID;
    searchObjectInfo.setVersionId(versionId);
    searchObjectInfo.setDeleted(false);
    List<ObjectInfo> objectInfos=dbObject.query(searchObjectInfo);
    if (objectInfos.size() > 0) {
      ObjectInfo objectInfo=objectInfos.get(0);
      if (ctx.hasAdministrativePrivileges() || (objectInfo.canReadACP(account.getAccountNumber()) && Lookups.checkPrivilege(PolicySpec.S3_GETOBJECTACL,PolicySpec.VENDOR_S3,PolicySpec.S3_RESOURCE_OBJECT,PolicySpec.objectFullName(bucketName,objectKey),objectInfo.getOwnerId()))) {
        if (logData != null) {
          updateLogData(bucket,logData);
          logData.setObjectSize(objectInfo.getSize());
          reply.setLogData(logData);
        }
        ownerId=objectInfo.getOwnerId();
        ArrayList<Grant> grants=new ArrayList<Grant>();
        List<GrantInfo> grantInfos=objectInfo.getGrants();
        for (        GrantInfo grantInfo : grantInfos) {
          String uId=grantInfo.getUserId();
          try {
            objectInfo.readPermissions(grants);
            addPermission(grants,Accounts.lookupAccountById(uId),grantInfo);
          }
 catch (          AuthException e) {
            throw new AccessDeniedException("Key",objectKey,logData);
          }
        }
        accessControlList.setGrants(grants);
      }
 else {
        db.rollback();
        throw new AccessDeniedException("Key",objectKey,logData);
      }
    }
 else {
      db.rollback();
      throw new NoSuchEntityException(objectKey,logData);
    }
  }
 else {
    db.rollback();
    throw new NoSuchBucketException(bucketName);
  }
  AccessControlPolicyType accessControlPolicy=new AccessControlPolicyType();
  try {
    Account ownerInfo=Accounts.lookupAccountById(ownerId);
    accessControlPolicy.setOwner(new CanonicalUserType(ownerInfo.getName(),ownerInfo.getAccountNumber()));
    accessControlPolicy.setAccessControlList(accessControlList);
  }
 catch (  AuthException e) {
    throw new AccessDeniedException("Key",objectKey,logData);
  }
  reply.setAccessControlPolicy(accessControlPolicy);
  db.commit();
  return reply;
}
