{
  PutObjectResponseType reply=(PutObjectResponseType)request.getReply();
  String userId=request.getUserId();
  String bucketName=request.getBucket();
  String objectKey=request.getKey();
  Long oldBucketSize=0L;
  String md5="";
  Date lastModified=null;
  AccessControlListType accessControlList=request.getAccessControlList();
  if (accessControlList == null) {
    accessControlList=new AccessControlListType();
  }
  String key=bucketName + "." + objectKey;
  String randomKey=request.getRandomKey();
  WalrusDataMessenger messenger=WalrusRESTBinding.getWriteMessenger();
  EntityWrapper<BucketInfo> db=WalrusControl.getEntityWrapper();
  BucketInfo bucketInfo=new BucketInfo(bucketName);
  List<BucketInfo> bucketList=db.query(bucketInfo);
  if (bucketList.size() > 0) {
    BucketInfo bucket=bucketList.get(0);
    BucketLogData logData=bucket.getLoggingEnabled() ? request.getLogData() : null;
    if (bucket.canWrite(userId)) {
      if (logData != null)       reply.setLogData(logData);
      ObjectInfo foundObject=null;
      EntityWrapper<ObjectInfo> dbObject=db.recast(ObjectInfo.class);
      ObjectInfo searchObject=new ObjectInfo();
      searchObject.setBucketName(bucketName);
      List<ObjectInfo> objectInfos=dbObject.query(searchObject);
      for (      ObjectInfo objectInfo : objectInfos) {
        if (objectInfo.getObjectKey().equals(objectKey)) {
          if (!objectInfo.canWrite(userId)) {
            db.rollback();
            messenger.removeQueue(key,randomKey);
            throw new AccessDeniedException("Key",objectKey,logData);
          }
          foundObject=objectInfo;
          break;
        }
      }
      String objectName;
      if (foundObject == null) {
        foundObject=new ObjectInfo(bucketName,objectKey);
        foundObject.setOwnerId(userId);
        List<GrantInfo> grantInfos=new ArrayList<GrantInfo>();
        foundObject.addGrants(userId,grantInfos,accessControlList);
        foundObject.setGrants(grantInfos);
        objectName=objectKey.replaceAll("/","-") + Hashes.getRandom(4);
        foundObject.setObjectName(objectName);
        foundObject.setSize(0L);
        dbObject.add(foundObject);
      }
 else {
        if (foundObject.canWriteACP(userId)) {
          List<GrantInfo> grantInfos=new ArrayList<GrantInfo>();
          foundObject.addGrants(userId,grantInfos,accessControlList);
          foundObject.setGrants(grantInfos);
        }
        objectName=foundObject.getObjectName();
        if (WalrusProperties.enableTorrents) {
          EntityWrapper<TorrentInfo> dbTorrent=db.recast(TorrentInfo.class);
          TorrentInfo torrentInfo=new TorrentInfo(bucketName,objectKey);
          List<TorrentInfo> torrentInfos=dbTorrent.query(torrentInfo);
          if (torrentInfos.size() > 0) {
            TorrentInfo foundTorrentInfo=torrentInfos.get(0);
            TorrentClient torrentClient=Torrents.getClient(bucketName + objectKey);
            if (torrentClient != null) {
              torrentClient.bye();
            }
            dbTorrent.delete(foundTorrentInfo);
          }
        }
 else {
          LOG.warn("Bittorrent support has been disabled. Please check pre-requisites");
        }
      }
      foundObject.setObjectKey(objectKey);
      foundObject.replaceMetaData(request.getMetaData());
      db.commit();
      LinkedBlockingQueue<WalrusDataMessage> putQueue=messenger.getQueue(key,randomKey);
      try {
        WalrusDataMessage dataMessage;
        String tempObjectName=objectName;
        MessageDigest digest=null;
        long size=0;
        FileIO fileIO=null;
        while ((dataMessage=putQueue.take()) != null) {
          if (WalrusDataMessage.isStart(dataMessage)) {
            tempObjectName=objectName + "." + Hashes.getRandom(12);
            digest=Hashes.Digest.MD5.get();
            try {
              fileIO=storageManager.prepareForWrite(bucketName,tempObjectName);
            }
 catch (            Exception ex) {
              messenger.removeQueue(key,randomKey);
              throw new EucalyptusCloudException(ex);
            }
          }
 else           if (WalrusDataMessage.isEOF(dataMessage)) {
            try {
              if (fileIO != null)               fileIO.finish();
              storageManager.renameObject(bucketName,tempObjectName,objectName);
            }
 catch (            IOException ex) {
              LOG.error(ex);
              messenger.removeQueue(key,randomKey);
              throw new EucalyptusCloudException(objectKey);
            }
            if (digest != null)             md5=Hashes.bytesToHex(digest.digest());
            lastModified=new Date();
            dbObject=WalrusControl.getEntityWrapper();
            objectInfos=dbObject.query(new ObjectInfo(bucketName,objectKey));
            if (objectInfos.size() > 0) {
              foundObject=objectInfos.get(0);
              foundObject.setEtag(md5);
              foundObject.setSize(size);
              foundObject.setLastModified(lastModified);
              foundObject.setStorageClass("STANDARD");
              foundObject.setContentType(request.getContentType());
              foundObject.setContentDisposition(request.getContentDisposition());
              reply.setSize(size);
              if (WalrusProperties.shouldEnforceUsageLimits && !request.isAdministrator()) {
                Long bucketSize=bucket.getBucketSize();
                long newSize=bucketSize + oldBucketSize + size;
                if (newSize > WalrusProperties.MAX_BUCKET_SIZE) {
                  messenger.removeQueue(key,randomKey);
                  dbObject.rollback();
                  throw new EntityTooLargeException("Key",objectKey);
                }
                bucket.setBucketSize(newSize);
              }
              if (WalrusProperties.trackUsageStatistics) {
                walrusStatistics.updateBytesIn(size);
                walrusStatistics.updateSpaceUsed(size);
              }
              if (logData != null) {
                logData.setObjectSize(size);
                updateLogData(bucket,logData);
              }
              dbObject.commit();
              if (logData != null) {
                logData.setTurnAroundTime(Long.parseLong(new String(dataMessage.getPayload())));
              }
            }
 else {
              dbObject.rollback();
              throw new NoSuchEntityException("Could not find object: " + bucketName + "/"+ objectKey,logData);
            }
            WalrusMonitor monitor=messenger.getMonitor(key);
synchronized (monitor) {
              monitor.setLastModified(lastModified);
              monitor.setMd5(md5);
              monitor.notifyAll();
            }
            messenger.removeQueue(key,randomKey);
            messenger.removeMonitor(key);
            LOG.info("Transfer complete: " + key);
            break;
          }
 else           if (WalrusDataMessage.isInterrupted(dataMessage)) {
            WalrusMonitor monitor=messenger.getMonitor(key);
synchronized (monitor) {
              monitor.wait();
              lastModified=monitor.getLastModified();
              md5=monitor.getMd5();
            }
            if (fileIO != null)             fileIO.finish();
            ObjectDeleter objectDeleter=new ObjectDeleter(bucketName,tempObjectName,-1L);
            objectDeleter.start();
            LOG.info("Transfer interrupted: " + key);
            break;
          }
 else {
            assert(WalrusDataMessage.isData(dataMessage));
            byte[] data=dataMessage.getPayload();
            try {
              if (fileIO != null)               fileIO.write(data);
            }
 catch (            IOException ex) {
              LOG.error(ex);
            }
            size+=data.length;
            if (digest != null)             digest.update(data);
          }
        }
      }
 catch (      InterruptedException ex) {
        LOG.error(ex,ex);
        messenger.removeQueue(key,randomKey);
        throw new EucalyptusCloudException("Transfer interrupted: " + key + "."+ randomKey);
      }
    }
 else {
      db.rollback();
      messenger.removeQueue(key,randomKey);
      throw new AccessDeniedException("Bucket",bucketName,logData);
    }
  }
 else {
    db.rollback();
    messenger.removeQueue(key,randomKey);
    throw new NoSuchBucketException(bucketName);
  }
  reply.setEtag(md5);
  reply.setLastModified(DateUtils.format(lastModified.getTime(),DateUtils.ISO8601_DATETIME_PATTERN) + ".000Z");
  return reply;
}
