{
  PutObjectResponseType reply=(PutObjectResponseType)request.getReply();
  String userId=request.getUserId();
  String bucketName=request.getBucket();
  String objectKey=request.getKey();
  Long oldBucketSize=0L;
  String md5="";
  Date lastModified=null;
  AccessControlListType accessControlList=request.getAccessControlList();
  if (accessControlList == null) {
    accessControlList=new AccessControlListType();
  }
  String key=bucketName + "." + objectKey;
  String randomKey=request.getRandomKey();
  WalrusDataMessenger messenger=WalrusRESTBinding.getWriteMessenger();
  EntityWrapper<BucketInfo> db=WalrusControl.getEntityWrapper();
  BucketInfo bucketInfo=new BucketInfo(bucketName);
  List<BucketInfo> bucketList=db.query(bucketInfo);
  if (bucketList.size() > 0) {
    BucketInfo bucket=bucketList.get(0);
    BucketLogData logData=bucket.getLoggingEnabled() ? request.getLogData() : null;
    if (bucket.canWrite(userId)) {
      if (logData != null)       reply.setLogData(logData);
      String objectName;
      String versionId;
      ObjectInfo objectInfo=null;
      if (bucket.isVersioningEnabled()) {
        objectInfo=new ObjectInfo(bucketName,objectKey);
        objectInfo.setOwnerId(userId);
        List<GrantInfo> grantInfos=new ArrayList<GrantInfo>();
        objectInfo.addGrants(userId,grantInfos,accessControlList);
        objectInfo.setGrants(grantInfos);
        objectName=objectKey.replaceAll("/","-") + Hashes.getRandom(4);
        objectInfo.setObjectName(objectName);
        objectInfo.setSize(0L);
        versionId=UUID.randomUUID().toString().replaceAll("-","");
      }
 else {
        versionId=WalrusProperties.NULL_VERSION_ID;
        ObjectInfo searchObject=new ObjectInfo(bucketName,objectKey);
        searchObject.setVersionId(versionId);
        EntityWrapper<ObjectInfo> dbObject=db.recast(ObjectInfo.class);
        try {
          ObjectInfo foundObject=dbObject.getUnique(searchObject);
          if (!foundObject.canWrite(userId)) {
            db.rollback();
            messenger.removeQueue(key,randomKey);
            throw new AccessDeniedException("Key",objectKey,logData);
          }
          objectName=foundObject.getObjectName();
        }
 catch (        EucalyptusCloudException ex) {
          objectInfo=new ObjectInfo(bucketName,objectKey);
          objectInfo.setOwnerId(userId);
          List<GrantInfo> grantInfos=new ArrayList<GrantInfo>();
          objectInfo.addGrants(userId,grantInfos,accessControlList);
          objectInfo.setGrants(grantInfos);
          objectName=objectKey.replaceAll("/","-") + Hashes.getRandom(4);
          objectInfo.setObjectName(objectName);
          objectInfo.setSize(0L);
        }
      }
      db.commit();
      WalrusDataQueue<WalrusDataMessage> putQueue=messenger.getQueue(key,randomKey);
      try {
        WalrusDataMessage dataMessage;
        String tempObjectName=objectName;
        MessageDigest digest=null;
        long size=0;
        FileIO fileIO=null;
        while ((dataMessage=putQueue.take()) != null) {
          if (putQueue.getInterrupted()) {
            if (WalrusDataMessage.isEOF(dataMessage)) {
              WalrusMonitor monitor=messenger.getMonitor(key);
              if (monitor.getLastModified() == null) {
synchronized (monitor) {
                  monitor.wait();
                }
              }
              lastModified=monitor.getLastModified();
              md5=monitor.getMd5();
              if (fileIO != null)               fileIO.finish();
              ObjectDeleter objectDeleter=new ObjectDeleter(bucketName,tempObjectName,-1L);
              objectDeleter.start();
              LOG.info("Transfer interrupted: " + key);
              messenger.removeQueue(key,randomKey);
              break;
            }
            continue;
          }
          if (WalrusDataMessage.isStart(dataMessage)) {
            tempObjectName=objectName + "." + Hashes.getRandom(12);
            digest=Hashes.Digest.MD5.get();
            try {
              fileIO=storageManager.prepareForWrite(bucketName,tempObjectName);
            }
 catch (            Exception ex) {
              messenger.removeQueue(key,randomKey);
              throw new EucalyptusCloudException(ex);
            }
          }
 else           if (WalrusDataMessage.isEOF(dataMessage)) {
            try {
              if (fileIO != null)               fileIO.finish();
              storageManager.renameObject(bucketName,tempObjectName,objectName);
            }
 catch (            IOException ex) {
              LOG.error(ex);
              messenger.removeQueue(key,randomKey);
              throw new EucalyptusCloudException(objectKey);
            }
            if (digest != null)             md5=Hashes.bytesToHex(digest.digest());
            lastModified=new Date();
            ObjectInfo searchObject=new ObjectInfo(bucketName,objectKey);
            searchObject.setVersionId(versionId);
            EntityWrapper<ObjectInfo> dbObject=WalrusControl.getEntityWrapper();
            List<ObjectInfo> objectInfos=dbObject.query(new ObjectInfo(bucketName,objectKey));
            for (            ObjectInfo objInfo : objectInfos) {
              objInfo.setLast(false);
            }
            ObjectInfo foundObject;
            try {
              foundObject=dbObject.getUnique(searchObject);
              if (foundObject.canWriteACP(userId)) {
                List<GrantInfo> grantInfos=new ArrayList<GrantInfo>();
                foundObject.addGrants(userId,grantInfos,accessControlList);
                foundObject.setGrants(grantInfos);
              }
            }
 catch (            EucalyptusCloudException ex) {
              if (objectInfo != null) {
                foundObject=objectInfo;
              }
 else {
                db.rollback();
                throw new EucalyptusCloudException("Unable to update object: " + bucketName + "/"+ objectKey);
              }
            }
            foundObject.setVersionId(versionId);
            foundObject.replaceMetaData(request.getMetaData());
            foundObject.setEtag(md5);
            foundObject.setSize(size);
            foundObject.setLastModified(lastModified);
            foundObject.setStorageClass("STANDARD");
            foundObject.setContentType(request.getContentType());
            foundObject.setContentDisposition(request.getContentDisposition());
            foundObject.setLast(true);
            foundObject.setDeleted(false);
            reply.setSize(size);
            if (WalrusProperties.shouldEnforceUsageLimits && !request.isAdministrator()) {
              Long bucketSize=bucket.getBucketSize();
              long newSize=bucketSize + oldBucketSize + size;
              if (newSize > WalrusProperties.MAX_BUCKET_SIZE) {
                messenger.removeQueue(key,randomKey);
                dbObject.rollback();
                throw new EntityTooLargeException("Key",objectKey);
              }
              bucket.setBucketSize(newSize);
            }
            if (WalrusProperties.trackUsageStatistics) {
              walrusStatistics.updateBytesIn(size);
              walrusStatistics.updateSpaceUsed(size);
            }
            if (logData != null) {
              logData.setObjectSize(size);
              updateLogData(bucket,logData);
            }
            if (objectInfo != null)             dbObject.add(foundObject);
            dbObject.commit();
            if (logData != null) {
              logData.setTurnAroundTime(Long.parseLong(new String(dataMessage.getPayload())));
            }
            WalrusMonitor monitor=messenger.getMonitor(key);
synchronized (monitor) {
              monitor.setLastModified(lastModified);
              monitor.setMd5(md5);
              monitor.notifyAll();
            }
            messenger.removeQueue(key,randomKey);
            LOG.info("Transfer complete: " + key);
            break;
          }
 else {
            assert(WalrusDataMessage.isData(dataMessage));
            byte[] data=dataMessage.getPayload();
            try {
              if (fileIO != null)               fileIO.write(data);
            }
 catch (            IOException ex) {
              LOG.error(ex);
            }
            size+=data.length;
            if (digest != null)             digest.update(data);
          }
        }
      }
 catch (      InterruptedException ex) {
        LOG.error(ex,ex);
        messenger.removeQueue(key,randomKey);
        throw new EucalyptusCloudException("Transfer interrupted: " + key + "."+ randomKey);
      }
    }
 else {
      db.rollback();
      messenger.removeQueue(key,randomKey);
      throw new AccessDeniedException("Bucket",bucketName,logData);
    }
  }
 else {
    db.rollback();
    messenger.removeQueue(key,randomKey);
    throw new NoSuchBucketException(bucketName);
  }
  reply.setEtag(md5);
  reply.setLastModified(DateUtils.format(lastModified.getTime(),DateUtils.ISO8601_DATETIME_PATTERN) + ".000Z");
  return reply;
}
