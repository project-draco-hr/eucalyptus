{
  GetObjectExtendedResponseType reply=(GetObjectExtendedResponseType)request.getReply();
  Long byteRangeStart=request.getByteRangeStart();
  if (byteRangeStart == null) {
    byteRangeStart=0L;
  }
  Long byteRangeEnd=request.getByteRangeEnd();
  if (byteRangeEnd == null) {
    byteRangeEnd=-1L;
  }
  Date ifModifiedSince=request.getIfModifiedSince();
  Date ifUnmodifiedSince=request.getIfUnmodifiedSince();
  String ifMatch=request.getIfMatch();
  String ifNoneMatch=request.getIfNoneMatch();
  boolean returnCompleteObjectOnFailure=request.getReturnCompleteObjectOnConditionFailure();
  String bucketName=request.getBucket();
  String objectKey=request.getKey();
  String userId=request.getUserId();
  Status status=new Status();
  EntityWrapper<BucketInfo> db=WalrusControl.getEntityWrapper();
  BucketInfo bucketInfo=new BucketInfo(bucketName);
  List<BucketInfo> bucketList=db.query(bucketInfo);
  if (bucketList.size() > 0) {
    EntityWrapper<ObjectInfo> dbObject=db.recast(ObjectInfo.class);
    ObjectInfo searchObjectInfo=new ObjectInfo(bucketName,objectKey);
    List<ObjectInfo> objectInfos=dbObject.query(searchObjectInfo);
    if (objectInfos.size() > 0) {
      ObjectInfo objectInfo=objectInfos.get(0);
      if (objectInfo.canRead(userId)) {
        String etag=objectInfo.getEtag();
        String objectName=objectInfo.getObjectName();
        if (byteRangeEnd == -1)         byteRangeEnd=objectInfo.getSize();
        if ((byteRangeStart > objectInfo.getSize()) || (byteRangeStart > byteRangeEnd) || (byteRangeEnd > objectInfo.getSize())|| (byteRangeStart < 0 || byteRangeEnd < 0)) {
          throw new InvalidRangeException("Range: " + byteRangeStart + "-"+ byteRangeEnd+ "object: "+ bucketName+ "/"+ objectKey);
        }
        DefaultHttpResponse httpResponse=new DefaultHttpResponse(HttpVersion.HTTP_1_1,HttpResponseStatus.OK);
        if (ifMatch != null) {
          if (!ifMatch.equals(etag) && !returnCompleteObjectOnFailure) {
            db.rollback();
            throw new PreconditionFailedException(objectKey + " etag: " + etag);
          }
        }
        if (ifNoneMatch != null) {
          if (ifNoneMatch.equals(etag) && !returnCompleteObjectOnFailure) {
            db.rollback();
            throw new NotModifiedException(objectKey + " ETag: " + etag);
          }
        }
        Date lastModified=objectInfo.getLastModified();
        if (ifModifiedSince != null) {
          if ((ifModifiedSince.getTime() >= lastModified.getTime()) && !returnCompleteObjectOnFailure) {
            db.rollback();
            throw new NotModifiedException(objectKey + " LastModified: " + lastModified.toString());
          }
        }
        if (ifUnmodifiedSince != null) {
          if ((ifUnmodifiedSince.getTime() < lastModified.getTime()) && !returnCompleteObjectOnFailure) {
            db.rollback();
            throw new PreconditionFailedException(objectKey + " lastModified: " + lastModified.toString());
          }
        }
        if (request.getGetMetaData()) {
          List<MetaDataInfo> metaDataInfos=objectInfo.getMetaData();
          for (          MetaDataInfo metaDataInfo : metaDataInfos) {
            httpResponse.addHeader(WalrusProperties.AMZ_META_HEADER_PREFIX + metaDataInfo.getName(),metaDataInfo.getValue());
          }
        }
        Long size=objectInfo.getSize();
        String contentType=objectInfo.getContentType();
        String contentDisposition=objectInfo.getContentDisposition();
        db.commit();
        if (request.getGetData()) {
          if (WalrusProperties.trackUsageStatistics) {
            walrusStatistics.updateBytesOut(size);
          }
          storageManager.sendObject(request.getChannel(),httpResponse,bucketName,objectName,byteRangeStart,byteRangeEnd,size,etag,DateUtils.format(lastModified.getTime(),DateUtils.ISO8601_DATETIME_PATTERN + ".000Z"),contentType,contentDisposition,request.getIsCompressed());
        }
 else {
          storageManager.sendHeaders(request.getChannel(),httpResponse,size,etag,DateUtils.format(lastModified.getTime(),DateUtils.ISO8601_DATETIME_PATTERN + ".000Z"),contentType,contentDisposition);
        }
        reply.setEtag(etag);
        reply.setLastModified(DateUtils.format(lastModified.getTime(),DateUtils.ISO8601_DATETIME_PATTERN) + ".000Z");
        if (byteRangeEnd > -1) {
          if (byteRangeEnd <= size && ((byteRangeEnd - byteRangeStart) > 0))           reply.setSize(byteRangeEnd - byteRangeStart);
 else           reply.setSize(0L);
        }
 else {
          reply.setSize(size);
        }
        status.setCode(200);
        status.setDescription("OK");
        reply.setContentType("binary/octet-stream");
        reply.setStatus(status);
      }
 else {
        db.rollback();
        throw new AccessDeniedException("Key",objectKey);
      }
    }
 else {
      db.rollback();
      throw new NoSuchEntityException(objectKey);
    }
  }
 else {
    db.rollback();
    throw new NoSuchBucketException(bucketName);
  }
  db.commit();
  return reply;
}
