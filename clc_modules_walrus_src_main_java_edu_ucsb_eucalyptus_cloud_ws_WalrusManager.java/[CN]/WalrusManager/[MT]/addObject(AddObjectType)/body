{
  AddObjectResponseType reply=(AddObjectResponseType)request.getReply();
  String bucketName=request.getBucket();
  String key=request.getKey();
  Context ctx=Contexts.lookup();
  Account account=ctx.getAccount();
  String objectName=request.getObjectName();
  AccessControlListType accessControlList=request.getAccessControlList();
  if (accessControlList == null) {
    accessControlList=new AccessControlListType();
  }
  EntityWrapper<BucketInfo> db=EntityWrapper.get(BucketInfo.class);
  BucketInfo bucketInfo=new BucketInfo(bucketName);
  List<BucketInfo> bucketList=db.queryEscape(bucketInfo);
  if (bucketList.size() > 0) {
    BucketInfo bucket=bucketList.get(0);
    if (ctx.hasAdministrativePrivileges() || (bucket.canWrite(account.getAccountNumber()) && (bucket.isGlobalWrite() || Lookups.checkPrivilege(PolicySpec.S3_PUTOBJECT,PolicySpec.VENDOR_S3,PolicySpec.S3_RESOURCE_BUCKET,bucket.getBucketName(),null)))) {
      EntityWrapper<ObjectInfo> dbObject=db.recast(ObjectInfo.class);
      ObjectInfo searchObjectInfo=new ObjectInfo();
      searchObjectInfo.setBucketName(bucketName);
      List<ObjectInfo> objectInfos=dbObject.queryEscape(searchObjectInfo);
      for (      ObjectInfo objectInfo : objectInfos) {
        if (objectInfo.getObjectKey().equals(key)) {
          db.rollback();
          throw new EucalyptusCloudException("object already exists " + key);
        }
      }
      ObjectInfo objectInfo=new ObjectInfo(bucketName,key);
      objectInfo.setObjectName(objectName);
      List<GrantInfo> grantInfos=new ArrayList<GrantInfo>();
      objectInfo.addGrants(account.getAccountNumber(),bucket.getOwnerId(),grantInfos,accessControlList);
      objectInfo.setGrants(grantInfos);
      dbObject.add(objectInfo);
      objectInfo.setObjectKey(key);
      objectInfo.setOwnerId(account.getAccountNumber());
      objectInfo.setSize(storageManager.getSize(bucketName,objectName));
      objectInfo.setEtag(request.getEtag());
      objectInfo.setLastModified(new Date());
      objectInfo.setStorageClass("STANDARD");
    }
 else {
      db.rollback();
      throw new AccessDeniedException("Bucket",bucketName);
    }
  }
 else {
    db.rollback();
    throw new NoSuchBucketException(bucketName);
  }
  db.commit();
  return reply;
}
