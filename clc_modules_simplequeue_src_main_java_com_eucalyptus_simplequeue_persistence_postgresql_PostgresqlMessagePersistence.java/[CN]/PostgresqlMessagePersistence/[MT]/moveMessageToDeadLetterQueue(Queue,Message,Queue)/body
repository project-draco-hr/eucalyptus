{
  try (TransactionResource db=Entities.transactionFor(MessageEntity.class)){
    List<MessageEntity> messageEntityList=Entities.criteriaQuery(MessageEntity.class).whereEqual(MessageEntity_.accountId,queue.getAccountId()).whereEqual(MessageEntity_.queueName,queue.getQueueName()).whereEqual(MessageEntity_.messageId,message.getMessageId()).list();
    if (messageEntityList != null) {
      for (      MessageEntity messageEntity : messageEntityList) {
        messageEntity.setReceiveCount(messageEntity.getReceiveCount() - 1);
        messageEntity.setLocalReceiveCount(0);
        messageEntity.setAccountId(deadLetterQueue.getAccountId());
        messageEntity.setQueueName(deadLetterQueue.getQueueName());
        messageEntity.setExpiredTimestampSecs(messageEntity.getSentTimestampSecs() + deadLetterQueue.getMessageRetentionPeriod());
      }
    }
    db.commit();
  }
 }
