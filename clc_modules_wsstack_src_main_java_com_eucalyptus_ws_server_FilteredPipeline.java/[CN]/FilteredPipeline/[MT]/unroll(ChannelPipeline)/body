{
  try {
    for (    final UnrollableStage s : this.stages) {
      s.unrollStage(pipeline);
    }
    if (this.msgReceiver != null) {
      pipeline.addLast("service-sink",new ServiceSinkHandler(this.msgReceiver));
    }
 else {
      pipeline.addLast("service-sink",new ServiceSinkHandler());
    }
    if (DebugUtil.TRACE) {
      for (      final Map.Entry<String,ChannelHandler> e : pipeline.toMap().entrySet()) {
        LOG.trace(EventRecord.here(this.getClass(),EventType.PIPELINE_HANDLER,e.getKey(),e.getValue().getClass().getSimpleName()));
      }
    }
  }
 catch (  final Exception e) {
    LOG.error("Error unrolling pipeline: " + this.getPipelineName());
    final ChannelFuture close=pipeline.getChannel().close();
    close.awaitUninterruptibly();
    LOG.error("Forced pipeline to close due to exception: ",e);
  }
}
