{
  try {
    String userProfileSearch=QueryBuilder.get().start(QueryType.user).add(EuareWebBackend.ID,user.getUserId()).query();
    String userKeySearch=QueryBuilder.get().start(QueryType.key).add(EuareWebBackend.USERID,user.getUserId()).query();
    LoginAction action=null;
    if (!authenticateWithLdap(user)) {
      if (Crypto.verifyPassword(user.getName(),user.getPassword()) || Strings.isNullOrEmpty(user.getInfo(User.EMAIL))) {
        action=LoginAction.FIRSTTIME;
      }
 else       if (user.getPasswordExpires() < System.currentTimeMillis()) {
        action=LoginAction.EXPIRATION;
      }
    }
    Account userAccount=user.getAccount();
    return new LoginUserProfile(user.getUserId(),user.getName(),userAccount.getAccountNumber(),userAccount.getName(),userProfileSearch,userKeySearch,action);
  }
 catch (  Exception e) {
    LOG.error("Exception in retrieving user profile",e);
    LOG.debug(e,e);
    throw new EucalyptusServiceException("Failed to retrieve user profile");
  }
}
