{
  try {
    User user=Accounts.lookupUserById(userId);
    EuarePermission.authorizeAddUserCertificate(requestUser,user.getAccount(),user);
    String encodedPem=B64.url.encString(pem);
    for (    Certificate c : user.getCertificates()) {
      if (c.getPem().equals(encodedPem)) {
        if (!c.isRevoked()) {
          throw new EucalyptusServiceException("Trying to upload a duplicate certificate: " + c.getCertificateId());
        }
 else {
          user.removeCertificate(c.getCertificateId());
        }
      }
    }
    X509Certificate x509=X509CertHelper.toCertificate(encodedPem);
    if (x509 == null) {
      throw new EucalyptusServiceException("Invalid certificate content");
    }
    user.addCertificate(x509);
  }
 catch (  EucalyptusServiceException e) {
    LOG.debug(e,e);
    throw e;
  }
catch (  Exception e) {
    LOG.error("Failed to add certificate to user " + userId + ": "+ pem,e);
    LOG.debug(e,e);
    throw new EucalyptusServiceException("Failed to add certificate to user " + userId);
  }
}
