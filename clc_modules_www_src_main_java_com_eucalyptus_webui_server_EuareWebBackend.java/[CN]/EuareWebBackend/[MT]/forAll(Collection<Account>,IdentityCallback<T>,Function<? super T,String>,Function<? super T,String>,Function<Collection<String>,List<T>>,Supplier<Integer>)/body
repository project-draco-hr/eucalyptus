{
  final Map<String,Account> accountsById=idMap(accounts,Accounts.toAccountNumber());
  final List<List<String>> accountIdBatches=useBulkProcessingForAccounts(accounts) ? Arrays.asList(Collections.<String>emptyList()) : idBatch(accounts,Accounts.toAccountNumber());
  for (  final List<String> accountIds : accountIdBatches) {
    final Iterable<T> items=Iterables.filter(DatabaseAuthUtils.extract(toSupplier(listByAccountId,accountIds)),CollectionUtils.propertyPredicate(accountsById.keySet(),toAccountNumber));
    final Map<String,T> itemsById=idMap(items,toIdentifier);
    final List<List<String>> itemsIdBatches=useBulkProcessing(items,countSupplier) ? Arrays.asList(Collections.<String>emptyList()) : idBatch(items,toIdentifier);
    for (    final List<String> itemIds : itemsIdBatches) {
      callback.doWithIdentities(accountsById,itemsById,itemIds);
    }
  }
}
