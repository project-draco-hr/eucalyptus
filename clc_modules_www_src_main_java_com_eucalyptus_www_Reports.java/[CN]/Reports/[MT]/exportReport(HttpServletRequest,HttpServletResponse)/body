{
  try {
    Type reportType=Type.valueOf(Param.type.get());
    try {
      Boolean doFlush=this.doFlush();
      final JRExporter exporter=reportType.setup(req,res,Param.name.get(req));
      ReportCache reportCache=getReportManager(Param.name.get(req),doFlush);
      LOG.info("--> scriptName:" + Param.name.get(req));
      LOG.info("--> start:" + Param.start.get(req));
      LOG.info("--> end:" + Param.end.get(req));
      System.out.println("--> scriptName:" + Param.name.get(req));
      JasperPrint jasperPrint=null;
      if (Param.name.get(req).equals("user_vms")) {
        long start=Long.parseLong(Param.start.get(req));
        long end=Long.parseLong(Param.end.get(req));
        Period period=new Period(0,Long.MAX_VALUE);
        LOG.info("--> period:" + period.toString());
        int criterionId=Integer.parseInt(Param.criterionId.get(req));
        int groupById=Integer.parseInt(Param.groupById.get(req));
        LOG.info("--> criterionId:" + criterionId);
        GroupByCriterion criterion=GroupByCriterion.values()[criterionId + 1];
        LOG.info("--> criterion:" + criterion.toString());
        Units displayUnits=Units.DEFAULT_DISPLAY_UNITS;
        Map<String,String> params=new HashMap<String,String>();
        params.put("criterion",criterion.toString());
        params.put("timeUnit",displayUnits.getTimeUnit().toString());
        params.put("sizeUnit",displayUnits.getSizeUnit().toString());
        params.put("sizeTimeTimeUnit",displayUnits.getSizeTimeTimeUnit().toString());
        params.put("sizeTimeSizeUnit",displayUnits.getSizeTimeSizeUnit().toString());
        InstanceDisplayDb dbInstance=InstanceDisplayDb.getInstance();
        if (groupById == 0) {
          List<InstanceDisplayBean> list=dbInstance.search(period,criterion,displayUnits);
          LOG.info("--> list size:" + list.size());
          JRDataSource dataSource=new JRBeanCollectionDataSource(list);
          File jrxmlFile=new File(SubDirectory.REPORTS.toString() + File.separator + "instance.jrxml");
          LOG.info("--> jrXmlFile:" + jrxmlFile.getAbsolutePath());
          JasperReport report=JasperCompileManager.compileReport(jrxmlFile.getAbsolutePath());
          jasperPrint=JasperFillManager.fillReport(report,params,dataSource);
        }
 else {
          LOG.info("--> groupById:" + criterionId);
          GroupByCriterion groupByCriterion=GroupByCriterion.values()[groupById - 1];
          LOG.info("--> groupBy:" + groupByCriterion);
          params.put("groupByCriterion",groupByCriterion.toString());
          List<InstanceDisplayBean> list=dbInstance.searchGroupBy(period,groupByCriterion,criterion,displayUnits);
          LOG.info("--> list size:" + list.size());
          JRDataSource dataSource=new JRBeanCollectionDataSource(list);
          File jrxmlFile=new File(SubDirectory.REPORTS.toString() + File.separator + "nested_instance.jrxml");
          JasperReport report=JasperCompileManager.compileReport(jrxmlFile.getAbsolutePath());
          jasperPrint=JasperFillManager.fillReport(report,params,dataSource);
        }
      }
 else {
        jasperPrint=reportCache.getJasperPrint(req);
      }
      exporter.setParameter(JRExporterParameter.JASPER_PRINT,jasperPrint);
      exporter.exportReport();
    }
 catch (    Throwable ex) {
      LOG.error(ex,ex);
      res.setContentType("text/plain");
      LOG.error("Could not create the report stream " + ex.getMessage() + " "+ ex.getLocalizedMessage());
      ex.printStackTrace(res.getWriter());
    }
 finally {
      reportType.close(res);
    }
  }
 catch (  NoSuchFieldException e) {
    LOG.debug(e,e);
    this.hasError("Failed to generate report: " + e.getMessage(),res);
  }
catch (  IOException e) {
    LOG.debug(e,e);
    this.hasError("Failed to generate report: " + e.getMessage(),res);
  }
}
