{
  String code=request.getParameter(PARAMETER_CODE);
  String userName=request.getParameter(PARAMETER_USERNAME);
  String keyName=request.getParameter(PARAMETER_KEYNAME);
  String mimetype="application/zip";
  Calendar now=Calendar.getInstance();
  keyName=(keyName == null || "".equals(keyName)) ? "default" : keyName;
  keyName=userName + String.format("-%1$ty%1$tm%1$te%1$tk%1$tM%1$tS",now);
  if (userName == null || "".equals(userName)) {
    hasError("No user name provided",response);
    return;
  }
  if (code == null || "".equals(code)) {
    hasError("Wrong confirmation code",response);
    return;
  }
  User user=null;
  try {
    user=Users.lookupUser(userName);
  }
 catch (  Exception e) {
    hasError("User does not exist",response);
    return;
  }
  if (!user.checkToken().equals(code)) {
    hasError("Confirmation code is invalid",response);
    return;
  }
  response.setContentType(mimetype);
  response.setHeader("Content-Disposition","attachment; filename=\"" + X509Download.NAME_SHORT + "-"+ userName+ "-x509.zip\"");
  LOG.info("pushing out the X509 certificate for user " + userName);
  try {
    byte[] x509zip=getX509Zip(userName,keyName);
    ServletOutputStream op=response.getOutputStream();
    response.setContentLength(x509zip.length);
    op.write(x509zip);
    op.flush();
  }
 catch (  Throwable e) {
    LOG.error(e,e);
  }
}
