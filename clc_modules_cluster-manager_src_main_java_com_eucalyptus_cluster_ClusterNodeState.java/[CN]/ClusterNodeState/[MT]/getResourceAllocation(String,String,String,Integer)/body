{
  VmTypeAvailability vmType=this.typeMap.get(vmTypeName);
  NavigableSet<VmTypeAvailability> sorted=this.sorted();
  LOG.debug("BEFORE ALLOCATE ============================");
  LOG.debug(sorted);
  if (vmType.getAvailable() < quantity)   throw new NotEnoughResourcesAvailable("Not enough resources available: vm resources");
  Set<VmTypeAvailability> tailSet=sorted.tailSet(vmType);
  Set<VmTypeAvailability> headSet=sorted.headSet(vmType);
  LOG.debug("DURING ALLOCATE ============================");
  LOG.debug("TAILSET: " + tailSet);
  LOG.debug("HEADSET: " + headSet);
  for (  VmTypeAvailability v : tailSet)   v.decrement(quantity);
  for (  VmTypeAvailability v : headSet)   v.setAvailable(vmType.getAvailable());
  LOG.debug("AFTER ALLOCATE ============================");
  LOG.debug(sorted);
  ResourceToken token=new ResourceToken(this.clusterName,requestId,userName,quantity,this.virtualTimer++,vmTypeName);
  LOG.info(String.format(EucalyptusProperties.DEBUG_FSTRING,EucalyptusProperties.TokenState.preallocate,token));
  this.pendingTokens.add(token);
  return token;
}
