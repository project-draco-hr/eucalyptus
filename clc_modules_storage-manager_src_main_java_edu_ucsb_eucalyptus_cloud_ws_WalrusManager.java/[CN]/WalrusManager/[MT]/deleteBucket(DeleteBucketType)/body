{
  DeleteBucketResponseType reply=(DeleteBucketResponseType)request.getReply();
  String bucketName=request.getBucket();
  String userId=request.getUserId();
  EntityWrapper<BucketInfo> db=new EntityWrapper<BucketInfo>();
  BucketInfo searchBucket=new BucketInfo(bucketName);
  List<BucketInfo> bucketList=db.query(searchBucket);
  if (bucketList.size() > 0) {
    BucketInfo bucketFound=bucketList.get(0);
    if (bucketFound.canWrite(userId)) {
      EntityWrapper<ObjectInfo> dbObject=db.recast(ObjectInfo.class);
      ObjectInfo searchObject=new ObjectInfo();
      searchObject.setBucketName(bucketName);
      List<ObjectInfo> objectInfos=dbObject.query(searchObject);
      if (objectInfos.size() == 0) {
        EntityWrapper<ImageCacheInfo> dbIC=db.recast(ImageCacheInfo.class);
        ImageCacheInfo searchImageCacheInfo=new ImageCacheInfo();
        searchImageCacheInfo.setBucketName(bucketName);
        List<ImageCacheInfo> foundImageCacheInfos=dbIC.query(searchImageCacheInfo);
        if (foundImageCacheInfos.size() > 0) {
          ImageCacheInfo foundImageCacheInfo=foundImageCacheInfos.get(0);
          walrusImageManager.startImageCacheFlusher(bucketName,foundImageCacheInfo.getManifestName());
        }
        db.delete(bucketFound);
        try {
          storageManager.deleteBucket(bucketName);
        }
 catch (        IOException ex) {
          LOG.error(ex);
        }
        if (WalrusProperties.enableVirtualHosting) {
          RemoveARecordType removeARecordType=new RemoveARecordType();
          removeARecordType.setUserId(userId);
          String zone=WalrusProperties.WALRUS_DOMAIN + ".";
          removeARecordType.setName(bucketName + "." + zone);
          removeARecordType.setZone(zone);
          LOG.info("Removing mapping for " + removeARecordType.getName());
          Messaging.send(DNSProperties.DNS_REF,removeARecordType);
        }
        Status status=new Status();
        status.setCode(204);
        status.setDescription("No Content");
        reply.setStatus(status);
      }
 else {
        db.rollback();
        throw new BucketNotEmptyException(bucketName);
      }
    }
 else {
      db.rollback();
      throw new AccessDeniedException(bucketName);
    }
  }
 else {
    db.rollback();
    throw new NoSuchBucketException(bucketName);
  }
  db.commit();
  return reply;
}
