{
  final DescribeServicesResponseType reply=request.getReply();
  final String typeFilter=request.getByType();
  final String hostFilter=request.getByHost();
  final String partitionFilter=request.getByPartition();
  final String stateFilter=request.getByState();
  final boolean listAll=Boolean.TRUE.equals(request.getListAll());
  for (  Component comp : Components.list()) {
    if (typeFilter == null || (typeFilter != null && !typeFilter.toLowerCase().equals(comp.getComponentId().name()))) {
      if (!listAll && (hostFilter == null || Internets.testLocal(hostFilter))) {
        if (comp.hasLocalService()) {
          final ServiceConfiguration config=comp.getLocalServiceConfiguration();
          if ((partitionFilter == null || partitionFilter.equals(config.getPartition())) && (stateFilter == null || stateFilter.toUpperCase().equals(config.lookupState().toString()))) {
            reply.getServiceStatuses().add(new ServiceStatusType(){
{
                setServiceId(TypeMappers.transform(config,ServiceId.class));
                setLocalEpoch(reply.getBaseEpoch());
                setLocalState(config.lookupStateMachine().getState().toString());
                if (Boolean.TRUE.equals(request.getShowEvents())) {
                  getStatusDetails().addAll(Collections2.transform(config.lookupDetails(),TypeMappers.lookup(ServiceCheckRecord.class,ServiceStatusDetail.class)));
                }
              }
            }
);
          }
        }
      }
 else {
        for (        final ServiceConfiguration config : comp.lookupServiceConfigurations()) {
          if ((partitionFilter == null || partitionFilter.equals(config.getPartition())) && (hostFilter == null || hostFilter.equals(config.getHostName())) && (stateFilter == null || stateFilter.toUpperCase().equals(config.lookupState().toString()))) {
            reply.getServiceStatuses().add(new ServiceStatusType(){
{
                setServiceId(TypeMappers.transform(config,ServiceId.class));
                setLocalEpoch(reply.getBaseEpoch());
                try {
                  setLocalState(config.lookupStateMachine().getState().toString());
                }
 catch (                Exception ex) {
                  setLocalState("n/a: " + ex.getMessage());
                }
                if (Boolean.TRUE.equals(request.getShowEvents())) {
                  getStatusDetails().addAll(Collections2.transform(config.lookupDetails(),TypeMappers.lookup(ServiceCheckRecord.class,ServiceStatusDetail.class)));
                }
              }
            }
);
          }
        }
      }
    }
  }
  return reply;
}
