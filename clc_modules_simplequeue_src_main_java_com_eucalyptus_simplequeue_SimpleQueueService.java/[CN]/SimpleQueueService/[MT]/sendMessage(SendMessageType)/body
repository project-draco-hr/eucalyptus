{
  SendMessageResponseType reply=request.getReply();
  try {
    final Context ctx=Contexts.lookup();
    final String accountId=ctx.getAccountNumber();
    QueueUrlParts queueUrlParts=getQueueUrlParts(request.getQueueUrl());
    if (!queueUrlParts.getAccountId().equals(accountId)) {
      throw new AccessDeniedException("Access to the resource " + request.getQueueUrl() + " is denied.");
    }
    String queueName=queueUrlParts.getQueueName();
    Queue queue=PersistenceFactory.getQueuePersistence().lookupQueue(accountId,queueName);
    if (queue == null) {
      throw new QueueDoesNotExistException("The specified queue does not exist.");
    }
    MessageInfo messageInfo=validateAndGetMessageInfo(queue,accountId,request.getMessageBody(),request.getDelaySeconds(),request.getMessageAttribute());
    PersistenceFactory.getMessagePersistence().sendMessage(queue,messageInfo.getMessage(),messageInfo.getSendAttributes());
    reply.getSendMessageResult().setmD5OfMessageAttributes(messageInfo.getMessage().getmD5OfMessageAttributes());
    reply.getSendMessageResult().setMessageId(messageInfo.getMessage().getMessageId());
    reply.getSendMessageResult().setmD5OfMessageBody(messageInfo.getMessage().getmD5OfBody());
  }
 catch (  Exception ex) {
    handleException(ex);
  }
  return reply;
}
