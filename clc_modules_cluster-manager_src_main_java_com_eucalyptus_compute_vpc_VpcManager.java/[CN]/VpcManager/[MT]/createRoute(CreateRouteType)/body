{
  final CreateRouteResponseType reply=request.getReply();
  final Context ctx=Contexts.lookup();
  final AccountFullName accountFullName=ctx.getUserFullName().asAccountFullName();
  final String gatewayId=Identifier.igw.normalize(request.getGatewayId());
  final String routeTableId=Identifier.rtb.normalize(request.getRouteTableId());
  final String destinationCidr=request.getDestinationCidrBlock();
  final Optional<Cidr> destinationCidrOption=Cidr.parse().apply(destinationCidr);
  if (!destinationCidrOption.isPresent()) {
    throw new ClientComputeException("InvalidParameterValue","Cidr invalid: " + destinationCidr);
  }
  final Supplier<Route> allocator=transactional(new Supplier<Route>(){
    @Override public Route get(){
      try {
        final InternetGateway internetGateway=internetGateways.lookupByName(accountFullName,gatewayId,Functions.<InternetGateway>identity());
        routeTables.updateByExample(RouteTable.exampleWithName(accountFullName,routeTableId),accountFullName,request.getRouteTableId(),new Callback<RouteTable>(){
          @Override public void fire(          final RouteTable routeTable){
            try {
              if (RestrictedTypes.filterPrivileged().apply(routeTable)) {
                final Optional<Route> existingRoute=Iterables.tryFind(routeTable.getRoutes(),CollectionUtils.propertyPredicate(destinationCidr,RouteTables.RouteFilterStringFunctions.DESTINATION_CIDR));
                if (existingRoute.isPresent()) {
                  throw new ClientComputeException("RouteAlreadyExists","Route exists for cidr: " + destinationCidr);
                }
                if (routeTable.getRoutes().size() >= VpcConfiguration.getRoutesPerTable()) {
                  throw new ClientComputeException("RouteLimitExceeded","Route limit exceeded for " + request.getRouteTableId());
                }
                routeTable.getRoutes().add(Route.create(routeTable,Route.RouteOrigin.CreateRoute,destinationCidr,internetGateway));
                routeTable.updateTimeStamps();
              }
            }
 catch (            Exception e) {
              throw Exceptions.toUndeclared(e);
            }
          }
        }
);
        return null;
      }
 catch (      Exception ex) {
        throw new RuntimeException(ex);
      }
    }
  }
);
  try {
    allocator.get();
    invalidate(routeTableId);
  }
 catch (  Exception e) {
    throw handleException(e);
  }
  return reply;
}
