{
  logRequest(request);
  ListPartsResponseType reply=request.getReply();
  String bucketName=request.getBucket();
  String objectKey=request.getKey();
  ObjectEntity objectEntity;
  Bucket bucket;
  try {
    bucket=BucketMetadataManagers.getInstance().lookupExtantBucket(bucketName);
  }
 catch (  NoSuchElementException e) {
    throw new NoSuchBucketException(request.getBucket());
  }
catch (  Exception e) {
    throw new InternalErrorException(e.getMessage());
  }
  try {
    objectEntity=ObjectMetadataManagers.getInstance().lookupUpload(bucket,request.getUploadId());
  }
 catch (  NoSuchElementException e) {
    throw new NoSuchKeyException(request.getBucket() + "/" + request.getKey());
  }
catch (  Exception e) {
    throw new InternalErrorException(e.getMessage());
  }
  if (OsgAuthorizationHandler.getInstance().operationAllowed(request,bucket,objectEntity,0)) {
    int maxParts=1000;
    try {
      if (request.getMaxParts() != null) {
        maxParts=request.getMaxParts();
      }
    }
 catch (    NumberFormatException e) {
      LOG.error("Failed to parse max parts from request properly: " + request.getMaxParts(),e);
      throw new InvalidArgumentException("maxParts");
    }
    try {
      Initiator initiator=new Initiator(objectEntity.getOwnerIamUserId(),objectEntity.getOwnerIamUserDisplayName());
      reply.setInitiator(initiator);
      CanonicalUser owner=new CanonicalUser(objectEntity.getOwnerCanonicalId(),objectEntity.getOwnerDisplayName());
      reply.setOwner(owner);
      reply.setStorageClass(objectEntity.getStorageClass());
      reply.setPartNumberMarker(request.getPartNumberMarker());
      reply.setMaxParts(request.getMaxParts());
      reply.setBucket(bucketName);
      reply.setKey(objectKey);
      reply.setUploadId(request.getUploadId());
    }
 catch (    Exception e) {
      throw new NoSuchUploadException(request.getUploadId());
    }
    try {
      PaginatedResult<PartEntity> result=MpuPartMetadataManagers.getInstance().listPartsForUpload(bucket,objectKey,request.getUploadId(),request.getPartNumberMarker(),maxParts);
      reply.setIsTruncated(result.getIsTruncated());
      if (result.getLastEntry() instanceof PartEntity) {
        reply.setNextPartNumberMarker(((PartEntity)result.getLastEntry()).getPartNumber());
      }
      for (      PartEntity entity : result.getEntityList()) {
        List<Part> replyParts=reply.getParts();
        replyParts.add(entity.toPartListEntry());
      }
    }
 catch (    Exception e) {
      throw new InternalErrorException(e.getMessage());
    }
    return reply;
  }
 else {
    throw new AccessDeniedException(request.getBucket() + "/" + request.getKey());
  }
}
