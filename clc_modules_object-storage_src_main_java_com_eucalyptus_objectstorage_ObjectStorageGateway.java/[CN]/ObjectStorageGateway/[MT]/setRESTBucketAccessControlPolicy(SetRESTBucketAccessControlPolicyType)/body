{
  logRequest(request);
  Bucket bucket=null;
  try {
    bucket=BucketManagers.getInstance().get(request.getBucket(),false,null);
  }
 catch (  NoSuchElementException e) {
    throw new NoSuchBucketException(request.getBucket());
  }
catch (  Exception e) {
    LOG.error("Error getting metadata for object " + request.getBucket() + " "+ request.getKey());
    throw new InternalErrorException(request.getBucket() + "/?acl");
  }
  if (OSGAuthorizationHandler.getInstance().operationAllowed(request,bucket,null,0)) {
    final String bucketOwnerCanonicalId=bucket.getOwnerCanonicalId();
    String aclString=null;
    if (request.getAccessControlPolicy() == null || request.getAccessControlPolicy().getAccessControlList() == null) {
      throw new MalformedACLErrorException(request.getBucket() + "/" + request.getKey()+ "?acl");
    }
 else {
      request.getAccessControlPolicy().setAccessControlList(AclUtils.expandCannedAcl(request.getAccessControlPolicy().getAccessControlList(),bucketOwnerCanonicalId,null));
      if (request.getAccessControlPolicy() == null || request.getAccessControlPolicy().getAccessControlList() == null) {
        LOG.error("Cannot put ACL that does not exist in request");
        throw new InternalErrorException(request.getBucket() + "?acl");
      }
 else {
        if (request.getAccessControlPolicy().getOwner() == null) {
          request.getAccessControlPolicy().setOwner(new CanonicalUser(bucketOwnerCanonicalId,bucket.getOwnerDisplayName()));
        }
      }
      aclString=S3AccessControlledEntity.marshallACPToString(request.getAccessControlPolicy());
      if (Strings.isNullOrEmpty(aclString)) {
        throw new MalformedACLErrorException(request.getBucket() + "?acl");
      }
    }
    try {
      BucketManagers.getInstance().setAcp(bucket,aclString,null);
      SetRESTBucketAccessControlPolicyResponseType reply=(SetRESTBucketAccessControlPolicyResponseType)request.getReply();
      reply.setStatus(HttpResponseStatus.OK);
      reply.setStatusMessage("OK");
      reply.setCorrelationId(request.getCorrelationId());
      return reply;
    }
 catch (    Exception e) {
      LOG.error("Transaction error updating bucket ACL for bucket " + request.getBucket(),e);
      throw new InternalErrorException(request.getBucket() + "?acl");
    }
  }
 else {
    throw new AccessDeniedException(request.getBucket());
  }
}
