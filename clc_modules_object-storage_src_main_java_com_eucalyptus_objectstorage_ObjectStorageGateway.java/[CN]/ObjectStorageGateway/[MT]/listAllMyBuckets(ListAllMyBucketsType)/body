{
  logRequest(request);
  Bucket fakeBucket=new Bucket();
  fakeBucket.setBucketName("*");
  fakeBucket.setOwnerCanonicalId(Contexts.lookup().getAccount().getCanonicalId());
  request.setBucket(fakeBucket.getBucketName());
  if (OsgAuthorizationHandler.getInstance().operationAllowed(request,fakeBucket,null,0)) {
    ListAllMyBucketsResponseType response=request.getReply();
    Account accnt;
    try {
      accnt=Contexts.lookup(request.getCorrelationId()).getAccount();
      if (accnt == null) {
        throw new NoSuchContextException();
      }
    }
 catch (    NoSuchContextException e) {
      LOG.error("Could not retrieve canonicalId for user with userId: " + request.getUserId() + " effectiveUserId: "+ request.getEffectiveUserId());
      throw new AccountProblemException(request.getUserId());
    }
    try {
      List<Bucket> listing=BucketMetadataManagers.getInstance().lookupBucketsByOwner(accnt.getCanonicalId());
      response.setBucketList(generateBucketListing(listing));
      response.setOwner(AclUtils.buildCanonicalUser(accnt));
      return response;
    }
 catch (    Exception e) {
      throw new InternalErrorException("Error getting bucket metadata",e);
    }
  }
 else {
    AccessDeniedException ex=new AccessDeniedException("ListAllMyBuckets");
    ex.setMessage("Insufficient permissions to list buckets. Check with your account administrator");
    ex.setResourceType("Service");
    throw ex;
  }
}
