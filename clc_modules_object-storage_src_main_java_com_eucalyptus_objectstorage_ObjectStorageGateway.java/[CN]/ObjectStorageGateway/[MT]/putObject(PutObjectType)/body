{
  logRequest(request);
  try {
    User requestUser=getRequestUser(request);
    Bucket bucket=BucketMetadataManagers.getInstance().lookupExtantBucket(request.getBucket());
    if (Strings.isNullOrEmpty(request.getContentLength())) {
      throw new MissingContentLengthException(request.getBucket() + "/" + request.getKey());
    }
    long objectSize, newBucketSize;
    try {
      objectSize=Long.parseLong(request.getContentLength());
      newBucketSize=bucket.getBucketSize() + objectSize;
    }
 catch (    Exception e) {
      LOG.error("Could not parse content length into a long: " + request.getContentLength(),e);
      throw new MissingContentLengthException(request.getBucket() + "/" + request.getKey());
    }
    ObjectEntity objectEntity=ObjectEntity.newInitializedForCreate(bucket,request.getKey(),objectSize,requestUser);
    if (!OsgAuthorizationHandler.getInstance().operationAllowed(request,bucket,objectEntity,newBucketSize)) {
      throw new AccessDeniedException(request.getBucket());
    }
    if (request.getExpectHeader()) {
      OSGChannelWriter.writeResponse(Contexts.lookup(request.getCorrelationId()),OSGMessageResponse.Continue);
    }
    AccessControlPolicy acp=getFullAcp(request.getAccessControlList(),requestUser,bucket.getOwnerCanonicalId());
    objectEntity.setAcl(acp);
    final String fullObjectKey=objectEntity.getObjectUuid();
    request.setKey(fullObjectKey);
    objectEntity=OsgObjectFactory.getFactory().createObject(ospClient,objectEntity,request.getData(),requestUser);
    PutObjectResponseType response=request.getReply();
    if (!ObjectStorageProperties.NULL_VERSION_ID.equals(objectEntity.getVersionId())) {
      response.setVersionId(objectEntity.getVersionId());
    }
    response.setEtag(objectEntity.geteTag());
    response.setLastModified(objectEntity.getObjectModifiedTimestamp());
    return response;
  }
 catch (  S3Exception e) {
    LOG.debug("CorrelationId: " + Contexts.lookup().getCorrelationId() + "Responding to client with: ",e);
    throw e;
  }
catch (  Exception e) {
    InternalErrorException ex=new InternalErrorException(request.getKey());
    ex.initCause(e);
    LOG.warn("CorrelationId: " + Contexts.lookup().getCorrelationId() + " Responding to client with 500 InternalError because of:",e);
    throw ex;
  }
}
