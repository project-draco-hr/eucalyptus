{
  if (params == null) {
    params=new Parameter[0];
  }
  URL url=new URL(uri);
  SignatureGenerator signatureGenerator=new SignatureGenerator(method.toString(),url.getHost(),url.getPort(),url.getPath());
  Parameter[] finalParams=new Parameter[params.length + 7];
  System.arraycopy(params,0,finalParams,0,params.length);
  int i=params.length;
  finalParams[i++]=new Parameter("SignatureMethod",SIGNATURE_METHOD);
  finalParams[i++]=new Parameter("SignatureVersion",SIGNATURE_VERSION);
  finalParams[i++]=new Parameter("Version",API_VERSION);
  finalParams[i++]=new Parameter("ClientId",user.getQueryId());
  finalParams[i++]=new Parameter("Expires",new Long((System.currentTimeMillis() / 1000) + EXPIRES_DELAY_SECONDS).toString());
  finalParams[i++]=new Parameter("Nonce",new Long(System.nanoTime()).toString());
  for (  Parameter param : finalParams) {
    if (param != null) {
      signatureGenerator.addParameter(param.getName(),param.getValue());
    }
  }
  String signature=signatureGenerator.getSignature(user.getSecretKey());
  finalParams[i++]=new Parameter("Signature",signature);
  return getNameValuePairs(finalParams);
}
