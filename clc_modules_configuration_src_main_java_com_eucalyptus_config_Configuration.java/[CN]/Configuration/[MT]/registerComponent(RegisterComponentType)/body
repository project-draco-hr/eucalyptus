{
  RegisterComponentResponseType reply=(RegisterComponentResponseType)request.getReply();
  reply.set_return(true);
  boolean isGood;
  try {
    isGood=NetworkUtil.testGoodAddress(request.getHost());
  }
 catch (  Exception e1) {
    throw new EucalyptusCloudException(e1.getMessage(),e1);
  }
  if (!isGood) {
    throw new EucalyptusCloudException("Components cannot be registered using local, link-local, or multicast addresses.");
  }
  if (ConfigurationUtil.checkComponentExists(request)) {
    return reply;
  }
  EntityWrapper<ComponentConfiguration> db=Configuration.getEntityWrapper();
  ComponentConfiguration newComponent;
  try {
    newComponent=ConfigurationUtil.getConfigurationInstance(request,request.getName(),NetworkUtil.tryToResolve(request.getHost()),request.getPort());
    db.add(newComponent);
    db.commit();
  }
 catch (  Exception e) {
    db.rollback();
    LOG.error(e,e);
    throw new EucalyptusCloudException(e);
  }
  if (request instanceof RegisterClusterType) {
    ConfigurationUtil.setupClusterCredentials(newComponent);
  }
  StartComponentEvent e=null;
  if (Component.walrus.equals(newComponent.getComponent()) && (Component.walrus.isLocal() || NetworkUtil.testLocal(newComponent.getHostName()))) {
    e=StartComponentEvent.getLocal(newComponent.getComponent());
  }
 else   if (Component.storage.equals(newComponent.getComponent()) && (Component.storage.isLocal() || NetworkUtil.testLocal(newComponent.getHostName()))) {
    e=StartComponentEvent.getLocal(newComponent.getComponent());
  }
 else {
    e=StartComponentEvent.getRemote(newComponent);
  }
  try {
    ListenerRegistry.getInstance().fireEvent(newComponent.getComponent(),e);
  }
 catch (  EventVetoedException e1) {
    throw new EucalyptusCloudException(e1.getMessage(),e1);
  }
  return reply;
}
