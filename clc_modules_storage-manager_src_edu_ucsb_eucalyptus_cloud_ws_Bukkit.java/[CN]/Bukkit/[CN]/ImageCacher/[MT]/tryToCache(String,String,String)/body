{
  Long unencryptedSize=0L;
  boolean failed=false;
  try {
    LOG.info("Caching image: " + bucketName + "/"+ manifestKey);
    LOG.info("Unzipping image: " + bucketName + "/"+ manifestKey);
    unzipImage(decryptedImageName,tarredImageName);
    LOG.info("Untarring image: " + bucketName + "/"+ manifestKey);
    unencryptedSize=untarImage(tarredImageName,imageName);
    Long oldCacheSize=0L;
    EntityWrapper<ImageCacheInfo> db=new EntityWrapper<ImageCacheInfo>();
    List<ImageCacheInfo> imageCacheInfos=db.query(new ImageCacheInfo());
    for (    ImageCacheInfo imageCacheInfo : imageCacheInfos) {
      if (imageCacheInfo.getInCache()) {
        oldCacheSize+=imageCacheInfo.getSize();
      }
    }
    db.commit();
    if ((oldCacheSize + unencryptedSize) > WalrusProperties.IMAGE_CACHE_SIZE) {
      failed=true;
    }
  }
 catch (  Exception ex) {
    LOG.warn(ex);
    failed=true;
  }
  if (failed) {
    try {
      storageManager.deleteAbsoluteObject(decryptedImageName);
      storageManager.deleteAbsoluteObject(tarredImageName);
    }
 catch (    Exception exception) {
      LOG.error(exception);
    }
    return -1L;
  }
  LOG.info("Cached image: " + bucketName + "/"+ manifestKey+ " size: "+ String.valueOf(unencryptedSize));
  return unencryptedSize;
}
