{
  String decryptedImageName=storageManager.getObjectPath(bucketName,decryptedImageKey);
  String tarredImageName=decryptedImageName.replaceAll("tgz","tar");
  String imageName=tarredImageName.replaceAll(".tar","");
  String imageKey=decryptedImageKey.replaceAll(".tgz","");
  Long unencryptedSize;
  while ((unencryptedSize=tryToCache(decryptedImageName,tarredImageName,imageName)) < 0) {
    EntityWrapper<ImageCacheInfo> db=new EntityWrapper<ImageCacheInfo>();
    List<ImageCacheInfo> imageCacheInfos=db.query(new ImageCacheInfo());
    ImageCacheInfo imageCacheInfo=null;
    if (imageCacheInfos.size() > 1) {
      Collections.sort(imageCacheInfos);
      imageCacheInfo=imageCacheInfos.get(0);
      break;
    }
    db.commit();
    if (imageCacheInfo != null && imageCacheInfo.getInCache()) {
      flushCachedImage(imageCacheInfo.getBucketName(),imageCacheInfo.getManifestName());
    }
  }
  try {
    storageManager.deleteAbsoluteObject(decryptedImageName);
    storageManager.deleteAbsoluteObject(tarredImageName);
    EntityWrapper<ImageCacheInfo> db=new EntityWrapper<ImageCacheInfo>();
    ImageCacheInfo searchImageCacheInfo=new ImageCacheInfo(bucketName,manifestKey);
    List<ImageCacheInfo> foundImageCacheInfos=db.query(searchImageCacheInfo);
    if (foundImageCacheInfos.size() > 0) {
      ImageCacheInfo foundImageCacheInfo=foundImageCacheInfos.get(0);
      foundImageCacheInfo.setImageName(imageKey);
      foundImageCacheInfo.setInCache(true);
      foundImageCacheInfo.setCaching(false);
      foundImageCacheInfo.setSize(unencryptedSize);
      db.commit();
      WalrusMonitor monitor=imageMessenger.getMonitor(bucketName + "/" + manifestKey);
synchronized (monitor) {
        monitor.notifyAll();
      }
      imageMessenger.removeMonitor(bucketName + "/" + manifestKey);
    }
 else {
      db.rollback();
      LOG.warn("Could not expand image" + decryptedImageName);
    }
  }
 catch (  Exception ex) {
    LOG.warn(ex,ex);
  }
}
