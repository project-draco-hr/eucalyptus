{
  String decryptedImageName=storageManager.getObjectPath(bucketName,decryptedImageKey);
  String tarredImageName=decryptedImageName.replaceAll("tgz","tar");
  String imageName=tarredImageName.replaceAll(".tar","");
  String imageKey=decryptedImageKey.replaceAll(".tgz","");
  Long unencryptedSize;
  int numberOfRetries=0;
  while ((unencryptedSize=tryToCache(decryptedImageName,tarredImageName,imageName)) < 0) {
    try {
      Thread.sleep(CACHE_RETRY_TIMEOUT);
    }
 catch (    InterruptedException ex) {
      notifyWaiters();
      return;
    }
    CACHE_RETRY_TIMEOUT=2 * CACHE_RETRY_TIMEOUT;
    if (numberOfRetries++ >= CACHE_RETRY_LIMIT) {
      notifyWaiters();
      return;
    }
    EntityWrapper<ImageCacheInfo> db=new EntityWrapper<ImageCacheInfo>();
    ImageCacheInfo searchImageCacheInfo=new ImageCacheInfo();
    searchImageCacheInfo.setInCache(true);
    List<ImageCacheInfo> imageCacheInfos=db.query(searchImageCacheInfo);
    if (imageCacheInfos.size() == 0) {
      LOG.error("No cached images found to flush. Unable to cache image. Please check the error log and the image cache size.");
      db.rollback();
      notifyWaiters();
      return;
    }
    Collections.sort(imageCacheInfos);
    ImageCacheInfo imageCacheInfo=imageCacheInfos.get(0);
    db.commit();
    try {
      flushCachedImage(imageCacheInfo.getBucketName(),imageCacheInfo.getManifestName());
    }
 catch (    Exception ex) {
      LOG.error(ex);
      LOG.error("Unable to flush previously cached image. Please increase your image cache size");
      notifyWaiters();
    }
  }
  try {
    storageManager.deleteAbsoluteObject(decryptedImageName);
    storageManager.deleteAbsoluteObject(tarredImageName);
    EntityWrapper<ImageCacheInfo> db=new EntityWrapper<ImageCacheInfo>();
    ImageCacheInfo searchImageCacheInfo=new ImageCacheInfo(bucketName,manifestKey);
    List<ImageCacheInfo> foundImageCacheInfos=db.query(searchImageCacheInfo);
    if (foundImageCacheInfos.size() > 0) {
      ImageCacheInfo foundImageCacheInfo=foundImageCacheInfos.get(0);
      foundImageCacheInfo.setImageName(imageKey);
      foundImageCacheInfo.setInCache(true);
      foundImageCacheInfo.setSize(unencryptedSize);
      db.commit();
      notifyWaiters();
    }
 else {
      db.rollback();
      LOG.error("Could not expand image" + decryptedImageName);
    }
  }
 catch (  Exception ex) {
    LOG.error(ex);
  }
}
