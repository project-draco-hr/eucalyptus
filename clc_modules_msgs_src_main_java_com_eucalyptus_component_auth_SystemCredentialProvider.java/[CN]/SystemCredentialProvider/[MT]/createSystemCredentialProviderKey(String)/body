{
  try {
    KeyPair sysKp=Certs.generateKeyPair();
    X509Certificate sysX509=Certs.generateServiceCertificate(sysKp,name);
    if (ComponentIds.lookup(Eucalyptus.class).name().equals(name)) {
      PEMFiles.write(SubDirectory.KEYS.toString() + "/cloud-cert.pem",sysX509);
      PEMFiles.write(SubDirectory.KEYS.toString() + "/cloud-pk.pem",sysKp.getPrivate());
    }
    SystemCredentialProvider.certs.put(name,sysX509);
    SystemCredentialProvider.keypairs.put(name,sysKp);
    EucaKeyStore.getInstance().addKeyPair(name,sysX509,sysKp.getPrivate(),name);
    EucaKeyStore.getInstance().store();
  }
 catch (  Exception e) {
    SystemCredentialProvider.certs.remove(name);
    SystemCredentialProvider.keypairs.remove(name);
    EucaKeyStore.getInstance().remove();
    throw e;
  }
}
