{
  UserEntity newUser=new UserEntity(userName);
  newUser.setQueryId(Hmacs.generateQueryId(userName));
  newUser.setSecretKey(Hmacs.generateSecretKey(userName));
  newUser.setAdministrator(admin);
  newUser.setEnabled(enabled);
  newUser.setPassword(Crypto.generateHashedPassword(userName));
  newUser.setToken(Crypto.generateSessionToken(userName));
  String confirmCode=Crypto.generateSessionToken(userName);
  UserInfo newUserInfo=new UserInfo(userName,confirmCode);
  try {
    EucaLdapHelper.addUser(newUser,newUserInfo);
  }
 catch (  EntryExistsException e) {
    LOG.error(e,e);
    throw new UserExistsException(e);
  }
catch (  LdapException e) {
    LOG.error(e,e);
  }
  User proxy=new LdapWrappedUser(newUser,newUserInfo,null);
  Groups.DEFAULT.addMember(proxy);
  return proxy;
}
