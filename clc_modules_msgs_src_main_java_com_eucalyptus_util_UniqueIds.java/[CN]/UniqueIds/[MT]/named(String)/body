{
  final EntityTransaction db=Entities.get(PersistedCounter.class);
  try {
    final PersistedCounter entity=Entities.uniqueResult(new PersistedCounter(null,counterName));
    db.commit();
    return entity;
  }
 catch (  final Exception ex) {
    db.rollback();
    final EntityTransaction saveDb=Entities.get(PersistedCounter.class);
    try {
      final PersistedCounter entity=Entities.persist(new PersistedCounter(0L,counterName));
      saveDb.commit();
      return entity;
    }
 catch (    final Exception ex1) {
      saveDb.rollback();
      LOG.error(ex1,ex1);
      throw Exceptions.toUndeclared("Failed to initialize counter for: " + counterName + " because of: "+ ex.getMessage(),ex);
    }
  }
}
