{
  Template template=new Template();
  template.setResourceInfoMap(Maps.<String,ResourceInfo>newLinkedHashMap());
  JsonNode templateJsonNode=null;
  try {
    templateJsonNode=objectMapper.readTree(templateBody);
  }
 catch (  IOException ex) {
    throw new ValidationErrorException(ex.getMessage());
  }
  if (!templateJsonNode.isObject()) {
    throw new ValidationErrorException("Template body is not a JSON object");
  }
  template.setTemplateBody(templateBody);
  addPseudoParameters(template,pseudoParameterValues);
  buildResourceMap(template,templateJsonNode);
  parseValidTopLevelKeys(templateJsonNode);
  parseVersion(template,templateJsonNode);
  parseDescription(template,templateJsonNode);
  parseMappings(template,templateJsonNode);
  ParameterParser.parseParameters(template,templateJsonNode,userParameters,true);
  parseConditions(template,templateJsonNode,true);
  parseResources(template,templateJsonNode,true);
  parseOutputs(template,templateJsonNode);
  Set<String> capabilitiesResourceTypes=Sets.newLinkedHashSet();
  Set<String> requiredCapabilities=Sets.newLinkedHashSet();
  for (  ResourceInfo resourceInfo : template.getResourceInfoMap().values()) {
    if (resourceInfo.getRequiredCapabilities() != null && !resourceInfo.getRequiredCapabilities().isEmpty()) {
      requiredCapabilities.addAll(resourceInfo.getRequiredCapabilities());
      capabilitiesResourceTypes.add(resourceInfo.getType());
    }
  }
  ValidateTemplateResult validateTemplateResult=new ValidateTemplateResult();
  validateTemplateResult.setDescription(template.getDescription());
  validateTemplateResult.setCapabilities(new ResourceList());
  validateTemplateResult.getCapabilities().setMember(Lists.newArrayList(requiredCapabilities));
  if (!requiredCapabilities.isEmpty()) {
    validateTemplateResult.setCapabilitiesReason("The following resource(s) require capabilities: " + capabilitiesResourceTypes);
  }
  validateTemplateResult.setParameters(new TemplateParameters());
  validateTemplateResult.getParameters().setMember(template.getTemplateParameters());
  return validateTemplateResult;
}
