{
  Map<String,String> pseudoParameterMap=StackEntityHelper.jsonToPseudoParameterMap(template.getStackEntity().getPseudoParameterMapJson());
  Map<String,StackEntity.Parameter> parameterMap=StackEntityHelper.jsonToParameterMap(template.getStackEntity().getParametersJson());
  if (jsonNode == null) {
    return;
  }
  if (jsonNode.isArray()) {
    for (int i=0; i < jsonNode.size(); i++) {
      resourceDependencyCrawl(resourceKey,jsonNode.get(i),resourceDependencies,template,unresolvedResourceDependencies);
    }
  }
  IntrinsicFunction.MatchResult refMatcher=IntrinsicFunctions.REF.evaluateMatch(jsonNode);
  if (refMatcher.isMatch()) {
    IntrinsicFunctions.REF.validateArgTypesWherePossible(refMatcher);
    String refName=jsonNode.get(FunctionEvaluation.REF_STR).textValue();
    if (template.getResourceInfoMap().containsKey(refName)) {
      resourceDependencies.addDependency(resourceKey,refName);
    }
 else     if (!parameterMap.containsKey(refName) && !pseudoParameterMap.containsKey(refName)) {
      unresolvedResourceDependencies.add(refName);
    }
    return;
  }
  IntrinsicFunction.MatchResult fnAttMatcher=IntrinsicFunctions.GET_ATT.evaluateMatch(jsonNode);
  if (fnAttMatcher.isMatch()) {
    IntrinsicFunctions.GET_ATT.validateArgTypesWherePossible(refMatcher);
    String refName=jsonNode.get(FunctionEvaluation.FN_GET_ATT).get(0).textValue();
    String attName=jsonNode.get(FunctionEvaluation.FN_GET_ATT).get(1).textValue();
    if (template.getResourceInfoMap().containsKey(refName)) {
      ResourceInfo resourceInfo=template.getResourceInfoMap().get(refName);
      if (resourceInfo.canCheckAttributes() && !ResourceAttributeResolver.resourceHasAttribute(resourceInfo,attName)) {
        throw new ValidationErrorException("Template error: resource " + refName + " does not support attribute type "+ attName+ " in Fn::GetAtt");
      }
 else {
        resourceDependencies.addDependency(resourceKey,refName);
      }
    }
 else {
      throw new ValidationErrorException("Template error: instance of Fn::GetAtt references undefined resource " + refName);
    }
    return;
  }
  List<String> fieldNames=Lists.newArrayList(jsonNode.fieldNames());
  for (  String fieldName : fieldNames) {
    resourceDependencyCrawl(resourceKey,jsonNode.get(fieldName),resourceDependencies,template,unresolvedResourceDependencies);
  }
}
