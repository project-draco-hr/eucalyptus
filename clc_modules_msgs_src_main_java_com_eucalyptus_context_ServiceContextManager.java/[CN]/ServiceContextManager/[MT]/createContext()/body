{
  List<ComponentId> components=ComponentIds.listEnabled();
  if (checkStateUnchanged(ComponentIds.listEnabled()) && context.getReference() != null) {
    return context.getReference();
  }
 else {
    LOG.info("The following components have been identified as active: ");
    for (    ComponentId c : components) {
      LOG.info("-> " + c);
    }
    Set<ConfigResource> configs=renderServiceConfigurations(components);
    for (    ConfigResource cfg : configs) {
      LOG.info("-> Rendered cfg: " + cfg.getResourceName());
    }
    try {
      builder=new SpringXmlConfigurationBuilder(configs.toArray(new ConfigResource[]{}));
    }
 catch (    Throwable ex) {
      LOG.fatal("Failed to bootstrap services.",ex);
      throw new ServiceInitializationException("Failed to bootstrap service context because of: " + ex.getMessage(),ex);
    }
    MuleContext muleCtx;
    try {
      muleCtx=contextFactory.createMuleContext(builder);
      last=components;
    }
 catch (    InitialisationException ex) {
      LOG.error(ex,ex);
      throw new ServiceInitializationException("Failed to initialize service context because of: " + ex.getMessage(),ex);
    }
catch (    ConfigurationException ex) {
      LOG.error(ex,ex);
      throw new ServiceInitializationException("Failed to initialize service context because of: " + ex.getMessage(),ex);
    }
    return muleCtx;
  }
}
