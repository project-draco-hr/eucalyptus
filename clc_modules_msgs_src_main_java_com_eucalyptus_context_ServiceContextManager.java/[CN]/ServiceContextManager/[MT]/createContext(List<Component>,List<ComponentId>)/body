{
  this.canHasWrite.lock();
  try {
    Set<ConfigResource> configs=Sets.newHashSet();
    MuleContext muleCtx=null;
    for (    Component component : components) {
      ComponentId id=component.getComponentId();
      String errMsg="Failed to render model for: " + component.getComponentId() + " because of: ";
      LOG.info("-> Rendering configuration for " + component.getComponentId().name());
      try {
        String outString=Templates.prepare(id.getServiceModelFileName()).withProperty("components",Components.toIds(components)).withProperty("thisComponent",id).evaluate(id.getServiceModel());
        ConfigResource configRsc=createConfigResource(component,outString);
        configs.add(configRsc);
      }
 catch (      Exception ex) {
        LOG.error(errMsg + ex.getMessage(),ex);
        throw new ServiceInitializationException(errMsg + ex.getMessage(),ex);
      }
    }
    try {
      SpringXmlConfigurationBuilder builder=new SpringXmlConfigurationBuilder(configs.toArray(new ConfigResource[]{}));
      muleCtx=contextFactory.createMuleContext(builder);
      this.enabledCompIds.clear();
      this.enabledCompIds.addAll(currentComponentIds);
    }
 catch (    Exception ex) {
      LOG.error(ex,ex);
      throw new ServiceInitializationException("Failed to build service context because of: " + ex.getMessage(),ex);
    }
    return muleCtx;
  }
  finally {
    this.canHasWrite.unlock();
  }
}
