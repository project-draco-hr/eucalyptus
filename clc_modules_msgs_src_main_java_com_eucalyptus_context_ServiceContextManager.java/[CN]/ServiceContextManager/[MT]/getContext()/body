{
  boolean[] bit=new boolean[1];
  MuleContext ref=null;
  if ((ref=context.get(bit)) == null && bit[0]) {
    Integer i=0;
    do {
      try {
        TimeUnit.MILLISECONDS.sleep(500);
        i+=500;
        LOG.trace("Waiting for service context to start.");
      }
 catch (      InterruptedException ex) {
        LOG.error(ex,ex);
      }
    }
 while (i < SERVICE_CONTEXT_RELOAD_TIMEOUT && (ref=context.get(bit)) == null && bit[0]);
    if (ref == null) {
      throw new ServiceStateException("Timed-out obtaining reference service context.  Waited for : " + SERVICE_CONTEXT_RELOAD_TIMEOUT + " milliseconds.");
    }
 else {
      return ref;
    }
  }
 else   if (ref == null && !bit[0]) {
    try {
      for (int i=0; (ref=context.getReference()) == null && i < 15; i++) {
        LOG.trace("Waiting for service context to start.");
        TimeUnit.MILLISECONDS.sleep(1000);
      }
      if (ref == null) {
        throw new ServiceStateException("Attempt to reference service context before it is ready.");
      }
 else {
        return ref;
      }
    }
 catch (    InterruptedException ex) {
      LOG.error(ex,ex);
      throw new ServiceStateException("Attempt to reference service context before it is ready.");
    }
  }
 else {
    return ref;
  }
}
