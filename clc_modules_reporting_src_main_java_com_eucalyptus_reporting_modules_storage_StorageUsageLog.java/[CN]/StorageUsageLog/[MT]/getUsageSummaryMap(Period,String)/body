{
  log.info("GetUsageSummaryMap period:" + period);
  final Map<StorageSummaryKey,StorageUsageSummary> usageMap=new HashMap<StorageSummaryKey,StorageUsageSummary>();
  EntityWrapper<StorageUsageSnapshot> entityWrapper=EntityWrapper.get(StorageUsageSnapshot.class);
  try {
    Map<StorageSummaryKey,StorageDataAccumulator> dataAccumulatorMap=new HashMap<StorageSummaryKey,StorageDataAccumulator>();
    Long latestSnapshotBeforeMs=findLatestAllSnapshotBefore(period.getBeginningMs());
    @SuppressWarnings("rawtypes") List list=null;
    if (accountId == null) {
      list=entityWrapper.createQuery("from StorageUsageSnapshot as sus" + " WHERE sus.key.timestampMs > ?" + " AND sus.key.timestampMs < ?"+ " ORDER BY sus.key.timestampMs").setLong(0,(latestSnapshotBeforeMs != null ? latestSnapshotBeforeMs : 0l)).setLong(1,new Long(period.getEndingMs())).list();
    }
 else {
      list=entityWrapper.createQuery("from StorageUsageSnapshot as sus" + " WHERE sus.key.timestampMs > ?" + " AND sus.key.timestampMs < ?"+ " AND sus.key.accountId = ?"+ " ORDER BY sus.key.timestampMs").setLong(0,(latestSnapshotBeforeMs != null ? latestSnapshotBeforeMs : 0l)).setLong(1,new Long(period.getEndingMs())).setString(2,accountId).list();
    }
    for (    Object obj : list) {
      StorageUsageSnapshot snapshot=(StorageUsageSnapshot)obj;
      StorageSnapshotKey snapshotKey=snapshot.getSnapshotKey();
      StorageSummaryKey summaryKey=new StorageSummaryKey(snapshotKey);
      if (snapshotKey.getTimestampMs() < period.getBeginningMs() || !dataAccumulatorMap.containsKey(summaryKey)) {
        StorageDataAccumulator accumulator=new StorageDataAccumulator(snapshotKey.getTimestampMs(),snapshot.getUsageData(),new StorageUsageSummary());
        dataAccumulatorMap.put(summaryKey,accumulator);
      }
 else {
        StorageDataAccumulator accumulator=dataAccumulatorMap.get(summaryKey);
        long beginningMs=Math.max(period.getBeginningMs(),accumulator.getLastTimestamp());
        long endingMs=snapshotKey.getTimestampMs() - 1;
        long durationSecs=(endingMs - beginningMs) / 1000;
        log.info(String.format("Accumulate usage, %d-%d, key:%s",beginningMs,endingMs,summaryKey));
        accumulator.accumulateUsage(durationSecs);
        accumulator.setLastTimestamp(snapshotKey.getTimestampMs());
        accumulator.setLastUsageData(snapshot.getUsageData());
      }
    }
    for (    StorageSummaryKey key : dataAccumulatorMap.keySet()) {
      StorageDataAccumulator accumulator=dataAccumulatorMap.get(key);
      long beginningMs=Math.max(period.getBeginningMs(),accumulator.getLastTimestamp());
      long endingMs=period.getEndingMs() - 1;
      long durationSecs=(endingMs - beginningMs) / 1000;
      log.info(String.format("Accumulate endUsage, %d-%d, key:%s",beginningMs,endingMs,key));
      accumulator.accumulateUsage(durationSecs);
      usageMap.put(key,accumulator.getCurrentSummary());
    }
    entityWrapper.commit();
  }
 catch (  Exception ex) {
    log.error(ex);
    entityWrapper.rollback();
    throw new RuntimeException(ex);
  }
  return usageMap;
}
