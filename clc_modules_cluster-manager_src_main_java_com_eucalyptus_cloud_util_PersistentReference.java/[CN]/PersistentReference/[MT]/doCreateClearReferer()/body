{
  final R referer=this.getReference();
  final ClearReference<T> ref=new ClearReference<T>(){
    private volatile boolean finished=false;
    @Override public T clear() throws ResourceAllocationException {
      this.checkFinished();
      final T ret=PersistentReference.this.doSetReferer(null,Resource.State.RELEASING,Resource.State.FREE);
      this.finished=true;
      return ret;
    }
    @Override public T abort() throws ResourceAllocationException {
      this.checkFinished();
      final T ret=PersistentReference.this.doSetReferer(referer,Resource.State.RELEASING,Resource.State.EXTANT);
      this.finished=true;
      return ret;
    }
    private void checkFinished() throws ResourceAllocationException {
      if (this.finished) {
        throw new ResourceAllocationException("Failed to set referer since this reference has already been set: " + PersistentReference.this.getDisplayName() + " to "+ PersistentReference.this.getReference()+ " and is currently in state "+ PersistentReference.this.getState());
      }
    }
  }
;
  return ref;
}
