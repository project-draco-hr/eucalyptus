{
  CreateStorageSnapshotResponseType reply=(CreateStorageSnapshotResponseType)request.getReply();
  if (!WalrusProperties.sharedMode) {
    if (!StorageProperties.enableSnapshots || !StorageProperties.enableStorage) {
      BlockStorageChecker.checkWalrusConnection();
      if (!StorageProperties.enableSnapshots)       LOG.error("Snapshots have been disabled. Please check connection to Walrus.");
      return reply;
    }
  }
  String volumeId=request.getVolumeId();
  String snapshotId=request.getSnapshotId();
  EntityWrapper<VolumeInfo> db=new EntityWrapper<VolumeInfo>();
  VolumeInfo volumeInfo=new VolumeInfo(volumeId);
  List<VolumeInfo> volumeInfos=db.query(volumeInfo);
  if (volumeInfos.size() > 0) {
    VolumeInfo foundVolumeInfo=volumeInfos.get(0);
    if (foundVolumeInfo.getStatus().equals(StorageProperties.Status.available.toString())) {
      if (StorageProperties.shouldEnforceUsageLimits && WalrusProperties.sharedMode) {
        int volSize=foundVolumeInfo.getSize();
        int totalSnapshotSize=0;
        SnapshotInfo snapInfo=new SnapshotInfo();
        EntityWrapper<SnapshotInfo> dbSnap=db.recast(SnapshotInfo.class);
        List<SnapshotInfo> snapInfos=dbSnap.query(snapInfo);
        for (        SnapshotInfo sInfo : snapInfos) {
          totalSnapshotSize+=blockManager.getSnapshotSize(sInfo.getSnapshotId());
        }
        if ((totalSnapshotSize + volSize) > StorageProperties.MAX_TOTAL_SNAPSHOT_SIZE) {
          db.rollback();
          throw new EntityTooLargeException(snapshotId);
        }
      }
      EntityWrapper<SnapshotInfo> db2=new EntityWrapper<SnapshotInfo>();
      edu.ucsb.eucalyptus.cloud.entities.SnapshotInfo snapshotInfo=new edu.ucsb.eucalyptus.cloud.entities.SnapshotInfo(snapshotId);
      snapshotInfo.setUserName(foundVolumeInfo.getUserName());
      snapshotInfo.setVolumeId(volumeId);
      Date startTime=new Date();
      snapshotInfo.setStartTime(startTime);
      snapshotInfo.setProgress("0");
      snapshotInfo.setStatus(StorageProperties.Status.creating.toString());
      db2.add(snapshotInfo);
      String snapshotSet="snapset-" + UUID.randomUUID();
      Snapshotter snapshotter=new Snapshotter(snapshotSet,volumeId,snapshotId);
      snapshotter.start();
      db2.commit();
      db.commit();
      reply.setSnapshotId(snapshotId);
      reply.setVolumeId(volumeId);
      reply.setStatus(snapshotInfo.getStatus());
      reply.setStartTime(DateUtils.format(startTime.getTime(),DateUtils.ISO8601_DATETIME_PATTERN) + ".000Z");
      reply.setProgress(snapshotInfo.getProgress());
    }
 else {
      db.rollback();
      throw new VolumeNotReadyException(volumeId);
    }
  }
 else {
    db.rollback();
    throw new NoSuchVolumeException(volumeId);
  }
  return reply;
}
