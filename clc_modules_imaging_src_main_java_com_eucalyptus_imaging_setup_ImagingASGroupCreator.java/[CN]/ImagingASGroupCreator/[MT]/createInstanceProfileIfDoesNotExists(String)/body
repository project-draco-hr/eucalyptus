{
  InstanceProfileType instanceProfile=null;
  try {
    List<InstanceProfileType> instanceProfiles=listInstanceProfiles(DEFAULT_INSTANCE_PROFILE_PATH_PREFIX);
    for (    InstanceProfileType ip : instanceProfiles) {
      if (DEFAULT_INSTANCE_PROFILE_NAME.equals(ip.getInstanceProfileName())) {
        instanceProfile=ip;
        break;
      }
    }
  }
 catch (  Exception ex) {
    throw new EucalyptusCloudException("Failed to list instance profiles",ex);
  }
  if (instanceProfile == null) {
    try {
      LOG.info("Creating default instance profile for Imager");
      instanceProfile=createInstanceProfile(DEFAULT_INSTANCE_PROFILE_NAME,DEFAULT_INSTANCE_PROFILE_PATH_PREFIX);
    }
 catch (    Exception ex) {
      throw new EucalyptusCloudException("Failed to create instance profile",ex);
    }
  }
  List<RoleType> roles=instanceProfile.getRoles().getMember();
  boolean roleFound=false;
  for (  RoleType role : roles) {
    if (role.getRoleName().equals(iamRoleName)) {
      roleFound=true;
      break;
    }
  }
  if (!roleFound) {
    try {
      addRoleToInstanceProfile(instanceProfile.getInstanceProfileName(),iamRoleName);
    }
 catch (    Exception ex2) {
      throw new EucalyptusCloudException("Failed to add role to the instance profile",ex2);
    }
  }
  return instanceProfile;
}
