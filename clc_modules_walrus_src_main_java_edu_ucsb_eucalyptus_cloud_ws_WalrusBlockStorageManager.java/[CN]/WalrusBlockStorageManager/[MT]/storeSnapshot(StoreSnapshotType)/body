{
  StoreSnapshotResponseType reply=(StoreSnapshotResponseType)request.getReply();
  String snapshotId=request.getKey();
  String bucketName=request.getBucket();
  String snapSizeString=request.getSnapshotSize();
  Long snapSize=0L;
  if (snapSizeString != null) {
    snapSize=Long.parseLong(snapSizeString);
  }
 else {
    throw new InvalidArgumentException("Snapshot size");
  }
  int snapshotSize=(int)(snapSize / WalrusProperties.G);
  if (WalrusProperties.shouldEnforceUsageLimits) {
    int totalSnapshotSize=0;
    WalrusSnapshotInfo snapInfo=new WalrusSnapshotInfo();
    EntityWrapper<WalrusSnapshotInfo> db=EntityWrapper.get(WalrusSnapshotInfo.class);
    List<WalrusSnapshotInfo> sInfos=db.query(snapInfo);
    for (    WalrusSnapshotInfo sInfo : sInfos) {
      totalSnapshotSize+=sInfo.getSize();
    }
    if ((totalSnapshotSize + snapshotSize) > WalrusInfo.getWalrusInfo().getStorageMaxTotalSnapshotSizeInGb()) {
      db.rollback();
      throw new EntityTooLargeException(snapshotId);
    }
    db.commit();
  }
  boolean createBucket=true;
  EntityWrapper<WalrusSnapshotInfo> db=EntityWrapper.get(WalrusSnapshotInfo.class);
  WalrusSnapshotInfo snapshotInfo=new WalrusSnapshotInfo(snapshotId);
  List<WalrusSnapshotInfo> snapInfos=db.query(snapshotInfo);
  if (snapInfos.size() > 0) {
    db.rollback();
    throw new EntityAlreadyExistsException(snapshotId);
  }
  db.commit();
  String userId=request.getUserId();
  if (createBucket) {
    CreateBucketType createBucketRequest=new CreateBucketType();
    createBucketRequest.setUserId(userId);
    createBucketRequest.setBucket(bucketName);
    createBucketRequest.setEffectiveUserId(request.getEffectiveUserId());
    try {
      walrusManager.createBucket(createBucketRequest);
    }
 catch (    EucalyptusCloudException ex) {
      if (!(ex instanceof BucketAlreadyExistsException || ex instanceof BucketAlreadyOwnedByYouException)) {
        throw ex;
      }
    }
  }
  PutObjectType putObjectRequest=new PutObjectType();
  putObjectRequest.setUserId(userId);
  putObjectRequest.setBucket(bucketName);
  putObjectRequest.setKey(snapshotId);
  putObjectRequest.setRandomKey(request.getRandomKey());
  putObjectRequest.setEffectiveUserId(request.getEffectiveUserId());
  try {
    PutObjectResponseType putObjectResponseType=walrusManager.putObject(putObjectRequest);
    reply.setEtag(putObjectResponseType.getEtag());
    reply.setLastModified(putObjectResponseType.getLastModified());
    reply.setStatusMessage(putObjectResponseType.getStatusMessage());
    snapshotInfo=new WalrusSnapshotInfo(snapshotId);
    db=EntityWrapper.get(WalrusSnapshotInfo.class);
    snapshotInfo.setSnapshotBucket(bucketName);
    snapshotInfo.setSize(snapshotSize);
    db.add(snapshotInfo);
    db.commit();
  }
 catch (  EucalyptusCloudException ex) {
    db.rollback();
    throw ex;
  }
  return reply;
}
