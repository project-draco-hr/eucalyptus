{
  InetSocketAddress addr=(InetSocketAddress)ctx.getChannel().getRemoteAddress();
  InetSocketAddress localAddr=(InetSocketAddress)ctx.getChannel().getLocalAddress();
  LOG.info(LogUtil.subheader("Using " + addr.getHostName() + " as the database address."));
  if (!Components.contains("walrus")) {
    try {
      Components.create("walrus",null);
    }
 catch (    ServiceRegistrationException ex) {
      LOG.error(ex,ex);
    }
  }
  try {
    this.prepareComponent(Components.delegate.db,addr);
    this.prepareComponent(Components.delegate.dns,addr);
    HeartbeatType msg=(HeartbeatType)request.getMessage();
    LOG.info(LogUtil.header("Got heartbeat event: " + LogUtil.dumpObject(msg)));
    for (    HeartbeatComponentType component : msg.getComponents()) {
      LOG.info(LogUtil.subheader("Registering local component: " + LogUtil.dumpObject(component)));
      System.setProperty("euca." + component.getComponent() + ".name",component.getName());
      try {
        final Component comp=Components.lookup(component.getComponent());
        URI uri=comp.getUri(localAddr.getHostName(),8773);
        comp.buildService(new ComponentConfiguration(comp.getName(),uri.getHost(),8773,uri.getPath()){
          @Override public com.eucalyptus.bootstrap.Component getComponent(){
            return comp.getPeer();
          }
        }
);
      }
 catch (      Exception ex) {
        LOG.warn(LogUtil.header("Failed registering local component " + LogUtil.dumpObject(component) + ":  Are the required packages installed?\n The cause of the error: "+ ex.getMessage()));
        LOG.error(ex,ex);
      }
      initializedComponents.add(component.getComponent());
    }
    if (!initializedComponents.contains(Components.delegate.walrus.name())) {
      this.prepareComponent(Components.delegate.walrus,addr);
    }
    for (    Bootstrap.Stage stage : Bootstrap.Stage.values()) {
      stage.updateBootstrapDependencies();
    }
    try {
      GroovyUtil.evaluateScript("after_database.groovy");
    }
 catch (    ScriptExecutionFailedException e1) {
      LOG.debug(e1,e1);
      System.exit(123);
    }
    boolean foundDb=false;
    try {
      foundDb=NetworkUtil.testReachability(addr.getHostName());
      LOG.debug("Initializing SSL just in case: " + SslSetup.class);
      foundDb=true;
    }
 catch (    Throwable e) {
      foundDb=false;
    }
    if (foundDb) {
      HttpResponse response=new DefaultHttpResponse(request.getProtocolVersion(),HttpResponseStatus.OK);
      ChannelFuture writeFuture=ctx.getChannel().write(response);
      writeFuture.addListener(ChannelFutureListener.CLOSE);
      initialized.set(true);
      if (this.channel != null) {
        this.channel.close();
      }
    }
 else {
      HttpResponse response=new DefaultHttpResponse(request.getProtocolVersion(),HttpResponseStatus.NOT_ACCEPTABLE);
      ChannelFuture writeFuture=ctx.getChannel().write(response);
      writeFuture.addListener(ChannelFutureListener.CLOSE);
    }
  }
 catch (  ServiceRegistrationException e) {
    LOG.error(e,e);
    System.exit(123);
  }
catch (  NoSuchElementException e) {
    LOG.error(e,e);
    System.exit(123);
  }
}
