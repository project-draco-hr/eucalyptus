{
  AddressUtil.updateAddressingMode();
  int addrCount=0;
  for (  Address a : Addresses.getInstance().listValues()) {
    if (request.getUserId().equals(a.getUserId()))     addrCount++;
  }
  if (addrCount >= edu.ucsb.eucalyptus.util.EucalyptusProperties.getSystemConfiguration().getMaxUserPublicAddresses() && !request.isAdministrator())   throw new EucalyptusCloudException(ExceptionList.ERR_SYS_INSUFFICIENT_ADDRESS_CAPACITY);
  String userId=request.getUserId();
  Address address=AddressUtil.nextAvailableAddress(userId);
  try {
    Addresses.getInstance().register(address);
  }
 catch (  Exception e) {
  }
  AllocateAddressResponseType reply=(AllocateAddressResponseType)request.getReply();
  reply.setPublicIp(address.getName());
  return reply;
}
