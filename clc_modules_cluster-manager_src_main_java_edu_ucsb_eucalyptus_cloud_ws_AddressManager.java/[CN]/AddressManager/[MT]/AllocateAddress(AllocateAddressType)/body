{
  AddressUtil.updateAddressingMode();
  int addrCount=0;
  for (  Address a : Addresses.getInstance().listValues()) {
    if (request.getUserId().equals(a.getUserId()))     addrCount++;
  }
  if (addrCount >= edu.ucsb.eucalyptus.util.EucalyptusProperties.getSystemConfiguration().getMaxUserPublicAddresses() && !request.isAdministrator())   throw new EucalyptusCloudException(ExceptionList.ERR_SYS_INSUFFICIENT_ADDRESS_CAPACITY);
  String userId=request.getUserId();
  Address address=Addresses.getInstance().getNextAvailable(userId);
  AllocateAddressResponseType reply=(AllocateAddressResponseType)request.getReply();
  reply.setPublicIp(address.getName());
  return reply;
}
