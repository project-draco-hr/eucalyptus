{
  AssociateAddressResponseType reply=(AssociateAddressResponseType)request.getReply();
  reply.set_return(false);
  Addresses.updateAddressingMode();
  final Address address=Addresses.restrictedLookup(request.getUserId(),request.isAdministrator(),request.getPublicIp());
  final VmInstance vm=VmInstances.restrictedLookup(request.getUserId(),request.isAdministrator(),request.getInstanceId());
  LOG.info(EventRecord.here(AddressManager.class,Events.ASSOCIATE,address.toString(),vm.toString()));
  final VmInstance oldVm=findCurrentAssignedVm(address);
  final Address oldAddr=findVmExistingAddress(vm);
  final boolean oldAddrSystem=oldAddr != null ? oldAddr.isSystemOwned() : false;
  reply.set_return(true);
  final UnconditionalCallback assignTarget=new UnconditionalCallback(){
    public void apply(){
      LOG.info(EventRecord.here(AddressManager.class,Events.ASSOCIATE,address.toString(),vm.toString()));
      AddressCategory.assign(address,vm).dispatch(address.getCluster());
      if (oldAddrSystem) {
        LOG.info(EventRecord.here(AddressManager.class,Events.RELEASE,oldAddr.toString()));
        Addresses.getAddressManager().releaseSystemAddress(oldAddr);
      }
      if (oldVm != null) {
        Addresses.system(oldVm);
      }
    }
  }
;
  final UnconditionalCallback unassignBystander=new UnconditionalCallback(){
    public void apply(){
      if (oldAddr != null) {
        LOG.info(EventRecord.here(AddressManager.class,Events.DISASSOCIATE,oldAddr.toString()));
        AddressCategory.unassign(oldAddr).then(assignTarget).dispatch(oldAddr.getCluster());
      }
 else {
        assignTarget.apply();
      }
    }
  }
;
  if (address.isAssigned()) {
    if (oldAddr != null)     address.unassign().getCallback().then(unassignBystander).dispatch(oldAddr.getCluster());
  }
 else {
    unassignBystander.apply();
  }
  return reply;
}
