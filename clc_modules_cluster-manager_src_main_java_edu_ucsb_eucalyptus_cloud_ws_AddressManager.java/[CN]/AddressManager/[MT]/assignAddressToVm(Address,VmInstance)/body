{
  EntityWrapper<Address> db=new EntityWrapper<Address>();
  try {
    Address addr=db.getUnique(new Address(address.getName()));
    addr.unassign();
    addr.assign(vm.getInstanceId(),vm.getNetworkConfig().getIpAddress());
    address.assign(vm.getInstanceId(),vm.getNetworkConfig().getIpAddress());
    AssignAddressType assignMsg=Admin.makeMsg(AssignAddressType.class,address.getName(),address.getInstanceAddress());
    ClusterConfiguration config=Clusters.getInstance().lookup(address.getCluster()).getConfiguration();
    ClusterEnvelope.dispatch(address.getCluster(),QueuedEvent.make(new AssignAddressCallback(config,vm),assignMsg));
    db.commit();
  }
 catch (  EucalyptusCloudException e) {
    db.rollback();
  }
}
