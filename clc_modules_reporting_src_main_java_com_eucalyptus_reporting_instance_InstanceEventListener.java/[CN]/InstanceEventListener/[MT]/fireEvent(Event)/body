{
  final long receivedEventMs=this.getCurrentTimeMillis();
  if (e instanceof InstanceEvent) {
    log.info("Received instance event");
    InstanceEvent event=(InstanceEvent)e;
    final String uuid=event.getUuid();
    EntityWrapper<InstanceAttributes> entityWrapper=EntityWrapper.get(InstanceAttributes.class);
    try {
      InstanceAttributes insAttrs=new InstanceAttributes(uuid,event.getInstanceId(),event.getInstanceType(),event.getUserId(),event.getAccountId(),event.getClusterName(),event.getAvailabilityZone());
      InstanceUsageSnapshot insUsageSnapshot=new InstanceUsageSnapshot(uuid,receivedEventMs,event.getCumulativeNetworkIoMegs(),event.getCumulativeDiskIoMegs());
      if (!recentlySeenUuids.contains(uuid)) {
        try {
          entityWrapper.getUnique(new InstanceAttributes(){
{
              setUuid(uuid);
            }
          }
);
        }
 catch (        Exception ex) {
          entityWrapper.add(insAttrs);
          log.info("Wrote Reporting Instance:" + uuid);
        }
        recentlySeenUuids.add(uuid);
      }
      recentUsageSnapshots.add(insUsageSnapshot);
      if (receivedEventMs > (lastWriteMs + getWriteIntervalMs())) {
        for (        InstanceUsageSnapshot ius : recentUsageSnapshots) {
          entityWrapper.recast(InstanceUsageSnapshot.class).add(ius);
          log.info("Wrote Instance Usage:" + ius.getUuid() + ":"+ ius.getEntityId());
        }
        recentUsageSnapshots.clear();
        lastWriteMs=receivedEventMs;
      }
      entityWrapper.commit();
    }
 catch (    Exception ex) {
      entityWrapper.rollback();
      log.error(ex);
    }
  }
}
