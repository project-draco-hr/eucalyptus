{
  final long receivedEventMs=this.getCurrentTimeMillis();
  if (e instanceof InstanceEvent) {
    log.info("Received instance event");
    InstanceEvent event=(InstanceEvent)e;
    final String uuid=event.getUuid();
    EntityWrapper<InstanceAttributes> entityWrapper=EntityWrapper.get(InstanceAttributes.class);
    try {
      InstanceAttributes insAttrs=new InstanceAttributes(uuid,event.getInstanceId(),event.getInstanceType(),event.getUserId(),event.getAccountId(),event.getClusterName(),event.getAvailabilityZone());
      InstanceUsageSnapshot insUsageSnapshot=new InstanceUsageSnapshot(uuid,receivedEventMs,event.getCumulativeNetworkIoMegs(),event.getCumulativeDiskIoMegs());
      if (!recentlySeenUuids.contains(uuid)) {
        try {
          entityWrapper.getUnique(new InstanceAttributes(){
{
              setUuid(uuid);
            }
          }
);
        }
 catch (        Exception ex) {
          entityWrapper.add(insAttrs);
          log.info("Wrote Reporting Instance:" + uuid);
        }
        recentlySeenUuids.add(uuid);
      }
      if (!recentUsageSnapshots.containsKey(uuid)) {
        recentUsageSnapshots.put(uuid,insUsageSnapshot);
      }
 else {
        InstanceUsageSnapshot oldSnapshot=recentUsageSnapshots.get(uuid);
        if (oldSnapshot.getTimestampMs() < insUsageSnapshot.getTimestampMs()) {
          recentUsageSnapshots.put(uuid,insUsageSnapshot);
        }
 else {
          log.error("Events are arriving out of order");
        }
      }
      log.info("Determining if events should be written");
      if (receivedEventMs > (lastWriteMs + getWriteIntervalMs())) {
        for (        String key : recentUsageSnapshots.keySet()) {
          log.info("beginning event writing for:" + uuid);
          InstanceUsageSnapshot ius=recentUsageSnapshots.get(key);
          entityWrapper.recast(InstanceUsageSnapshot.class).add(ius);
          log.info("Wrote Instance Usage:" + ius.getUuid() + ":"+ ius.getEntityId());
        }
        recentUsageSnapshots.clear();
        lastWriteMs=receivedEventMs;
      }
      entityWrapper.commit();
    }
 catch (    Exception ex) {
      entityWrapper.rollback();
      log.error(ex);
    }
  }
}
