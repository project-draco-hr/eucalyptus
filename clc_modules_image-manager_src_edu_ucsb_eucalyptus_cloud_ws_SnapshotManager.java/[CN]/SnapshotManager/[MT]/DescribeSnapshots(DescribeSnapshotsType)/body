{
  DescribeSnapshotsResponseType reply=(DescribeSnapshotsResponseType)request.getReply();
  EntityWrapper<Snapshot> db=getEntityWrapper();
  String userName=request.isAdministrator() ? null : request.getUserId();
  List<Snapshot> snapshots=db.query(Snapshot.ownedBy(userName));
  for (  Snapshot v : snapshots) {
    if (request.getSnapshotSet().isEmpty() || request.getSnapshotSet().contains(v.getDisplayName())) {
      DescribeStorageSnapshotsResponseType snapshotInfo=null;
      try {
        snapshotInfo=(DescribeStorageSnapshotsResponseType)Messaging.send(StorageProperties.STORAGE_REF,new DescribeStorageSnapshotsType(Lists.newArrayList(v.getDisplayName())));
        for (        StorageSnapshot storageSnapshot : snapshotInfo.getSnapshotSet()) {
          v.setMappedState(storageSnapshot.getStatus());
          edu.ucsb.eucalyptus.msgs.Snapshot snapReply=v.morph(new edu.ucsb.eucalyptus.msgs.Snapshot());
          if (storageSnapshot.getProgress() != null)           snapReply.setProgress(storageSnapshot.getProgress());
          snapReply.setVolumeId(storageSnapshot.getVolumeId());
          reply.getSnapshotSet().add(snapReply);
        }
      }
 catch (      EucalyptusCloudException e) {
        LOG.debug(e,e);
        throw e;
      }
    }
  }
  db.commit();
  LOG.warn("RESPONSE ============\n" + reply);
  return reply;
}
