{
  String redirectHost=null;
  if (!Topology.isEnabledLocally(Eucalyptus.class)) {
    try {
      ServiceConfiguration clc=Topology.lookup(Eucalyptus.class);
      if (clc == null) {
        throw new RuntimeException("Can not find enabled cloud controller");
      }
      redirectHost=clc.getHostName();
    }
 catch (    Exception e) {
      LOG.error("Failed to lookup service configuration for cloud controller",e);
      throw new IOException("No available cloud web service");
    }
  }
  String urlStr=req.getRequestURL().toString();
  if (redirectHost == null && !urlStr.startsWith("https")) {
    redirectHost=(new URL(urlStr)).getHost();
  }
  if (redirectHost != null) {
    String redirectUrl=getRedirectUrl(redirectHost,req);
    LOG.debug("Redirecting request to " + redirectUrl);
    resp.sendRedirect(redirectUrl);
  }
  return target;
}
