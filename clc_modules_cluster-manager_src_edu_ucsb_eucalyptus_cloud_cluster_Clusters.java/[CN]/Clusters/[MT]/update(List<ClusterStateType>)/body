{
  EntityWrapper<ClusterInfo> db=new EntityWrapper<ClusterInfo>();
  List<ClusterInfo> clusterList=db.query(new ClusterInfo());
  for (  ClusterInfo c : clusterList) {
    boolean found=false;
    for (    ClusterStateType newClusterInfo : clusterChanges) {
      if (c.getName().equals(newClusterInfo.getName())) {
        found=true;
        break;
      }
    }
    if (!found) {
      Cluster cluster=null;
      try {
        cluster=this.lookup(c.getName());
        db.delete(c);
        this.deregister(cluster.getName());
        cluster.stop();
      }
 catch (      Exception e) {
        LOG.error(e,e);
      }
    }
  }
  db.commit();
  for (  ClusterStateType c : clusterChanges) {
    db=new EntityWrapper<ClusterInfo>();
    try {
      ClusterInfo clusterInfo=db.getUnique(new ClusterInfo(c.getName()));
      if (!clusterInfo.getHost().equals(c.getHost()) || clusterInfo.getPort() != c.getPort()) {
        clusterInfo.setHost(c.getHost());
        clusterInfo.setPort(c.getPort());
        Cluster cluster=this.lookup(c.getName());
        this.deregister(c.getName());
        cluster.stop();
        Cluster newCluster=new Cluster(clusterInfo);
        this.register(newCluster);
        db.commit();
        newCluster.start();
      }
 else       db.rollback();
    }
 catch (    Exception e) {
      ClusterInfo clusterInfo=setupCluster(c);
      db.add(clusterInfo);
      db.commit();
    }
  }
}
