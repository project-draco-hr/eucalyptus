{
  if (this.getBundleTask() != null) {
    final BundleState current=this.getBundleTask().getState();
    if (BundleState.complete.equals(state) && !BundleState.complete.equals(current) && !BundleState.none.equals(current)) {
      this.getBundleTask().setState(state);
      bundleRestartInstance(this.getBundleTask());
    }
 else     if (BundleState.failed.equals(state) && !BundleState.failed.equals(current) && !BundleState.none.equals(current)) {
      try {
        Bundles.deleteBucket(Accounts.lookupUserById(this.getVmInstance().getOwnerUserId()),this.getBundleTask().getBucket(),true);
      }
 catch (      final Exception ex) {
        LOG.error("After bundle failure, failed to delete the bucket",ex);
      }
      this.getBundleTask().setState(state);
      bundleRestartInstance(this.getBundleTask());
    }
 else     if (BundleState.cancelled.equals(state) && !BundleState.cancelled.equals(current) && !BundleState.none.equals(current)) {
      try {
        Bundles.deleteBucket(Accounts.lookupUserById(this.getVmInstance().getOwnerUserId()),this.getBundleTask().getBucket(),true);
      }
 catch (      final Exception ex) {
        LOG.error("After bundle cancellation, failed to delete the bucket",ex);
      }
      this.getBundleTask().setState(state);
      bundleRestartInstance(this.getBundleTask());
    }
 else     if (BundleState.canceling.equals(state) || BundleState.canceling.equals(current)) {
    }
 else     if (BundleState.pending.equals(current) && !BundleState.none.equals(state)) {
      this.getBundleTask().setState(state);
      this.getBundleTask().setUpdateTime(new Date());
      EventRecord.here(VmRuntimeState.class,EventType.BUNDLE_TRANSITION,this.vmInstance.getOwner().toString(),"" + this.getBundleTask()).info();
    }
 else     if (BundleState.storing.equals(state)) {
      this.getBundleTask().setState(state);
      this.getBundleTask().setUpdateTime(new Date());
      EventRecord.here(VmRuntimeState.class,EventType.BUNDLE_TRANSITION,this.vmInstance.getOwner().toString(),"" + this.getBundleTask()).info();
    }
  }
 else {
    this.setBundleTask(new VmBundleTask(this.vmInstance,state.name(),new Date(),new Date(),0,"unknown","unknown","unknown","unknown"));
    Logs.extreme().trace("Unhandle bundle task state update: " + state);
  }
}
