{
  Callable<Boolean> action=null;
  LOG.info(String.format("%s state change: %s -> %s",this.getVmInstance().getInstanceId(),this.getVmInstance().getState(),newState));
  if (VmStateSet.RUN.contains(oldState) && VmStateSet.NOT_RUNNING.contains(newState)) {
    this.getVmInstance().setState(newState);
    action=this.cleanUpRunnable();
  }
 else   if (VmState.PENDING.equals(oldState) && VmState.RUNNING.equals(newState)) {
    this.getVmInstance().setState(newState);
  }
 else   if (VmState.SHUTTING_DOWN.equals(oldState) && VmStateSet.RUN.contains(newState)) {
    this.getVmInstance().setState(oldState);
  }
 else   if (VmState.TERMINATED.equals(newState) && (oldState.ordinal() <= VmState.RUNNING.ordinal())) {
    this.getVmInstance().setState(newState);
    action=this.cleanUpRunnable();
  }
 else   if (VmState.TERMINATED.equals(newState) && (oldState.ordinal() > VmState.RUNNING.ordinal())) {
    this.getVmInstance().setState(newState);
  }
 else   if (newState.ordinal() > oldState.ordinal()) {
    this.getVmInstance().setState(newState);
  }
 else   if (VmState.STOPPED.equals(oldState) && VmState.PENDING.equals(newState)) {
    this.getVmInstance().setState(newState);
  }
  try {
    this.getVmInstance().store();
  }
 catch (  final Exception ex1) {
    LOG.error(ex1,ex1);
  }
  return action;
}
