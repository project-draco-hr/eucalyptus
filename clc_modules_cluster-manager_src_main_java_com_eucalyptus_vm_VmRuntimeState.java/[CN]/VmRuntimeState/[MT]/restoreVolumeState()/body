{
  final VmInstance vm=this.getVmInstance();
  if (vm.isBlockStorage()) {
    final String vmId=vm.getInstanceId();
    final ServiceConfiguration scConfig=Topology.lookup(Storage.class,vm.lookupPartition());
    final ServiceConfiguration ccConfig=Topology.lookup(ClusterController.class,vm.lookupPartition());
    final Cluster cluster=Clusters.lookup(ccConfig);
    final String iqn=cluster.getNode(this.getServiceTag()).getIqn();
    final Predicate<VmVolumeAttachment> attachVolumes=new Predicate<VmVolumeAttachment>(){
      public boolean apply(      VmVolumeAttachment input){
        final String volumeId=input.getVolumeId();
        final String vmDevice=input.getDevice();
        try {
          LOG.debug(vmId + ": attaching volume: " + input);
          final AttachStorageVolumeType attachMsg=new AttachStorageVolumeType(iqn,volumeId);
          final CheckedListenableFuture<AttachStorageVolumeResponseType> scAttachReplyFuture=AsyncRequests.dispatch(scConfig,attachMsg);
          final Callable<Boolean> ncAttachRequest=new Callable<Boolean>(){
            public Boolean call(){
              try {
                LOG.debug(vmId + ": waiting for storage volume: " + volumeId);
                AttachStorageVolumeResponseType scReply=scAttachReplyFuture.get();
                LOG.debug(vmId + ": " + volumeId+ " => "+ scAttachReplyFuture.get());
                AsyncRequests.dispatch(ccConfig,new AttachVolumeType(volumeId,vmId,vmDevice,scReply.getRemoteDeviceString()));
                final EntityTransaction db=Entities.get(VmInstance.class);
                try {
                  final VmInstance entity=Entities.merge(vm);
                  entity.lookupVolumeAttachment(volumeId).setRemoteDevice(scReply.getRemoteDeviceString());
                  db.commit();
                }
 catch (                final Exception ex) {
                  Logs.extreme().error(ex,ex);
                  db.rollback();
                }
              }
 catch (              Exception ex) {
                Exceptions.maybeInterrupted(ex);
                LOG.error(vmId + ": " + ex);
                Logs.extreme().error(ex,ex);
              }
              return true;
            }
          }
;
          Threads.enqueue(Eucalyptus.class,VmRuntimeState.class,ncAttachRequest);
        }
 catch (        Exception ex) {
          LOG.error(vmId + ": " + ex);
          Logs.extreme().error(ex,ex);
        }
        return true;
      }
    }
;
    try {
      this.getVmInstance().getTransientVolumeState().eachVolumeAttachment(attachVolumes);
    }
 catch (    Exception ex) {
      LOG.error(this.getVmInstance().getInstanceId() + ": " + ex);
      Logs.extreme().error(this.getVmInstance().getInstanceId() + ": " + ex,ex);
    }
  }
}
