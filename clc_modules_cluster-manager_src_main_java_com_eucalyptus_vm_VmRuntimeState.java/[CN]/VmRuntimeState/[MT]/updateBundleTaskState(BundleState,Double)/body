{
  if (this.getBundleTask() != null) {
    final BundleState current=this.getBundleTask().getState();
    VmBundleTask currentTask=this.getBundleTask();
    currentTask.setProgress((int)Math.round(progress * 100D));
    if (BundleState.complete.equals(state) && !BundleState.complete.equals(current) && !BundleState.none.equals(current)) {
      currentTask.setState(state);
      currentTask.setProgress(100);
      bundleRestartInstance(currentTask);
    }
 else     if (BundleState.failed.equals(state) && !BundleState.failed.equals(current) && !BundleState.none.equals(current)) {
      try {
        Bundles.deleteBucketContent(Accounts.lookupAccountById(this.getVmInstance().getOwnerAccountNumber()).lookupAdmin(),currentTask.getBucket(),currentTask.getPrefix(),true);
      }
 catch (      final Exception ex) {
        LOG.error("After bundle failure, failed to delete the bucket",ex);
      }
      currentTask.setState(state);
      bundleRestartInstance(currentTask);
    }
 else     if (BundleState.cancelled.equals(state) && !BundleState.cancelled.equals(current) && !BundleState.none.equals(current)) {
      try {
        Bundles.deleteBucketContent(Accounts.lookupAccountById(this.getVmInstance().getOwnerAccountNumber()).lookupAdmin(),this.getBundleTask().getBucket(),this.getBundleTask().getPrefix(),true);
      }
 catch (      final Exception ex) {
        LOG.error("After bundle cancellation, failed to delete the bucket",ex);
      }
      currentTask.setState(state);
      bundleRestartInstance(currentTask);
    }
 else     if (BundleState.canceling.equals(state) || BundleState.canceling.equals(current)) {
    }
 else     if (BundleState.pending.equals(current) && !BundleState.none.equals(state)) {
      currentTask.setState(state);
      currentTask.setUpdateTime(new Date());
      EventRecord.here(VmRuntimeState.class,EventType.BUNDLE_TRANSITION,this.vmInstance.getOwner().toString(),"" + this.getBundleTask()).info();
    }
 else     if (BundleState.storing.equals(state)) {
      currentTask.setState(state);
      currentTask.setUpdateTime(new Date());
      EventRecord.here(VmRuntimeState.class,EventType.BUNDLE_TRANSITION,this.vmInstance.getOwner().toString(),"" + this.getBundleTask()).info();
    }
  }
 else {
    this.setBundleTask(new VmBundleTask(this.vmInstance,state.name(),new Date(),new Date(),0,"unknown","unknown","unknown","unknown"));
    Logs.extreme().trace("Unhandle bundle task state update: " + state);
  }
}
