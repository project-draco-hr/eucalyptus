{
  this.immutableStates=ImmutableList.of(this.startState.getDeclaringClass().getEnumConstants());
  if (this.transitions.isEmpty()) {
    throw new IllegalStateException("Started state machine with no registered transitions.");
  }
  T[] trans=this.transitions.iterator().next().getName().getDeclaringClass().getEnumConstants();
  Map<String,Transition<P,S,T>> alltransitions=Maps.newHashMap();
  for (  S s1 : this.immutableStates) {
    for (    S s2 : this.immutableStates) {
      alltransitions.put(String.format("%s.%s->%s.%s",s1,false,s2,false),null);
      alltransitions.put(String.format("%s.%s->%s.%s",s1,false,s2,true),null);
      alltransitions.put(String.format("%s.%s->%s.%s",s1,true,s2,false),null);
      alltransitions.put(String.format("%s.%s->%s.%s",s1,true,s2,true),null);
    }
  }
  LOG.debug("Starting state machine: " + this.parent.getClass().getSimpleName() + " "+ this.parent.getName());
  for (  S s : this.immutableStates) {
    LOG.debug("fsm " + this.parent.getName() + "       state:"+ s.name());
  }
  Multimap<T,Transition<P,S,T>> transNames=Multimaps.newArrayListMultimap();
  for (  Transition<P,S,T> t : this.transitions) {
    transNames.put(t.getName(),t);
  }
  for (  T t : trans) {
    LOG.debug("fsm " + this.parent.getName() + " transitions:"+ (transNames.containsKey(t) ? transNames.get(t) : t.name() + ":NONE"));
    for (    Transition<P,S,T> tr : transNames.get(t)) {
      String trKey=String.format("%s.%s->%s.%s",tr.getFromState(),tr.getFromStateMark(),tr.getToState(),tr.getToStateMark());
      if (alltransitions.get(trKey) != null) {
        LOG.error("Duplicate transition: " + tr + " AND "+ alltransitions.get(trKey));
        throw new IllegalStateException("Duplicate transition: " + tr + " AND "+ alltransitions.get(trKey));
      }
 else {
        alltransitions.put(trKey,tr);
      }
    }
  }
  for (  String trKey : alltransitions.keySet()) {
    LOG.debug(String.format("fsm %s %-60.60s %s",this.parent.getName(),trKey,alltransitions.get(trKey)));
  }
}
