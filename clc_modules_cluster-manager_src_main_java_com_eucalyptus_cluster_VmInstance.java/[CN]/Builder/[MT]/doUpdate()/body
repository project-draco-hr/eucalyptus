{
  return new Predicate<VmInfo>(){
    @Override public boolean apply(    final VmInfo runVm){
      if (!Entities.isPersistent(VmInstance.this)) {
        throw new TransientEntityException(this.toString());
      }
 else {
        final EntityTransaction db=Entities.get(VmInstance.class);
        try {
          final VmState state=VmState.Mapper.get(runVm.getStateName());
          final long splitTime=VmInstance.this.getSplitTime();
          final VmState oldState=VmInstance.this.getState();
          if (VmStateSet.RUN.contains(state) && VmStateSet.RUN.contains(VmInstance.this.getState())) {
            VmInstance.this.setState(state,Reason.APPEND,"UPDATE");
            this.updateState(runVm);
          }
 else           if (VmState.STOPPING.equals(oldState) && VmState.SHUTTING_DOWN.equals(state)) {
            VmInstance.this.setState(VmState.STOPPED,Reason.APPEND,"STOPPED");
          }
 else           if (VmState.SHUTTING_DOWN.equals(oldState) && VmState.SHUTTING_DOWN.equals(state)) {
            VmInstance.this.setState(VmState.TERMINATED,Reason.APPEND,"DONE");
          }
 else           if (VmStateSet.STOP.contains(oldState) && (splitTime > VmInstances.BURY_TIME)) {
            VmInstance.this.setState(VmState.STOPPED,Reason.EXPIRED);
          }
 else {
            this.updateState(runVm);
          }
          db.commit();
        }
 catch (        final Exception ex) {
          Logs.exhaust().error(ex,ex);
          db.rollback();
        }
      }
      return true;
    }
    private void updateState(    final VmInfo runVm){
      VmInstance.this.getRuntimeState().setServiceTag(runVm.getServiceTag());
      VmInstance.this.updateBundleTaskState(runVm.getBundleTaskStateName());
      VmInstance.this.updateCreateImageTaskState(runVm.getBundleTaskStateName());
      VmInstance.this.updateVolumeAttachments(runVm.getVolumes());
      VmInstance.this.updateAddresses(runVm.getNetParams().getIpAddress(),runVm.getNetParams().getIgnoredPublicIp());
      VmInstance.this.updateBlockBytes(runVm.getBlockBytes());
      VmInstance.this.updateNetworkBytes(runVm.getNetworkBytes());
    }
  }
;
}
