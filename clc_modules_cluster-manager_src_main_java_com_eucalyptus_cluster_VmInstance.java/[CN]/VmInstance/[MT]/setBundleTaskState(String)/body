{
  BundleState next=null;
  if (BundleState.storing.getMappedState().equals(state)) {
    next=BundleState.storing;
  }
 else   if (BundleState.complete.getMappedState().equals(state)) {
    next=BundleState.complete;
  }
 else   if (BundleState.failed.getMappedState().equals(state)) {
    next=BundleState.failed;
  }
 else {
    next=BundleState.none;
  }
  if (this.bundleTask.getReference() != null) {
    if (!this.bundleTask.isMarked()) {
      BundleState current=BundleState.valueOf(this.getBundleTask().getState());
      if (BundleState.complete.equals(current) || BundleState.failed.equals(current)) {
        return;
      }
 else       if (BundleState.storing.equals(next) || BundleState.storing.equals(current)) {
        this.getBundleTask().setState(next.name());
        EventRecord.here(BundleCallback.class,EventType.BUNDLE_TRANSITION,this.getOwner().toString(),this.getBundleTask().getBundleId(),this.getInstanceId(),this.getBundleTask().getState()).info();
        this.getBundleTask().setUpdateTime(new Date());
      }
 else       if (BundleState.none.equals(next) && BundleState.failed.equals(current)) {
        this.resetBundleTask();
      }
    }
 else {
      this.getBundleTask().setUpdateTime(new Date());
    }
  }
}
