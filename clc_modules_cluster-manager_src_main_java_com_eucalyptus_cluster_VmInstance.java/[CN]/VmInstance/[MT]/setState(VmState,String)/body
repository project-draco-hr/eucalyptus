{
  this.resetStopWatch();
  VmState oldState=this.state.getReference();
  if (!this.getState().equals(state)) {
    EventRecord.caller(VmInstance.class,EventType.VM_STATE,this.instanceId,this.ownerId,this.state.getReference().name(),this.launchTime);
    LOG.info(String.format("%s state change: %s -> %s",this.getInstanceId(),this.getState(),state));
  }
  this.state.set(state,this.state.isMarked());
  this.reason=reason;
  if (VmState.PENDING.equals(oldState) && VmState.SHUTTING_DOWN.equals(this.getState())) {
    try {
      VmInstances.cleanUp(this);
    }
 catch (    Throwable t) {
      LOG.debug(t,t);
    }
  }
 else   if (VmState.TERMINATED.equals(this.getState())) {
    VmInstances.getInstance().disable(this.getName());
    try {
      VmInstances.cleanUp(this);
    }
 catch (    Throwable t) {
      LOG.debug(t,t);
    }
  }
 else   if (VmState.SHUTTING_DOWN.equals(this.getState()) || VmState.BURIED.equals(this.getState())) {
    try {
      VmInstances.cleanUp(this);
    }
 catch (    Throwable t) {
      LOG.debug(t,t);
    }
  }
}
