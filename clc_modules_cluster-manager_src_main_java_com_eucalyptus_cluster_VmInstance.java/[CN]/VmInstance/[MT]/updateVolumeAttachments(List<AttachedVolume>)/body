{
  final Map<String,AttachedVolume> volMap=new HashMap<String,AttachedVolume>(){
{
      for (      AttachedVolume v : volList) {
        put(v.getVolumeId(),v);
      }
    }
  }
;
  this.eachVolumeAttachment(new Predicate<AttachedVolume>(){
    @Override public boolean apply(    AttachedVolume arg0){
      String volId=arg0.getVolumeId();
      if ("detaching".equals(arg0.getStatus()) && !volMap.containsKey(volId)) {
        VmInstance.this.removeVolumeAttachment(volId);
      }
 else       if ("attaching".equals(arg0.getStatus()) || "attached".equals(arg0.getStatus())) {
        VmInstance.this.updateVolumeAttachment(volId,volMap.get(volId).getStatus());
      }
      volMap.remove(volId);
      return true;
    }
  }
);
  for (  AttachedVolume v : volMap.values()) {
    LOG.warn("Restoring volume attachment state for " + this.getInstanceId() + " with "+ v.toString());
    this.addVolumeAttachment(v);
  }
}
