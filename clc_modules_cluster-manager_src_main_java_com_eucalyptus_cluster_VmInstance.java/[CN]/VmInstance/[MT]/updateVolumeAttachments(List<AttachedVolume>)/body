{
  final Map<String,AttachedVolume> ncAttachedVolMap=new HashMap<String,AttachedVolume>(){
{
      for (      AttachedVolume v : ncAttachedVols) {
        put(v.getVolumeId(),v);
      }
    }
  }
;
  this.eachVolumeAttachment(new Predicate<AttachedVolume>(){
    @Override public boolean apply(    AttachedVolume arg0){
      String volId=arg0.getVolumeId();
      if (ncAttachedVolMap.containsKey(volId)) {
        AttachedVolume ncVol=ncAttachedVolMap.get(volId);
        if ("detached".equals(ncVol.getStatus())) {
          VmInstance.this.removeVolumeAttachment(volId);
        }
 else         if ("attaching".equals(arg0.getStatus()) || "attached".equals(arg0.getStatus())) {
          VmInstance.this.updateVolumeAttachment(volId,arg0.getStatus());
        }
      }
 else       if ("detaching".equals(arg0.getStatus())) {
        VmInstance.this.removeVolumeAttachment(volId);
      }
      ncAttachedVolMap.remove(volId);
      return true;
    }
  }
);
  for (  AttachedVolume v : ncAttachedVolMap.values()) {
    LOG.warn("Restoring volume attachment state for " + this.getInstanceId() + " with "+ v.toString());
    this.addVolumeAttachment(v);
  }
}
