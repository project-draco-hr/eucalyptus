{
  LoadBalancer lb;
  try {
    lb=LoadBalancers.getLoadbalancer(evt.getContext(),evt.getLoadBalancer());
  }
 catch (  NoSuchElementException ex) {
    throw new EventHandlerException("Could not find the loadbalancer with name=" + evt.getLoadBalancer(),ex);
  }
catch (  Exception ex) {
    throw new EventHandlerException("Error while looking for loadbalancer with name=" + evt.getLoadBalancer(),ex);
  }
  group=lb.getAutoScaleGroup();
  if (group == null) {
    LOG.warn(String.format("No autoscaling group found for %s-%s",evt.getContext().getUserFullName(),evt.getLoadBalancer()));
    return;
  }
 else {
    this.groupName=group.getName();
    final List<LoadBalancerZoneCoreView> currentZones=Lists.newArrayList(Collections2.filter(lb.getZones(),new Predicate<LoadBalancerZoneCoreView>(){
      @Override public boolean apply(      @Nullable LoadBalancerZoneCoreView arg0){
        return arg0.getState().equals(LoadBalancerZone.STATE.InService);
      }
    }
));
    final List<String> availableZones=Lists.newArrayList(Collections2.transform(currentZones,new Function<LoadBalancerZoneCoreView,String>(){
      @Override public String apply(      @Nullable LoadBalancerZoneCoreView arg0){
        return arg0.getName();
      }
    }
));
    final List<String> updatedZones=Lists.newArrayList();
    updatedZones.addAll(availableZones);
    for (    final String req : evt.getZones()) {
      updatedZones.remove(req);
    }
    try {
      int capacityPerZone=Integer.parseInt(EventHandlerChainNew.VM_PER_ZONE);
      if (capacityPerZone <= 0)       capacityPerZone=1;
      final int newCapacity=capacityPerZone * updatedZones.size();
      EucalyptusActivityTasks.getInstance().updateAutoScalingGroup(this.groupName,updatedZones,newCapacity);
      this.beforeUpdate=availableZones;
      this.afterUpdate=updatedZones;
      LoadBalancerAutoScalingGroup scaleGroup;
      try {
        scaleGroup=LoadBalancerAutoScalingGroupEntityTransform.INSTANCE.apply(this.group);
      }
 catch (      final Exception ex) {
        LOG.error("unable to transform autoscale group from the view",ex);
        throw ex;
      }
      try (final TransactionResource db=Entities.transactionFor(LoadBalancerAutoScalingGroup.class)){
        final LoadBalancerAutoScalingGroup update=Entities.uniqueResult(scaleGroup);
        update.setCapacity(newCapacity);
        Entities.persist(update);
        db.commit();
      }
 catch (      NoSuchElementException ex) {
        LOG.error("failed to find the autoscaling group record",ex);
      }
catch (      Exception ex) {
        LOG.error("failed to update the autoscaling group record",ex);
      }
    }
 catch (    final Exception ex) {
      throw new EventHandlerException("failed to update the autoscaling group",ex);
    }
  }
}
