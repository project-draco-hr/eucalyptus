{
  LOG.trace(this.getClass().getSimpleName() + "[incoming]: " + e);
  if (e instanceof ExceptionEvent) {
    this.exceptionCaught(ctx,(ExceptionEvent)e);
  }
 else   if (e instanceof MessageEvent) {
    this.startTime.compareAndSet(0l,System.currentTimeMillis());
    final MessageEvent event=(MessageEvent)e;
    if (event.getMessage() instanceof MappingHttpMessage) {
      final MappingHttpMessage request=(MappingHttpMessage)event.getMessage();
      final User user=Contexts.lookup(request.getCorrelationId()).getUser();
      final EucalyptusMessage msg=(EucalyptusMessage)request.getMessage();
      final String userAgent=request.getHeader(HttpHeaders.Names.USER_AGENT);
      if (msg.getCorrelationId() == null) {
        msg.setCorrelationId(UUID.randomUUID().toString());
      }
      if ((userAgent != null) && userAgent.matches(".*EucalyptusAdminAccess") && msg.getClass().getSimpleName().startsWith("Describe")) {
        msg.setEffectiveUserId(msg.getUserId());
      }
 else       if ((user != null) && (this.msgReceiver == null)) {
        msg.setUserId(user.getUserName());
        msg.setEffectiveUserId(user.getIsAdministrator() ? Component.eucalyptus.name() : user.getUserName());
      }
      LOG.trace(EventRecord.here(Component.eucalyptus,EventType.MSG_RECEIVED,msg.getClass().getSimpleName()));
      if (this.msgReceiver == null) {
        ServiceSinkHandler.dispatchRequest(msg);
      }
 else       if ((user == null) || ((user != null) && user.getIsAdministrator())) {
        this.dispatchRequest(ctx,request,msg);
      }
 else {
        ctx.getChannel().write(new MappingHttpResponse(request.getProtocolVersion(),HttpResponseStatus.FORBIDDEN));
      }
    }
 else     if (e instanceof IdleStateEvent) {
      LOG.warn("Closing idle connection: " + e);
      e.getFuture().addListener(ChannelFutureListener.CLOSE);
      ctx.sendUpstream(e);
    }
  }
}
