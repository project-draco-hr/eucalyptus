{
  LOG.trace(this.getClass().getSimpleName() + "[incoming]: " + e);
  if (e instanceof ExceptionEvent) {
    this.exceptionCaught(ctx,(ExceptionEvent)e);
  }
 else   if (e instanceof MessageEvent) {
    this.startTime.compareAndSet(0l,System.currentTimeMillis());
    final MessageEvent event=(MessageEvent)e;
    if (event.getMessage() instanceof MappingHttpMessage) {
      final MappingHttpMessage request=(MappingHttpMessage)event.getMessage();
      final User user=Contexts.lookup(request.getCorrelationId()).getUser();
      final BaseMessage msg=(BaseMessage)request.getMessage();
      final String userAgent=request.getHeader(HttpHeaders.Names.USER_AGENT);
      if (msg.getCorrelationId() == null) {
        String corrId=null;
        try {
          corrId=Contexts.lookup(ctx.getChannel()).getCorrelationId();
        }
 catch (        Exception e1) {
          corrId=UUID.randomUUID().toString();
        }
        msg.setCorrelationId(corrId);
      }
      if ((userAgent != null) && userAgent.matches(".*EucalyptusAdminAccess") && msg.getClass().getSimpleName().startsWith("Describe")) {
        msg.setEffectiveUserId(msg.getUserId());
      }
 else       if ((user != null) && (this.msgReceiver == null)) {
        msg.setUserId(user.getName());
        msg.setEffectiveUserId(user.isAdministrator() ? Component.eucalyptus.name() : user.getName());
      }
      EventRecord.here(ServiceSinkHandler.class,EventType.MSG_RECEIVED,msg.getClass().getSimpleName()).trace();
      if (this.msgReceiver == null) {
        ServiceSinkHandler.dispatchRequest(msg);
      }
 else       if ((user == null) || ((user != null) && user.isAdministrator())) {
        this.dispatchRequest(ctx,request,msg);
      }
 else {
        Contexts.clear(Contexts.lookup(msg.getCorrelationId()));
        ctx.getChannel().write(new MappingHttpResponse(request.getProtocolVersion(),HttpResponseStatus.FORBIDDEN));
      }
    }
 else     if (e instanceof IdleStateEvent) {
      LOG.warn("Closing idle connection: " + e);
      e.getFuture().addListener(ChannelFutureListener.CLOSE);
      ctx.sendUpstream(e);
    }
  }
}
