{
  HashMap<PutMetricDataAggregationKey,MetricQueueItem> aggregationMap=Maps.newHashMap();
  for (  MetricQueueItem item : dataBatch) {
    item.setTimestamp(MetricManager.stripSeconds(item.getTimestamp()));
    PutMetricDataAggregationKey key=new PutMetricDataAggregationKey(item);
    if (!aggregationMap.containsKey(key)) {
      aggregationMap.put(key,new MetricQueueItem(item));
    }
 else {
      MetricQueueItem totalSoFar=aggregationMap.get(key);
      totalSoFar.setSampleMax(Math.max(item.getSampleMax(),totalSoFar.getSampleMax()));
      totalSoFar.setSampleMin(Math.min(item.getSampleMin(),totalSoFar.getSampleMin()));
      totalSoFar.setSampleSize(totalSoFar.getSampleSize() + item.getSampleSize());
      totalSoFar.setSampleSum(totalSoFar.getSampleSum() + item.getSampleSum());
    }
  }
  return Lists.newArrayList(aggregationMap.values());
}
