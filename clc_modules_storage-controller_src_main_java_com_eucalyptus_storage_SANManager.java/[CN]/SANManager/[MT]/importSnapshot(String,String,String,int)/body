{
  String eucaHomeDir=System.getProperty("euca.home");
  if (eucaHomeDir == null) {
    throw new EucalyptusCloudException("euca.home not set");
  }
  EntityWrapper<SANVolumeInfo> db=StorageProperties.getEntityWrapper();
  try {
    db.getUnique(new SANVolumeInfo(snapshotId));
    throw new EucalyptusCloudException("Snapshot " + snapshotId + " already exists. Import failed.");
  }
 catch (  EucalyptusCloudException ex) {
  }
 finally {
    db.commit();
  }
  String iqn=connectionManager.createVolume(snapshotId,size);
  if (iqn != null) {
    String deviceName=connectionManager.connectTarget(iqn);
    try {
      SystemUtil.run(new String[]{eucaHomeDir + StorageProperties.EUCA_ROOT_WRAPPER,"dd","if=" + snapPath,"of=" + deviceName,"bs=" + StorageProperties.blockSize});
    }
 catch (    ExecutionException e) {
      LOG.error(e);
      throw new EucalyptusCloudException(e);
    }
 finally {
      connectionManager.disconnectTarget(snapshotId,iqn);
    }
    SANVolumeInfo volumeInfo=new SANVolumeInfo(snapshotId,iqn,size);
    volumeInfo.setSnapshotOf(volumeId);
    db=StorageProperties.getEntityWrapper();
    db.add(volumeInfo);
    db.commit();
  }
}
