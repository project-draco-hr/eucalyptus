{
  Accounts.addAccount("test");
  Users.addAccountAdmin("test","foobar");
  User tom=Users.addUser("tom","/",true,true,null,true,true,true,"test");
  User jack=Users.addUser("jack","/",true,true,null,true,true,true,"test");
  User chris=Users.addUser("chris","/",true,true,null,true,true,true,"test");
  Group sales=Groups.addGroup("sales","/","test");
  sales.addMember(tom);
  Group marketing=Groups.addGroup("marketing","/","test");
  marketing.addMember(jack);
  String policy="{" + "'Statement':[{" + "'Effect':'Allow',"+ "'Action':'ec2:RunInstances',"+ "'Resource':'arn:aws:ec2:::image/emi-1234*',"+ "'Condition':{"+ "'DateLessThanEquals':{"+ "'aws:currenttime':'2010-12-31'"+ "}"+ "}"+ "},"+ "{"+ "'Effect':'Deny',"+ "'Action':'ec2:RunInstances',"+ "'Resource':'arn:aws:ec2:::image/emi-12345678',"+ "}]"+ "}";
  Policies.attachGroupPolicy(policy,"sales","test");
  final User user=Users.lookupUserByName("tom","test");
  RequestContext.setAdaptor(new ContextAdaptor(){
    @Override public User getRequestUser(){
      return user;
    }
    @Override public Class<? extends BaseMessage> getRequestMessageClass(){
      return RunInstancesType.class;
    }
    @Override public SocketAddress getRemoteAddress(){
      return new InetSocketAddress("192.168.7.54",80808);
    }
  }
);
  PolicyEngine engine=new PolicyEngineImpl();
  engine.evaluateAuthorization(Image.class,"emi-12345678");
}
