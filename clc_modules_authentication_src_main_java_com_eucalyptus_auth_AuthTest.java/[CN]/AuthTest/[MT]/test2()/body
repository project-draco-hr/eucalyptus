{
  Accounts.addAccount("test");
  User admin=Users.addAccountAdmin("test");
  admin.setPassword("foobar");
  User tom=Users.addUser("tom","/",true,true,null,true,true,"test");
  User jack=Users.addUser("jack","/",true,true,null,true,true,"test");
  User chris=Users.addUser("chris","/",true,true,null,true,true,"test");
  Group sales=Groups.addGroup("sales","/","test");
  sales.addMember(tom);
  Group marketing=Groups.addGroup("marketing","/","test");
  marketing.addMember(jack);
  Keys.registerKey("ec2:test-quota",TestQuota.class);
  String policy="{" + "'Statement':[{" + "'Effect':'Allow',"+ "'Action':'ec2:RunInstances',"+ "'Resource':'arn:aws:ec2:::image/emi-1234*',"+ "'Condition':{"+ "'DateLessThanEquals':{"+ "'aws:currenttime':'2010-12-31'"+ "}"+ "}"+ "},"+ "{"+ "'Effect':'Limit',"+ "'Action':'*',"+ "'Resource':'arn:aws:ec2:::image/*',"+ "'Condition':{"+ "'NumericLessThanEquals':{"+ "'ec2:test-quota':'10'"+ "}"+ "}"+ "}]"+ "}";
  Policies.attachGroupPolicy(policy,"sales","test");
  final User user=Users.lookupUserByName("tom","test");
  PolicyEngine engine=new PolicyEngineImpl();
  engine.evaluateAuthorization(Image.class,"emi-12345678",user.getAccount().getAccountId(),new RunInstancesType(),user);
  engine.evaluateQuota(Image.class,"",1,new RunInstancesType(),user);
}
