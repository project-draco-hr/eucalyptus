{
  ListAllMyBucketsResponseType reply=(ListAllMyBucketsResponseType)request.getReply();
  Context ctx=Contexts.lookup();
  Account account=ctx.getAccount();
  if (account == null) {
    throw new AccessDeniedException("no such account");
  }
  EntityWrapper<BucketInfo> db=EntityWrapper.get(BucketInfo.class);
  try {
    ArrayList<BucketListEntry> buckets=new ArrayList<BucketListEntry>();
    if (ctx.hasAdministrativePrivileges() || Lookups.checkPrivilege(PolicySpec.S3_LISTALLMYBUCKETS,PolicySpec.VENDOR_S3,PolicySpec.S3_RESOURCE_BUCKET,PolicySpec.ALL_RESOURCE,account.getAccountNumber())) {
      BucketInfo searchBucket=new BucketInfo();
      searchBucket.setOwnerId(account.getAccountNumber());
      searchBucket.setHidden(false);
      List<BucketInfo> bucketInfoList=db.queryEscape(searchBucket);
      for (      BucketInfo bucketInfo : bucketInfoList) {
        try {
          if (bucketHasSnapshots(bucketInfo.getBucketName())) {
            continue;
          }
 else {
            buckets.add(new BucketListEntry(bucketInfo.getBucketName(),DateUtils.format(bucketInfo.getCreationDate().getTime(),DateUtils.ALT_ISO8601_DATE_PATTERN)));
          }
        }
 catch (        Exception e) {
          LOG.debug(e,e);
          continue;
        }
      }
      db.commit();
    }
 else {
      throw new AccessDeniedException("s3:listallmybuckets");
    }
    try {
      CanonicalUserType owner=new CanonicalUserType(account.getCanonicalId(),account.getName());
      ListAllMyBucketsList bucketList=new ListAllMyBucketsList();
      reply.setOwner(owner);
      bucketList.setBuckets(buckets);
      reply.setBucketList(bucketList);
    }
 catch (    Exception ex) {
      LOG.error(ex);
      throw new AccessDeniedException("Account: " + account.getName() + " not found",ex);
    }
  }
 catch (  EucalyptusCloudException e) {
    db.rollback();
    throw e;
  }
catch (  Exception e) {
    LOG.debug(e,e);
    db.rollback();
  }
  return reply;
}
