{
  String sanSnapshotId=resourceIdOnSan(snapshotId);
  String sanVolumeId=null;
  SANVolumeInfo snapInfo=new SANVolumeInfo(snapshotId);
  int size=-1;
  StorageResource storageResource=null;
  try (TransactionResource tran=Entities.transactionFor(SANVolumeInfo.class)){
    try {
      SANVolumeInfo volumeInfo=Entities.uniqueResult(new SANVolumeInfo(volumeId));
      if (volumeInfo == null || StringUtils.isBlank(volumeInfo.getSanVolumeId())) {
        throw new EucalyptusCloudException("Backend ID not found for " + volumeId);
      }
      sanVolumeId=volumeInfo.getSanVolumeId();
      size=volumeInfo.getSize();
    }
 catch (    TransactionException|NoSuchElementException ex) {
      LOG.error(volumeId + ": Failed to lookup source volume entity",ex);
      throw new EucalyptusCloudException("Failed to lookup source volume entity for " + volumeId,ex);
    }
    try {
      SANVolumeInfo existingSnap=Entities.uniqueResult(snapInfo);
      if (connectionManager.snapshotExists(existingSnap.getSanVolumeId())) {
        throw new VolumeAlreadyExistsException("Snapshot already exists on storage backend for " + snapshotId);
      }
 else {
        LOG.debug(snapshotId + ": Found the database entity but the snapshot does not exist on SAN. Deleting the database entity");
        Entities.delete(existingSnap);
        tran.commit();
      }
    }
 catch (    TransactionException|VolumeAlreadyExistsException ex) {
      throw new EucalyptusCloudException(ex);
    }
catch (    NoSuchElementException ex) {
    }
  }
   try {
    Transactions.save(snapInfo.withSanVolumeId(sanSnapshotId).withSize(size).withSnapshotOf(volumeId));
  }
 catch (  Exception ex) {
    LOG.error(snapshotId + ": Failed to add database entity" + snapshotId,ex);
    throw new EucalyptusCloudException("Failed to add database entity for " + snapshotId,ex);
  }
  LOG.info("Creating backend snapshot " + sanSnapshotId + " mapping to "+ snapshotId+ " from backend volume "+ sanVolumeId+ " mapping to "+ volumeId+ " using snapshot point "+ snapshotPointId);
  String iqn=connectionManager.createSnapshot(sanVolumeId,sanSnapshotId,snapshotPointId);
  if (iqn != null) {
    if (shouldTransferSnapshots) {
      String scIqn=StorageProperties.getStorageIqn();
      if (scIqn == null) {
        throw new EucalyptusCloudException("Could not get the SC's initiator IQN, found null.");
      }
      String lun=null;
      try {
        LOG.info("Exporting backend snapshot holder " + sanSnapshotId + " mapping to "+ snapshotId+ " to SC host IQN "+ scIqn);
        lun=connectionManager.exportResource(sanSnapshotId,scIqn);
      }
 catch (      EucalyptusCloudException attEx) {
        LOG.debug("Failed to setup attachment for snapshot " + snapshotId + " to SC",attEx);
        throw new EucalyptusCloudException("Could not setup snapshot volume " + snapshotId + " to SC because of error in attach prep",attEx);
      }
      if (lun == null) {
        throw new EucalyptusCloudException("Failed to export backend snapshot holder " + sanSnapshotId + " mapping to "+ snapshotId+ " to SC host IQN "+ scIqn);
      }
      try (TransactionResource tran=Entities.transactionFor(SANVolumeInfo.class)){
        SANVolumeInfo existingSnap=Entities.uniqueResult(snapInfo);
        existingSnap.setIqn(iqn + ',' + lun);
        Entities.merge(existingSnap);
        tran.commit();
      }
 catch (      Exception ex) {
        LOG.error(snapshotId + ": Failed to update database entity with IQN and LUN post snapshot creation");
        throw new EucalyptusCloudException("Failed to update database entity with IQN and LUN post snapshot creation for " + snapshotId,ex);
      }
      try {
        storageResource=connectionManager.connectTarget(iqn,lun);
        storageResource.setId(snapshotId);
      }
 catch (      Exception connEx) {
        LOG.debug("Failed to connect SC to snapshot volume on SAN for snapshot " + snapshotId + ". Detaching and cleaning up.");
        try {
          LOG.info("Unexporting backend snapshot holder " + sanSnapshotId + " mapping to "+ snapshotId+ " from SC host IQN "+ scIqn);
          connectionManager.unexportResource(sanSnapshotId,scIqn);
        }
 catch (        EucalyptusCloudException detEx) {
          LOG.debug("Could not detach snapshot volume " + snapshotId + " during cleanup of failed connection");
        }
        throw new EucalyptusCloudException("Could not connect SC to target snapshot for snapshot upload",connEx);
      }
    }
 else {
      try (TransactionResource tran=Entities.transactionFor(SANVolumeInfo.class)){
        SANVolumeInfo existingSnap=Entities.uniqueResult(snapInfo);
        existingSnap.setIqn(iqn);
        Entities.merge(existingSnap);
        tran.commit();
      }
 catch (      Exception ex) {
        LOG.error(snapshotId + ": Failed to update database entity with IQN post snapshot creation");
        throw new EucalyptusCloudException("Failed to update database entity with IQN post snapshot creation for " + snapshotId,ex);
      }
    }
  }
 else {
    throw new EucalyptusCloudException("Unable to create snapshot: " + snapshotId + " from volume: "+ volumeId);
  }
  return storageResource;
}
