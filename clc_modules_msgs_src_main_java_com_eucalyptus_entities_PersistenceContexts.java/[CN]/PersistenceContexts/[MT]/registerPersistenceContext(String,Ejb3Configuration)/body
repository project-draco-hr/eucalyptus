{
synchronized (PersistenceContexts.class) {
    if (illegalAccesses != null && !illegalAccesses.isEmpty()) {
      for (      Exception e : illegalAccesses) {
        LOG.fatal(e,e);
      }
      LogUtil.header("Illegal Access to Persistence Context.  Database not yet configured. This is always a BUG: " + persistenceContext);
      System.exit(1);
    }
 else     if (!emf.containsKey(persistenceContext)) {
      illegalAccesses=null;
      EntityManagerFactoryImpl entityManagerFactory=(EntityManagerFactoryImpl)config.buildEntityManagerFactory();
      LOG.info("-> Setting up persistence context for : " + persistenceContext);
      LOG.info(LogUtil.subheader(LogUtil.dumpObject(config)));
      emf.put(persistenceContext,entityManagerFactory);
    }
    return emf.get(persistenceContext);
  }
}
