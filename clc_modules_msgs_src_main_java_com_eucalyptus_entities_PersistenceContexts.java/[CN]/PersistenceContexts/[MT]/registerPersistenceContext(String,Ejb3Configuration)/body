{
synchronized (PersistenceContexts.class) {
    if (illegalAccesses != null && !illegalAccesses.isEmpty()) {
      for (      Exception e : illegalAccesses) {
        LOG.fatal(e,e);
      }
      LOG.error(Threads.currentStackString());
      LOG.error(LogUtil.header("Illegal Access to Persistence Context.  Database not yet configured. This is always a BUG: " + persistenceContext));
    }
 else     if (!emf.containsKey(persistenceContext)) {
      illegalAccesses=null;
      LOG.trace("-> Setting up persistence context for : " + persistenceContext);
      EntityManagerFactoryImpl entityManagerFactory=(EntityManagerFactoryImpl)config.buildEntityManagerFactory();
      LOG.trace(LogUtil.subheader(LogUtil.dumpObject(config)));
      emf.put(persistenceContext,entityManagerFactory);
    }
    return emf.get(persistenceContext);
  }
}
