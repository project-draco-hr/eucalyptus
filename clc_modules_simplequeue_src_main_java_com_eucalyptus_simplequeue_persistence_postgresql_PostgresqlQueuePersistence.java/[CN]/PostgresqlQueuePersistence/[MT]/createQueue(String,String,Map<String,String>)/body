{
  try (TransactionResource db=Entities.transactionFor(QueueEntity.class)){
    Criteria criteria=Entities.createCriteria(QueueEntity.class).add(Restrictions.eq("accountId",accountId)).add(Restrictions.eq("queueName",queueName));
    QueueEntity queueEntity=(QueueEntity)criteria.uniqueResult();
    if (queueEntity == null) {
      queueEntity=new QueueEntity();
      queueEntity.setAccountId(accountId);
      queueEntity.setQueueName(queueName);
      queueEntity.setAttributes(convertAttributeMapToJson(attributes));
      Entities.persist(queueEntity);
      db.commit();
      return queueFromQueueEntity(queueEntity);
    }
 else {
      throw new QueueAlreadyExistsException("Queue " + queueName + " already exists");
    }
  }
 }
