{
  ClusterState clusterState=Clusters.getInstance().lookup(clusterName).getState();
  Network existingNet=Networks.getInstance().lookup(networkName);
  NetworkToken networkToken=clusterState.getNetworkAllocation(userId,existingNet.getNetworkName());
  LOG.info(String.format(EucalyptusProperties.DEBUG_FSTRING,EucalyptusProperties.TokenState.preallocate,networkToken));
  if (existingNet.hasToken(networkToken.getCluster())) {
    LOG.info(String.format(EucalyptusProperties.DEBUG_FSTRING,EucalyptusProperties.TokenState.returned,networkToken));
    clusterState.releaseNetworkAllocation(networkToken);
    throw new NetworkAlreadyExistsException();
  }
 else {
    LOG.info(String.format(EucalyptusProperties.DEBUG_FSTRING,EucalyptusProperties.TokenState.accepted,networkToken));
    existingNet.addTokenIfAbsent(networkToken);
    return networkToken;
  }
}
