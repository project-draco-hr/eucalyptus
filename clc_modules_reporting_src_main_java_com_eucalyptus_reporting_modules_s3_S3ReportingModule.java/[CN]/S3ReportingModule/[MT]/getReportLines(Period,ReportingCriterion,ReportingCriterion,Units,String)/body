{
  Map<S3ReportLineKey,S3ReportLine> reportLineMap=new HashMap<S3ReportLineKey,S3ReportLine>();
  S3UsageLog usageLog=S3UsageLog.getS3UsageLog();
  Map<S3SummaryKey,S3UsageSummary> usageMap=usageLog.getUsageSummaryMap(period,accountId);
  for (  S3SummaryKey key : usageMap.keySet()) {
    Log.info("Adding key:" + key + " data:"+ usageMap.get(key));
    String critVal=getAttributeValue(crit,key);
    String groupVal=(groupByCrit == null) ? null : getAttributeValue(groupByCrit,key);
    S3ReportLineKey lineKey=new S3ReportLineKey(critVal,groupVal);
    if (!reportLineMap.containsKey(lineKey)) {
      reportLineMap.put(lineKey,new S3ReportLine(lineKey,new S3UsageSummary(),displayUnits));
    }
    S3ReportLine reportLine=reportLineMap.get(lineKey);
    S3UsageSummary summary=usageMap.get(key);
    reportLine.addUsage(summary);
  }
  final List<S3ReportLine> results=new ArrayList<S3ReportLine>();
  for (  S3ReportLineKey lineKey : reportLineMap.keySet()) {
    results.add(reportLineMap.get(lineKey));
  }
  Collections.sort(results);
  return results;
}
