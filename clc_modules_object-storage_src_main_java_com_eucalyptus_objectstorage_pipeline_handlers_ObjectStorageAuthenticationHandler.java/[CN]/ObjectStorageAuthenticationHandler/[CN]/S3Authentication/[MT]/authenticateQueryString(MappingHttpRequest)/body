{
  Map<String,String> parameters=httpRequest.getParameters();
  String verb=httpRequest.getMethod().getName();
  String content_md5=httpRequest.getHeader("Content-MD5");
  content_md5=content_md5 == null ? "" : content_md5;
  String content_type=httpRequest.getHeader(HttpHeaders.Names.CONTENT_TYPE);
  content_type=content_type == null ? "" : content_type;
  String addrString=getS3AddressString(httpRequest,true);
  String accesskeyid=parameters.remove(SecurityParameter.AWSAccessKeyId.toString());
  try {
    String signature=parameters.remove(SecurityParameter.Signature.toString());
    if (signature == null) {
      throw new InvalidSecurityException("No signature found");
    }
    String expires=parameters.remove(SecurityParameter.Expires.toString());
    if (expires == null) {
      throw new InvalidSecurityException("Expiration parameter must be specified.");
    }
    String securityToken=parameters.get(SecurityParameter.SecurityToken.toString());
    if (checkExpires(expires)) {
      String canonicalizedAmzHeaders=getCanonicalizedAmzHeaders(httpRequest);
      String stringToSign=verb + "\n" + content_md5+ "\n"+ content_type+ "\n"+ Long.parseLong(expires)+ "\n"+ canonicalizedAmzHeaders+ addrString;
      try {
        SecurityContext.getLoginContext(new ObjectStorageWrappedCredentials(httpRequest.getCorrelationId(),stringToSign,accesskeyid,signature,securityToken)).login();
      }
 catch (      Exception ex) {
        if (httpRequest.getUri().startsWith(ComponentIds.lookup(ObjectStorage.class).getServicePath())) {
          try {
            String modifiedAddrString=getS3AddressString(httpRequest,false);
            stringToSign=verb + "\n" + content_md5+ "\n"+ content_type+ "\n"+ Long.parseLong(expires)+ "\n"+ canonicalizedAmzHeaders+ modifiedAddrString;
            SecurityContext.getLoginContext(new ObjectStorageWrappedCredentials(httpRequest.getCorrelationId(),stringToSign,accesskeyid,signature,securityToken)).login();
          }
 catch (          Exception ex2) {
            LOG.error("CorrelationId: " + httpRequest.getCorrelationId() + " authentication failed due to signature mismatch:",ex2);
            throw new SignatureDoesNotMatchException(stringToSign);
          }
        }
 else {
          LOG.error("CorrelationId: " + httpRequest.getCorrelationId() + " authentication failed due to signature mismatch:",ex);
          throw new SignatureDoesNotMatchException(stringToSign);
        }
      }
    }
 else {
      throw new AccessDeniedException("Cannot process request. Expired.");
    }
  }
 catch (  Exception ex) {
    throw new AccessDeniedException("Could not verify request " + ex.getMessage());
  }
}
