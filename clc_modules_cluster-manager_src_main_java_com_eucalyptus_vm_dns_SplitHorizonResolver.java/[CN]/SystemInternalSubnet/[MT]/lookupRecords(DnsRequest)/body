{
  final Record query=request.getQuery();
  try {
    if (RequestType.PTR.apply(query)) {
      final InetAddress ip=DomainNameRecords.inAddrArpaToInetAddress(query.getName());
      if (InstanceDomainNames.isInstance(ip)) {
        final String hostAddress=ip.getHostAddress();
        if (VmInstances.privateIpInUse(hostAddress)) {
          final Name dnsName=InstanceDomainNames.fromInetAddress(InstanceDomainNames.INTERNAL,ip);
          return DnsResponse.forName(query.getName()).answer(DomainNameRecords.ptrRecord(dnsName,ip));
        }
 else         if (VmInstances.lookupByPublicIp(hostAddress) != null) {
          final Name dnsName=InstanceDomainNames.fromInetAddress(InstanceDomainNames.EXTERNAL,ip);
          return DnsResponse.forName(query.getName()).answer(DomainNameRecords.ptrRecord(dnsName,ip));
        }
      }
    }
  }
 catch (  final Exception ex) {
    LOG.debug(ex);
  }
  return DnsResponse.forName(query.getName()).nxdomain();
}
