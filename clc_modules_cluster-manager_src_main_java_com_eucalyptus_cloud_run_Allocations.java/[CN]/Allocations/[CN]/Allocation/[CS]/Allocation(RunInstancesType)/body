{
  super();
  this.context=Contexts.lookup();
  this.instanceIds=Maps.newHashMap();
  this.request=request;
  this.minCount=request.getMinCount();
  this.maxCount=request.getMaxCount();
  this.ownerFullName=this.context.getUserFullName();
  if ((this.request.getInstanceType() == null) || "".equals(this.request.getInstanceType())) {
    this.request.setInstanceType(VmTypes.defaultTypeName());
  }
  this.reservationIndex=UniqueIds.nextIndex(VmInstance.class,(long)request.getMaxCount());
  this.reservationId=VmInstances.getId(this.reservationIndex,0).replaceAll("i-","r-");
  final byte[] tmpData=new byte[0];
  Contract<Date> expiry=this.getContext().getContracts().get(Contract.Type.EXPIRATION);
  this.expiration=(expiry == null ? new Date(32503708800000l) : expiry.getValue());
  if (this.request.getUserData() != null) {
    try {
      this.userData=Base64.decode(this.request.getUserData());
      this.request.setUserData(new String(Base64.encode(tmpData)));
    }
 catch (    final Exception e) {
    }
  }
 else {
    try {
      this.request.setUserData(new String(Base64.encode(tmpData)));
    }
 catch (    final Exception ex) {
      LOG.error(ex,ex);
    }
  }
}
