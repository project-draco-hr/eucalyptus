{
  PutGetImageInfo ret=null;
  String imageName=(imageNameArg != null) ? imageNameArg : manifest.getName();
  eki=(eki != null) ? eki : manifest.getKernelId();
  eki=(eki != null) ? eki : ImageConfiguration.getInstance().getDefaultKernelId();
  eri=(eri != null) ? eri : manifest.getRamdiskId();
  eri=(eri != null) ? eri : ImageConfiguration.getInstance().getDefaultRamdiskId();
  ImageMetadata.Architecture imageArch=(requestArch != null) ? requestArch : manifest.getArchitecture();
  ImageMetadata.Platform imagePlatform=manifest.getPlatform();
switch (manifest.getImageType()) {
case kernel:
    ret=new KernelImageInfo(creator,ImageUtil.newImageId(ImageMetadata.Type.kernel.getTypePrefix(),manifest.getImageLocation()),imageName,imageDescription,manifest.getSize(),imageArch,imagePlatform,manifest.getImageLocation(),manifest.getBundledSize(),manifest.getChecksum(),manifest.getChecksumType());
  break;
case ramdisk:
ret=new RamdiskImageInfo(creator,ImageUtil.newImageId(ImageMetadata.Type.ramdisk.getTypePrefix(),manifest.getImageLocation()),imageName,imageDescription,manifest.getSize(),imageArch,imagePlatform,manifest.getImageLocation(),manifest.getBundledSize(),manifest.getChecksum(),manifest.getChecksumType());
break;
case machine:
if (ImageMetadata.Platform.windows.equals(imagePlatform)) {
virtType=ImageMetadata.VirtualizationType.hvm;
}
if (ImageMetadata.VirtualizationType.hvm.equals(virtType)) {
eki=null;
eri=null;
}
ret=new MachineImageInfo(creator,ImageUtil.newImageId(ImageMetadata.Type.machine.getTypePrefix(),manifest.getImageLocation()),imageName,imageDescription,manifest.getSize(),imageArch,imagePlatform,manifest.getImageLocation(),manifest.getBundledSize(),manifest.getChecksum(),manifest.getChecksumType(),eki,eri,virtType);
break;
}
if (ret == null) {
throw new IllegalArgumentException("Failed to prepare image using the provided image manifest: " + manifest);
}
 else {
ret.setSignature(manifest.getSignature());
ret.setState(ImageMetadata.State.available);
EntityWrapper<PutGetImageInfo> db=EntityWrapper.get(PutGetImageInfo.class);
try {
ret=db.merge(ret);
db.commit();
LOG.info("Registering image pk=" + ret.getDisplayName() + " ownerId="+ creator);
}
 catch (Exception e) {
db.rollback();
throw new EucalyptusCloudException("Failed to register image: " + manifest + " because of: "+ e.getMessage(),e);
}
maybeUpdateDefault(ret);
LOG.info("Triggering cache population in Walrus for: " + ret.getDisplayName());
if (ret instanceof ImageMetadata.StaticDiskImage) {
WalrusUtil.triggerCaching((StaticDiskImage)ret);
}
return ret;
}
}
