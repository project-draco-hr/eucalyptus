{
  Context ctx=Contexts.lookup();
  Image.Architecture imageArch=Image.Architecture.x86_64;
  Image.Platform imagePlatform=Image.Platform.linux;
  BlockDeviceMappingItemType rootBlockDevice=Iterables.find(blockDeviceMappings,findEbsRoot(rootDeviceName));
  String snapshotId=rootBlockDevice.getEbs().getSnapshotId();
  try {
    Snapshot snap=Snapshots.lookup(userFullName,snapshotId);
    if (!userFullName.getUserId().equals(snap.getOwnerUserId())) {
      throw new EucalyptusCloudException("Failed to create image from specified block device mapping: " + rootBlockDevice + " because of: you must the owner of the source snapshot.");
    }
    Integer snapVolumeSize=snap.getVolumeSize();
    Integer suppliedVolumeSize=(rootBlockDevice.getEbs().getVolumeSize() != null) ? rootBlockDevice.getEbs().getVolumeSize() : -1;
    suppliedVolumeSize=(suppliedVolumeSize == null) ? rootBlockDevice.getSize() : suppliedVolumeSize;
    Integer targetVolumeSizeGB=(snapVolumeSize <= suppliedVolumeSize) ? suppliedVolumeSize : snapVolumeSize;
    Long imageSizeBytes=targetVolumeSizeGB * 1024l * 1024l* 1024l;
    Boolean targetDeleteOnTermination=Boolean.TRUE.equals(rootBlockDevice.getEbs().getDeleteOnTermination());
    String imageId=generateImageId(Image.Type.machine.getTypePrefix(),snapshotId);
    BlockStorageImageInfo ret=new BlockStorageImageInfo(userFullName,imageId,imageName,imageDescription,imageSizeBytes,imageArch,imagePlatform,eki,eri,snap.getDisplayName(),targetDeleteOnTermination);
    EntityWrapper<BlockStorageImageInfo> db=EntityWrapper.get(BlockStorageImageInfo.class);
    try {
      ret=db.merge(ret);
      ret.getDeviceMappings().addAll(Lists.transform(blockDeviceMappings,Images.deviceMappingGenerator(ret)));
      ret.setState(Image.State.available);
      db.commit();
      LOG.info("Registering image pk=" + ret.getDisplayName() + " ownerId="+ userFullName);
    }
 catch (    Exception e) {
      db.rollback();
      throw new EucalyptusCloudException("Failed to register image using snapshot: " + snapshotId + " because of: "+ e.getMessage(),e);
    }
    return ret;
  }
 catch (  TransactionFireException ex) {
    throw new EucalyptusCloudException("Failed to create image from specified block device mapping: " + rootBlockDevice + " because of: "+ ex.getMessage());
  }
catch (  ExecutionException ex) {
    LOG.error(ex,ex);
    throw new EucalyptusCloudException("Failed to create image from specified block device mapping: " + rootBlockDevice + " because of: "+ ex.getMessage());
  }
}
