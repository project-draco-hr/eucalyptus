{
  if (bdms != null) {
    Set<BlockDeviceMappingItemType> bdmset=new HashSet<BlockDeviceMappingItemType>();
    int ephemeralCount=0;
    for (    BlockDeviceMappingItemType bdm : bdms) {
      checkParam(bdm,notNullValue());
      checkParam(bdm.getDeviceName(),notNullValue());
      if (!bdmset.add(bdm)) {
        throw Exceptions.toUndeclared(new MetadataException(bdm.getDeviceName() + " is assigned multiple times"));
      }
 else       if (bdm.getDeviceName().matches(".*\\d\\Z")) {
        throw Exceptions.toUndeclared(new MetadataException(bdm.getDeviceName() + " is not supported. Device name cannot be a partition"));
      }
 else       if (bdm.getNoDevice() != null && bdm.getNoDevice()) {
        if (isSuppressMappingValid != null && isSuppressMappingValid) {
          continue;
        }
 else {
          throw Exceptions.toUndeclared(new MetadataException("Block device mapping for " + bdm.getDeviceName() + " cannot be suppressed"));
        }
      }
 else       if (StringUtils.isNotBlank(bdm.getVirtualName())) {
        if (bdm.getVirtualName().matches("ephemeral[0123]")) {
          ephemeralCount++;
          if (ephemeralCount > 1) {
            throw Exceptions.toUndeclared(new MetadataException("Only one ephemeral device is supported. More than one ephemeral device mappings found"));
          }
 else {
            continue;
          }
        }
 else {
          throw Exceptions.toUndeclared(new MetadataException("Virtual device name must be of the form ephemeral[0123]. Fix the mapping for " + bdm.getDeviceName()));
        }
      }
 else       if (null != bdm.getEbs()) {
        if (isEbsMappingValid != null && isEbsMappingValid) {
          EbsDeviceMapping ebsInfo=bdm.getEbs();
          if (ebsInfo.getSnapshotId() != null) {
            Snapshot snap;
            try {
              snap=Transactions.find(Snapshot.named(null,ebsInfo.getSnapshotId()));
            }
 catch (            Exception ex) {
              LOG.error("Failed to find snapshot " + ebsInfo.getSnapshotId(),ex);
              throw Exceptions.toUndeclared(new MetadataException("Unable to find snapshot " + ebsInfo.getSnapshotId() + " in the block device mapping for "+ bdm.getDeviceName()));
            }
            if (ebsInfo.getVolumeSize() != null && ebsInfo.getVolumeSize() < snap.getVolumeSize()) {
              throw Exceptions.toUndeclared(new MetadataException("Size of the volume cannot be smaller than the source snapshot for " + bdm.getDeviceName()));
            }
            continue;
          }
 else           if (ebsInfo.getVolumeSize() != null && ebsInfo.getVolumeSize() == 0) {
            throw Exceptions.toUndeclared(new MetadataException("Volume size for " + bdm.getDeviceName() + " cannot be 0"));
          }
        }
 else {
          throw Exceptions.toUndeclared(new MetadataException("Ebs block device mappings are not supported"));
        }
      }
 else {
        throw Exceptions.toUndeclared(new MetadataException("Incorrectly constructed block device mapping for " + bdm.getDeviceName() + " . Refer to documentation"));
      }
    }
  }
  return Boolean.TRUE;
}
