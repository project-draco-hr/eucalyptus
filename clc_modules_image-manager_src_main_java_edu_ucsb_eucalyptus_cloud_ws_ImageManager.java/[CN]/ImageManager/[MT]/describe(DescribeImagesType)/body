{
  DescribeImagesResponseType reply=(DescribeImagesResponseType)request.getReply();
  ArrayList<String> remList=Lists.newArrayList();
  EntityWrapper<ImageInfo> db=new EntityWrapper<ImageInfo>();
  List<ImageInfo> imgList=Lists.newArrayList();
  try {
    imgList=db.query(ImageInfo.deregistered());
    for (    ImageInfo deregImg : imgList)     db.delete(deregImg);
    db.commit();
  }
 catch (  Throwable e1) {
    db.rollback();
  }
  db=new EntityWrapper<ImageInfo>();
  UserInfo user=null;
  try {
    user=db.recast(UserInfo.class).getUnique(new UserInfo(request.getUserId()));
    db.commit();
  }
 catch (  Throwable e) {
    db.commit();
    throw new EucalyptusCloudException("Failed to find user information for: " + request.getUserId(),e);
  }
  ArrayList<String> imageList=request.getImagesSet();
  ArrayList<String> owners=request.getOwnersSet();
  ArrayList<String> executable=request.getExecutableBySet();
  if (owners.isEmpty() && executable.isEmpty()) {
    executable.add("self");
  }
  Set<ImageDetails> repList=Sets.newHashSet();
  if (!owners.isEmpty()) {
    repList.addAll(ImageUtil.getImagesByOwner(imgList,user,owners));
  }
  if (!executable.isEmpty()) {
    if (executable.remove("self")) {
      repList.addAll(ImageUtil.getImageOwnedByUser(imgList,user));
    }
    repList.addAll(ImageUtil.getImagesByExec(user,executable));
  }
  if (!imageList.isEmpty()) {
    ArrayList<ImageDetails> newList=Lists.newArrayList();
    for (    ImageDetails img : repList) {
      if (imageList.contains(img.getImageId())) {
        newList.add(img);
      }
    }
    reply.setImagesSet(newList);
  }
  return reply;
}
