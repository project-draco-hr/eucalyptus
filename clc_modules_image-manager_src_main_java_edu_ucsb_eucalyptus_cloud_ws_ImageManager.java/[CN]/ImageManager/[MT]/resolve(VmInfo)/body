{
  String walrusUrl=ImageUtil.getWalrusUrl();
  ArrayList<String> productCodes=Lists.newArrayList();
  ImageInfo diskInfo=null, kernelInfo=null, ramdiskInfo=null;
  String diskUrl=null, kernelUrl=null, ramdiskUrl=null;
  EntityWrapper<ImageInfo> db=new EntityWrapper<ImageInfo>();
  try {
    diskInfo=db.getUnique(ImageInfo.named(vmInfo.getImageId()));
    for (    ProductCode p : diskInfo.getProductCodes()) {
      productCodes.add(p.getValue());
    }
    diskUrl=ImageUtil.getImageUrl(walrusUrl,diskInfo);
    db.commit();
  }
 catch (  EucalyptusCloudException e) {
    db.rollback();
  }
  VmImageInfo vmImgInfo=new VmImageInfo(vmInfo.getImageId(),vmInfo.getKernelId(),vmInfo.getRamdiskId(),diskUrl,null,null,productCodes);
  ArrayList<String> ancestorIds=ImageUtil.getAncestors(vmInfo.getOwnerId(),diskInfo.getImageLocation());
  vmImgInfo.setAncestorIds(ancestorIds);
  return vmImgInfo;
}
