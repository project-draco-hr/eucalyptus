{
  final Collection<LoadBalancerListenerCoreView> listeners=lb.getListeners();
  LoadBalancerListenerCoreView listener=null;
  for (  final LoadBalancerListenerCoreView l : listeners) {
    if (l.getLoadbalancerPort() == lbPort) {
      listener=l;
      break;
    }
  }
  if (listener == null)   throw new ListenerNotFoundException();
  if (!(PROTOCOL.HTTPS.equals(listener.getProtocol()) || PROTOCOL.SSL.equals(listener.getProtocol())))   throw new InvalidConfigurationRequestException("Listener's protocol is not HTTPS or SSL");
  try {
    final String acctNumber=lb.getOwnerAccountNumber();
    final String prefix=String.format("arn:aws:iam::%s:server-certificate",acctNumber);
    if (!certArn.startsWith(prefix))     throw new CertificateNotFoundException();
    final String pathAndName=certArn.replace(prefix,"");
    final String certName=pathAndName.substring(pathAndName.lastIndexOf("/") + 1);
    final ServerCertificateType cert=EucalyptusActivityTasks.getInstance().getServerCertificate(lb.getOwnerUserId(),certName);
    if (cert == null)     throw new CertificateNotFoundException();
    if (!certArn.equals(cert.getServerCertificateMetadata().getArn()))     throw new CertificateNotFoundException();
  }
 catch (  final Exception ex) {
    throw new CertificateNotFoundException();
  }
  final EntityTransaction db=Entities.get(LoadBalancerListener.class);
  try {
    final LoadBalancerListener update=Entities.uniqueResult(LoadBalancerListener.named(lb,lbPort));
    update.setSSLCertificateId(certArn);
    Entities.persist(update);
    db.commit();
  }
 catch (  final NoSuchElementException ex) {
    db.rollback();
    throw new ListenerNotFoundException();
  }
catch (  final Exception ex) {
    db.rollback();
    throw Exceptions.toUndeclared(ex);
  }
 finally {
    if (db.isActive())     db.rollback();
  }
}
