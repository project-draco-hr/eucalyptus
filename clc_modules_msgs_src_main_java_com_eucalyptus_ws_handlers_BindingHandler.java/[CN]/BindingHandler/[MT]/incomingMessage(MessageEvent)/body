{
  if (event.getMessage() instanceof MappingHttpMessage) {
    MappingHttpMessage httpMessage=(MappingHttpMessage)event.getMessage();
    BaseMessage msg=null;
    Class msgType=null;
    String namespace=null;
    try {
      OMElement elem=httpMessage.getOmMessage();
      OMNamespace omNs=elem.getNamespace();
      namespace=omNs.getNamespaceURI();
      if (!namespacePattern.matcher(namespace).matches()) {
        throw new WebServicesException("Invalid request");
      }
      this.binding=BindingManager.getBinding(BindingManager.sanitizeNamespace(namespace));
      msgType=this.binding.getElementClass(httpMessage.getOmMessage().getLocalName());
    }
 catch (    BindingException ex) {
      if (this.defaultBinding != null) {
        this.namespace=namespace;
        this.binding=this.defaultBinding;
        try {
          msgType=this.binding.getElementClass(httpMessage.getOmMessage().getLocalName());
        }
 catch (        Exception ex1) {
          throw new WebServicesException("Failed to find binding for namespace: " + namespace + " due to: "+ ex.getMessage(),ex);
        }
      }
    }
catch (    Exception e1) {
      LOG.error(e1.getMessage() + " while attempting to bind: " + httpMessage.getOmMessage());
      Logs.extreme().error(httpMessage.getSoapEnvelope().toString(),e1);
      if (this.binding == null) {
        throw new WebServicesException(e1);
      }
 else {
        throw new WebServicesException("Failed to find binding for namespace: " + namespace + " due to: "+ e1.getMessage(),e1);
      }
    }
    try {
      if (httpMessage instanceof MappingHttpRequest) {
        if (msgType != null) {
          msg=(BaseMessage)this.binding.fromOM(httpMessage.getOmMessage(),msgType);
        }
 else {
          msg=(BaseMessage)this.binding.fromOM(httpMessage.getOmMessage());
        }
      }
 else {
        msg=(BaseMessage)this.binding.fromOM(httpMessage.getOmMessage());
      }
    }
 catch (    Exception e1) {
      try {
        msg=(BaseMessage)this.binding.fromOM(httpMessage.getOmMessage(),this.namespace);
      }
 catch (      Exception ex) {
        LOG.warn("FAILED TO PARSE:\n" + httpMessage.getMessageString());
        throw new WebServicesException(e1);
      }
    }
    msg.setCorrelationId(httpMessage.getCorrelationId());
    httpMessage.setMessage(msg);
  }
}
