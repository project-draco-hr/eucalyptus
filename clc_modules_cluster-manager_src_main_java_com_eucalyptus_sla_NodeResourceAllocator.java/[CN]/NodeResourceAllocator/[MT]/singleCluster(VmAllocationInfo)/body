{
  RunInstancesType request=vmInfo.getRequest();
  String clusterName=request.getAvailabilityZone();
  try {
    Cluster cluster=Clusters.getInstance().lookup(clusterName);
    ClusterNodeState clusterState=cluster.getNodeState();
    int available=clusterState.getAvailability(request.getInstanceType()).getAvailable();
    if (available < request.getMinCount()) {
      throw new NotEnoughResourcesAvailable("Not enough resources: vm resources in the requested cluster " + clusterName);
    }
    int count=available > request.getMaxCount() ? request.getMaxCount() : available;
    ResourceToken token=clusterState.getResourceAllocation(request.getCorrelationId(),request.getUserId(),request.getInstanceType(),count);
    vmInfo.getAllocationTokens().add(token);
  }
 catch (  NoSuchElementException e) {
    throw new NotEnoughResourcesAvailable("Not enough resources: request cluster does not exist " + clusterName);
  }
}
