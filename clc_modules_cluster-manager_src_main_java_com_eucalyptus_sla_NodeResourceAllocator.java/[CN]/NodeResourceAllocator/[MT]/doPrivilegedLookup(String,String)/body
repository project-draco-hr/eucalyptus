{
  if ("default".equals(clusterName)) {
    Group group=Contexts.lookup().getGroups().get(0);
    Iterable<Cluster> authorizedClusters=Iterables.filter(Clusters.getInstance().listValues(),new Predicate<Cluster>(){
      @Override public boolean apply(      final Cluster c){
        return Iterables.any(Contexts.lookup().getAuthorizations(),new Predicate<Authorization>(){
          @Override public boolean apply(          Authorization arg0){
            return arg0.check(new AvailabilityZonePermission(c.getName()));
          }
        }
);
      }
    }
);
    Multimap<VmTypeAvailability,Cluster> sorted=Multimaps.newTreeMultimap();
    for (    Cluster c : authorizedClusters) {
      sorted.put(c.getNodeState().getAvailability(vmTypeName),c);
    }
    if (sorted.isEmpty()) {
      throw new NotEnoughResourcesAvailable("Not enough resources: no cluster is available on which you have permissions to run instances.");
    }
 else {
      return Lists.newArrayList(sorted.values());
    }
  }
 else {
    final Cluster cluster=Clusters.getInstance().lookup(clusterName);
    if (Iterables.any(Contexts.lookup().getAuthorizations(),new Predicate<Authorization>(){
      @Override public boolean apply(      Authorization arg0){
        return arg0.check(new AvailabilityZonePermission(cluster.getName()));
      }
    }
)) {
      return Lists.newArrayList(cluster);
    }
 else {
      if (Clusters.getInstance().contains(clusterName)) {
        throw new NotEnoughResourcesAvailable("Not authorized: you do not have sufficient permission to use " + clusterName);
      }
 else {
        throw new NotEnoughResourcesAvailable("Not enough resources: request cluster does not exist " + clusterName);
      }
    }
  }
}
