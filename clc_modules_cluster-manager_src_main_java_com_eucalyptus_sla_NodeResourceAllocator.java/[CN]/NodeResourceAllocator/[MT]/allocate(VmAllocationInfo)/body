{
  String clusterName=vmInfo.getRequest().getAvailabilityZone();
  String vmTypeName=vmInfo.getRequest().getVmType().getName();
  Integer amount=vmInfo.getRequest().getMinCount();
  Cluster authorizedCluster=this.doPrivilegedLookup(clusterName,vmTypeName);
  VmTypeAvailability vmAvailability=authorizedCluster.getNodeState().getAvailability(vmTypeName);
  if (vmAvailability.getAvailable() < amount) {
    throw new NotEnoughResourcesAvailable("Not enough resources (" + vmAvailability.getAvailable() + " < "+ amount+ ": vm instances.");
  }
  Context ctx=Contexts.lookup();
  ResourceToken token=authorizedCluster.getNodeState().getResourceAllocation(ctx.getCorrelationId(),ctx.getUser().getName(),vmTypeName,amount);
  vmInfo.getAllocationTokens().add(token);
}
