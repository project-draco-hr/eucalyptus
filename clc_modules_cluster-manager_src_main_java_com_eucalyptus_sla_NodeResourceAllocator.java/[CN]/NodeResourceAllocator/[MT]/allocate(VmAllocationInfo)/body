{
  String clusterName=vmInfo.getRequest().getAvailabilityZone();
  String vmTypeName=vmInfo.getRequest().getInstanceType();
  Integer minAmount=vmInfo.getRequest().getMinCount();
  Integer maxAmount=vmInfo.getRequest().getMaxCount();
  Cluster authorizedCluster=this.doPrivilegedLookup(clusterName,vmTypeName);
  VmTypeAvailability vmAvailability=authorizedCluster.getNodeState().getAvailability(vmTypeName);
  Context ctx=Contexts.lookup();
  ResourceToken token=authorizedCluster.getNodeState().getResourceAllocation(ctx.getCorrelationId(),ctx.getUser().getName(),vmTypeName,minAmount,maxAmount);
  vmInfo.getAllocationTokens().add(token);
}
