{
  Map<String,ReservationInfoType> rsvMap=new HashMap<String,ReservationInfoType>();
  if (isAdmin) {
    for (    VmInstance v : VmInstances.getInstance().listValues()) {
      if (!instancesSet.isEmpty() && !instancesSet.contains(v.getInstanceId()))       continue;
      if (rsvMap.get(v.getReservationId()) == null) {
        ReservationInfoType reservation=new ReservationInfoType(v.getReservationId(),v.getOwnerId(),v.getNetworkNames());
        rsvMap.put(reservation.getReservationId(),reservation);
      }
      rsvMap.get(v.getReservationId()).getInstancesSet().add(v.getAsRunningInstanceItemType());
    }
    for (    VmInstance v : VmInstances.getInstance().listDisabledValues()) {
      if (VmState.BURIED.equals(v.getState()))       continue;
      if (!instancesSet.isEmpty() && !instancesSet.contains(v.getInstanceId()))       continue;
      if (rsvMap.get(v.getReservationId()) == null) {
        ReservationInfoType reservation=new ReservationInfoType(v.getReservationId(),v.getOwnerId(),v.getNetworkNames());
        rsvMap.put(reservation.getReservationId(),reservation);
      }
      rsvMap.get(v.getReservationId()).getInstancesSet().add(v.getAsRunningInstanceItemType());
    }
    return new ArrayList<ReservationInfoType>(rsvMap.values());
  }
  StateSnapshot state=SystemState.getSnapshot(RULE_FILE);
  for (  VmInstance v : VmInstances.getInstance().getDisabledEntries()) {
    if (!VmState.BURIED.equals(v.getState())) {
      state.insert(v);
    }
  }
  try {
    QueryResults res=state.findInstances(userId,instancesSet);
    Iterator iter=res.iterator();
    while (iter.hasNext()) {
      QueryResult result=(QueryResult)iter.next();
      VmInstance v=(VmInstance)result.get("vm");
      if (rsvMap.get(v.getReservationId()) == null) {
        ReservationInfoType reservation=new ReservationInfoType(v.getReservationId(),v.getOwnerId(),v.getNetworkNames());
        rsvMap.put(reservation.getReservationId(),reservation);
      }
      rsvMap.get(v.getReservationId()).getInstancesSet().add(v.getAsRunningInstanceItemType());
    }
  }
  finally {
    state.destroy();
  }
  return new ArrayList<ReservationInfoType>(rsvMap.values());
}
