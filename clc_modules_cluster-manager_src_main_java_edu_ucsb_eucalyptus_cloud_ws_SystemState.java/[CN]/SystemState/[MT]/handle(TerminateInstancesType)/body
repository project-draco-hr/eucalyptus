{
  TerminateInstancesResponseType reply=(TerminateInstancesResponseType)request.getReply();
  reply.set_return(true);
  for (  String instanceId : request.getInstancesSet()) {
    try {
      VmInstance v=VmInstances.getInstance().lookup(instanceId);
      if (request.isAdministrator() || v.getOwnerId().equals(request.getUserId())) {
        reply.getInstancesSet().add(new TerminateInstancesItemType(v.getInstanceId(),v.getState().getCode(),v.getState().getName(),VmState.SHUTTING_DOWN.getCode(),VmState.SHUTTING_DOWN.getName()));
        v.setState(VmState.SHUTTING_DOWN);
        v.resetStopWatch();
        SystemState.returnNetworkIndex(v);
        SystemState.cleanUp(v);
        SystemState.returnPublicAddress(v);
        try {
          Network net=v.getNetworks().get(0);
          Cluster cluster=Clusters.getInstance().lookup(v.getPlacement());
          SystemState.checkNetwork(cluster,net);
        }
 catch (        Throwable e) {
          LOG.debug(e,e);
        }
      }
    }
 catch (    NoSuchElementException e) {
      try {
        VmInstance v=VmInstances.getInstance().lookupDisabled(instanceId);
        v.setState(VmState.BURIED);
      }
 catch (      NoSuchElementException e1) {
      }
    }
  }
  return reply;
}
