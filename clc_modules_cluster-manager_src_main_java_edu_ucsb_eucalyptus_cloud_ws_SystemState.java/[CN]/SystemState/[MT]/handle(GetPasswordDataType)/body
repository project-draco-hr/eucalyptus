{
  try {
    Cluster cluster=null;
    VmInstance v=VmInstances.getInstance().lookup(request.getInstanceId());
    if (!VmState.RUNNING.equals(v.getState())) {
      throw new NoSuchElementException("Instance " + request.getInstanceId() + " is not in a running state.");
    }
    if (request.isAdministrator() || v.getOwnerId().equals(request.getUserId())) {
      cluster=Clusters.getInstance().lookup(v.getPlacement());
    }
    if (v.getPasswordData() == null && cluster != null) {
      new PasswordDataCallback(request).dispatch(cluster);
    }
 else     if (v.getPasswordData() != null) {
      GetPasswordDataResponseType reply=request.getReply();
      reply.set_return(true);
      reply.setOutput(v.getPasswordData());
      reply.setTimestamp(new Date());
      reply.setInstanceId(v.getInstanceId());
      Messaging.dispatch("vm://ReplyQueue",reply);
    }
 else {
      Messaging.dispatch("vm://ReplyQueue",new EucalyptusErrorMessageType(RequestContext.getEventContext().getService().getComponent().getClass().getSimpleName(),request,"Failed to find required vm information"));
    }
    return;
  }
 catch (  NoSuchElementException e) {
    Messaging.dispatch("vm://ReplyQueue",new EucalyptusErrorMessageType(RequestContext.getEventContext().getService().getComponent().getClass().getSimpleName(),request,e.getMessage()));
    throw new EucalyptusCloudException(e.getMessage());
  }
}
