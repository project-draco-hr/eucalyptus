{
  VmInstance vm=null;
  try {
    vm=VmInstances.getInstance().lookup(runVm.getInstanceId());
    vm.setServiceTag(runVm.getServiceTag());
    if (VmState.SHUTTING_DOWN.equals(vm.getState())) {
      long splitTime=vm.getSplitTime();
      if (splitTime > SHUT_DOWN_TIME) {
        VmInstances.getInstance().disable(vm.getName());
        vm.setState(VmState.TERMINATED);
        vm.resetStopWatch();
        vm.setReason(INSTANCE_EXPIRED);
        SystemState.cleanUp(vm);
      }
 else       if (VmState.SHUTTING_DOWN.equals(VmState.Mapper.get(runVm.getStateName()))) {
        VmInstances.getInstance().disable(vm.getName());
        vm.setState(VmState.TERMINATED);
        vm.resetStopWatch();
        vm.setReason(INSTANCE_TERMINATED);
        SystemState.cleanUp(vm);
      }
 else       return;
    }
 else {
      vm.resetStopWatch();
      if (!VmInstance.DEFAULT_IP.equals(runVm.getNetParams().getIpAddress()) && !"".equals(runVm.getNetParams().getIpAddress()) && runVm.getNetParams().getIpAddress() != null) {
        vm.getNetworkConfig().setIpAddress(runVm.getNetParams().getIpAddress());
      }
      if (VmInstance.DEFAULT_IP.equals(vm.getNetworkConfig().getIgnoredPublicIp()) && !VmInstance.DEFAULT_IP.equals(runVm.getNetParams().getIgnoredPublicIp()) && !"".equals(runVm.getNetParams().getIgnoredPublicIp())&& runVm.getNetParams().getIgnoredPublicIp() != null) {
        vm.getNetworkConfig().setIgnoredPublicIp(runVm.getNetParams().getIgnoredPublicIp());
      }
      VmState oldState=vm.getState();
      vm.setState(VmState.Mapper.get(runVm.getStateName()));
      if (VmState.PENDING.equals(oldState) && VmState.SHUTTING_DOWN.equals(vm.getState())) {
        SystemState.returnNetworkIndex(vm);
        SystemState.returnPublicAddress(vm);
      }
 else       if (vm.getNetworkIndex() > 0 && runVm.getNetworkIndex() > 0 && (VmState.RUNNING.equals(vm.getState()) || VmState.PENDING.equals(vm.getState()))) {
        try {
          vm.setNetworkIndex(runVm.getNetworkIndex());
          Networks.getInstance().lookup(runVm.getOwnerId() + "-" + runVm.getGroupNames().get(0)).extantNetworkIndex(vm.getPlacement(),vm.getNetworkIndex());
        }
 catch (        Exception e) {
        }
      }
      for (      AttachedVolume vol : runVm.getVolumes()) {
        vol.setInstanceId(vm.getInstanceId());
        vol.setStatus("attached");
      }
      vm.setVolumes(runVm.getVolumes());
    }
  }
 catch (  NoSuchElementException e) {
    try {
      vm=VmInstances.getInstance().lookupDisabled(runVm.getInstanceId());
      long splitTime=vm.getSplitTime();
      if (splitTime > BURY_TIME)       vm.setState(VmState.BURIED);
    }
 catch (    NoSuchElementException e1) {
      SystemState.restoreInstance(originCluster,runVm);
    }
  }
}
