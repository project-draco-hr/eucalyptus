{
  if (!StorageProperties.enableSnapshots) {
    LOG.error("Snapshot functionality disabled. Please check connection to Walrus");
    throw new EucalyptusCloudException("could not connect to Walrus.");
  }
  String snapshotLocation="snapshots" + "/" + snapshotId;
  String tmpUncompressedFileName=null;
  String tmpCompressedFileName=null;
  File tmpCompressedFile=null;
  int retry=0;
  int maxRetry=5;
  do {
    tmpUncompressedFileName=StorageProperties.storageRootDirectory + File.separator + snapshotId+ "-"+ String.valueOf(randomGenerator.nextInt());
    tmpCompressedFileName=tmpUncompressedFileName + ".gz";
    tmpCompressedFile=new File(tmpCompressedFileName);
  }
 while (tmpCompressedFile.exists() && retry++ < maxRetry);
  if (retry >= maxRetry) {
    throw new EucalyptusCloudException("Could not get a temporary file for snapshot download after " + maxRetry + " attempts");
  }
  try {
    HttpReader snapshotGetter=new HttpReader(snapshotLocation,null,tmpCompressedFile,"GetWalrusSnapshot","");
    snapshotGetter.run();
  }
 catch (  Exception ex) {
    cleanupFile(tmpCompressedFile);
    throw new EucalyptusCloudException("Failed to download snapshot " + snapshotId + " from Walrus",ex);
  }
  try {
    CommandOutput output=SystemUtil.runWithRawOutput(new String[]{"/bin/gunzip",tmpCompressedFile.getAbsolutePath()});
    if (output.returnValue != 0) {
      throw new EucalyptusCloudException("Failed to uncompress snapshot " + snapshotId + " due to: "+ output.error);
    }
  }
 catch (  Exception ex) {
    if (ex instanceof EucalyptusCloudException) {
      throw (EucalyptusCloudException)ex;
    }
 else {
      throw new EucalyptusCloudException("Failed to uncompress and/or move snapshot " + snapshotId,ex);
    }
  }
 finally {
    cleanupFile(tmpCompressedFile);
  }
  return tmpUncompressedFileName;
}
