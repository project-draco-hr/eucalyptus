{
  if (!StorageProperties.enableSnapshots) {
    LOG.error("Snapshot functionality disabled. Please check connection to ObjectStorage");
    throw new EucalyptusCloudException("could not connect to ObjectStorage.");
  }
  String snapshotLocation="snap-" + snapshotId;
  String tmpUncompressedFileName=null;
  String tmpCompressedFileName=null;
  File tmpCompressedFile=null;
  int retry=0;
  int maxRetry=5;
  do {
    tmpUncompressedFileName=StorageProperties.storageRootDirectory + File.separator + snapshotId+ "-"+ String.valueOf(randomGenerator.nextInt());
    tmpCompressedFileName=tmpUncompressedFileName + ".gz";
    tmpCompressedFile=new File(tmpCompressedFileName);
  }
 while (tmpCompressedFile.exists() && retry++ < maxRetry);
  if (retry >= maxRetry) {
    throw new EucalyptusCloudException("Could not get a temporary file for snapshot download after " + maxRetry + " attempts");
  }
  try {
    snapshotOps.downloadSnapshot(StorageProperties.SNAPSHOT_BUCKET,snapshotLocation,new File(tmpUncompressedFileName));
  }
 catch (  Exception ex) {
    cleanupFile(tmpCompressedFile);
    throw new EucalyptusCloudException("Failed to download snapshot " + snapshotId + " from ObjectStorage",ex);
  }
  return tmpUncompressedFileName;
}
