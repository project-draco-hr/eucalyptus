{
  EntityWrapper<SnapshotInfo> db=StorageProperties.getEntityWrapper();
  SnapshotInfo searchSnap=new SnapshotInfo();
  searchSnap.setStatus(StorageProperties.Status.deleting.toString());
  List<SnapshotInfo> snapshots=db.query(searchSnap);
  db.commit();
  S3SnapshotTransfer snapshotTransfer=null;
  for (  SnapshotInfo snap : snapshots) {
    String snapshotId=snap.getSnapshotId();
    LOG.info("Snapshot: " + snapshotId + " was marked for deletion. Cleaning up...");
    try {
      blockManager.deleteSnapshot(snapshotId);
    }
 catch (    EucalyptusCloudException e1) {
      LOG.error(e1);
      continue;
    }
    SnapshotInfo snapInfo=new SnapshotInfo(snapshotId);
    db=StorageProperties.getEntityWrapper();
    SnapshotInfo foundSnapshotInfo;
    try {
      foundSnapshotInfo=db.getUnique(snapInfo);
      foundSnapshotInfo.setStatus(StorageProperties.Status.deleted.toString());
      db.commit();
    }
 catch (    EucalyptusCloudException e) {
      db.rollback();
      LOG.error(e);
      continue;
    }
    try {
      String[] names=SnapshotInfo.getSnapshotBucketKeyNames(foundSnapshotInfo.getSnapshotLocation());
      if (snapshotTransfer == null) {
        snapshotTransfer=new S3SnapshotTransfer();
      }
      snapshotTransfer.setSnapshotId(snapshotId);
      snapshotTransfer.setBucketName(names[0]);
      snapshotTransfer.setKeyName(names[1]);
      snapshotTransfer.delete();
    }
 catch (    Exception e) {
      LOG.warn("Failed to delete snapshot " + snapshotId + " from objectstorage",e);
    }
  }
}
