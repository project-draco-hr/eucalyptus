{
  LOG.info("Verifying snapshot " + snapshotId + " before uploading it to OSG");
  long size=Long.parseLong(sizeAsString);
  File snapshotFile=new File(snapshotFileName);
  assert(snapshotFile.exists());
  FileInputStream snapInStream=null;
  try {
    snapInStream=new FileInputStream(snapshotFile);
    byte[] bytes=new byte[1024];
    if (snapInStream.read(bytes) <= 0) {
      throw new EucalyptusCloudException("Unable to read snapshot file: " + snapshotFileName);
    }
  }
 catch (  FileNotFoundException e) {
    throw new EucalyptusCloudException(e);
  }
catch (  IOException e) {
    throw new EucalyptusCloudException(e);
  }
 finally {
    if (snapInStream != null) {
      try {
        snapInStream.close();
      }
 catch (      IOException e) {
        throw new EucalyptusCloudException(e);
      }
    }
  }
  SnapshotProgressCallback callback=new SnapshotProgressCallback(snapshotId,size,StorageProperties.TRANSFER_CHUNK_SIZE);
  try {
    LOG.info("Attempting to upload snapshot " + snapshotId + " to OSG");
    snapshotOps.uploadSnapshot(snapshotFile,callback,snapshotKey,snapshotId);
  }
 catch (  Exception ex) {
    try {
      LOG.debug("Deleting snapshot from OSG after failed upload of " + snapshotId);
      snapshotOps.deleteSnapshot(snapshotKey,snapshotId);
    }
 catch (    Exception iex) {
      LOG.debug("Failed to delete snapshot " + snapshotId + " from OSG",iex);
    }
    throw ex;
  }
}
