{
  this.runnable=runnable;
  try {
    this.txUuid=String.format("%s:%s",ctx,UUID.randomUUID().toString());
    this.owner=Logs.isExtrrreeeme() ? Threads.currentStackString() : "n/a";
    this.startTime=System.currentTimeMillis();
    this.stopWatch=new StopWatch();
    this.stopWatch.start();
    this.eventLog(TxState.BEGIN,TxEvent.CREATE);
    final EntityManagerFactory anemf=(EntityManagerFactoryImpl)PersistenceContexts.getEntityManagerFactory(ctx);
    assertThat(anemf,notNullValue());
    this.em=anemf.createEntityManager();
    assertThat(this.em,notNullValue());
    this.transaction=this.em.getTransaction();
    this.transaction.begin();
    this.session=new WeakReference<Session>((Session)this.em.getDelegate());
    this.eventLog(TxState.END,TxEvent.CREATE);
  }
 catch (  Throwable ex) {
    Logs.exhaust().error(ex,ex);
    this.eventLog(TxState.FAIL,TxEvent.CREATE);
    this.rollback();
    throw new RuntimeException(PersistenceExceptions.throwFiltered(ex));
  }
 finally {
    this.runnable.run();
    outstanding.put(this.txUuid,this);
  }
}
