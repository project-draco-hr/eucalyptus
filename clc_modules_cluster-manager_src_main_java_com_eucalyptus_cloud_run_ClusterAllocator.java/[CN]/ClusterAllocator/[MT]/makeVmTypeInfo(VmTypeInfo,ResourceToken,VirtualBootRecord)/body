{
  VmTypeInfo childVmInfo=vmInfo;
  if (root.isBlockStorage()) {
    childVmInfo=vmInfo.child();
    final Volume vol=token.getRootVolume();
    final ServiceConfiguration scConfig=waitForVolume(vol);
    VirtualBootRecord vbrRootDevice=childVmInfo.lookupRoot();
    String volumeId=vol.getDisplayName();
    String remoteDeviceString=null;
    Exception lastError=null;
    for (    final String nodeTag : this.cluster.getNodeTags()) {
      try {
        String newDevString=requestAttachStorageVolume(scConfig,volumeId,nodeTag);
        if (newDevString != null && remoteDeviceString == null) {
          Logs.extreme().debug("Updating remote device for " + token + " with "+ newDevString);
          remoteDeviceString=newDevString;
        }
      }
 catch (      Exception ex) {
        lastError=ex;
      }
    }
    if (remoteDeviceString == null) {
      if (lastError == null) {
        lastError=new NullPointerException("Unknown error.");
      }
      LOG.error("Failed to start instance " + token + " while preparing attachment of volume "+ volumeId+ " failed because: "+ lastError,lastError);
      throw lastError;
    }
 else {
      vbrRootDevice.setResourceLocation(remoteDeviceString);
      final String updateRemoteDevString=remoteDeviceString;
      final Function<String,VmInstance> updateInstance=new Function<String,VmInstance>(){
        public VmInstance apply(        final String input){
          VmVolumeAttachment attachment=VmInstances.lookupVolumeAttachment(input);
          attachment.setRemoteDevice(updateRemoteDevString);
          return attachment.getVmInstance();
        }
      }
;
      try {
        Entities.asTransaction(VmInstance.class,updateInstance).apply(volumeId);
      }
 catch (      Exception ex) {
        LOG.error(ex);
        Logs.extreme().error(ex,ex);
      }
    }
  }
  return childVmInfo;
}
