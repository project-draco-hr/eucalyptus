{
  LOG.debug("Transition error(): " + this.currentTransition.get());
  if (this.currentTransition.get() == null) {
    Exceptions.trace(new IllegalStateException("error() called when there is no currently pending transition: " + this.toString()));
  }
 else {
    ActiveTransition tr=this.currentTransition.get();
    if (!this.state.compareAndSet(tr.getTransitionRule().getToState(),tr.getTransitionRule().getErrorState(),true,tr.getTransitionRule().getErrorStateMark())) {
      this.state.set(this.state.getReference(),false);
      Exceptions.trace(new IllegalStateException("Failed to apply toState for the transition: " + tr.toString() + " for current state: "+ this.toString()));
    }
    if (!this.state.getReference().equals(tr.getTransitionRule().getErrorState())) {
      this.currentTransition.set(null);
      this.state.set(tr.getTransitionRule().getErrorState(),false);
      this.fireInListeners(tr.getTransitionRule().getErrorState());
    }
 else {
      this.currentTransition.set(null);
      this.state.set(tr.getTransitionRule().getErrorState(),false);
    }
  }
}
