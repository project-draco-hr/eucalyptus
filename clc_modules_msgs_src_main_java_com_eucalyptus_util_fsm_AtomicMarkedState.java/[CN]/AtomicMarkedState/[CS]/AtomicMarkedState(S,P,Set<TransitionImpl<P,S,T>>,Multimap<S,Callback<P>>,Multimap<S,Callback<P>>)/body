{
  this.startState=startState;
  this.name=String.format("State-%s-%s",parent.getClass().getSimpleName(),parent.getName());
  this.parent=parent;
  final S[] states=this.startState.getDeclaringClass().getEnumConstants();
  this.stateTransitions=new HashMap<S,Map<S,TransitionImpl<P,S,T>>>(){
{
      for (      S s : states) {
        this.put(s,new HashMap<S,TransitionImpl<P,S,T>>());
      }
    }
  }
;
  this.immutableStates=ImmutableList.of(states);
  this.state=new AtomicMarkableReference<S>(this.startState,false);
  this.immutableTransitions=ImmutableList.copyOf(transitions);
  for (  TransitionImpl<P,S,T> t : transitions) {
    this.transitions.put(t.getName(),t);
    this.stateTransitions.get(t.getFromState()).put(t.getToState(),t);
  }
  this.inStateListeners.putAll(inStateListeners);
  this.outStateListeners.putAll(outStateListeners);
}
