{
  try {
    return Transactions.transformOne(this,new Function<ExtantNetwork,SetReference<PrivateNetworkIndex,VmInstance>>(){
      @Override public SetReference<PrivateNetworkIndex,VmInstance> apply(      ExtantNetwork input){
        if (input.getIndexes().isEmpty()) {
          input.onCommit();
        }
        for (        PrivateNetworkIndex idx : input.getIndexes()) {
          if (ResourceAllocation.State.FREE.equals(idx.getState())) {
            try {
              return idx.allocate();
            }
 catch (            ResourceAllocationException ex) {
              LOG.error(ex,ex);
            }
          }
        }
        throw new UndeclaredThrowableException(new NoSuchElementException("Failed to locate a free network index."));
      }
    }
);
  }
 catch (  TransactionException ex) {
    throw ex;
  }
}
