{
  if (!NetworkGroups.networkingConfiguration().hasNetworking()) {
    try {
      return PrivateNetworkIndex.bogus().allocate();
    }
 catch (    ResourceAllocationException ex) {
      throw new RuntimeException("BUG BUG BUG: failed to call PrivateNetworkIndex.allocate() on the .bogus() index.");
    }
  }
 else   if (!Entities.isPersistent(this)) {
    throw new TransientEntityException(this.toString());
  }
 else {
    SetReference<PrivateNetworkIndex,VmInstance> ref=null;
    PrivateNetworkIndex netIdx=null;
    try {
      return Entities.uniqueResult(PrivateNetworkIndex.named(this,idx)).allocate();
    }
 catch (    Exception ex) {
      try {
        netIdx=PrivateNetworkIndex.create(this,idx);
        Entities.persist(netIdx);
        this.getIndexes().add(netIdx);
        return netIdx.allocate();
      }
 catch (      Exception ex1) {
        throw new TransactionExecutionException("Failed to allocate a private network index in network: " + this.displayName,ex1);
      }
    }
  }
}
