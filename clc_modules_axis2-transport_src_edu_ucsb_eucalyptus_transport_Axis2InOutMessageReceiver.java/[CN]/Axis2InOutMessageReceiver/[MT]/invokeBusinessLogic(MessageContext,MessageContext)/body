{
  String methodName=this.findOperation(msgContext);
  Class serviceMethodArgType=this.findArgumentClass(methodName);
  SOAPFactory factory=this.getSOAPFactory(msgContext);
  OMElement msgBodyOm=msgContext.getEnvelope().getBody().getFirstElement();
  String bindingName=this.findBindingName(msgBodyOm);
  EucalyptusMessage wrappedParam=this.bindMessage(methodName,serviceMethodArgType,msgBodyOm,bindingName);
  HttpRequest httprequest=(HttpRequest)msgContext.getProperty(GenericHttpDispatcher.HTTP_REQUEST);
  if (httprequest == null) {
    this.verifyUser(msgContext,wrappedParam);
  }
 else {
    bindingName=httprequest.getBindingName();
    Policy p=new Policy();
    newMsgContext.setProperty(RampartMessageData.KEY_RAMPART_POLICY,p);
    if (httprequest.isPureClient()) {
      if (wrappedParam instanceof ModifyImageAttributeType) {
        ModifyImageAttributeType pure=((ModifyImageAttributeType)wrappedParam);
        pure.setImageId(pure.getImageId().replaceFirst("a","e").toLowerCase());
      }
 else       if (wrappedParam instanceof DescribeImageAttributeType) {
        DescribeImageAttributeType pure=((DescribeImageAttributeType)wrappedParam);
        pure.setImageId(pure.getImageId().replaceFirst("^a","e").toLowerCase());
      }
 else       if (wrappedParam instanceof ResetImageAttributeType) {
        ResetImageAttributeType pure=((ResetImageAttributeType)wrappedParam);
        pure.setImageId(pure.getImageId().replaceFirst("^a","e").toLowerCase());
      }
 else       if (wrappedParam instanceof DescribeImagesType) {
        ArrayList<String> strs=Lists.newArrayList();
        for (        String imgId : ((DescribeImagesType)wrappedParam).getImagesSet()) {
          strs.add(imgId.replaceFirst("^a","e").toLowerCase());
        }
        ((DescribeImagesType)wrappedParam).setImagesSet(strs);
      }
 else       if (wrappedParam instanceof DeregisterImageType) {
        DeregisterImageType pure=((DeregisterImageType)wrappedParam);
        pure.setImageId(pure.getImageId().replaceFirst("^a","e").toLowerCase());
      }
 else       if (wrappedParam instanceof RunInstancesType) {
        RunInstancesType pure=((RunInstancesType)wrappedParam);
        pure.setImageId(pure.getImageId().replaceFirst("^a","e").toLowerCase());
        pure.setKernelId(pure.getKernelId().replaceFirst("^a","e").toLowerCase());
        pure.setRamdiskId(pure.getRamdiskId().replaceFirst("^a","e").toLowerCase());
      }
    }
  }
  MuleMessage message=this.invokeService(methodName,wrappedParam);
  if (message == null)   throw new AxisFault("Received a NULL response. This is a bug -- it should NEVER happen.");
  this.checkException(message);
  if (httprequest != null) {
    if (httprequest.isPureClient()) {
      if (message.getPayload() instanceof DescribeImagesResponseType) {
        DescribeImagesResponseType purify=(DescribeImagesResponseType)message.getPayload();
        for (        ImageDetails img : purify.getImagesSet()) {
          img.setImageId(img.getImageId().replaceFirst("^e","a").toLowerCase());
          if (img.getKernelId() != null)           img.setKernelId(img.getKernelId().replaceFirst("^e","a").toLowerCase());
          if (img.getRamdiskId() != null)           img.setRamdiskId(img.getRamdiskId().replaceFirst("^e","a").toLowerCase());
        }
      }
 else       if (message.getPayload() instanceof DescribeInstancesResponseType) {
        DescribeInstancesResponseType purify=(DescribeInstancesResponseType)message.getPayload();
        for (        ReservationInfoType rsvInfo : purify.getReservationSet()) {
          for (          RunningInstancesItemType r : rsvInfo.getInstancesSet()) {
            r.setImageId(r.getImageId().replaceFirst("^e","a").toLowerCase());
            if (r.getKernel() != null)             r.setKernel(r.getKernel().replaceFirst("^e","a").toLowerCase());
            if (r.getRamdisk() != null)             r.setRamdisk(r.getRamdisk().replaceFirst("^e","a").toLowerCase());
          }
        }
      }
    }
  }
  if (newMsgContext != null) {
    SOAPEnvelope envelope=generateMessage(methodName,factory,bindingName,message.getPayload());
    newMsgContext.setEnvelope(envelope);
  }
  newMsgContext.setProperty(Axis2HttpWorker.REAL_HTTP_REQUEST,msgContext.getProperty(Axis2HttpWorker.REAL_HTTP_REQUEST));
  newMsgContext.setProperty(Axis2HttpWorker.REAL_HTTP_RESPONSE,msgContext.getProperty(Axis2HttpWorker.REAL_HTTP_RESPONSE));
  LOG.info("Returning reply: " + message.getPayload());
  if (message.getPayload() instanceof WalrusErrorMessageType) {
    WalrusErrorMessageType errorMessage=(WalrusErrorMessageType)message.getPayload();
    msgContext.setProperty(Axis2HttpWorker.HTTP_STATUS,errorMessage.getHttpCode());
    newMsgContext.setProperty(Axis2HttpWorker.HTTP_STATUS,errorMessage.getHttpCode());
    newMsgContext.setProperty("messageType","application/walrus");
    return;
  }
  Boolean putType=(Boolean)msgContext.getProperty(WalrusProperties.STREAMING_HTTP_PUT);
  Boolean getType=(Boolean)msgContext.getProperty(WalrusProperties.STREAMING_HTTP_GET);
  if (getType != null || putType != null) {
    WalrusDataResponseType reply=(WalrusDataResponseType)message.getPayload();
    AxisHttpResponse response=(AxisHttpResponse)msgContext.getProperty(Axis2HttpWorker.REAL_HTTP_RESPONSE);
    response.addHeader(new BasicHeader("Last-Modified",reply.getLastModified()));
    response.addHeader(new BasicHeader("ETag",'\"' + reply.getEtag() + '\"'));
    if (getType != null) {
      newMsgContext.setProperty(WalrusProperties.STREAMING_HTTP_GET,getType);
      WalrusDataRequestType request=(WalrusDataRequestType)wrappedParam;
      Boolean isCompressed=request.getIsCompressed();
      if (isCompressed == null)       isCompressed=false;
      if (isCompressed) {
        newMsgContext.setProperty("GET_COMPRESSED",isCompressed);
      }
 else {
        Long contentLength=reply.getSize();
        response.addHeader(new BasicHeader(HTTP.CONTENT_LEN,String.valueOf(contentLength)));
      }
      List<MetaDataEntry> metaData=reply.getMetaData();
      for (      MetaDataEntry metaDataEntry : metaData) {
        response.addHeader(new BasicHeader(WalrusProperties.AMZ_META_HEADER_PREFIX + metaDataEntry.getName(),metaDataEntry.getValue()));
      }
      if (getType.equals(Boolean.TRUE)) {
        newMsgContext.setProperty("GET_KEY",request.getBucket() + "." + request.getKey());
        newMsgContext.setProperty("GET_RANDOM_KEY",request.getRandomKey());
      }
      newMsgContext.setProperty("messageType","application/walrus");
    }
 else     if (putType != null) {
      if (reply instanceof PostObjectResponseType) {
        PostObjectResponseType postReply=(PostObjectResponseType)reply;
        String redirectUrl=postReply.getRedirectUrl();
        if (redirectUrl != null) {
          response.addHeader(new BasicHeader("Location",redirectUrl));
          msgContext.setProperty(Axis2HttpWorker.HTTP_STATUS,HttpStatus.SC_SEE_OTHER);
          newMsgContext.setProperty(Axis2HttpWorker.HTTP_STATUS,HttpStatus.SC_SEE_OTHER);
          newMsgContext.setProperty("messageType","application/walrus");
        }
 else {
          Integer successCode=postReply.getSuccessCode();
          if (successCode != null) {
            newMsgContext.setProperty(Axis2HttpWorker.HTTP_STATUS,successCode);
            if (successCode == 201) {
              return;
            }
 else {
              newMsgContext.setProperty("messageType","application/walrus");
              return;
            }
          }
        }
      }
      response.addHeader(new BasicHeader(HTTP.CONTENT_LEN,String.valueOf(0)));
    }
  }
}
