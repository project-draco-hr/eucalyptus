{
  final BundleInstanceResponseType reply=request.getReply();
  reply.set_return(true);
  Component walrus=Components.lookup(Walrus.class);
  NavigableSet<ServiceConfiguration> configs=walrus.lookupServiceConfigurations();
  if (configs.isEmpty() || !Component.State.ENABLED.isIn(configs.first())) {
    throw new EucalyptusCloudException("Failed to bundle instance because there is no available walrus service at the moment.");
  }
  final String walrusUrl=configs.first().getUri().toASCIIString();
  final String instanceId=request.getInstanceId();
  final Context ctx=Contexts.lookup();
  final User user=ctx.getUser();
  try {
    final VmInstance v=VmInstances.getInstance().lookup(instanceId);
    if (v.isBundling()) {
      reply.setTask(v.getBundleTask());
      return reply;
    }
 else     if (!"windows".equals(v.getPlatform())) {
      throw new EucalyptusCloudException("Failed to bundle requested vm because the platform is not 'windows': " + request.getInstanceId());
    }
 else     if (!VmState.RUNNING.equals(v.getState())) {
      throw new EucalyptusCloudException("Failed to bundle requested vm because it is not currently 'running': " + request.getInstanceId());
    }
 else     if (Types.checkPrivilege(request,PolicySpec.VENDOR_EC2,PolicySpec.EC2_RESOURCE_INSTANCE,instanceId,v.getOwner())) {
      BundleInstanceChecker.check(request);
      final BundleTask bundleTask=new BundleTask(v.getInstanceId().replaceFirst("i-","bun-"),v.getInstanceId(),request.getBucket(),request.getPrefix());
      if (v.startBundleTask(bundleTask)) {
        reply.setTask(bundleTask);
      }
 else       if (v.getBundleTask() == null) {
        v.resetBundleTask();
        v.startBundleTask(bundleTask);
        reply.setTask(bundleTask);
      }
 else {
        throw new EucalyptusCloudException("Instance is already being bundled: " + v.getBundleTask().getBundleId());
      }
      LOG.info(EventRecord.here(BundleCallback.class,EventType.BUNDLE_PENDING,ctx.getUserFullName().toString(),v.getBundleTask().getBundleId(),v.getInstanceId()));
      final BundleCallback callback=new BundleCallback(request);
      request.setUrl(walrusUrl);
      request.setAwsAccessKeyId(Accounts.getFirstActiveAccessKeyId(user));
      AsyncRequests.newRequest(callback).dispatch(v.getClusterName());
      return reply;
    }
 else {
      throw new EucalyptusCloudException("Failed to find instance: " + request.getInstanceId());
    }
  }
 catch (  EucalyptusCloudException e) {
    throw e;
  }
catch (  final Exception e) {
    throw new EucalyptusCloudException("Failed to find instance: " + request.getInstanceId());
  }
}
