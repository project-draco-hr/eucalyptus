{
  BundleInstanceResponseType reply=request.getReply();
  reply.set_return(true);
  String walrusUrl=SystemConfiguration.getWalrusUrl();
  String instanceId=request.getInstanceId();
  User user=null;
  try {
    user=Users.lookupUser(request.getUserId());
  }
 catch (  NoSuchUserException e1) {
    throw new EucalyptusCloudException("Failed to lookup the specified user's information: " + request.getUserId());
  }
  try {
    VmInstance v=VmInstances.getInstance().lookup(instanceId);
    if (v.isBundling()) {
      reply.setTask(v.getBundleTask());
      return reply;
    }
 else     if (!"windows".equals(v.getPlatform())) {
      throw new EucalyptusCloudException("Failed to bundle requested vm because the platform is not 'windows': " + request.getInstanceId());
    }
 else     if (!VmState.RUNNING.equals(v.getState())) {
      throw new EucalyptusCloudException("Failed to bundle requested vm because it is not currently 'running': " + request.getInstanceId());
    }
 else     if (request.isAdministrator() || v.getOwnerId().equals(request.getUserId())) {
      BundleTask bundleTask=new BundleTask(v.getInstanceId().replaceFirst("i-","bun-"),v.getInstanceId(),request.getBucket(),request.getPrefix());
      if (v.startBundleTask(bundleTask)) {
        reply.setTask(bundleTask);
      }
 else       if (v.getBundleTask() == null) {
        v.resetBundleTask();
        v.startBundleTask(bundleTask);
        reply.setTask(bundleTask);
      }
 else {
        throw new EucalyptusCloudException("Instance is already being bundled: " + v.getBundleTask().getBundleId());
      }
      LOG.info(EventRecord.here(BundleCallback.class,EventType.BUNDLE_PENDING,request.getUserId(),v.getBundleTask().getBundleId(),v.getInstanceId()));
      BundleCallback callback=new BundleCallback(request);
      request.setUrl(walrusUrl);
      request.setAwsAccessKeyId(user.getQueryId());
      callback.dispatch(v.getPlacement());
      return reply;
    }
 else {
      throw new EucalyptusCloudException("Failed to find instance: " + request.getInstanceId());
    }
  }
 catch (  NoSuchElementException e) {
    throw new EucalyptusCloudException("Failed to find instance: " + request.getInstanceId());
  }
}
