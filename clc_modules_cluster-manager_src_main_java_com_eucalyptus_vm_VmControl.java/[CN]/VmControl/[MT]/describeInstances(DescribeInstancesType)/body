{
  final DescribeInstancesResponseType reply=(DescribeInstancesResponseType)msg.getReply();
  Context ctx=Contexts.lookup();
  boolean showAll=msg.getInstancesSet().remove("verbose");
  final ArrayList<String> instancesSet=msg.getInstancesSet();
  final Multimap<String,RunningInstancesItemType> instanceMap=TreeMultimap.create();
  final Map<String,ReservationInfoType> reservations=Maps.newHashMap();
  final Filter filter=Filters.generate(msg.getFilterSet(),VmInstance.class);
  final Predicate<? super VmInstance> requestedAndAccessible=CloudMetadatas.filteringFor(VmInstance.class).byId(msg.getInstancesSet()).byPredicate(filter.asPredicate()).byPredicate(filter.isFilteringOnTags() ? Predicates.not(VmState.TERMINATED) : Predicates.<VmInstance>alwaysTrue()).byPrivileges().buildPredicate();
  OwnerFullName ownerFullName=(ctx.hasAdministrativePrivileges() && showAll) ? null : ctx.getUserFullName().asAccountFullName();
  try {
    final List<VmInstance> instances=VmInstances.list(ownerFullName,filter.asCriterion(),filter.getAliases(),requestedAndAccessible);
    final Map<String,List<Tag>> tagsMap=TagSupport.forResourceClass(VmInstance.class).getResourceTagMap(AccountFullName.getInstance(ctx.getAccount()),Iterables.transform(instances,CloudMetadatas.toDisplayName()));
    for (    final VmInstance vm : instances) {
      if (!instancesSet.isEmpty() && !instancesSet.contains(vm.getInstanceId())) {
        continue;
      }
      final EntityTransaction db=Entities.get(VmInstance.class);
      try {
        VmInstance v=Entities.merge(vm);
        if (instanceMap.put(v.getReservationId(),VmInstances.transform(v)) && !reservations.containsKey(v.getReservationId())) {
          reservations.put(v.getReservationId(),new ReservationInfoType(v.getReservationId(),v.getOwner().getAccountNumber(),v.getNetworkNames()));
        }
      }
 catch (      Exception ex) {
        Logs.exhaust().error(ex,ex);
        db.rollback();
        try {
          if (vm != null) {
            try {
              RunningInstancesItemType ret=VmInstances.transform(vm);
              if (ret != null && vm.getReservationId() != null) {
                if (instanceMap.put(vm.getReservationId(),VmInstances.transform(vm)) && !reservations.containsKey(vm.getReservationId())) {
                  reservations.put(vm.getReservationId(),new ReservationInfoType(vm.getReservationId(),vm.getOwner().getAccountNumber(),vm.getNetworkNames()));
                }
              }
            }
 catch (            Exception ex1) {
              LOG.error(ex1,ex1);
            }
          }
        }
 catch (        Exception ex1) {
          LOG.error(ex1,ex1);
        }
      }
 finally {
        if (db.isActive())         db.rollback();
      }
    }
    List<ReservationInfoType> replyReservations=reply.getReservationSet();
    for (    ReservationInfoType r : reservations.values()) {
      Collection<RunningInstancesItemType> instanceSet=instanceMap.get(r.getReservationId());
      if (!instanceSet.isEmpty()) {
        for (        final RunningInstancesItemType instancesItemType : instanceSet) {
          Tags.addFromTags(instancesItemType.getTagSet(),ResourceTag.class,tagsMap.get(instancesItemType.getInstanceId()));
        }
        r.getInstancesSet().addAll(instanceSet);
        replyReservations.add(r);
      }
    }
  }
 catch (  final Exception e) {
    LOG.error(e);
    LOG.debug(e,e);
    throw new EucalyptusCloudException(e.getMessage());
  }
  return reply;
}
