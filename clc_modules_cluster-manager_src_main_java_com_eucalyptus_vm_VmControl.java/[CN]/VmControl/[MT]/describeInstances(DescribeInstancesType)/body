{
  final DescribeInstancesResponseType reply=(DescribeInstancesResponseType)msg.getReply();
  final boolean isVerbose=msg.getInstancesSet().remove("verbose");
  final ArrayList<String> instancesSet=msg.getInstancesSet();
  final Map<String,ReservationInfoType> rsvMap=new HashMap<String,ReservationInfoType>();
  Predicate<VmInstance> privileged=RestrictedTypes.filterPrivileged();
  try {
    for (    final VmInstance vm : Iterables.filter(VmInstances.listValues(),privileged)) {
      EntityTransaction db=Entities.get(VmInstance.class);
      try {
        VmInstance v=Entities.merge(vm);
        if (VmState.TERMINATED.apply(v) && v.getSplitTime() > VmInstances.SHUT_DOWN_TIME) {
          VmInstances.terminate(v);
        }
 else         if (VmState.BURIED.apply(v) && v.getSplitTime() > VmInstances.BURY_TIME) {
          VmInstances.delete(v);
        }
        if (VmState.BURIED.apply(v) && !isVerbose) {
          continue;
        }
        if (!instancesSet.isEmpty() && !instancesSet.contains(v.getInstanceId())) {
          continue;
        }
        if (rsvMap.get(v.getReservationId()) == null) {
          final ReservationInfoType reservation=new ReservationInfoType(v.getReservationId(),v.getOwner().getNamespace(),v.getNetworkNames());
          rsvMap.put(reservation.getReservationId(),reservation);
        }
        rsvMap.get(v.getReservationId()).getInstancesSet().add(VmInstances.transform(v));
        db.commit();
      }
 catch (      Exception ex) {
        Logs.exhaust().error(ex,ex);
        db.rollback();
        try {
          if (vm != null && !VmState.BURIED.apply(vm)) {
            RunningInstancesItemType ret=VmInstances.transform(vm);
            if (ret != null && vm.getReservationId() != null) {
              rsvMap.get(vm.getReservationId()).getInstancesSet().add(ret);
            }
          }
        }
 catch (        Exception ex1) {
          LOG.error(ex1,ex1);
        }
      }
    }
    ArrayList<ReservationInfoType> vms=new ArrayList<ReservationInfoType>(rsvMap.values());
    reply.setReservationSet(vms);
  }
 catch (  final Exception e) {
    LOG.error(e);
    LOG.debug(e,e);
    throw new EucalyptusCloudException(e.getMessage());
  }
  return reply;
}
