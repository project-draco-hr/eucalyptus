{
  VmInstance v=null;
  try {
    v=VmInstances.getInstance().lookup(request.getInstanceId());
  }
 catch (  NoSuchElementException e2) {
    try {
      v=VmInstances.getInstance().lookupDisabled(request.getInstanceId());
      GetConsoleOutputResponseType reply=request.getReply();
      reply.setInstanceId(request.getInstanceId());
      reply.setTimestamp(new Date());
      reply.setOutput(v.getConsoleOutputString());
      ServiceContext.dispatch("ReplyQueue",reply);
    }
 catch (    NoSuchElementException ex) {
      throw new EucalyptusCloudException("No such instance: " + request.getInstanceId());
    }
  }
  if (!request.isAdministrator() && !v.getOwnerId().equals(request.getUserId())) {
    throw new EucalyptusCloudException("Permission denied for vm: " + request.getInstanceId());
  }
 else   if (!VmState.RUNNING.equals(v.getState())) {
    throw new EucalyptusCloudException("Instance " + request.getInstanceId() + " is not in a running state.");
  }
 else {
    Cluster cluster=null;
    try {
      cluster=Clusters.getInstance().lookup(v.getPlacement());
    }
 catch (    NoSuchElementException e1) {
      throw new EucalyptusCloudException("Failed to find cluster info for '" + v.getPlacement() + "' related to vm: "+ request.getInstanceId());
    }
    RequestContext.getEventContext().setStopFurtherProcessing(true);
    Callbacks.newClusterRequest(new ConsoleOutputCallback(request)).dispatch(cluster.getServiceEndpoint());
  }
}
