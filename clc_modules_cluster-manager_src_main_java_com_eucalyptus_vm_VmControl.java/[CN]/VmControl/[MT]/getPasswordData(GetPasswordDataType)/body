{
  final String instanceId=normalizeIdentifier(request.getInstanceId());
  try {
    final Context ctx=Contexts.lookup();
    Cluster cluster=null;
    final VmInstance v=VmInstances.lookup(instanceId);
    if (!VmState.RUNNING.equals(v.getState())) {
      throw new NoSuchElementException("Instance " + instanceId + " is not in a running state.");
    }
    if (!ImageMetadata.Platform.windows.name().equals(v.getPlatform()))     throw new ClientComputeException("OperationNotPermitted","Instance's platform is not Windows");
    if (RestrictedTypes.filterPrivileged().apply(v)) {
      ServiceConfiguration ccConfig=Topology.lookup(ClusterController.class,v.lookupPartition());
      cluster=Clusters.lookup(ccConfig);
    }
 else {
      throw new NoSuchElementException("Instance " + instanceId + " does not exist.");
    }
    RequestContext.getEventContext().setStopFurtherProcessing(true);
    if (v.getPasswordData() == null) {
      AsyncRequests.newRequest(new PasswordDataCallback(request)).dispatch(cluster.getConfiguration());
    }
 else {
      final GetPasswordDataResponseType reply=request.getReply();
      reply.set_return(true);
      reply.setOutput(v.getPasswordData());
      reply.setTimestamp(new Date());
      reply.setInstanceId(v.getInstanceId());
      ServiceContext.dispatch("ReplyQueue",reply);
    }
  }
 catch (  final NoSuchElementException e) {
    ServiceContext.dispatch("ReplyQueue",new EucalyptusErrorMessageType("VmControl",request,e.getMessage()));
  }
}
