{
  final DescribeBundleTasksResponseType reply=request.getReply();
  final EntityTransaction db=Entities.get(VmInstance.class);
  try {
    Predicate<VmInstance> filter=Predicates.and(VmInstance.Filters.BUNDLING,RestrictedTypes.filterPrivileged());
    if (request.getBundleIds().isEmpty()) {
      for (      final VmInstance v : VmInstances.list(filter)) {
        reply.getBundleTasks().add(Bundles.transform(v.getRuntimeState().getBundleTask()));
      }
    }
 else {
      for (      final String bundleId : request.getBundleIds()) {
        try {
          final VmInstance v=VmInstances.lookupByBundleId(bundleId);
          if (RestrictedTypes.filterPrivileged().apply(v)) {
            reply.getBundleTasks().add(Bundles.transform(v.getRuntimeState().getBundleTask()));
          }
        }
 catch (        final NoSuchElementException e) {
        }
      }
    }
  }
 catch (  Exception ex) {
    Logs.exhaust().error(ex,ex);
    throw new EucalyptusCloudException(ex);
  }
 finally {
    db.rollback();
  }
  return reply;
}
