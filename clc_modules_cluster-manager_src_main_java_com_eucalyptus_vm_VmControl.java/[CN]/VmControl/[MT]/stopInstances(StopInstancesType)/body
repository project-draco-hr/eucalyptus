{
  final StopInstancesResponseType reply=request.getReply();
  try {
    final Context ctx=Contexts.lookup();
    final List<TerminateInstancesItemType> results=reply.getInstancesSet();
    Predicate<String> stopPredicate=new Predicate<String>(){
      @Override public boolean apply(      final String instanceId){
        try {
          final VmInstance v=VmInstances.lookup(instanceId);
          if (RestrictedTypes.filterPrivileged().apply(v)) {
            if (v.getBootRecord().getMachine() instanceof BlockStorageImageInfo) {
              final int oldCode=v.getState().getCode(), newCode=VmState.STOPPING.getCode();
              final String oldState=v.getState().getName(), newState=VmState.STOPPING.getName();
              results.add(new TerminateInstancesItemType(v.getInstanceId(),oldCode,oldState,newCode,newState));
              VmInstances.stopped(v);
              return true;
            }
 else {
              return false;
            }
          }
          return true;
        }
 catch (        final NoSuchElementException e) {
          try {
            VmInstances.stopped(instanceId);
            return true;
          }
 catch (          final NoSuchElementException e1) {
            return false;
          }
catch (          TransactionException ex) {
            Logs.extreme().error(ex,ex);
            return false;
          }
        }
catch (        Exception ex) {
          LOG.error(ex);
          Logs.extreme().error(ex,ex);
          throw Exceptions.toUndeclared(ex);
        }
      }
    }
;
    Predicate<String> stopTx=Entities.asTransaction(VmInstance.class,stopPredicate);
    Iterables.all(request.getInstancesSet(),stopTx);
    reply.set_return(!reply.getInstancesSet().isEmpty());
    return reply;
  }
 catch (  final Throwable e) {
    LOG.error(e);
    LOG.debug(e,e);
    throw new EucalyptusCloudException(e.getMessage());
  }
}
