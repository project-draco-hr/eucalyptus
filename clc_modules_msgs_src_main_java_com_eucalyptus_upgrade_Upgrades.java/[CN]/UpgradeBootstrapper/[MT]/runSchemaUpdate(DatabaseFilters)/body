{
  try {
    final Map<String,String> props=Maps.newHashMap(UpgradeState.getDatabaseProperties());
    for (    final String ctx : PersistenceContexts.list()) {
      final String databaseName=PersistenceContexts.toDatabaseName().apply(ctx);
      final String schemaName=PersistenceContexts.toSchemaName().apply(ctx);
      UpgradeState.putContextProperties(props,schemaName,dbName.getVersionedName(databaseName));
      final PersistenceContextConfiguration config=new PersistenceContextConfiguration(ctx,PersistenceContexts.listEntities(ctx),props);
      new SchemaUpdate(PersistenceContexts.getConfiguration(config)).execute(true,true);
    }
  }
 catch (  final Exception e) {
    LOG.fatal(e,e);
    LOG.fatal("Failed to initialize the persistence layer.");
    throw Exceptions.toUndeclared(e);
  }
}
