{
  MigrateInstancesResponseType reply=request.getReply();
  for (  ServiceConfiguration c : Topology.enabledServices(ClusterController.class)) {
    try {
      Cluster cluster=Clusters.lookup(c);
      if (!Strings.isNullOrEmpty(request.getSourceHost())) {
        cluster.migrateInstances(request.getSourceHost(),request.getAllowHosts(),request.getDestinationHosts());
      }
 else       if (!Strings.isNullOrEmpty(request.getInstanceId())) {
        cluster.migrateInstance(request.getInstanceId(),request.getAllowHosts(),request.getDestinationHosts());
      }
 else {
        throw new IllegalArgumentException("Either the sourceHost or instanceId must be provided");
      }
      return reply.markWinning();
    }
 catch (    Exception ex) {
      LOG.error(ex);
      throw new EucalyptusCloudException(ex.getMessage(),ex);
    }
  }
  return reply.markFailed();
}
