{
  EntityWrapper<ImageCacheInfo> db=EntityWrapper.get(ImageCacheInfo.class);
  ImageCacheInfo searchImageCacheInfo=new ImageCacheInfo(bucketName,manifestKey);
  List<ImageCacheInfo> imageCacheInfos=db.query(searchImageCacheInfo);
  String decryptedImageKey=null;
  if (imageCacheInfos.size() != 0) {
    ImageCacheInfo icInfo=imageCacheInfos.get(0);
    if (!icInfo.getInCache()) {
      decryptedImageKey=icInfo.getImageName();
    }
 else {
      db.commit();
      return;
    }
  }
  db.commit();
  ImageCacher imageCacher=imageCachers.putIfAbsent(bucketName + manifestKey,new ImageCacher(bucketName,manifestKey,decryptedImageKey));
  if (imageCacher == null) {
    if (decryptedImageKey == null) {
      try {
        decryptedImageKey=decryptImage(bucketName,manifestKey,account,isAdministrator);
      }
 catch (      EucalyptusCloudException ex) {
        imageCachers.remove(bucketName + manifestKey);
        throw ex;
      }
      ImageCacheInfo foundImageCacheInfo=new ImageCacheInfo(bucketName,manifestKey);
      foundImageCacheInfo.setImageName(decryptedImageKey);
      foundImageCacheInfo.setInCache(false);
      foundImageCacheInfo.setUseCount(0);
      foundImageCacheInfo.setSize(0L);
      db=EntityWrapper.get(ImageCacheInfo.class);
      db.add(foundImageCacheInfo);
      db.commit();
    }
    imageCacher=imageCachers.get(bucketName + manifestKey);
    imageCacher.setDecryptedImageKey(decryptedImageKey);
    imageCacher.start();
  }
}
