{
  NavigableSet<ServiceConfiguration> services=this.serviceRegistry.getServices();
  if (this.getComponentId().isCloudLocal() && services.size() != 1 && !"db".equals(this.getName())) {
    throw new RuntimeException("Cloud local component has " + services.size() + " registered services (Should be exactly 1): "+ this+ " "+ services.toString());
  }
 else   if (this.getComponentId().isCloudLocal() && services.size() != 1 && "db".equals(this.getName())) {
    return this.getComponentId().getLocalEndpointUri();
  }
 else   if (this.getComponentId().isCloudLocal() && services.size() == 1) {
    return services.first().getUri();
  }
 else {
    for (    ServiceConfiguration s : services) {
      if (s.isVmLocal()) {
        return s.getUri();
      }
    }
    throw new RuntimeException("Attempting to get the URI for a service which is either not a singleton or has no locally defined service endpoint.");
  }
}
