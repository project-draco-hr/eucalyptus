{
  DescribeVolumesResponseType reply=(DescribeVolumesResponseType)request.getReply();
  EntityWrapper<Volume> db=getEntityWrapper();
  String userName=request.isAdministrator() ? null : request.getUserId();
  LOG.debug(request);
  List<Volume> volumes=db.query(Volume.ownedBy(userName));
  for (  Volume v : volumes) {
    if (request.getVolumeSet().isEmpty() || request.getVolumeSet().contains(v.getDisplayName())) {
      DescribeStorageVolumesResponseType volState=(DescribeStorageVolumesResponseType)Messaging.send(StorageProperties.STORAGE_REF,new DescribeStorageVolumesType(Lists.newArrayList(v.getDisplayName())));
      String volumeState="unavailable";
      if (!volState.getVolumeSet().isEmpty()) {
        StorageVolume vol=volState.getVolumeSet().get(0);
        volumeState=vol.getStatus();
      }
      v.setMappedState(volumeState);
      reply.getVolumeSet().add(v.morph(new edu.ucsb.eucalyptus.msgs.Volume()));
    }
  }
  db.commit();
  return reply;
}
