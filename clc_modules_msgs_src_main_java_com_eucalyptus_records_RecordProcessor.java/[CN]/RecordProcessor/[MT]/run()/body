{
  try {
    do {
      String msg="";
      int total=0;
      TimeUnit.MILLISECONDS.sleep(RECORD_QUEUE_FLUSH_INTERVAL);
      List<Record> savedRecords=Lists.newArrayList();
      for (      RecordLevel level : RecordLevel.values()) {
        List<Record> records=level.drain();
        savedRecords.addAll(records);
        msg+=level.name() + ":" + records.size()+ " ";
      }
      if (!savedRecords.isEmpty()) {
        long start=System.currentTimeMillis();
        EntityWrapper<BaseRecord> db=EntityWrapper.get(BaseRecord.class);
        try {
          for (          Record record : savedRecords) {
            if (record instanceof BaseRecord) {
              db.add((BaseRecord)record);
            }
 else {
              LOG.debug("Received system event record of a type which cannot be stored: " + record.getClass().getCanonicalName());
            }
          }
          db.commit();
          LOG.debug("Saving " + savedRecords.size() + " records total in "+ (System.currentTimeMillis() - start)+ " msec. "+ msg);
        }
 catch (        Exception e) {
          LOG.error(e,e);
        }
      }
 else {
        LOG.trace("Found nothing to save from the event record queues.");
      }
    }
 while (!finished);
  }
 catch (  InterruptedException e) {
    finished=true;
    Thread.currentThread().interrupted();
  }
  LOG.info("Terminated records storage thread.");
}
