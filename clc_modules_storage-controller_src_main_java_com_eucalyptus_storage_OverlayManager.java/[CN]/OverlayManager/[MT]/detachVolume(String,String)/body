{
  VolumeEntityWrapperManager volumeManager=new VolumeEntityWrapperManager();
  LVMVolumeInfo foundLVMVolumeInfo=volumeManager.getVolumeInfo(volumeId);
  if (foundLVMVolumeInfo != null) {
    String loDevName=foundLVMVolumeInfo.getLoDevName();
    String vgName=foundLVMVolumeInfo.getVgName();
    String lvName=foundLVMVolumeInfo.getLvName();
    String absoluteLVName=lvmRootDirectory + PATH_SEPARATOR + vgName+ PATH_SEPARATOR+ lvName;
    volumeManager.unexportVolume(foundLVMVolumeInfo);
    LVMVolumeInfo volumeInfo=new LVMVolumeInfo();
    volumeInfo.setSnapshotOf(volumeId);
    volumeInfo.setStatus(StorageProperties.Status.pending.toString());
    LVMVolumeInfo snapshotInfo=volumeManager.getVolumeInfo(volumeInfo);
    if (snapshotInfo == null) {
      LOG.info("Detaching loop device: " + loDevName);
      disableLogicalVolume(absoluteLVName);
      removeLoopback(loDevName);
      foundLVMVolumeInfo.setLoDevName(null);
    }
 else {
      LOG.info("Snapshot: " + snapshotInfo.getVolumeId() + " in progress. Not detaching loop device.");
    }
    volumeManager.finish();
  }
 else {
    volumeManager.abort();
    throw new EucalyptusCloudException("Unable to find volume: " + volumeId);
  }
}
