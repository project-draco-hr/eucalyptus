{
  VolumeEntityWrapperManager volumeManager=new VolumeEntityWrapperManager();
  List<LVMVolumeInfo> volumes=volumeManager.getAllVolumeInfos();
  for (  LVMVolumeInfo foundLVMVolumeInfo : volumes) {
    LOG.info("CHECKING VOL: " + foundLVMVolumeInfo.getVolumeId() + " FOR CLEANUP");
    exportManager.cleanup(foundLVMVolumeInfo);
    String loDevName=foundLVMVolumeInfo.getLoDevName();
    String vgName=foundLVMVolumeInfo.getVgName();
    String lvName=foundLVMVolumeInfo.getLvName();
    String absoluteLVName=lvmRootDirectory + PATH_SEPARATOR + vgName+ PATH_SEPARATOR+ lvName;
    LVMVolumeInfo volumeInfo=new LVMVolumeInfo();
    volumeInfo.setSnapshotOf(foundLVMVolumeInfo.getVolumeId());
    volumeInfo.setStatus(StorageProperties.Status.pending.toString());
    LVMVolumeInfo snapshotInfo=volumeManager.getVolumeInfo(volumeInfo);
    if (snapshotInfo == null) {
      LOG.info("Detaching loop device: " + loDevName);
      try {
        disableLogicalVolume(absoluteLVName);
        removeLoopback(loDevName);
        foundLVMVolumeInfo.setLoDevName(null);
      }
 catch (      EucalyptusCloudException e) {
        LOG.error(e,e);
      }
    }
 else {
      LOG.info("Snapshot: " + snapshotInfo.getVolumeId() + " in progress. Not detaching loop device.");
    }
  }
  volumeManager.finish();
}
