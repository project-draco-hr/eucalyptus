{
  try {
    VolumeEntityWrapperManager volumeManager=new VolumeEntityWrapperManager();
    List<LVMVolumeInfo> volumes=volumeManager.getAllVolumeInfos();
    volumeManager.abort();
    for (    LVMVolumeInfo foundLVMVolumeInfo : volumes) {
      if (foundLVMVolumeInfo.getCleanup()) {
        try {
          exportManager.cleanup(foundLVMVolumeInfo);
        }
 catch (        EucalyptusCloudException ee) {
          LOG.error(ee,ee);
          continue;
        }
        String loDevName=foundLVMVolumeInfo.getLoDevName();
        if (loDevName != null) {
          volumeManager=new VolumeEntityWrapperManager();
          String volumeId=foundLVMVolumeInfo.getVolumeId();
          LVMVolumeInfo volInfo=volumeManager.getVolumeInfo(volumeId);
          if (volInfo != null) {
            String vgName=foundLVMVolumeInfo.getVgName();
            String lvName=foundLVMVolumeInfo.getLvName();
            String absoluteLVName=lvmRootDirectory + PATH_SEPARATOR + vgName+ PATH_SEPARATOR+ lvName;
            if (!volumeManager.areSnapshotsPending(volumeId)) {
              LOG.info("Detaching loop device: " + loDevName);
              try {
                disableLogicalVolume(absoluteLVName);
                removeLoopback(loDevName);
                volInfo.setLoDevName(null);
              }
 catch (              EucalyptusCloudException e) {
                LOG.error(e,e);
              }
            }
 else {
              LOG.info("Snapshot in progress. Not detaching loop device.");
            }
            volInfo.setCleanup(false);
            volumeManager.finish();
          }
        }
 else {
          volumeManager.abort();
        }
      }
    }
  }
 catch (  Exception ex) {
    LOG.error(ex,ex);
  }
}
