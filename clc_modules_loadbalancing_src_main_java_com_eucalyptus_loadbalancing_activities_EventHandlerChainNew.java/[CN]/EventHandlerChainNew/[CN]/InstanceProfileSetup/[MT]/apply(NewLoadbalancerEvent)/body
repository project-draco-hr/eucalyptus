{
  try {
    List<InstanceProfileType> instanceProfiles=EucalyptusActivityTasks.getInstance().listInstanceProfiles(DEFAULT_INSTANCE_PROFILE_PATH_PREFIX);
    for (    InstanceProfileType ip : instanceProfiles) {
      if (DEFAULT_INSTANCE_PROFILE_NAME.equals(ip.getInstanceProfileName())) {
        instanceProfile=ip;
        break;
      }
    }
  }
 catch (  Exception ex) {
    throw new EventHandlerException("Failed to list instance profiles",ex);
  }
  if (instanceProfile == null) {
    try {
      instanceProfile=EucalyptusActivityTasks.getInstance().createInstanceProfile(DEFAULT_INSTANCE_PROFILE_NAME,DEFAULT_INSTANCE_PROFILE_PATH_PREFIX);
    }
 catch (    Exception ex) {
      throw new EventHandlerException("Failed to create instance profile",ex);
    }
  }
  if (instanceProfile == null)   throw new EventHandlerException("No instance profile for loadbalancer VM is found");
  final List<String> result=this.chain.findHandler(IAMRoleSetup.class).getResult();
  String lbRoleName=null;
  if (result != null && result.size() > 0)   lbRoleName=result.get(0);
  try {
    List<RoleType> roles=instanceProfile.getRoles().getMember();
    boolean roleFound=false;
    for (    RoleType role : roles) {
      if (role.getRoleName().equals(lbRoleName)) {
        roleFound=true;
        break;
      }
    }
    if (!roleFound)     throw new NoSuchElementException();
  }
 catch (  Exception ex) {
    if (lbRoleName == null)     throw new EventHandlerException("No role name is found for loadbalancer VMs");
    try {
      EucalyptusActivityTasks.getInstance().addRoleToInstanceProfile(this.instanceProfile.getInstanceProfileName(),lbRoleName);
    }
 catch (    Exception ex2) {
      throw new EventHandlerException("Failed to add role to the instance profile",ex2);
    }
  }
}
