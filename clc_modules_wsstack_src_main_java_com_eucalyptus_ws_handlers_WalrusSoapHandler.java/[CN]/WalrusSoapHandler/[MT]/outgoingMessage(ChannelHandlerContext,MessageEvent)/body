{
  if (event.getMessage() instanceof MappingHttpMessage) {
    final MappingHttpMessage httpMessage=(MappingHttpMessage)event.getMessage();
    if (httpMessage.getMessage() instanceof EucalyptusErrorMessageType) {
      EucalyptusErrorMessageType errorMessage=(EucalyptusErrorMessageType)httpMessage.getMessage();
      EucalyptusMessage errMsg=WalrusUtil.convertErrorMessage(errorMessage);
      if (errMsg instanceof WalrusErrorMessageType) {
        WalrusErrorMessageType walrusErrMsg=(WalrusErrorMessageType)errMsg;
        httpMessage.setSoapEnvelope(createFault(walrusErrMsg.getCode(),walrusErrMsg.getMessage(),walrusErrMsg.getStatus().getReasonPhrase(),walrusErrMsg.getResourceType(),walrusErrMsg.getResource()));
      }
 else {
        httpMessage.setSoapEnvelope(Binding.createFault(errorMessage.getSource(),errorMessage.getMessage(),errorMessage.getStatusMessage()));
      }
    }
 else {
      httpMessage.setSoapEnvelope(HoldMe.getOMSOAP11Factory().getDefaultEnvelope());
      httpMessage.getSoapEnvelope().getBody().addChild(httpMessage.getOmMessage());
    }
    ByteArrayOutputStream byteOut=new ByteArrayOutputStream();
    HoldMe.canHas.lock();
    try {
      httpMessage.getSoapEnvelope().serialize(byteOut);
    }
  finally {
      HoldMe.canHas.unlock();
    }
    ChannelBuffer buffer=ChannelBuffers.wrappedBuffer(byteOut.toByteArray());
    httpMessage.addHeader(HttpHeaders.Names.CONTENT_LENGTH,String.valueOf(buffer.readableBytes()));
    httpMessage.addHeader(HttpHeaders.Names.CONTENT_TYPE,"text/xml; charset=UTF-8");
    httpMessage.setContent(buffer);
  }
}
