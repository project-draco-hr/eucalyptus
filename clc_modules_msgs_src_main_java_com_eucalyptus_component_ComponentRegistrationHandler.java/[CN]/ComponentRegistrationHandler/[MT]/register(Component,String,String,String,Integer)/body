{
  final ServiceBuilder builder=component.getBuilder();
  String partition=part;
  if (!component.getComponentId().isPartitioned()) {
    partition=name;
  }
 else   if (component.getComponentId().isCloudLocal()) {
    partition=Components.lookup(Eucalyptus.class).getComponentId().name();
  }
 else   if (partition == null) {
    LOG.error("BUG: Provided partition is null.  Using the service name as the partition name for the time being.");
    partition=name;
  }
  LOG.info("Using builder: " + builder.getClass().getSimpleName() + " for: "+ partition+ "."+ name+ "@"+ hostName+ ":"+ port);
  if (!builder.checkAdd(partition,name,hostName,port)) {
    LOG.info(builder.getClass().getSimpleName() + ": checkAdd failed.");
    return false;
  }
  try {
    final ServiceConfiguration newComponent=builder.add(partition,name,hostName,port);
    try {
      final CheckedListenableFuture<ServiceConfiguration> future=component.startTransition(newComponent);
      Threads.lookup(ConfigurationService.class,ComponentRegistrationHandler.class,newComponent.getFullName().toString()).submit(new Runnable(){
        public void run(){
          try {
            future.get();
          }
 catch (          Exception ex) {
            LOG.error(ex,ex);
          }
        }
      }
);
      future.addListener(new Runnable(){
        @Override public void run(){
          for (int i=0; i < 3; i++) {
            try {
              future.get(1000,TimeUnit.MILLISECONDS);
            }
 catch (            TimeoutException ex1) {
              LOG.error(ex1,Exceptions.filterStackTrace(ex1,10));
              continue;
            }
catch (            ExecutionException ex1) {
              LOG.error(ex1,Exceptions.filterStackTrace(ex1,10));
              continue;
            }
catch (            InterruptedException ex1) {
              LOG.error(ex1,Exceptions.filterStackTrace(ex1,10));
              Thread.currentThread().interrupt();
              break;
            }
          }
          for (int i=0; i < 3; i++) {
            try {
              component.enableTransition(newComponent).get();
              break;
            }
 catch (            IllegalStateException ex) {
              LOG.error(ex,Exceptions.filterStackTrace(ex,10));
              continue;
            }
catch (            ExecutionException ex) {
              LOG.error(ex,Exceptions.filterStackTrace(ex,10));
              continue;
            }
catch (            InterruptedException ex) {
              LOG.error(ex,Exceptions.filterStackTrace(ex,10));
              Thread.currentThread().interrupt();
              break;
            }
          }
        }
      }
,Threads.lookup(ConfigurationService.class,ComponentRegistrationHandler.class,newComponent.getFullName().toString()));
    }
 catch (    Throwable ex) {
      builder.remove(newComponent);
      LOG.info(builder.getClass().getSimpleName() + ": enable failed because of: " + ex.getMessage());
    }
    return true;
  }
 catch (  Throwable e) {
    e=Exceptions.filterStackTrace(e);
    LOG.info(builder.getClass().getSimpleName() + ": add failed because of: " + e.getMessage());
    LOG.error(e,e);
    throw new ServiceRegistrationException(builder.getClass().getSimpleName() + ": add failed with message: " + e.getMessage(),e);
  }
}
