{
  VmTypeAvailability vmType=this.typeMap.get(vmTypeName);
  NavigableSet<VmTypeAvailability> sorted=this.sorted();
  int available=0;
  if (sorted.headSet(VmTypeAvailability.ZERO).contains(vmType))   available=sorted.higher(VmTypeAvailability.ZERO).getAvailable();
 else   available=vmType.getAvailable();
  if (available < quantity)   throw new NotEnoughResourcesAvailable();
  for (  VmTypeAvailability v : sorted.tailSet(VmTypeAvailability.ZERO))   v.decrement(quantity);
  if (!sorted.headSet(VmTypeAvailability.ZERO).contains(vmType))   for (  VmTypeAvailability v : sorted.headSet(vmType))   v.setDisabled(true);
  ResourceToken token=new ResourceToken(this.parent.getName(),requestId,userName,quantity,this.virtualTimer++,vmTypeName);
  this.pendingTokens.add(token);
  return token;
}
