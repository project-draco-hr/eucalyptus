{
  if (!bootSet.hasKernel()) {
    throw new InvalidMetadataException("Image specified does not have a kernel: " + bootSet);
  }
  boolean skipRamdisk=false;
  String ramdiskId=null;
  Context ctx=null;
  try {
    ctx=Contexts.lookup();
    if (ctx.getRequest() instanceof RunInstancesType) {
      RunInstancesType msg=(RunInstancesType)ctx.getRequest();
      if (ImageUtil.isSet(msg.getKernelId())) {
        skipRamdisk|=(!ImageUtil.isSet(msg.getRamdiskId()));
      }
 else {
        skipRamdisk|=(ImageUtil.isSet(bootSet.getMachine().getKernelId()) && !ImageUtil.isSet(bootSet.getMachine().getRamdiskId()) && !ImageUtil.isSet(msg.getRamdiskId()));
      }
      ramdiskId=((RunInstancesType)ctx.getRequest()).getRamdiskId();
    }
  }
 catch (  IllegalContextAccessException ex) {
    LOG.error(ex,ex);
  }
  if (ramdiskId == null || "".equals(ramdiskId)) {
    ramdiskId=bootSet.getMachine().getRamdiskId();
  }
  if (ramdiskId == null || "".equals(ramdiskId)) {
    ramdiskId=ImageConfiguration.getInstance().getDefaultRamdiskId();
  }
  Preconditions.checkNotNull(ramdiskId,"Attempt to resolve a ramdiskId for " + bootSet.toString() + " during request "+ (ctx != null ? ctx.getRequest().toSimpleString() : "UNKNOWN"));
  if (ramdiskId == null) {
    throw new InvalidMetadataException("Unable to determine required ramdisk image for " + bootSet.toString());
  }
 else   if (!ramdiskId.startsWith(ImageMetadata.Type.ramdisk.getTypePrefix())) {
    throw new InvalidMetadataException("Image specified is not a ramdisk: " + ramdiskId);
  }
  return ramdiskId;
}
