{
  List<String> attrNames=Lists.newArrayList();
  attrNames.addAll(lic.getUserInfoAttributes());
  if (!lic.getUserInfoAttributes().contains(lic.getUserIdAttribute())) {
    attrNames.add(lic.getUserIdAttribute());
  }
  if (VERBOSE) {
    LOG.debug("Search users by: baseDn=" + lic.getUserBaseDn() + ", attributes="+ attrNames);
  }
  NamingEnumeration<SearchResult> results=ldap.search(lic.getUserBaseDn(),WILDCARD_FILTER,attrNames.toArray(new String[0]));
  try {
    Map<String,Map<String,String>> userMap=Maps.newHashMap();
    while (results.hasMore()) {
      Attributes attrs=results.next().getAttributes();
      if (VERBOSE) {
        LOG.debug("Retrieved user: " + attrs);
      }
      Map<String,String> infoMap=Maps.newHashMap();
      for (      String attr : lic.getUserInfoAttributes()) {
        infoMap.put(attr,(String)attrs.get(attr).get());
      }
      userMap.put(getId(lic.getUserIdAttribute(),attrs),infoMap);
    }
    return userMap;
  }
 catch (  NamingException e) {
    LOG.error(e,e);
    throw new LdapException("Error reading users",e);
  }
}
