{
  VmTypeAvailability vmType=this.typeMap.get(vmTypeName);
  NavigableSet<VmTypeAvailability> sorted=this.sorted();
  LOG.warn("BEFORE ALLOCATE ============================");
  LOG.warn(sorted);
  if (vmType.getAvailable() < quantity)   throw new NotEnoughResourcesAvailable();
  Set<VmTypeAvailability> tailSet=sorted.tailSet(vmType);
  Set<VmTypeAvailability> headSet=sorted.headSet(vmType);
  LOG.warn("DURING ALLOCATE ============================");
  LOG.warn("TAILSET: " + tailSet);
  LOG.warn("HEADSET: " + headSet);
  for (  VmTypeAvailability v : tailSet)   v.decrement(quantity);
  for (  VmTypeAvailability v : headSet)   v.setAvailable(vmType.getAvailable());
  LOG.warn("AFTER ALLOCATE ============================");
  LOG.warn(sorted);
  ResourceToken token=new ResourceToken(this.parent.getName(),requestId,userName,quantity,this.virtualTimer++,vmTypeName);
  this.pendingTokens.add(token);
  return token;
}
