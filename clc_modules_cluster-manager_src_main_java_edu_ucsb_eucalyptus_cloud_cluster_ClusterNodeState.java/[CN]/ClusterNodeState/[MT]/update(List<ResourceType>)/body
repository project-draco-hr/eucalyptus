{
  int outstandingCount=0;
  for (  ResourceToken t : this.pendingTokens)   outstandingCount+=t.getAmount();
  for (  ResourceToken t : this.submittedTokens)   outstandingCount+=t.getAmount();
  for (  ResourceToken t : this.redeemedTokens)   outstandingCount+=t.getAmount();
  this.redeemedTokens.clear();
  for (  ResourceType rsc : rscUpdate) {
    VmTypeAvailability vmAvailable=this.typeMap.get(rsc.getInstanceType().getName());
    if (vmAvailable == null)     continue;
    vmAvailable.setAvailable(rsc.getAvailableInstances());
    vmAvailable.decrement(outstandingCount);
    vmAvailable.setMax(rsc.getMaxInstances());
  }
}
