{
  this.runnable=runnable;
  this.txUuid=String.format("%s:%s",ctx,UUID.randomUUID().toString());
  this.owner=Threads.currentStackString();
  this.startTime=Calendar.getInstance();
  this.stopWatch=new StopWatch();
  this.stopWatch.start();
  final EntityManagerFactory anemf=(EntityManagerFactoryImpl)PersistenceContexts.getEntityManagerFactory(ctx);
  Assertions.assertNotNull(anemf,"Failed to find persistence context for ctx=" + ctx);
  try {
    this.em=anemf.createEntityManager();
    Assertions.assertNotNull(this.em,"Failed to build entity manager for persistence context ctx=" + ctx);
    this.delegate=this.em.getTransaction();
    this.delegate.begin();
    this.session=new WeakReference<Session>((Session)this.em.getDelegate());
  }
 catch (  final Throwable e) {
    this.rollback();
    LOG.error(e,e);
    throw new RuntimeException(e);
  }
 finally {
    outstanding.put(this.txUuid,this);
  }
}
