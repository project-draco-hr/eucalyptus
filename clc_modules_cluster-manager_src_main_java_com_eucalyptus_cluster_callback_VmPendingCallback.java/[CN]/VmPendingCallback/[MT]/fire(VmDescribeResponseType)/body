{
  for (  final VmInfo runVm : reply.getVms()) {
    runVm.setPlacement(this.getSubject().getConfiguration().getName());
    VmState state=VmState.Mapper.get(runVm.getStateName());
    try {
      final VmInstance vm=VmInstances.lookup(runVm.getInstanceId());
      vm.setServiceTag(runVm.getServiceTag());
      if (VmState.SHUTTING_DOWN.equals(vm.getState()) && vm.getSplitTime() > VmInstances.SHUT_DOWN_TIME) {
        vm.setState(VmState.TERMINATED,Reason.EXPIRED);
      }
 else       if (VmState.SHUTTING_DOWN.equals(vm.getState()) && VmState.SHUTTING_DOWN.equals(state)) {
        vm.setState(VmState.TERMINATED,Reason.APPEND,"DONE");
      }
 else       if ((VmState.PENDING.equals(state) || VmState.RUNNING.equals(state)) && (VmState.PENDING.equals(vm.getState()) || VmState.RUNNING.equals(vm.getState()))) {
        if (!VmInstance.DEFAULT_IP.equals(runVm.getNetParams().getIpAddress())) {
          vm.updateAddresses(runVm.getNetParams().getIpAddress(),runVm.getNetParams().getIgnoredPublicIp());
        }
        vm.setState(VmState.Mapper.get(runVm.getStateName()),Reason.APPEND,"UPDATE");
        vm.updateNetworkIndex(runVm.getNetParams().getNetworkIndex());
        vm.updateVolumeAttachments(runVm.getVolumes());
      }
    }
 catch (    NoSuchElementException e) {
      LOG.debug("Ignoring update for uncached vm: " + runVm.getInstanceId());
    }
  }
}
