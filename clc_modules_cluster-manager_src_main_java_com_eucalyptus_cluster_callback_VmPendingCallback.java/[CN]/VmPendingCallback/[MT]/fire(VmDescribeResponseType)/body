{
  for (  final VmInfo runVm : reply.getVms()) {
    runVm.setPlacement(this.getSubject().getConfiguration().getName());
    VmState state=VmState.Mapper.get(runVm.getStateName());
    EntityTransaction db=Entities.get(VmInstance.class);
    try {
      final VmInstance vm=VmInstances.lookup(runVm.getInstanceId());
      vm.setServiceTag(runVm.getServiceTag());
      if (VmStateSet.RUN.apply(vm) || VmStateSet.CHANGING.apply(vm)) {
        vm.doUpdate().apply(runVm);
      }
 else       if (VmInstances.Timeout.SHUTTING_DOWN.apply(vm)) {
        VmInstances.terminated(vm);
      }
 else       if (VmState.SHUTTING_DOWN.apply(vm) && VmState.SHUTTING_DOWN.equals(state)) {
        VmInstances.terminated(vm);
      }
 else       if (VmStateSet.RUN.apply(vm) && VmStateSet.RUN.contains(state)) {
        if (!VmNetworkConfig.DEFAULT_IP.equals(runVm.getNetParams().getIpAddress())) {
          vm.updateAddresses(runVm.getNetParams().getIpAddress(),runVm.getNetParams().getIgnoredPublicIp());
        }
        vm.setState(VmState.Mapper.get(runVm.getStateName()),Reason.APPEND,"UPDATE");
        vm.updateVolumeAttachments(runVm.getVolumes());
      }
      db.commit();
    }
 catch (    Exception ex) {
      LOG.debug("Ignoring update for uncached vm: " + runVm.getInstanceId());
    }
  }
}
