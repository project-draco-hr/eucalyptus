{
  final Context ctx=Contexts.lookup();
  final User user=ctx.getUser();
  if (!Permissions.isAuthorized(PolicySpec.VENDOR_LOADBALANCING,PolicySpec.ALL_RESOURCE,"",null,getIamActionByMessageType(message),user)) {
    throw new EucalyptusWebServiceException("UnauthorizedOperation",Role.Sender,"You are not authorized to perform this operation.");
  }
  try {
    final LoadBalancingBackendMessage out=(LoadBalancingBackendMessage)mapper.readValue(mapper.valueToTree(message),Class.forName(message.getClass().getName().replace(".common.msgs.",".common.backend.msgs.")));
    if (out instanceof LoadBalancingServoBackendMessage) {
      final LoadBalancingServoBackendMessage servoOut=(LoadBalancingServoBackendMessage)out;
      final InetSocketAddress remoteAddr=((InetSocketAddress)ctx.getChannel().getRemoteAddress());
      final String remoteHost=remoteAddr.getAddress().getHostAddress();
      servoOut.setSourceIp(remoteHost);
    }
    final BaseMessage result=AsyncRequests.sendSyncWithCurrentIdentity(Topology.lookup(LoadBalancingBackend.class),out);
    final LoadBalancingMessage response=(LoadBalancingMessage)mapper.readValue(mapper.valueToTree(result),message.getReply().getClass());
    response.setCorrelationId(message.getCorrelationId());
    return response;
  }
 catch (  Exception e) {
    Exceptions.findAndRethrow(e,EucalyptusWebServiceException.class,EucalyptusCloudException.class);
    throw new EucalyptusCloudException(e);
  }
}
