{
  String certPem=new String(UrlBase64.encode(Hashes.getPemBytes(cert)));
  User searchUser=new User();
  X509Cert searchCert=new X509Cert();
  searchCert.setPemCertificate(certPem);
  EntityWrapper<User> db=Credentials.getEntityWrapper();
  try {
    Session session=db.getSession();
    Example qbeUser=Example.create(searchUser).enableLike(MatchMode.EXACT);
    Example qbeCert=Example.create(searchCert).enableLike(MatchMode.EXACT);
    List<User> users=(List<User>)session.createCriteria(User.class).add(qbeUser).createCriteria("certificates").add(qbeCert).list();
    if (users.size() > 1) {
      db.rollback();
      throw new GeneralSecurityException("Multiple users with the same certificate.");
    }
 else     if (users.size() < 1) {
      throw new GeneralSecurityException("No user with the specified certificate.");
    }
    db.commit();
    return users.get(0).getUserName();
  }
 catch (  HibernateException e) {
    db.rollback();
    throw new GeneralSecurityException(e);
  }
}
