{
  Map<String,String> parameters=httpRequest.getParameters();
  String verb=httpRequest.getMethod().getName();
  String addr=httpRequest.getUri();
  if (httpRequest.containsHeader(StorageProperties.StorageSecurityParameters.EucaSignature.toString())) {
    String date=httpRequest.getAndRemoveHeader(SecurityParameter.Date.toString());
    String eucaCert=httpRequest.getAndRemoveHeader(StorageProperties.StorageSecurityParameters.EucaCert.toString());
    String signature=httpRequest.getAndRemoveHeader(StorageProperties.StorageSecurityParameters.EucaSignature.toString());
    String data=verb + "\n" + date+ "\n"+ addr+ "\n";
    Signature sig;
    boolean valid=false;
    try {
      byte[] bytes=Base64.decode(eucaCert);
      String certString=new String(bytes);
      PEMReader pemReader=new PEMReader(new StringReader(certString));
      X509Certificate cert=(X509Certificate)pemReader.readObject();
      AbstractKeyStore keyStore=EucaKeyStore.getInstance();
      if (keyStore.getCertificateAlias(cert) != null) {
        PublicKey publicKey=cert.getPublicKey();
        sig=Signature.getInstance("SHA1withRSA");
        sig.initVerify(publicKey);
        sig.update(data.getBytes());
        valid=sig.verify(Base64.decode(signature));
      }
 else {
        LOG.warn("WalrusQuerySecurityHandler(): certificate not found in keystore");
      }
    }
 catch (    Exception ex) {
      LOG.warn("Authentication exception: " + ex.getMessage());
      ex.printStackTrace();
    }
    if (!valid) {
      throw new AuthenticationException("User authentication failed.");
    }
  }
 else   if (httpRequest.containsHeader(WalrusProperties.FormField.FormUploadPolicyData.toString())) {
    String data=httpRequest.getAndRemoveHeader(WalrusProperties.FormField.FormUploadPolicyData.toString());
    String auth_part=httpRequest.getAndRemoveHeader(SecurityParameter.Authorization.toString());
    if (auth_part != null) {
      String sigString[]=getSigInfo(auth_part);
      String signature=sigString[1];
      authenticate(httpRequest,sigString[0],signature,data);
    }
    throw new AuthenticationException("User authentication failed.");
  }
 else {
    String content_md5=httpRequest.getAndRemoveHeader("Content-MD5");
    content_md5=content_md5 == null ? "" : content_md5;
    String content_type=httpRequest.getHeader(WalrusProperties.CONTENT_TYPE);
    content_type=content_type == null ? "" : content_type;
    if (httpRequest.containsHeader(WalrusProperties.VIRTUAL_SUBDOMAIN)) {
      String bukkit=httpRequest.getAndRemoveHeader(WalrusProperties.VIRTUAL_SUBDOMAIN);
      addr=addr.replaceAll("services/" + WalrusProperties.SERVICE_NAME,"");
      addr="/" + bukkit + addr;
    }
    String[] addrStrings=addr.split("\\?");
    String addrString=addrStrings[0];
    if (addrStrings.length > 1) {
      for (      WalrusProperties.SubResource subResource : WalrusProperties.SubResource.values()) {
        if (addr.endsWith(subResource.toString().toLowerCase())) {
          addrString+="?" + subResource.toString().toLowerCase();
          break;
        }
      }
    }
    if (httpRequest.containsHeader(SecurityParameter.Authorization.toString())) {
      String date;
      String verifyDate;
      if (httpRequest.containsHeader("x-amz-date")) {
        date="";
        verifyDate=httpRequest.getHeader("x-amz-date");
      }
 else {
        date=httpRequest.getAndRemoveHeader(SecurityParameter.Date.toString());
        verifyDate=date;
        if (date == null || date.length() <= 0)         throw new AuthenticationException("User authentication failed. Date must be specified.");
      }
      try {
        Date dateToVerify=DateUtil.parseDate(verifyDate);
        Date currentDate=new Date();
        if (Math.abs(currentDate.getTime() - dateToVerify.getTime()) > EXPIRATION_LIMIT)         throw new AuthenticationException("Message expired. Sorry.");
      }
 catch (      Exception ex) {
        throw new AuthenticationException("Unable to parse date.");
      }
      String data=verb + "\n" + content_md5+ "\n"+ content_type+ "\n"+ date+ "\n"+ getCanonicalizedAmzHeaders(httpRequest)+ addrString;
      String auth_part=httpRequest.getAndRemoveHeader(SecurityParameter.Authorization.toString());
      String sigString[]=getSigInfo(auth_part);
      String signature=sigString[1];
      authenticate(httpRequest,sigString[0],signature,data);
    }
 else     if (parameters.containsKey(SecurityParameter.AWSAccessKeyId.toString())) {
      String accesskeyid=parameters.remove(SecurityParameter.AWSAccessKeyId.toString());
      try {
        String signature=URLDecoder.decode(parameters.remove(SecurityParameter.Signature.toString()),"UTF-8");
        if (signature == null) {
          throw new AuthenticationException("User authentication failed. Null signature.");
        }
        String expires=parameters.remove(SecurityParameter.Expires.toString());
        if (expires == null) {
          throw new AuthenticationException("Authentication failed. Expires must be specified.");
        }
        if (checkExpires(expires)) {
          String stringToSign=verb + "\n" + content_md5+ "\n"+ content_type+ "\n"+ Long.parseLong(expires)+ "\n"+ getCanonicalizedAmzHeaders(httpRequest)+ addrString;
          authenticate(httpRequest,accesskeyid,signature,stringToSign);
        }
 else {
          throw new AuthenticationException("Cannot process request. Expired.");
        }
      }
 catch (      Exception ex) {
        throw new AuthenticationException("Could not verify request " + ex.getMessage());
      }
    }
 else {
    }
  }
}
