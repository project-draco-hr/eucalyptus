{
  if (reportType == null)   throw new IllegalArgumentException("ReportType can't be null");
  if (criterion == null)   throw new IllegalArgumentException("Criterion can't be null");
  if (displayUnits == null)   displayUnits=Units.DEFAULT_DISPLAY_UNITS;
  final Map<String,String> params=new HashMap<String,String>();
  params.put("criterion",criterion.toString());
  params.put("timeUnit",displayUnits.getTimeUnit().toString());
  params.put("sizeUnit",displayUnits.getSizeUnit().toString());
  params.put("sizeTimeTimeUnit",displayUnits.getSizeTimeTimeUnit().toString());
  params.put("sizeTimeSizeUnit",displayUnits.getSizeTimeSizeUnit().toString());
  if (groupByCriterion != null) {
    params.put("groupByCriterion",groupByCriterion.toString());
  }
  final String filename=(groupByCriterion == null) ? reportType.getJrxmlFilename() : reportType.getNestedJrxmlFilename();
  final File jrxmlFile=new File(SubDirectory.REPORTS.toString() + File.separator + filename);
  JRDataSource dataSource=null;
switch (reportType) {
case INSTANCE:
    List<InstanceReportLine> irl=InstanceReportLineGenerator.getInstance().getReportLines(period,criterion,groupByCriterion,displayUnits);
  dataSource=new JRBeanCollectionDataSource(irl);
break;
case STORAGE:
List<StorageReportLine> srl=StorageReportLineGenerator.getInstance().getReportLines(period,criterion,groupByCriterion,displayUnits);
dataSource=new JRBeanCollectionDataSource(srl);
break;
case S3:
List<S3ReportLine> s3rl=S3ReportLineGenerator.getInstance().getReportLines(period,criterion,groupByCriterion,displayUnits);
dataSource=new JRBeanCollectionDataSource(s3rl);
break;
}
try {
JasperReport report=JasperCompileManager.compileReport(jrxmlFile.getAbsolutePath());
JasperPrint jasperPrint=JasperFillManager.fillReport(report,params,dataSource);
JRExporter exporter=format.getExporter();
exporter.setParameter(JRExporterParameter.OUTPUT_STREAM,out);
exporter.setParameter(JRExporterParameter.JASPER_PRINT,jasperPrint);
exporter.exportReport();
}
 catch (Exception ex) {
throw new RuntimeException(ex);
}
}
