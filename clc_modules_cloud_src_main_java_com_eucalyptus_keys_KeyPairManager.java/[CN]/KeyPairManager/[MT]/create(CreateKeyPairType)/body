{
  CreateKeyPairResponseType reply=request.getReply();
  com.eucalyptus.context.Context ctx=Contexts.lookup();
  try {
    KeyPairUtil.getUserKeyPair(ctx.getUserFullName(),request.getKeyName());
  }
 catch (  Exception e1) {
    PrivateKey pk=KeyPairUtil.createUserKeyPair(ctx.getUserFullName(),request.getKeyName());
    reply.setKeyFingerprint(Certs.getFingerPrint(pk));
    ByteArrayOutputStream byteOut=new ByteArrayOutputStream();
    PEMWriter privOut=new PEMWriter(new OutputStreamWriter(byteOut));
    try {
      privOut.writeObject(pk);
      privOut.close();
    }
 catch (    IOException e) {
      LOG.error(e);
      throw new EucalyptusCloudException(e);
    }
    reply.setKeyName(request.getKeyName());
    reply.setKeyMaterial(byteOut.toString());
    return reply;
  }
  throw new EucalyptusCloudException("Creation failed.  Keypair already exists: " + request.getKeyName());
}
