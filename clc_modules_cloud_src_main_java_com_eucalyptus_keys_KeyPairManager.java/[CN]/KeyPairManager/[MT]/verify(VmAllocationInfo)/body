{
  if (SshKeyPair.NO_KEY_NAME.equals(vmAllocInfo.getRequest().getKeyName()) || vmAllocInfo.getRequest().getKeyName() == null) {
    if ("windows".equals(vmAllocInfo.getPlatform())) {
      throw new EucalyptusCloudException("You must specify a keypair when running a windows vm: " + vmAllocInfo.getRequest().getImageId());
    }
 else {
      vmAllocInfo.setKeyInfo(new VmKeyInfo());
      return vmAllocInfo;
    }
  }
  RunInstancesType request=vmAllocInfo.getRequest();
  String action=PolicySpec.requestToAction(request);
  String keyName=request.getKeyName();
  User requestUser=Permissions.getUserById(request.getUserId());
  Account account=Permissions.getAccountByUserId(request.getUserId());
  SshKeyPair keypair=KeyPairUtil.getUserKeyPair(account.getId(),keyName);
  if (keypair == null) {
    throw new EucalyptusCloudException("Failed to find keypair: " + keyName);
  }
  if (!Permissions.isAuthorized(PolicySpec.EC2_RESOURCE_KEYPAIR,keyName,account,action,requestUser)) {
    throw new EucalyptusCloudException("Not authorized to use keypair " + keyName + " by "+ requestUser.getName());
  }
  vmAllocInfo.setKeyInfo(new VmKeyInfo(keypair.getDisplayName(),keypair.getPublicKey(),keypair.getFingerPrint()));
  return vmAllocInfo;
}
