{
  ModifyImageAttributeResponseType reply=(ModifyImageAttributeResponseType)request.getReply();
  final Context ctx=Contexts.lookup();
  final String requestAccountId=ctx.getUserFullName().getAccountNumber();
  final User requestUser=ctx.getUser();
  final String action=PolicySpec.requestToAction(request);
  EntityWrapper<ImageInfo> db=EntityWrapper.get(ImageInfo.class);
  ImageInfo imgInfo=null;
  try {
    imgInfo=db.getUnique(Images.exampleWithImageId(request.getImageId()));
    if (!ctx.hasAdministrativePrivileges() && (!imgInfo.getOwnerAccountNumber().equals(requestAccountId) || !Permissions.isAuthorized(PolicySpec.VENDOR_EC2,PolicySpec.EC2_RESOURCE_IMAGE,request.getImageId(),null,action,requestUser))) {
      throw new EucalyptusCloudException("Not authorized to modify image attribute");
    }
    for (    String productCode : request.getProductCodes()) {
      imgInfo.addProductCode(productCode);
    }
    if (request.getAttribute() != null) {
      if (ADD.equals(request.getOperationType())) {
        imgInfo.addPermissions(request.getQueryUserId());
        if (!request.getQueryUserGroup().isEmpty()) {
          imgInfo.setImagePublic(true);
        }
      }
 else {
        imgInfo.removePermissions(request.getQueryUserId());
        if (!request.getQueryUserGroup().isEmpty()) {
          imgInfo.setImagePublic(false);
        }
      }
    }
    db.commit();
    reply.set_return(true);
  }
 catch (  EucalyptusCloudException e) {
    LOG.error(e,e);
    db.rollback();
    reply.set_return(false);
  }
  return reply;
}
