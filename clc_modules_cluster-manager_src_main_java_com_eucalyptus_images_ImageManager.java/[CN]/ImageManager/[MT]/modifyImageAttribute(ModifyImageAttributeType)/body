{
  final ModifyImageAttributeResponseType reply=(ModifyImageAttributeResponseType)request.getReply();
  final Context ctx=Contexts.lookup();
  final String requestAccountId=ctx.getUserFullName().getAccountNumber();
  final EntityTransaction db=Entities.get(ImageInfo.class);
  try {
    final ImageInfo imgInfo=Entities.uniqueResult(Images.exampleWithImageId(imageIdentifier(request.getImageId())));
    if (!ctx.hasAdministrativePrivileges() && (!imgInfo.getOwnerAccountNumber().equals(requestAccountId) || !RestrictedTypes.filterPrivileged().apply(imgInfo))) {
      throw new EucalyptusCloudException("Not authorized to modify image attribute");
    }
switch (request.getImageAttribute()) {
case LaunchPermission:
      if (request.isAdd()) {
        imgInfo.addPermissions(verifyUserIds(request.getUserIds()));
        if (request.isGroupAll()) {
          imgInfo.setImagePublic(true);
        }
      }
 else {
        imgInfo.removePermissions(request.getUserIds());
        if (request.isGroupAll()) {
          imgInfo.setImagePublic(false);
        }
      }
    break;
case ProductCode:
  for (  String productCode : request.getProductCodes()) {
    imgInfo.addProductCode(productCode);
  }
break;
case Description:
imgInfo.setDescription(request.getDescription());
break;
}
db.commit();
reply.set_return(true);
}
 catch (EucalyptusCloudException e) {
db.rollback();
reply.set_return(false);
throw e;
}
return reply;
}
