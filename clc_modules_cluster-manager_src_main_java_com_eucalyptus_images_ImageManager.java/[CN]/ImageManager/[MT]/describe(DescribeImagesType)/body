{
  DescribeImagesResponseType reply=request.getReply();
  final Context ctx=Contexts.lookup();
  final String requestAccountId=ctx.getUserFullName().getAccountNumber();
  final Set<String> imageSelectionSet=request.getImagesSet() != null ? new HashSet<String>(request.getImagesSet()) : new HashSet<String>();
  final Set<String> ownerSelectionSet=request.getOwnersSet() != null ? new HashSet<String>(request.getOwnersSet()) : new HashSet<String>();
  if (ownerSelectionSet.remove(SELF)) {
    ownerSelectionSet.add(requestAccountId);
  }
  final Set<String> exeBySelectionSet=request.getExecutableBySet() != null ? new HashSet<String>(request.getExecutableBySet()) : new HashSet<String>();
  final boolean exeByNonEmpty=exeBySelectionSet.size() > 0;
  final boolean exeByHasSelf=exeBySelectionSet.remove(SELF);
  final boolean exeByHasAll=exeBySelectionSet.remove(ALL);
  final Predicate<ImageInfo> imageFilter=new Predicate<ImageInfo>(){
    /** 
 * @param image
 * @param accountIds
 * @return true if image has launch permission for any of the account in accountIds
 */
    private boolean allowsAny(    ImageInfo image,    Set<String> accountIds){
      final Set<LaunchPermission> permissions=image.getPermissions();
      for (      String aid : accountIds) {
        if (permissions.contains(new LaunchPermission(image,aid))) {
          return true;
        }
      }
      return false;
    }
    /** 
 * @param image
 * @param accountId
 * @return true if image has launch permission including public, explicit and implicit
 */
    private boolean hasLaunchPermission(    ImageInfo image,    String accountId){
      return image.getImagePublic() || hasExplicitOrImplicitLaunchPermission(image,accountId);
    }
    /** 
 * @param image
 * @param accountId
 * @return true if image has explicit or implicit launch permission
 */
    private boolean hasExplicitOrImplicitLaunchPermission(    ImageInfo image,    String accountId){
      return image.getOwnerAccountId().equals(accountId) || image.getPermissions().contains(new LaunchPermission(image,accountId));
    }
    @Override public boolean apply(    ImageInfo image){
      if (imageSelectionSet.size() > 0 && !imageSelectionSet.contains(image.getDisplayName())) {
        return false;
      }
      if (!ctx.hasAdministrativePrivileges() && !hasLaunchPermission(image,requestAccountId)) {
        return false;
      }
      if (ownerSelectionSet.size() > 0 && !ownerSelectionSet.contains(image.getOwnerAccountId())) {
        return false;
      }
      if (exeByNonEmpty) {
        if (!((exeByHasAll && image.getImagePublic()) || (exeByHasSelf && hasExplicitOrImplicitLaunchPermission(image,requestAccountId)) || (exeBySelectionSet.size() > 0 && image.getOwnerAccountId().equals(requestAccountId) && allowsAny(image,exeBySelectionSet)))) {
          return false;
        }
      }
      if (!Lookups.checkPrivilege(request,PolicySpec.VENDOR_EC2,PolicySpec.EC2_RESOURCE_IMAGE,image.getDisplayName(),image.getOwner())) {
        return false;
      }
      return true;
    }
  }
;
  List<ImageDetails> imageDetailsList=Transactions.filteredTransform(new ImageInfo(),imageFilter,Images.TO_IMAGE_DETAILS);
  reply.getImagesSet().addAll(imageDetailsList);
  ImageUtil.cleanDeregistered();
  return reply;
}
