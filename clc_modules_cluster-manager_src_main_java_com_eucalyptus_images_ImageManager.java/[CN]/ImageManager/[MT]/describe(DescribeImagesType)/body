{
  DescribeImagesResponseType reply=request.getReply();
  final Context ctx=Contexts.lookup();
  final String requestAccountId=ctx.getUserFullName().getAccountNumber();
  final User requestUser=ctx.getUser();
  final String action=PolicySpec.requestToAction(request);
  final Set<String> imageSelectionSet=request.getImagesSet() != null ? new HashSet<String>(request.getImagesSet()) : new HashSet<String>();
  final Set<String> ownerSelectionSet=request.getOwnersSet() != null ? new HashSet<String>(request.getOwnersSet()) : new HashSet<String>();
  if (ownerSelectionSet.remove(SELF)) {
    ownerSelectionSet.add(requestAccountId);
  }
  final Set<String> exeBySelectionSet=request.getExecutableBySet() != null ? new HashSet<String>(request.getExecutableBySet()) : new HashSet<String>();
  final boolean exeByNonEmpty=exeBySelectionSet.size() > 0;
  final boolean exeByHasSelf=exeBySelectionSet.remove(SELF);
  final boolean exeByHasAll=exeBySelectionSet.remove(ALL);
  final Predicate<ImageInfo> imageFilter=new Predicate<ImageInfo>(){
    @Override public boolean apply(    ImageInfo image){
      if (imageSelectionSet.size() > 0 && !imageSelectionSet.contains(image.getDisplayName())) {
        return false;
      }
      if (!ctx.hasAdministrativePrivileges() && !image.hasPermissionForOne(requestAccountId)) {
        return false;
      }
      if (ownerSelectionSet.size() > 0 && !ownerSelectionSet.contains(image.getOwnerAccountId())) {
        return false;
      }
      if (exeByNonEmpty) {
        if (!((exeByHasAll && image.getImagePublic()) || (exeByHasSelf && image.hasExplicitOrImplicitPermissionForOne(requestAccountId)) || (exeBySelectionSet.size() > 0 && image.getOwnerAccountId().equals(requestAccountId) && image.hasExplicitPermissionForAny(exeBySelectionSet)))) {
          return false;
        }
      }
      if (!Permissions.isAuthorized(PolicySpec.VENDOR_EC2,PolicySpec.EC2_RESOURCE_IMAGE,image.getDisplayName(),null,action,requestUser)) {
        return false;
      }
      return true;
    }
  }
;
  List<ImageDetails> imageDetailsList=Transactions.filteredTransform(new ImageInfo(),imageFilter,Images.TO_IMAGE_DETAILS);
  reply.getImagesSet().addAll(imageDetailsList);
  ImageUtil.cleanDeregistered();
  return reply;
}
