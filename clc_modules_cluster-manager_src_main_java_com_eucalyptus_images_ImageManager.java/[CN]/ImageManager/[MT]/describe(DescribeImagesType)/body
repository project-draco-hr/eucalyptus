{
  DescribeImagesResponseType reply=request.getReply();
  final Context ctx=Contexts.lookup();
  final Account requestAccount=ctx.getAccount();
  final String requestAccountId=ctx.getUserFullName().getAccountNumber();
  final List<String> imageList=request.getImagesSet();
  final List<String> owners=request.getOwnersSet();
  final List<String> executable=request.getExecutableBySet();
  final boolean showPublic=executable.remove("all");
  final boolean showMyImages=owners.remove("self");
  final boolean showMyAllowedImages=executable.remove("self");
  final Predicate<ImageInfo> imageFilter=new Predicate<ImageInfo>(){
    @Override public boolean apply(    ImageInfo t){
      if (showMyImages && requestAccountId.equals(t.getOwnerAccountId())) {
        LOG.trace("Considering image " + t.getFullName() + " because user wants to see their images and is owner.");
      }
 else       if (showMyAllowedImages && t.isAllowed(requestAccount)) {
        LOG.trace("Considering image " + t.getFullName() + " because user wants to see their executable images and is allowed.");
      }
 else       if (showPublic && t.getImagePublic()) {
        LOG.trace("Considering image " + t.getFullName() + " because user wants to see public images and it is public.");
      }
 else       if (!t.isAllowed(requestAccount)) {
        LOG.trace("Rejecting image " + t.getFullName() + " because user is not allowed.");
        return false;
      }
      if (!Lookups.checkPrivilege(request,PolicySpec.VENDOR_EC2,PolicySpec.EC2_RESOURCE_IMAGE,t.getDisplayName(),t.getOwner())) {
        LOG.error("Accessing image " + t.getDisplayName() + " is denied by permission of "+ ctx.getUser().getName());
        return false;
      }
      if (!imageList.isEmpty() && !imageList.contains(t.getDisplayName())) {
        LOG.trace("Rejecting image " + t.getFullName() + " because user provide an image id list which does not contain the result: "+ imageList);
        return false;
      }
 else       if (!owners.isEmpty() && !owners.contains(t.getOwnerAccountId())) {
        LOG.trace("Rejecting image " + t.getFullName() + " because user provide an image id list which does not contain the result: "+ owners);
        return false;
      }
 else       if (!executable.isEmpty()) {
        for (        String accountId : executable) {
          try {
            if ("self".equals(accountId) || ctx.hasAdministrativePrivileges() || t.isAllowed(Accounts.lookupAccountById(accountId))) {
              return true;
            }
          }
 catch (          AuthException ex) {
            LOG.error(ex);
          }
        }
        LOG.trace("Rejecting image " + t.getFullName() + " because user provide an image id list which does not contain the result: "+ owners);
        return false;
      }
      return true;
    }
  }
;
  List<ImageDetails> imageDetailsList=Transactions.filteredTransform(new ImageInfo(),imageFilter,Images.TO_IMAGE_DETAILS);
  reply.getImagesSet().addAll(imageDetailsList);
  ImageUtil.cleanDeregistered();
  return reply;
}
