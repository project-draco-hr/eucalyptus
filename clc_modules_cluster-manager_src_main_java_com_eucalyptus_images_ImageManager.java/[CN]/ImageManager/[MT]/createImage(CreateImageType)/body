{
  CreateImageResponseType reply=request.getReply();
  Context ctx=Contexts.lookup();
  VmInstance vm=null;
  try {
    vm=VmInstances.lookup(request.getInstanceId());
  }
 catch (  NoSuchElementException e) {
    LOG.debug(e,e);
    throw new EucalyptusCloudException("Instance does not exist: " + request.getInstanceId());
  }
  if (!Types.checkPrivilege(request,PolicySpec.VENDOR_EC2,PolicySpec.EC2_RESOURCE_INSTANCE,request.getInstanceId(),vm.getOwner())) {
    throw new EucalyptusCloudException("Not authorized to create an image from instance " + request.getInstanceId() + " as "+ ctx.getUser().getName());
  }
  if (!VmState.RUNNING.equals(vm.getRuntimeState()) && !VmState.STOPPED.equals(vm.getRuntimeState())) {
    throw new EucalyptusCloudException("Cannot create an image from an instance which is not in either the 'running' or 'stopped' state: " + vm.getInstanceId() + " is in state "+ vm.getRuntimeState().getName());
  }
  Cluster cluster=null;
  try {
    cluster=Clusters.getInstance().lookup(vm.getClusterName());
  }
 catch (  NoSuchElementException e) {
    LOG.debug(e);
    throw new EucalyptusCloudException("Cluster does not exist: " + vm.getClusterName());
  }
  return reply;
}
