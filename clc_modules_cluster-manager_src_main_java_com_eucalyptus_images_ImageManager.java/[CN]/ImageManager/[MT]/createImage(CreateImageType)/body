{
  CreateImageResponseType reply=request.getReply();
  Context ctx=Contexts.lookup();
  VmInstance vm;
  try {
    vm=RestrictedTypes.doPrivileged(request.getInstanceId(),VmInstance.Lookup.INSTANCE);
    if (!VmState.RUNNING.equals(vm.getState()) && !VmState.STOPPED.equals(vm.getState())) {
      throw new EucalyptusCloudException("Cannot create an image from an instance which is not in either the 'running' or 'stopped' state: " + vm.getInstanceId() + " is in state "+ vm.getState().getName());
    }
    if (vm.isBlockStorage() && !ctx.hasAdministrativePrivileges()) {
      throw new EucalyptusCloudException("Cannot create an image from an instance which is not booted from a volume: " + vm.getInstanceId() + " is in state "+ vm.getState().getName());
    }
 else     if (vm.isBlockStorage()) {
    }
 else {
      Cluster cluster=null;
      try {
        cluster=Clusters.getInstance().lookup(vm.lookupPartition());
      }
 catch (      NoSuchElementException e) {
        LOG.debug(e);
        throw new EucalyptusCloudException("Cluster does not exist: " + vm.lookupClusterConfiguration());
      }
    }
  }
 catch (  AuthException ex) {
    throw new EucalyptusCloudException("Not authorized to create an image from instance " + request.getInstanceId() + " as "+ ctx.getUser().getName());
  }
catch (  NoSuchElementException ex) {
    throw new EucalyptusCloudException("Instance does not exist: " + request.getInstanceId(),ex);
  }
catch (  PersistenceException ex) {
    throw new EucalyptusCloudException("Instance does not exist: " + request.getInstanceId(),ex);
  }
  return reply;
}
