{
  final Context ctx=Contexts.lookup();
  String imageLocation=request.getImageLocation();
  User requestUser=Contexts.lookup().getUser();
  String action=PolicySpec.requestToAction(request);
  if (!ctx.hasAdministrativePrivileges()) {
    if (!Permissions.isAuthorized(PolicySpec.EC2_RESOURCE_IMAGE,"",ctx.getAccount(),action,requestUser)) {
      throw new EucalyptusCloudException("Register image is not allowed for " + requestUser.getName());
    }
    if (!Permissions.canAllocate(PolicySpec.EC2_RESOURCE_IMAGE,"",action,requestUser,1L)) {
      throw new EucalyptusCloudException("Quota exceeded in registering image for " + requestUser.getName());
    }
  }
  String[] imagePathParts;
  try {
    imagePathParts=ImageUtil.getImagePathParts(imageLocation);
    ImageUtil.checkBucketAcl(request,imagePathParts);
  }
 catch (  EucalyptusCloudException e) {
    LOG.trace(e,e);
    throw e;
  }
  try {
    WalrusUtil.verifyManifestIntegrity(ctx.getUser(),imageLocation);
  }
 catch (  EucalyptusCloudException e) {
    throw new EucalyptusCloudException("Image registration failed because the manifest referenced is invalid or unavailable.");
  }
  Document inputSource=ImageUtil.getManifestDocument(imagePathParts,ctx.getUserFullName());
  XPath xpath=XPathFactory.newInstance().newXPath();
  Image.Architecture arch=ImageUtil.extractArchitecture(inputSource,xpath);
  ImageInfo imageInfo=null;
  String kernelId=ImageUtil.extractKernelId(inputSource,xpath);
  String ramdiskId=ImageUtil.extractRamdiskId(inputSource,xpath);
  Image.Type imageType=Image.Type.machine;
  Image.Platform platform=Image.Platform.linux;
  String newImageId=null;
  String signature=null;
  try {
    signature=(String)xpath.evaluate("/manifest/signature/text()",inputSource,XPathConstants.STRING);
  }
 catch (  XPathExpressionException e) {
    LOG.warn(e.getMessage());
  }
  if ("yes".equals(kernelId) || "true".equals(kernelId) || imagePathParts[1].startsWith("vmlinuz")) {
    if (!Contexts.lookup().hasAdministrativePrivileges()) {
      throw new EucalyptusCloudException("Only administrators can register kernel images.");
    }
    imageType=Image.Type.kernel;
    imageInfo=new KernelImageInfo(ctx.getUserFullName(),ImageUtil.newImageId(imageType.getTypePrefix(),imageLocation),imageLocation,arch,Image.Platform.linux);
  }
 else   if ("yes".equals(ramdiskId) || "true".equals(ramdiskId) || imagePathParts[1].startsWith("initrd")) {
    if (!Contexts.lookup().hasAdministrativePrivileges()) {
      throw new EucalyptusCloudException("Only administrators can register ramdisk images.");
    }
    imageType=Image.Type.ramdisk;
    imageInfo=new RamdiskImageInfo(ctx.getUserFullName(),ImageUtil.newImageId(imageType.getTypePrefix(),imageLocation),imageLocation,arch,Image.Platform.linux);
  }
 else {
    if (imagePathParts[1].startsWith(Image.Platform.windows.toString())) {
      imageType=Image.Type.machine;
      imageInfo=new MachineImageInfo(ctx.getUserFullName(),ImageUtil.newImageId(imageType.getTypePrefix(),imageLocation),imageLocation,arch,Image.Platform.windows);
    }
 else {
      if (kernelId != null) {
        ImageInfo k=null;
        try {
          k=Images.lookupImage(kernelId);
        }
 catch (        Exception ex) {
          LOG.error(ex,ex);
          throw new EucalyptusCloudException("Referenced kernel id is invalid: " + kernelId,ex);
        }
        if (!Lookups.checkPrivilege(request,PolicySpec.EC2_RESOURCE_IMAGE,kernelId,k.getOwner())) {
          throw new EucalyptusCloudException("Access to kernel image " + kernelId + " is deined for "+ ctx.getUser().getName());
        }
      }
      if (ramdiskId != null) {
        ImageInfo r=null;
        try {
          r=Images.lookupImage(ramdiskId);
        }
 catch (        Exception ex) {
          LOG.error(ex,ex);
          throw new EucalyptusCloudException("Referenced ramdisk id is invalid: " + ramdiskId,ex);
        }
        if (!Lookups.checkPrivilege(request,PolicySpec.EC2_RESOURCE_IMAGE,ramdiskId,r.getOwner())) {
          throw new EucalyptusCloudException("Access to ramdisk image " + ramdiskId + " is deined for "+ ctx.getUser().getName());
        }
      }
      imageType=Image.Type.machine;
      imageInfo=new MachineImageInfo(ctx.getUserFullName(),ImageUtil.newImageId(imageType.getTypePrefix(),imageLocation),imageLocation,arch,Image.Platform.linux,kernelId,ramdiskId);
    }
  }
  imageInfo.setSignature(signature);
  imageInfo.setState(Image.State.available);
  EntityWrapper<ImageInfo> db=EntityWrapper.get(ImageInfo.class);
  try {
    imageInfo=db.merge(imageInfo);
    db.commit();
    LOG.info("Registering image pk=" + imageInfo.getDisplayName() + " ownerId="+ ctx.getUserFullName());
  }
 catch (  Exception e) {
    db.rollback();
    throw new EucalyptusCloudException("failed to register image.");
  }
  LOG.info("Triggering cache population in Walrus for: " + imageInfo.getDisplayName());
  WalrusUtil.triggerCaching(imageInfo);
  RegisterImageResponseType reply=(RegisterImageResponseType)request.getReply();
  reply.setImageId(imageInfo.getDisplayName());
  return reply;
}
