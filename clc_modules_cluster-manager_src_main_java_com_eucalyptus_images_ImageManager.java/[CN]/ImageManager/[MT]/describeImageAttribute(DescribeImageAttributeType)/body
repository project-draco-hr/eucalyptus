{
  DescribeImageAttributeResponseType reply=(DescribeImageAttributeResponseType)request.getReply();
  reply.setImageId(request.getImageId());
  final Context ctx=Contexts.lookup();
  final String requestAccountId=ctx.getUserFullName().getAccountNumber();
  final User requestUser=Contexts.lookup().getUser();
  final String action=PolicySpec.requestToAction(request);
  if (request.getAttribute() != null)   request.applyAttribute();
  EntityWrapper<ImageInfo> db=EntityWrapper.get(ImageInfo.class);
  try {
    ImageInfo imgInfo=db.getUnique(Images.exampleWithImageId(request.getImageId()));
    if (!ctx.hasAdministrativePrivileges() && (!imgInfo.getOwnerAccountNumber().equals(requestAccountId) || !Permissions.isAuthorized(PolicySpec.VENDOR_EC2,PolicySpec.EC2_RESOURCE_IMAGE,request.getImageId(),null,action,requestUser))) {
      throw new EucalyptusCloudException("Not authorized to describe image attribute");
    }
    if (request.getKernel() != null) {
      reply.setRealResponse(reply.getKernel());
      if (imgInfo instanceof MachineImageInfo) {
        if (((MachineImageInfo)imgInfo).getKernelId() != null) {
          reply.getKernel().add(((MachineImageInfo)imgInfo).getKernelId());
        }
      }
    }
 else     if (request.getRamdisk() != null) {
      reply.setRealResponse(reply.getRamdisk());
      if (imgInfo instanceof MachineImageInfo) {
        if (((MachineImageInfo)imgInfo).getRamdiskId() != null) {
          reply.getRamdisk().add(((MachineImageInfo)imgInfo).getRamdiskId());
        }
      }
    }
 else     if (request.getLaunchPermission() != null) {
      reply.setRealResponse(reply.getLaunchPermission());
      if (imgInfo.getImagePublic()) {
        reply.getLaunchPermission().add(LaunchPermissionItemType.getGroup());
      }
      reply.getLaunchPermission().add(LaunchPermissionItemType.getUser(Contexts.lookup().getAccount().getAccountNumber()));
    }
 else     if (request.getProductCodes() != null) {
      reply.setRealResponse(reply.getProductCodes());
      reply.getProductCodes().addAll(imgInfo.getProductCodes());
    }
 else     if (request.getBlockDeviceMapping() != null) {
      reply.setRealResponse(reply.getBlockDeviceMapping());
      reply.getBlockDeviceMapping().add(ImageUtil.EMI);
      reply.getBlockDeviceMapping().add(ImageUtil.EPHEMERAL);
      reply.getBlockDeviceMapping().add(ImageUtil.SWAP);
      reply.getBlockDeviceMapping().add(ImageUtil.ROOT);
    }
 else {
      throw new EucalyptusCloudException("invalid image attribute request.");
    }
  }
  finally {
    db.commit();
  }
  return reply;
}
