{
  DescribeImageAttributeResponseType reply=(DescribeImageAttributeResponseType)request.getReply();
  reply.setImageId(request.getImageId());
  if (request.getAttribute() != null)   request.applyAttribute();
  EntityWrapper<ImageInfo> db=new EntityWrapper<ImageInfo>();
  try {
    ImageInfo imgInfo=db.getUnique(new ImageInfo(request.getImageId()));
    if (!imgInfo.isAllowed(Users.lookupUserById(request.getUserId())))     throw new EucalyptusCloudException("image attribute: not authorized.");
    if (request.getKernel() != null) {
      reply.setRealResponse(reply.getKernel());
      if (imgInfo.getKernelId() != null) {
        reply.getKernel().add(imgInfo.getKernelId());
      }
    }
 else     if (request.getRamdisk() != null) {
      reply.setRealResponse(reply.getRamdisk());
      if (imgInfo.getRamdiskId() != null) {
        reply.getRamdisk().add(imgInfo.getRamdiskId());
      }
    }
 else     if (request.getLaunchPermission() != null) {
      reply.setRealResponse(reply.getLaunchPermission());
      for (      ImageAuthorization auth : imgInfo.getUserGroups())       reply.getLaunchPermission().add(LaunchPermissionItemType.getGroup(auth.getValue()));
      for (      ImageAuthorization auth : imgInfo.getPermissions())       reply.getLaunchPermission().add(LaunchPermissionItemType.getUser(auth.getValue()));
    }
 else     if (request.getProductCodes() != null) {
      reply.setRealResponse(reply.getProductCodes());
      for (      ProductCode p : imgInfo.getProductCodes()) {
        reply.getProductCodes().add(p.getValue());
      }
    }
 else     if (request.getBlockDeviceMapping() != null) {
      reply.setRealResponse(reply.getBlockDeviceMapping());
      reply.getBlockDeviceMapping().add(ImageUtil.EMI);
      reply.getBlockDeviceMapping().add(ImageUtil.EPHEMERAL);
      reply.getBlockDeviceMapping().add(ImageUtil.SWAP);
      reply.getBlockDeviceMapping().add(ImageUtil.ROOT);
    }
 else {
      throw new EucalyptusCloudException("invalid image attribute request.");
    }
  }
 catch (  EucalyptusCloudException e) {
    db.commit();
    throw e;
  }
catch (  AuthException e) {
    db.commit();
    throw new EucalyptusCloudException("can not find user info.");
  }
  return reply;
}
