{
  if (!request.getImageId().matches("(emi-|eki-|eri-)\\w{8}"))   throw new EucalyptusCloudException("Invalid id: " + "\"" + request.getImageId() + "\"");
  DeregisterImageResponseType reply=request.getReply();
  final Context ctx=Contexts.lookup();
  final String requestAccountId=ctx.getUserFullName().getAccountNumber();
  final User requestUser=Contexts.lookup().getUser();
  final String action=PolicySpec.requestToAction(request);
  EntityWrapper<ImageInfo> db=EntityWrapper.get(ImageInfo.class);
  try {
    ImageInfo imgInfo=db.getUnique(Images.exampleWithImageId(request.getImageId()));
    if (!ctx.hasAdministrativePrivileges() && (!imgInfo.getOwnerAccountNumber().equals(requestAccountId) || !RestrictedTypes.filterPrivileged().apply(imgInfo))) {
      throw new EucalyptusCloudException("Not authorized to deregister image");
    }
    Images.deregisterImage(imgInfo.getDisplayName());
    return reply;
  }
 catch (  NoSuchImageException ex) {
    LOG.trace(ex);
    reply.set_return(false);
    return reply;
  }
catch (  NoSuchElementException ex) {
    LOG.trace(ex);
    reply.set_return(false);
    return reply;
  }
catch (  InstanceNotTerminatedException re) {
    throw new EucalyptusCloudException(re);
  }
catch (  EucalyptusCloudException ex) {
    if (ex.getCause() instanceof NoSuchElementException)     throw new EucalyptusCloudException("The image id '[" + request.getImageId() + "]' does not exist");
 else     throw ex;
  }
 finally {
    db.commit();
  }
}
