{
  DeregisterImageResponseType reply=request.getReply();
  final Context ctx=Contexts.lookup();
  final String requestAccountId=ctx.getUserFullName().getAccountNumber();
  EntityTransaction tx=Entities.get(ImageInfo.class);
  try {
    ImageInfo imgInfo=Entities.uniqueResult(Images.exampleWithImageId(imageIdentifier(request.getImageId())));
    if (!ctx.hasAdministrativePrivileges() && (!imgInfo.getOwnerAccountNumber().equals(requestAccountId) || !RestrictedTypes.filterPrivileged().apply(imgInfo))) {
      throw new EucalyptusCloudException("Not authorized to deregister image");
    }
    Images.deregisterImage(imgInfo.getDisplayName());
    tx.commit();
    return reply;
  }
 catch (  NoSuchImageException|NoSuchElementException ex) {
    throw new ClientComputeException("InvalidAMIID.NotFound","The image ID '" + request.getImageId() + "' does not exist");
  }
catch (  InstanceNotTerminatedException|ConstraintViolationException re) {
    throw new ClientComputeException("InvalidAMIID.Unavailable","The image ID '" + request.getImageId() + "' is no longer available");
  }
catch (  TransactionException ex) {
    if (ex.getCause() instanceof NoSuchElementException)     throw new ClientComputeException("InvalidAMIID.NotFound","The image ID '" + request.getImageId() + "' does not exist");
 else     throw new EucalyptusCloudException(ex);
  }
 finally {
    if (tx.isActive())     tx.rollback();
  }
}
