{
  Multimap<String,ServiceConfiguration> services=Multimaps.newArrayListMultimap();
  for (  Component c : Components.list()) {
    if (!c.getIdentity().isCloudLocal() && !c.getIdentity().isAlwaysLocal()) {
      for (      Service s : c.getServices()) {
        if (s.isLocal()) {
          services.put(s.getHost(),s.getServiceConfiguration());
        }
      }
    }
  }
  Set<String> currentHosts=services.keySet();
  for (  String host : this.heartbeatMap.keySet()) {
    if (!currentHosts.contains(host)) {
      HeartbeatClient staleHb=this.heartbeatMap.remove(host);
      LOG.debug("Removing stale heartbeat client for " + host);
      staleHb.close();
    }
  }
  for (  String host : services.keySet()) {
    if (!heartbeatMap.containsKey(host)) {
      heartbeatMap.put(host,new HeartbeatClient(this.clientBootstrap,host,8773));
    }
    HeartbeatClient hb=this.heartbeatMap.get(host);
    Collection<ServiceConfiguration> currentServices=services.get(host);
    LOG.debug("Sending heartbeat to: " + hb.getHostName() + " with "+ services);
    hb.send(currentServices);
  }
}
