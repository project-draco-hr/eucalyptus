{
  DeleteStackResponseType reply=request.getReply();
  try {
    final Context ctx=Contexts.lookup();
    checkActionPermission(PolicySpec.CLOUDFORMATION_DELETESTACK,ctx);
    User user=ctx.getUser();
    String userId=user.getUserId();
    String accountId=user.getAccount().getAccountNumber();
    String stackName=request.getStackName();
    if (stackName == null)     throw new ValidationErrorException("Stack name is null");
    StackEntity stackEntity=StackEntityManager.getNonDeletedStackByNameOrId(stackName,accountId);
    if (stackEntity != null) {
      if (stackEntity.getStackStatus() == StackEntity.Status.CREATE_IN_PROGRESS || stackEntity.getStackStatus() == StackEntity.Status.ROLLBACK_IN_PROGRESS || stackEntity.getStackStatus() == StackEntity.Status.DELETE_IN_PROGRESS) {
        Date mostRecentActionDate=getLatestDate(stackEntity);
        List<StackResourceEntity> stackResourceEntityList=StackResourceEntityManager.getStackResources(stackEntity.getStackId(),accountId);
        if (stackResourceEntityList != null) {
          for (          StackResourceEntity stackResourceEntity : stackResourceEntityList) {
            mostRecentActionDate=newestDate(mostRecentActionDate,getLatestDate(stackResourceEntity));
          }
        }
        List<StackEventEntity> stackEventEntityList=StackEventEntityManager.getStackEventEntitiesById(stackEntity.getStackId(),accountId);
        if (stackEventEntityList != null) {
          for (          StackEventEntity stackEventEntity : stackEventEntityList) {
            mostRecentActionDate=newestDate(mostRecentActionDate,getLatestDate(stackEventEntity));
          }
        }
        if (mostRecentActionDate != null && (System.currentTimeMillis() - mostRecentActionDate.getTime() < 60 * 60 * 1000L)) {
          throw new StackOperationInProgressException("A stack operation is ongoing (" + stackEntity.getStackStatus() + "), please try again later.");
        }
      }
      new StackDeletor(stackEntity,userId).start();
    }
  }
 catch (  Exception ex) {
    LOG.error(ex,ex);
    handleException(ex);
  }
  return reply;
}
