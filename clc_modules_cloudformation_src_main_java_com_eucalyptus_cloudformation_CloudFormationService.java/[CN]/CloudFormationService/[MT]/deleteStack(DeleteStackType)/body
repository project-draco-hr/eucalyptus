{
  DeleteStackResponseType reply=request.getReply();
  try {
    final Context ctx=Contexts.lookup();
    checkActionPermission(PolicySpec.CLOUDFORMATION_DELETESTACK,ctx);
    User user=ctx.getUser();
    String userId=user.getUserId();
    String accountId=user.getAccount().getAccountNumber();
    String stackName=request.getStackName();
    if (stackName == null)     throw new ValidationErrorException("Stack name is null");
    StackEntity stackEntity=StackEntityManager.getNonDeletedStackByNameOrId(stackName,accountId);
    if (stackEntity != null) {
      boolean existingOpenDeleteWorkflow=false;
      List<StackWorkflowEntity> deleteWorkflows=StackWorkflowEntityManager.getStackWorkflowEntities(stackEntity.getStackId(),StackWorkflowEntity.WorkflowType.DELETE_STACK_WORKFLOW);
      if (deleteWorkflows != null) {
        if (deleteWorkflows.size() > 1) {
          throw new ValidationErrorException("More than one delete workflow exists for " + stackEntity.getStackId());
        }
        try {
          AmazonSimpleWorkflow simpleWorkflowClient=CloudFormationBootstrapper.getSimpleWorkflowClient();
          StackWorkflowEntity deleteStackWorkflowEntity=deleteWorkflows.get(0);
          DescribeWorkflowExecutionRequest describeWorkflowExecutionRequest=new DescribeWorkflowExecutionRequest();
          describeWorkflowExecutionRequest.setDomain(deleteStackWorkflowEntity.getDomain());
          WorkflowExecution execution=new WorkflowExecution();
          execution.setRunId(deleteStackWorkflowEntity.getRunId());
          execution.setWorkflowId(deleteStackWorkflowEntity.getWorkflowId());
          describeWorkflowExecutionRequest.setExecution(execution);
          WorkflowExecutionDetail workflowExecutionDetail=simpleWorkflowClient.describeWorkflowExecution(describeWorkflowExecutionRequest);
          if ("OPEN".equals(workflowExecutionDetail.getExecutionInfo().getExecutionStatus())) {
            existingOpenDeleteWorkflow=true;
          }
        }
 catch (        Exception ex) {
          LOG.error("Unable to get status of delete workflow for " + stackEntity.getStackId() + ", assuming not open");
          LOG.debug(ex);
        }
      }
      if (!existingOpenDeleteWorkflow) {
        WorkflowClientFactory workflowClientFactory=new WorkflowClientFactory(CloudFormationBootstrapper.getSimpleWorkflowClient(),CloudFormationBootstrapper.SWF_DOMAIN,CloudFormationBootstrapper.SWF_TASKLIST);
        WorkflowDescriptionTemplate workflowDescriptionTemplate=new DeleteStackWorkflowDescriptionTemplate();
        InterfaceBasedWorkflowClient<DeleteStackWorkflow> client=workflowClientFactory.getNewWorkflowClient(DeleteStackWorkflow.class,workflowDescriptionTemplate,new WorkflowTags());
        DeleteStackWorkflow deleteStackWorkflow=new DeleteStackWorkflowClient(client);
        deleteStackWorkflow.deleteStack(stackEntity.getStackId(),stackEntity.getAccountId(),stackEntity.getResourceDependencyManagerJson(),userId);
        StackWorkflowEntityManager.addOrUpdateStackWorkflowEntity(stackEntity.getStackId(),StackWorkflowEntity.WorkflowType.DELETE_STACK_WORKFLOW,CloudFormationBootstrapper.SWF_DOMAIN,client.getWorkflowExecution().getWorkflowId(),client.getWorkflowExecution().getRunId());
      }
    }
  }
 catch (  Exception ex) {
    LOG.error(ex,ex);
    handleException(ex);
  }
  return reply;
}
