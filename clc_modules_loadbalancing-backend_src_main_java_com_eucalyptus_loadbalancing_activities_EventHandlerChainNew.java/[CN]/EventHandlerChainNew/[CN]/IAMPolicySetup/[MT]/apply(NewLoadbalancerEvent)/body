{
  String roleName=null;
  try {
    StoredResult<String> roleResult=this.chain.findHandler(IAMRoleSetup.class);
    if (roleResult.getResult() != null && roleResult.getResult().size() > 0)     roleName=roleResult.getResult().get(0);
    if (roleName == null)     throw new Exception();
  }
 catch (  final Exception ex) {
    throw new EventHandlerException("could not find the role name for loadbalancer vm");
  }
  GetRolePolicyResult policy=null;
  try {
    final List<String> policies=EucalyptusActivityTasks.getInstance().listRolePolicies(roleName);
    if (policies.contains(SERVO_ROLE_POLICY_NAME)) {
      policy=EucalyptusActivityTasks.getInstance().getRolePolicy(roleName,SERVO_ROLE_POLICY_NAME);
    }
  }
 catch (  final Exception ex) {
    ;
  }
  boolean putPolicy=false;
  if (policy == null || policy.getPolicyName() == null || !policy.getPolicyName().equals(SERVO_ROLE_POLICY_NAME)) {
    putPolicy=true;
  }
 else   if (!SERVO_ROLE_POLICY_DOCUMENT.toLowerCase().equals(policy.getPolicyDocument().toLowerCase())) {
    try {
      EucalyptusActivityTasks.getInstance().deleteRolePolicy(roleName,SERVO_ROLE_POLICY_NAME);
    }
 catch (    final Exception ex) {
      LOG.warn("failed to delete role policy",ex);
    }
    putPolicy=true;
  }
 else {
    putPolicy=false;
  }
  if (putPolicy) {
    try {
      EucalyptusActivityTasks.getInstance().putRolePolicy(roleName,SERVO_ROLE_POLICY_NAME,SERVO_ROLE_POLICY_DOCUMENT);
    }
 catch (    final Exception ex) {
      throw new EventHandlerException("failed to put role policy for loadbalancer vm");
    }
  }
}
