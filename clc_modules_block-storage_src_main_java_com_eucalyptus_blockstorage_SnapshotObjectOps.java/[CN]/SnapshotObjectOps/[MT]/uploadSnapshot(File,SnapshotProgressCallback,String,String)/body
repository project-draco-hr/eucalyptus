{
  refreshOsgURI();
  try {
    s3Client.getS3Client().listObjects(StorageProperties.SNAPSHOT_BUCKET);
  }
 catch (  Exception ex) {
    try {
      s3Client.getS3Client().createBucket(StorageProperties.SNAPSHOT_BUCKET);
    }
 catch (    Exception e) {
      LOG.error("Snapshot upload failed. Unable to create bucket: snapshots",e);
      throw new EucalyptusCloudException(e);
    }
  }
  try {
    FileInputStreamWithCallback snapInputStream=new FileInputStreamWithCallback(snapshotFile,callback);
    ObjectMetadata metadata=new ObjectMetadata();
    metadata.setContentLength(snapInputStream.getFileSize());
    s3Client.getS3Client().putObject(StorageProperties.SNAPSHOT_BUCKET,snapshotKey,snapInputStream,metadata);
  }
 catch (  Exception ex) {
    LOG.error("Snapshot " + snapshotId + " upload failed to: "+ snapshotKey,ex);
    throw new EucalyptusCloudException(ex);
  }
}
