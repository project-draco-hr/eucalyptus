{
  CaseInsensitiveMap hdrs=new CaseInsensitiveMap(headers);
  if (hdrs.containsKey(StorageProperties.EUCALYPTUS_OPERATION)) {
    String date=(String)hdrs.remove(SecurityParameter.Date);
    String eucaCert=(String)hdrs.remove(StorageQuerySecurityHandler.StorageSecurityParameters.EucaCert);
    String signature=(String)hdrs.remove(StorageQuerySecurityHandler.StorageSecurityParameters.EucaSignature);
    String data=verb + "\n" + date+ "\n"+ addr+ "\n";
    Signature sig;
    boolean valid=false;
    try {
      X509Certificate cert=(X509Certificate)new PEMReader(new StringReader(new String(Base64.decode(eucaCert)))).readObject();
      AbstractKeyStore keyStore=ServiceKeyStore.getInstance();
      if (keyStore.getCertificateAlias(cert) != null) {
        PublicKey publicKey=cert.getPublicKey();
        sig=Signature.getInstance("SHA1withRSA");
        sig.initVerify(publicKey);
        sig.update(data.getBytes());
        valid=sig.verify(Base64.decode(signature));
      }
 else {
        LOG.warn("WalrusQuerySecurityHandler(): certificate not found in keystore");
      }
    }
 catch (    Exception ex) {
      LOG.warn("Authentication exception: " + ex.getMessage());
      ex.printStackTrace();
    }
    if (!valid) {
      throw new QuerySecurityException("User authentication failed.");
    }
    UserInfo admin=new UserInfo("admin");
    admin.setIsAdministrator(Boolean.TRUE);
    return admin;
  }
 else {
    String date=(String)hdrs.remove(SecurityParameter.Date);
    date=date == null ? "" : date;
    String content_md5=(String)hdrs.remove("Content-MD5");
    content_md5=content_md5 == null ? "" : content_md5;
    String content_type=(String)hdrs.remove("Content-Type");
    content_type=content_type == null ? "" : content_type;
    String[] addrStrings=addr.split("\\?");
    String addrString=addrStrings[0];
    if (addrStrings.length > 1) {
      for (      SubResource subResource : SubResource.values()) {
        if (addr.contains(subResource.toString())) {
          addrString+="?" + subResource.toString();
          break;
        }
      }
    }
    String data=verb + "\n" + content_md5+ "\n"+ content_type+ "\n"+ date+ "\n"+ getCanonicalizedAmzHeaders(hdrs)+ addrString;
    String auth_part=(String)hdrs.remove(SecurityParameter.Authorization);
    if (auth_part != null) {
      String sigString[]=getSigInfo(auth_part);
      String signature=sigString[1];
      signature=signature.replaceAll("=","");
      String queryKey=findQueryKey(sigString[0]);
      String authSig=checkSignature(queryKey,data);
      if (!authSig.equals(signature))       throw new QuerySecurityException("User authentication failed.");
      return findUserId(sigString[0]);
    }
 else {
      return null;
    }
  }
}
