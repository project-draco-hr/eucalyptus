{
  ServiceConfiguration empyreanConfig=ServiceConfigurations.createEphemeral(Empyrean.INSTANCE);
  if (!serviceOperations.containsKey(request.getClass())) {
    try {
      ServiceContext.dispatch(RequestQueue.ENDPOINT,request);
    }
 catch (    Exception ex) {
      throw Exceptions.toUndeclared(ex);
    }
  }
 else {
    try {
      final Context ctx=Contexts.lookup(request.getCorrelationId());
      final Function<I,O> op=(Function<I,O>)serviceOperations.get(request.getClass());
      Threads.enqueue(empyreanConfig,new Runnable(){
        @Override public void run(){
          Contexts.threadLocal(ctx);
          try {
            final O reply=op.apply(request);
            Contexts.response(request);
          }
 catch (          final Exception ex) {
            Logs.extreme().error(ex,ex);
            Contexts.responseError(request.getCorrelationId(),ex);
          }
 finally {
            Contexts.removeThreadLocal();
          }
        }
      }
);
    }
 catch (    final Exception ex) {
      Logs.extreme().error(ex,ex);
    }
  }
}
