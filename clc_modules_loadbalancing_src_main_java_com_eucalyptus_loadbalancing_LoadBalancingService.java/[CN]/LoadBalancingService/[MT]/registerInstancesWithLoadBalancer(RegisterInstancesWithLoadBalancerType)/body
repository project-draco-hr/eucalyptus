{
  RegisterInstancesWithLoadBalancerResponseType reply=request.getReply();
  final Context ctx=Contexts.lookup();
  final UserFullName ownerFullName=ctx.getUserFullName();
  final String lbName=request.getLoadBalancerName();
  final Collection<Instance> instances=request.getInstances().getMember();
  LoadBalancer lb=null;
  try {
    lb=LoadBalancers.getLoadbalancer(ctx,lbName);
  }
 catch (  final Exception ex) {
    throw new AccessPointNotFoundException();
  }
  if (!LoadBalancingMetadatas.filterPrivileged().apply(lb)) {
    throw new AccessPointNotFoundException();
  }
  Set<String> backends=Sets.newHashSet(Collections2.transform(lb.getBackendInstances(),new Function<LoadBalancerBackendInstanceCoreView,String>(){
    @Override @Nullable public String apply(    @Nullable LoadBalancerBackendInstanceCoreView arg0){
      return arg0.getInstanceId();
    }
  }
));
  final Predicate<LoadBalancer> creator=new Predicate<LoadBalancer>(){
    @Override public boolean apply(    LoadBalancer lb){
      for (      Instance vm : instances) {
        if (lb.hasBackendInstance(vm.getInstanceId()))         continue;
        try {
          final LoadBalancerBackendInstance beInstance=LoadBalancerBackendInstance.newInstance(ownerFullName,lb,vm.getInstanceId());
          beInstance.setState(LoadBalancerBackendInstance.STATE.OutOfService);
          Entities.persist(beInstance);
        }
 catch (        final LoadBalancingException ex) {
          throw Exceptions.toUndeclared(ex);
        }
      }
      return true;
    }
  }
;
  try {
    RegisterInstancesEvent evt=new RegisterInstancesEvent();
    evt.setLoadBalancer(lbName);
    evt.setContext(ctx);
    evt.setInstances(instances);
    ActivityManager.getInstance().fire(evt);
  }
 catch (  EventFailedException e) {
    LOG.error("failed to handle RegisterInstances event",e);
    final String reason=e.getCause() != null && e.getCause().getMessage() != null ? e.getCause().getMessage() : "internal error";
    throw new InternalFailure400Exception(String.format("Failed to register instances: %s",reason),e);
  }
  if (instances != null) {
    try {
      reply.set_return(Entities.asTransaction(LoadBalancerBackendInstance.class,creator).apply(lb));
      backends.addAll(Collections2.transform(instances,new Function<Instance,String>(){
        @Override @Nullable public String apply(        @Nullable Instance arg0){
          return arg0.getInstanceId();
        }
      }
));
    }
 catch (    Exception ex) {
      handleException(ex);
    }
  }
  RegisterInstancesWithLoadBalancerResult result=new RegisterInstancesWithLoadBalancerResult();
  Instances returnInstances=new Instances();
  returnInstances.setMember(Lists.newArrayList(Collections2.transform(backends,new Function<String,Instance>(){
    @Override @Nullable public Instance apply(    @Nullable String arg0){
      Instance instance=new Instance();
      instance.setInstanceId(arg0);
      return instance;
    }
  }
)));
  result.setInstances(returnInstances);
  reply.setRegisterInstancesWithLoadBalancerResult(result);
  return reply;
}
