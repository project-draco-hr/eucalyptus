{
  EntityTransaction db=Entities.get(VmInstance.class);
  try {
    if (!reply.get_return()) {
      LOG.info("Attempt to bundle instance " + this.getRequest().getInstanceId() + " has failed.");
      try {
        VmInstance vm=VmInstances.lookup(this.getRequest().getInstanceId());
        vm.resetBundleTask();
      }
 catch (      NoSuchElementException e1) {
      }
      db.commit();
    }
 else {
      VmInstance vm=VmInstances.lookup(this.getRequest().getInstanceId());
      vm.clearPendingBundleTask();
      db.commit();
      EventRecord.here(BundleCallback.class,EventType.BUNDLE_STARTED,this.getRequest().toSimpleString(),vm.getBundleTask().getBundleId(),vm.getInstanceId()).info();
    }
  }
 catch (  Exception ex) {
    Logs.exhaust().error(ex,ex);
    db.rollback();
  }
}
