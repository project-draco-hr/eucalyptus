{
  final String report;
  if (!"raw".equals(type)) {
    final ReportGenerator generator=ReportGenerator.getInstance();
    final ByteArrayOutputStream reportOutput=new ByteArrayOutputStream(10240);
    try {
      generator.generateReport(new Period(start,end),ReportFormat.HTML,ReportType.valueOf(type.toUpperCase().replace('-','_')),null,reportOutput,null);
    }
 catch (    final Exception e) {
      throw new ReportGenerationException("Error generating report",e);
    }
    report=new String(reportOutput.toByteArray(),Charsets.UTF_8);
  }
 else {
    final ReportingExport export=Export.export(new Date(start),new Date(end));
    final StringBuilder builder=new StringBuilder(10240);
    final Map<String,String> uuidToInstanceIdMap=Maps.newHashMap();
    for (    final Serializable item : export) {
      if (item instanceof ReportingInstanceCreateEvent) {
        final ReportingInstanceCreateEvent event=(ReportingInstanceCreateEvent)item;
        uuidToInstanceIdMap.put(event.getUuid(),event.getInstanceId());
      }
      if (item instanceof ReportingInstanceUsageEvent) {
        final ReportingInstanceUsageEvent event=(ReportingInstanceUsageEvent)item;
        builder.append(SerializationUtils.serializeDateTime(new Date(event.getTimestampMs()))).append(", ");
        builder.append(event.getUuid()).append(", ");
        builder.append(uuidToInstanceIdMap.get(event.getUuid())).append(", ");
        builder.append(event.getTimestamp()).append(", ");
        builder.append(event.getResourceName()).append(", ");
        builder.append(event.getMetric()).append(", ");
        builder.append(event.getSequenceNum()).append(", ");
        builder.append(event.getDimension()).append(", ");
        builder.append(event.getValue()).append(", ");
        builder.append(SerializationUtils.serializeDateTime(new Date(event.getValueTimestamp()))).append("\n");
      }
    }
    report=builder.toString();
  }
  return report;
}
