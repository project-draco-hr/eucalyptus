{
  User user=this.getUserFromSession(Param.session.getRaw(req));
  if (user == null) {
    throw new RuntimeException("User was null");
  }
  if (user.isSystemAdmin()) {
    throw new RuntimeException("Only admins can generate reports");
  }
  final String reportType=Param.type.get(req);
  final ReportFormat format=ReportFormat.valueOf(Objects.firstNonNull(Param.format.get(req),"html"));
  final long start=Long.parseLong(Param.start.get(req));
  final long end=Long.parseLong(Param.end.get(req));
  final Period period=new Period(start,end);
  LOG.info(String.format("Params: type:%s format:%s period:%s",reportType,format,period));
  setContentTypeHeader(res,format,Param.type.get(req));
  try {
    String report=ReportGenerationFacade.generateReport(reportType,format.name(),period.getBeginningMs(),period.getEndingMs());
    res.getWriter().print(report);
  }
 catch (  ReportGenerationFacade.ReportGenerationException e) {
    LOG.error(e,e);
  }
}
