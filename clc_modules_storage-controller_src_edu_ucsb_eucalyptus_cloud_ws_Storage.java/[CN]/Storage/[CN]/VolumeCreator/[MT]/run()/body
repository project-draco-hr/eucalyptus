{
  boolean success=true;
  if (snapshotId != null) {
    EntityWrapper<SnapshotInfo> db=new EntityWrapper<SnapshotInfo>();
    try {
      SnapshotInfo snapshotInfo=new SnapshotInfo(snapshotId);
      SnapshotInfo foundSnapshotInfo=db.getUnique(snapshotInfo);
      if (foundSnapshotInfo == null) {
        String volumePath=getVolume(volumeId,snapshotSetName,snapshotId);
        size=ebsManager.createVolume(volumeId,volumePath);
      }
 else {
        if (!foundSnapshotInfo.getStatus().equals(Status.available.toString())) {
          success=false;
          db.rollback();
          LOG.warn("snapshot " + foundSnapshotInfo.getSnapshotId() + " not available.");
        }
        size=ebsManager.createVolume(volumeId,snapshotId,size);
      }
      db.commit();
    }
 catch (    Exception ex) {
      success=false;
      db.rollback();
      ex.printStackTrace();
    }
  }
 else {
    try {
      assert(size > 0);
      ebsManager.createVolume(volumeId,size);
    }
 catch (    Exception ex) {
      success=false;
      ex.printStackTrace();
    }
  }
  try {
    EntityWrapper<VolumeInfo> db=new EntityWrapper<VolumeInfo>();
    VolumeInfo volumeInfo=new VolumeInfo(volumeId);
    VolumeInfo foundVolumeInfo=db.getUnique(volumeInfo);
    if (foundVolumeInfo != null) {
      if (success)       foundVolumeInfo.setStatus(Status.available.toString());
 else       foundVolumeInfo.setStatus(Status.failed.toString());
      if (snapshotId != null) {
        foundVolumeInfo.setSize(size);
      }
    }
 else {
      db.rollback();
      throw new EucalyptusCloudException();
    }
    db.commit();
  }
 catch (  EucalyptusCloudException ex) {
    ex.printStackTrace();
  }
}
