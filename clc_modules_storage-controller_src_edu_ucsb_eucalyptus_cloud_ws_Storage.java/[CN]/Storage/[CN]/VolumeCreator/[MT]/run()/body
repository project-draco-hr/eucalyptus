{
  boolean success=true;
  if (snapshotId != null) {
    EntityWrapper<SnapshotInfo> db=new EntityWrapper<SnapshotInfo>();
    try {
      SnapshotInfo snapshotInfo=new SnapshotInfo(snapshotId);
      List<SnapshotInfo> foundSnapshotInfos=db.query(snapshotInfo);
      if (foundSnapshotInfos.size() == 0) {
        String volumePath=getVolume(volumeId,snapshotSetName,snapshotId);
        size=blockManager.createVolume(volumeId,volumePath);
        db.commit();
      }
 else {
        SnapshotInfo foundSnapshotInfo=foundSnapshotInfos.get(0);
        if (!foundSnapshotInfo.getStatus().equals(StorageProperties.Status.available.toString())) {
          success=false;
          db.rollback();
          LOG.warn("snapshot " + foundSnapshotInfo.getSnapshotId() + " not available.");
        }
 else {
          size=blockManager.createVolume(volumeId,snapshotId,size);
          db.commit();
        }
      }
    }
 catch (    Exception ex) {
      success=false;
      db.rollback();
      ex.printStackTrace();
    }
  }
 else {
    try {
      assert(size > 0);
      blockManager.createVolume(volumeId,size);
    }
 catch (    Exception ex) {
      success=false;
      ex.printStackTrace();
    }
  }
  try {
    EntityWrapper<VolumeInfo> db=new EntityWrapper<VolumeInfo>();
    VolumeInfo volumeInfo=new VolumeInfo(volumeId);
    VolumeInfo foundVolumeInfo=db.getUnique(volumeInfo);
    if (foundVolumeInfo != null) {
      if (success) {
        EntityWrapper<StorageMetaInfo> dbMeta=new EntityWrapper<StorageMetaInfo>();
        StorageMetaInfo metaInfo=new StorageMetaInfo();
        StorageMetaInfo foundMetaInfo;
        try {
          foundMetaInfo=dbMeta.getUnique(metaInfo);
          if ((foundMetaInfo.getMaxTotalVolumeSize() + size) > StorageProperties.MAX_TOTAL_VOLUME_SIZE || (size > StorageProperties.MAX_VOLUME_SIZE)) {
            success=false;
            LOG.warn("Volume size limit exceeeded");
          }
 else {
            foundMetaInfo.setMaxTotalVolumeSize(foundMetaInfo.getMaxTotalVolumeSize() + size);
          }
        }
 catch (        Exception ex) {
          dbMeta.rollback();
          foundVolumeInfo.setStatus(StorageProperties.Status.failed.toString());
          db.commit();
          ex.printStackTrace();
          return;
        }
        dbMeta.commit();
        foundVolumeInfo.setStatus(StorageProperties.Status.available.toString());
      }
 else {
        foundVolumeInfo.setStatus(StorageProperties.Status.failed.toString());
      }
      if (snapshotId != null) {
        foundVolumeInfo.setSize(size);
      }
    }
 else {
      db.rollback();
      throw new EucalyptusCloudException();
    }
    db.commit();
  }
 catch (  EucalyptusCloudException ex) {
    ex.printStackTrace();
  }
}
