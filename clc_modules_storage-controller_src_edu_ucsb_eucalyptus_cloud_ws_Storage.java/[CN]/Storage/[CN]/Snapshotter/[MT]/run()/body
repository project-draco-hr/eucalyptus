{
  try {
    blockManager.createSnapshot(volumeId,snapshotId);
    if (sharedMode) {
      EntityWrapper<SnapshotInfo> db=new EntityWrapper<SnapshotInfo>();
      SnapshotInfo snapshotInfo=new SnapshotInfo(snapshotId);
      SnapshotInfo foundSnapshotInfo=db.getUnique(snapshotInfo);
      foundSnapshotInfo.setProgress("100");
      foundSnapshotInfo.setTransferred(true);
      foundSnapshotInfo.setStatus(StorageProperties.Status.available.toString());
      db.commit();
      return;
    }
 else {
      List<String> returnValues=blockManager.prepareForTransfer(volumeId,snapshotId);
      volumeFileName=returnValues.get(0);
      snapshotFileName=returnValues.get(1);
      EntityWrapper<VolumeInfo> db=new EntityWrapper<VolumeInfo>();
      VolumeInfo volumeInfo=new VolumeInfo(volumeId);
      List<VolumeInfo> volumeInfos=db.query(volumeInfo);
      boolean shouldTransferVolume=false;
      if (volumeInfos.size() > 0) {
        VolumeInfo foundVolumeInfo=volumeInfos.get(0);
        if (!foundVolumeInfo.getTransferred()) {
          foundVolumeInfo.setVolumeBucket(volumeBucket);
          shouldTransferVolume=true;
        }
        volumeBucket=foundVolumeInfo.getVolumeBucket();
        db.commit();
        EntityWrapper<SnapshotInfo> db2=new EntityWrapper<SnapshotInfo>();
        SnapshotInfo snapshotInfo=new SnapshotInfo(snapshotId);
        SnapshotInfo foundSnapshotInfo=db2.getUnique(snapshotInfo);
        if (foundSnapshotInfo != null) {
          transferSnapshot(shouldTransferVolume);
        }
        db2.commit();
      }
 else {
        db.rollback();
        throw new EucalyptusCloudException();
      }
    }
  }
 catch (  EucalyptusCloudException ex) {
    LOG.warn(ex,ex);
  }
}
