{
  try {
    List<String> returnValues=ebsManager.prepareForTransfer(volumeId,snapshotId);
    volumeFileName=returnValues.get(0);
    snapshotFileName=returnValues.get(1);
    EntityWrapper<VolumeInfo> db=new EntityWrapper<VolumeInfo>();
    VolumeInfo volumeInfo=new VolumeInfo(volumeId);
    List<VolumeInfo> volumeInfos=db.query(volumeInfo);
    boolean shouldTransferVolume=false;
    if (volumeInfos.size() > 0) {
      VolumeInfo foundVolumeInfo=volumeInfos.get(0);
      if (!foundVolumeInfo.getTransferred()) {
        volumeBucket="snapset-" + Hashes.getRandom(12);
        volumeBucket=volumeBucket.replaceAll("\\.","x");
        volumeKey=volumeId + Hashes.getRandom(4);
        foundVolumeInfo.setVolumeBucket(volumeBucket);
        foundVolumeInfo.setVolumeKey(volumeKey);
        foundVolumeInfo.setTransferred(Boolean.TRUE);
        shouldTransferVolume=true;
      }
 else {
        volumeKey=foundVolumeInfo.getVolumeKey();
        volumeBucket=foundVolumeInfo.getVolumeBucket();
      }
      db.commit();
      EntityWrapper<SnapshotInfo> db2=new EntityWrapper<SnapshotInfo>();
      SnapshotInfo snapshotInfo=new SnapshotInfo(snapshotId);
      SnapshotInfo foundSnapshotInfo=db2.getUnique(snapshotInfo);
      if (foundSnapshotInfo != null) {
        transferSnapshot(shouldTransferVolume,snapshotValues);
      }
      db2.commit();
    }
 else {
      db.rollback();
      throw new EucalyptusCloudException();
    }
  }
 catch (  EucalyptusCloudException ex) {
    ex.printStackTrace();
  }
}
