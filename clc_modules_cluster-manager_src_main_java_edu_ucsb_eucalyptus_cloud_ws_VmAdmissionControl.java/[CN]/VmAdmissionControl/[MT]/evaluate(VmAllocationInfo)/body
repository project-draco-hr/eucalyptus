{
  SLAs sla=new SLAs();
  List<ResourceToken> allocTokeList=null;
  Exception failed=null;
  boolean hasVms=false;
  try {
    allocTokeList=sla.doVmAllocation(vmAllocInfo);
    int addrCount=0;
    for (    ResourceToken token : allocTokeList) {
      addrCount+=token.getAmount();
    }
    if (!EucalyptusProperties.disableNetworking && ("public".equals(vmAllocInfo.getRequest().getAddressingType()) || vmAllocInfo.getRequest().getAddressingType() == null)) {
      NavigableSet<String> addresses=AddressManager.allocateAddresses(addrCount);
      for (      ResourceToken token : allocTokeList) {
        for (int i=0; i < token.getAmount(); i++) {
          token.getAddresses().add(addresses.pollFirst());
        }
      }
    }
    vmAllocInfo.getAllocationTokens().addAll(allocTokeList);
    sla.doNetworkAllocation(vmAllocInfo.getRequest().getUserId(),vmAllocInfo.getAllocationTokens(),vmAllocInfo.getNetworks());
  }
 catch (  FailScriptFailException e) {
    failed=e;
    LOG.debug(e,e);
  }
catch (  NotEnoughResourcesAvailable e) {
    failed=e;
    LOG.debug(e,e);
  }
  if (failed != null) {
    if (allocTokeList != null) {
      for (      ResourceToken token : allocTokeList) {
        Clusters.getInstance().lookup(token.getCluster()).getNodeState().releaseToken(token);
      }
      throw new EucalyptusCloudException(failed.getMessage());
    }
    throw new EucalyptusCloudException(failed.getMessage());
  }
  return vmAllocInfo;
}
