{
  try {
    Channel channel=request.getChannel();
    RandomAccessFile raf=new RandomAccessFile(new File(getObjectPath(bucketName,objectName)),"r");
    httpResponse.addHeader(HttpHeaders.Names.CONTENT_TYPE,contentType != null ? contentType : "binary/octet-stream");
    if (etag != null)     httpResponse.addHeader(HttpHeaders.Names.ETAG,etag);
    httpResponse.addHeader(HttpHeaders.Names.LAST_MODIFIED,lastModified);
    if (contentDisposition != null)     httpResponse.addHeader("Content-Disposition",contentDisposition);
    final ChunkedInput file;
    isCompressed=isCompressed == null ? false : isCompressed;
    if (isCompressed) {
      file=new CompressedChunkedFile(raf,start,end,(int)Math.min((end - start),8192));
    }
 else {
      file=new ChunkedDataFile(raf,start,end,(int)Math.min((end - start),8192));
      httpResponse.addHeader(HttpHeaders.Names.CONTENT_LENGTH,String.valueOf((end - start)));
    }
    httpResponse.addHeader("Content-Range",start + "-" + end+ "/"+ size);
    if (logData != null) {
      logData.setTurnAroundTime(System.currentTimeMillis() - logData.getTurnAroundTime());
      logData.setBytesSent(size);
    }
    if (versionId != null) {
      httpResponse.addHeader(WalrusProperties.X_AMZ_VERSION_ID,versionId);
    }
    channel.write(httpResponse);
    channel.write(file).addListener(new ChannelFutureListener(){
      @Override public void operationComplete(      ChannelFuture future) throws Exception {
        Contexts.clear(request.getCorrelationId());
        file.close();
        if (logData != null) {
          logData.setTotalTime(System.currentTimeMillis() - logData.getTotalTime());
          WalrusBucketLogger.getInstance().addLogEntry(logData);
        }
      }
    }
);
  }
 catch (  Exception ex) {
    LOG.error(ex,ex);
  }
}
