{
  final String instanceId=addr.getInstanceId();
  try {
    final VmInstance vm=VmInstances.getInstance().lookup(instanceId);
    return new SuccessCallback(){
      public void apply(      Object response){
        try {
          if (!addr.isSystemOwned()) {
            addr.release();
          }
 else {
            Addresses.getAddressManager().releaseSystemAddress(addr);
          }
        }
 catch (        Throwable e) {
          LOG.debug(e,e);
        }
        if (VmState.PENDING.equals(vm.getState()) || VmState.RUNNING.equals(vm.getState())) {
          Addresses.system(vm);
        }
      }
    }
;
  }
 catch (  NoSuchElementException e) {
    return new SuccessCallback(){
      public void apply(      Object response){
        if (!addr.isSystemOwned()) {
          addr.release();
        }
 else {
          Addresses.getAddressManager().releaseSystemAddress(addr);
        }
      }
    }
;
  }
}
