{
  try {
    final String instanceId=addr.getInstanceId();
    if (addr.isReallyAssigned()) {
      boolean unassign=false;
      try {
        final VmInstance vm=VmInstances.lookup(instanceId);
        if (VmStateSet.RUN.apply(vm)) {
          AsyncRequests.dispatchSafely(AsyncRequests.newRequest(addr.unassign().getCallback()).then(new UnconditionalCallback(){
            @Override public void fire(){
              try {
                Addresses.system(vm);
              }
  finally {
                try {
                  addr.release();
                }
 catch (                Exception e) {
                  LOG.error("Error releasing address after unassign",e);
                }
              }
            }
          }
),vm.getPartition());
        }
 else {
          unassign=true;
        }
      }
 catch (      NoSuchElementException e) {
        Logs.extreme().debug(e,e);
        unassign=true;
      }
      if (unassign) {
        addr.unassign().clearPending();
        addr.release();
      }
    }
 else {
      addr.release();
    }
  }
 catch (  final Exception e) {
    LOG.debug(e,e);
  }
}
