{
  try {
    final String instanceId=addr.getInstanceId();
    if (addr.isAssigned()) {
      try {
        final VmInstance vm=VmInstances.lookup(instanceId);
        final ServiceConfiguration ccConfig=Topology.lookup(ClusterController.class,vm.lookupPartition());
        if (VmStateSet.RUN.apply(vm)) {
          AsyncRequests.newRequest(addr.unassign().getCallback()).then(new UnconditionalCallback(){
            @Override public void fire(){
              try {
                Addresses.system(vm);
              }
 catch (              final NoSuchElementException ex) {
              }
 finally {
                try {
                  addr.release();
                }
 catch (                Exception e) {
                  LOG.error("Error releasing address after unassign",e);
                }
              }
            }
          }
).dispatch(ccConfig);
        }
      }
 catch (      TerminatedInstanceException ex) {
      }
catch (      NoSuchElementException ex) {
      }
    }
 else {
      addr.release();
    }
  }
 catch (  final Exception e) {
    LOG.debug(e,e);
  }
}
