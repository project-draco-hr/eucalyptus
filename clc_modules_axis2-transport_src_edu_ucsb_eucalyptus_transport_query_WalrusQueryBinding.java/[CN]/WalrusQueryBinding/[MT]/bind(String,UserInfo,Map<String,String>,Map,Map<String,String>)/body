{
  OMElement msg;
  EucalyptusMessage eucaMsg;
  Map<String,String> fieldMap;
  Class targetType;
  try {
    targetType=Class.forName("edu.ucsb.eucalyptus.msgs.".concat(operationName).concat("Type"));
    fieldMap=this.buildFieldMap(targetType);
    eucaMsg=(EucalyptusMessage)targetType.newInstance();
  }
 catch (  Exception e) {
    throw new QueryBindingException("Failed to construct message of type " + operationName);
  }
  CaseInsensitiveMap caseInsensitiveHeaders=new CaseInsensitiveMap(headers);
  List<String> failedMappings=populateObject(eucaMsg,fieldMap,params,bindingArguments);
  populateObjectFromBindingMap(eucaMsg,fieldMap,caseInsensitiveHeaders,bindingArguments);
  setRequiredParams(eucaMsg,user);
  if (!failedMappings.isEmpty() || !params.isEmpty()) {
    StringBuilder errMsg=new StringBuilder("Failed to bind the following fields:\n");
    for (    String f : failedMappings)     errMsg.append(f).append('\n');
    for (    Map.Entry<String,String> f : params.entrySet())     errMsg.append(f.getKey()).append(" = ").append(f.getValue()).append('\n');
    throw new QueryBindingException(errMsg.toString());
  }
  if (user != null) {
    eucaMsg.setUserId(user.getUserName());
    eucaMsg.setEffectiveUserId(user.isAdministrator() ? "eucalyptus" : user.getUserName());
  }
  LOG.warn(eucaMsg.toString());
  try {
    Binding binding=BindingManager.getBinding(namespace);
    msg=binding.toOM(eucaMsg);
  }
 catch (  JiBXException e) {
    throw new QueryBindingException("Failed to build a valid message: " + e.getMessage());
  }
  return msg;
}
