{
  final Context ctx=Contexts.lookup();
  final UserFullName userFullName=ctx.getUserFullName();
  final AccountFullName accountFullName=userFullName.asAccountFullName();
  final Predicate<? super WorkflowExecution> accessible=SimpleWorkflowMetadatas.filteringFor(WorkflowExecution.class).byPrivileges().buildPredicate();
  try {
    workflowExecutions.updateByExample(WorkflowExecution.exampleForOpenWorkflow(accountFullName,request.getDomain(),request.getWorkflowId()),accountFullName,request.getWorkflowId(),new Function<WorkflowExecution,Void>(){
      @Override public Void apply(      final WorkflowExecution workflowExecution){
        if (accessible.apply(workflowExecution)) {
          workflowExecution.setCancelRequested(true);
          workflowExecution.addHistoryEvent(WorkflowHistoryEvent.create(workflowExecution,new WorkflowExecutionCancelRequestedEventAttributes().withExternalInitiatedEventId(0L)));
          if (workflowExecution.getDecisionStatus() != Pending) {
            workflowExecution.addHistoryEvent(WorkflowHistoryEvent.create(workflowExecution,new DecisionTaskScheduledEventAttributes().withTaskList(new TaskList().withName(workflowExecution.getTaskList())).withStartToCloseTimeout(String.valueOf(workflowExecution.getTaskStartToCloseTimeout()))));
            workflowExecution.setDecisionStatus(Pending);
            workflowExecution.setDecisionTimestamp(new Date());
          }
        }
        return null;
      }
    }
);
  }
 catch (  SwfMetadataNotFoundException e) {
    throw new SimpleWorkflowClientException("UnknownResourceFault",request.getRunId() == null ? "Unknown execution, workflowId = " + request.getWorkflowId() : "Unknown execution: WorkflowExecution=[workflowId=" + request.getWorkflowId() + ", runId="+ request.getRunId()+ "]");
  }
catch (  SwfMetadataException e) {
    throw handleException(e);
  }
  longPollExit();
  return request.reply(new SimpleWorkflowMessage());
}
