{
  EntityTransaction db=Entities.get(VmInstance.class);
  try {
    Allocation allocInfo=token.getAllocationInfo();
    VmInstance vmInst=new VmInstance(allocInfo.getOwnerFullName(),token.getInstanceId(),token.getInstanceUuid(),allocInfo.getReservationId(),token.getLaunchIndex(),allocInfo.getRequest().getAvailabilityZone(),allocInfo.getUserData(),allocInfo.getBootSet(),allocInfo.getSshKeyPair(),allocInfo.getVmType(),allocInfo.getNetworkGroups(),token.getNetworkIndex());
    vmInst=Entities.persist(vmInst);
    token.getNetworkIndex().set(vmInst);
    db.commit();
    token.setVmInstance(vmInst);
    return vmInst;
  }
 catch (  ResourceAllocationException ex) {
    db.rollback();
    Logs.extreme().error(ex,ex);
    throw ex;
  }
catch (  Exception ex) {
    db.rollback();
    Logs.extreme().error(ex,ex);
    throw new TransactionExecutionException(ex);
  }
}
