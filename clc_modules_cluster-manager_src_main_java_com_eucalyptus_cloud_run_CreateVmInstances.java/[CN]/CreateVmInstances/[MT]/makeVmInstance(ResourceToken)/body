{
  Allocation allocInfo=token.getAllocationInfo();
  VmTypeInfo vbr=null;
  try {
    vbr=VmTypes.asVmTypeInfo(allocInfo.getVmType(),allocInfo.getBootSet().getMachine());
  }
 catch (  MetadataException ex) {
    LOG.error(ex,ex);
  }
  VmInstance vmInst=new VmInstance(allocInfo.getOwnerFullName(),token.getInstanceId(),token.getInstanceUuid(),allocInfo.getReservationId(),token.getLaunchIndex(),allocInfo.getRequest().getAvailabilityZone(),allocInfo.getUserData(),vbr,allocInfo.getSshKeyPair(),allocInfo.getVmType(),allocInfo.getBootSet().getMachine().getPlatform().name(),allocInfo.getNetworkGroups(),token.getNetworkIndex().get());
  vmInst=VmInstances.register(vmInst);
  try {
    token.getNetworkIndex().set(vmInst);
  }
 catch (  ResourceAllocationException ex) {
    LOG.error(ex,ex);
  }
  return vmInst;
}
