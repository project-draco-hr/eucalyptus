{
  Allocation allocInfo=token.getAllocationInfo();
  EntityTransaction db=Entities.get(VmInstance.class);
  VmInstance vmInst=new VmInstance(allocInfo.getOwnerFullName(),token.getInstanceId(),token.getInstanceUuid(),allocInfo.getReservationId(),token.getLaunchIndex(),allocInfo.getRequest().getAvailabilityZone(),allocInfo.getUserData(),allocInfo.getBootSet(),allocInfo.getSshKeyPair(),allocInfo.getVmType(),allocInfo.getNetworkGroups(),token.getNetworkIndex());
  vmInst=Entities.persist(vmInst);
  vmInst=VmInstances.register(vmInst);
  try {
    token.getNetworkIndex().set(vmInst);
  }
 catch (  ResourceAllocationException ex) {
    LOG.error(ex,ex);
  }
  return vmInst;
}
