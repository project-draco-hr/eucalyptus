{
  Allocation allocInfo=token.getAllocationInfo();
  EntityTransaction db=Entities.get(VmInstance.class);
  VmInstance vmInst;
  try {
    vmInst=new VmInstance(allocInfo.getOwnerFullName(),token.getInstanceId(),token.getInstanceUuid(),allocInfo.getReservationId(),token.getLaunchIndex(),allocInfo.getRequest().getAvailabilityZone(),allocInfo.getUserData(),allocInfo.getBootSet(),allocInfo.getSshKeyPair(),allocInfo.getVmType(),allocInfo.getNetworkGroups(),token.getNetworkIndex());
    vmInst=Entities.persist(vmInst);
    token.getNetworkIndex().set(vmInst);
    vmInst=VmInstances.register(vmInst);
    db.commit();
    return vmInst;
  }
 catch (  ResourceAllocationException ex) {
    db.rollback();
    LOG.error(ex,ex);
    throw ex;
  }
catch (  Exception ex) {
    db.rollback();
    LOG.error(ex,ex);
    throw new TransactionExecutionException(ex);
  }
}
