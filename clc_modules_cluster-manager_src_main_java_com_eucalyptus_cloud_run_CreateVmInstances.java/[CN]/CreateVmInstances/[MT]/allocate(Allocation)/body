{
  final long quantity=allocInfo.getAllocationTokens().size();
  final Context ctx=allocInfo.getContext();
  final User requestUser=ctx.getUser();
  final UserFullName userFullName=ctx.getUserFullName();
  final String action=PolicySpec.requestToAction(allocInfo.getRequest());
  final String vmType=allocInfo.getVmType().getName();
  if (!Permissions.canAllocate(PolicySpec.VENDOR_EC2,PolicySpec.EC2_RESOURCE_VMTYPE,vmType,action,requestUser,1L)) {
    throw new EucalyptusCloudException("Quota exceeded in allocating vm type " + vmType + " for "+ requestUser.getName());
  }
  if (!Permissions.canAllocate(PolicySpec.VENDOR_EC2,PolicySpec.EC2_RESOURCE_INSTANCE,"",action,requestUser,quantity)) {
    throw new EucalyptusCloudException("Quota exceeded in allocating " + quantity + " vm instances for "+ requestUser.getName());
  }
  for (  final ResourceToken token : allocInfo.getAllocationTokens()) {
    try {
      token.setVmInstance(VmInstance.CreateAllocation.INSTANCE.apply(token));
    }
 catch (    Exception ex) {
      LOG.error(ex,ex);
    }
  }
  return allocInfo;
}
