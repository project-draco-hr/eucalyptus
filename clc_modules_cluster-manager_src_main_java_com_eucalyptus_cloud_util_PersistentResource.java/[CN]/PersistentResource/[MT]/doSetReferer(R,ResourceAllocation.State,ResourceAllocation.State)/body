{
  try {
    return Transactions.naturalId((T)this,new Callback<T>(){
      @Override public void fire(      T input){
        if (!preconditionState.equals(input.getState())) {
          throw new RuntimeException("Error allocating resource " + PersistentResource.this.getClass().getSimpleName() + " with id "+ PersistentResource.this.getDisplayName()+ " as the state is not "+ preconditionState.name()+ " (currently "+ PersistentResource.this.getState()+ ").");
        }
 else {
          PersistentResource.this.setReferer(referer);
          PersistentResource.this.setState(finalState);
        }
      }
    }
);
  }
 catch (  TransactionException ex) {
    Logs.extreme().error(ex,ex);
    throw new ResourceAllocationException(ex);
  }
}
