{
  if (!this.request.compareAndSet(null,request)) {
    LOG.warn("Duplicate write attempt for request: " + this.request.get().getClass().getSimpleName());
    return true;
  }
 else {
    final SocketAddress serviceSocketAddress=config.getSocketAddress();
    final ChannelPipelineFactory factory=config.getComponentId().getClientPipeline();
    try {
      this.clientBootstrap=ChannelUtil.getClientBootstrap(new ChannelPipelineFactory(){
        @Override public ChannelPipeline getPipeline() throws Exception {
          ChannelPipeline pipeline=factory.getPipeline();
          pipeline.addLast("request-handler",AsyncRequestHandler.this);
          return pipeline;
        }
      }
);
      EventRecord.here(request.getClass(),EventClass.SYSTEM_REQUEST,EventType.CHANNEL_OPENING,request.getClass().getSimpleName(),request.getCorrelationId(),serviceSocketAddress.toString()).trace();
      this.connectFuture=this.clientBootstrap.connect(serviceSocketAddress);
      final HttpRequest httpRequest=new MappingHttpRequest(HttpVersion.HTTP_1_1,HttpMethod.POST,config,this.request.get());
      this.connectFuture.addListener(new ChannelFutureListener(){
        @Override public void operationComplete(        ChannelFuture future) throws Exception {
          try {
            if (future.isSuccess()) {
              final String localhostAddr=((InetSocketAddress)future.getChannel().getLocalAddress()).getAddress().getHostAddress();
              if (!factory.getClass().getSimpleName().startsWith("GatherLog")) {
                List<ServiceInfoType> serviceInfos=new ArrayList<ServiceInfoType>(){
{
                    addAll(Components.lookup(Eucalyptus.class).getServiceSnapshot(localhostAddr));
                    addAll(Components.lookup(Walrus.class).getServiceSnapshot(localhostAddr));
                    for (                    ServiceInfoType s : Components.lookup(Storage.class).getServiceSnapshot(localhostAddr)) {
                      if (config.getPartition().equals(s.getPartition())) {
                        add(s);
                      }
                    }
                    for (                    ServiceInfoType s : Components.lookup(ClusterController.class).getServiceSnapshot(localhostAddr)) {
                      if (config.getPartition().equals(s.getPartition())) {
                        add(s);
                      }
                    }
                  }
                }
;
                AsyncRequestHandler.this.request.get().getBaseServices().addAll(serviceInfos);
              }
              EventRecord.here(request.getClass(),EventClass.SYSTEM_REQUEST,EventType.CHANNEL_OPEN,request.getClass().getSimpleName(),request.getCorrelationId(),serviceSocketAddress.toString(),"" + future.getChannel().getLocalAddress(),"" + future.getChannel().getRemoteAddress()).trace();
              future.getChannel().getCloseFuture().addListener(new ChannelFutureListener(){
                @Override public void operationComplete(                ChannelFuture future) throws Exception {
                  EventRecord.here(request.getClass(),EventClass.SYSTEM_REQUEST,EventType.CHANNEL_CLOSED,request.getClass().getSimpleName(),request.getCorrelationId(),serviceSocketAddress.toString(),"" + future.getChannel().getLocalAddress(),"" + future.getChannel().getRemoteAddress()).trace();
                }
              }
);
              future.getChannel().write(httpRequest).addListener(new ChannelFutureListener(){
                @Override public void operationComplete(                ChannelFuture future) throws Exception {
                  AsyncRequestHandler.this.writeComplete.set(true);
                  EventRecord.here(request.getClass(),EventClass.SYSTEM_REQUEST,EventType.CHANNEL_WRITE,request.getClass().getSimpleName(),request.getCorrelationId(),serviceSocketAddress.toString(),"" + future.getChannel().getLocalAddress(),"" + future.getChannel().getRemoteAddress()).trace();
                }
              }
);
            }
 else {
              AsyncRequestHandler.this.teardown(future.getCause());
            }
          }
 catch (          RuntimeException ex) {
            LOG.error(ex,ex);
            AsyncRequestHandler.this.teardown(future.getCause());
          }
        }
      }
);
      return true;
    }
 catch (    Throwable t) {
      LOG.error(t,t);
      this.teardown(t);
      return false;
    }
  }
}
