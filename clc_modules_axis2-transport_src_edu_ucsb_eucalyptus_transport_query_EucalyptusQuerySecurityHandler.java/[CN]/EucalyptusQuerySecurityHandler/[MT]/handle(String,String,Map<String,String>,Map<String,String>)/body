{
  this.checkParameters(parameters);
  URL url=null;
  try {
    url=new URL(urlString);
  }
 catch (  MalformedURLException e) {
    throw new QuerySecurityException(e.getMessage());
  }
  String host=url.getHost();
  String addr=url.getPath();
  String sig=parameters.remove(SecurityParameter.Signature.toString());
  String queryId=parameters.get(SecurityParameter.AWSAccessKeyId.toString());
  String queryKey=findQueryKey(queryId);
  String paramString=makeSubjectString(parameters);
  String paramString2=makePlusSubjectString(parameters);
  LOG.info("VERSION1-SIG1: " + paramString);
  LOG.info("VERSION1-SIG2: " + paramString2);
  String headerHost=headers.get("Host");
  String headerPort="8773";
  if (headerHost != null && headerHost.contains(":")) {
    String[] hostTokens=headerHost.split(":");
    headerHost=hostTokens[0];
    if (hostTokens.length > 1 && hostTokens[1] != null && "".equals(hostTokens[1])) {
      headerPort=hostTokens[1];
    }
  }
  String paramString3=makeV2SubjectString(verb,headerHost,addr,parameters);
  String paramString4=makeV2SubjectString(verb,headerHost + ":" + headerPort,addr,parameters);
  String paramString5=makeV2SubjectString(verb,headerHost,addr.replaceFirst("/services",""),parameters);
  String authSig=checkSignature(queryKey,paramString);
  String authSig2=checkSignature(queryKey,paramString2);
  String authv2sha256=checkSignature256(queryKey,paramString3);
  String authv2sha256port=checkSignature256(queryKey,paramString4);
  String authv2sha256typica=checkSignature256(queryKey,paramString5);
  LOG.info("VERSION2-SHA256:        " + authv2sha256 + " -- "+ sig);
  LOG.info("VERSION2-SHA256-HEADER: " + authv2sha256port + " -- "+ sig);
  LOG.info("VERSION2-SHA256-TYPICA: " + authv2sha256typica + " -- "+ sig);
  if (!authSig.equals(sig) && !authSig2.equals(sig) && !authv2sha256.equals(sig)&& !authv2sha256port.equals(sig)&& !authv2sha256typica.equals(sig))   throw new QuerySecurityException("User authentication failed.");
  Calendar now=Calendar.getInstance();
  Calendar expires=null;
  if (parameters.containsKey(SecurityParameter.Timestamp.toString())) {
    String timestamp=parameters.remove(SecurityParameter.Timestamp.toString());
    expires=parseTimestamp(timestamp);
    expires.add(Calendar.MINUTE,5);
  }
 else {
    String exp=parameters.remove(SecurityParameter.Expires.toString());
    expires=parseTimestamp(exp);
  }
  if (now.after(expires))   throw new QuerySecurityException("Message has expired.");
  for (  Axis2QueryDispatcher.OperationParameter op : Axis2QueryDispatcher.OperationParameter.values())   parameters.remove(op.name());
  parameters.remove(Axis2QueryDispatcher.RequiredQueryParams.SignatureVersion.toString());
  parameters.remove(Axis2QueryDispatcher.RequiredQueryParams.Version.toString());
  parameters.remove("SignatureMethod");
  return findUserId(parameters.remove(SecurityParameter.AWSAccessKeyId.toString()));
}
