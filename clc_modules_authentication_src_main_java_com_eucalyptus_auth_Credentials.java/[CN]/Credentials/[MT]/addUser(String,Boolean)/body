{
  User newUser=new User();
  newUser.setUserName(userName);
  String queryId=Hashes.getDigestBase64(userName,Hashes.Digest.SHA224,false).replaceAll("\\p{Punct}","");
  String secretKey=Hashes.getDigestBase64(userName,Hashes.Digest.SHA224,true).replaceAll("\\p{Punct}","");
  newUser.setQueryId(queryId);
  newUser.setSecretKey(secretKey);
  newUser.setIsAdministrator(isAdmin);
  EntityWrapper<User> db=getEntityWrapper();
  try {
    db.add(newUser);
  }
 catch (  Exception e) {
    db.rollback();
    throw new UserExistsException(e);
  }
 finally {
    db.commit();
  }
  return newUser;
}
