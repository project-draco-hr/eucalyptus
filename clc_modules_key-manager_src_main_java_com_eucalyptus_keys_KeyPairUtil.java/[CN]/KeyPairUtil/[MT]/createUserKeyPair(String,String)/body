{
  SshKeyPair newKey=new SshKeyPair(userName,keyName);
  EntityWrapper<SshKeyPair> db=KeyPairUtil.getEntityWrapper();
  try {
    db.add(newKey);
    db.commit();
  }
 catch (  Throwable e1) {
    db.rollback();
    throw new EucalyptusCloudException("KeyPair generation error. Key pair: " + keyName + " already exists.");
  }
  KeyTool keyTool=new KeyTool();
  KeyPair newKeys=keyTool.getKeyPair();
  String authKeyString=getAuthKeyString(userName,newKeys);
  newKey.setPublicKey(authKeyString);
  newKey.setFingerPrint(Hashes.getFingerPrint(newKeys.getPrivate()));
  db=KeyPairUtil.getEntityWrapper();
  db.merge(newKey);
  db.commit();
  return newKeys.getPrivate();
}
