{
  SshKeyPair newKey=new SshKeyPair(userName,keyName);
  KeyPair newKeys=null;
  try {
    KeyTool keyTool=new KeyTool();
    newKeys=keyTool.getKeyPair();
    String authKeyString=getAuthKeyString(userName,newKeys);
    newKey.setPublicKey(authKeyString);
    newKey.setFingerPrint(Hashes.getFingerPrint(newKeys.getPrivate()));
  }
 catch (  Exception e) {
    throw new EucalyptusCloudException("KeyPair generation error: Key pair creation failed.",e);
  }
  EntityWrapper<SshKeyPair> db=KeyPairUtil.getEntityWrapper();
  try {
    db.add(newKey);
    db.commit();
  }
 catch (  Throwable e1) {
    db.rollback();
    throw new EucalyptusCloudException("KeyPair generation error. Key pair: " + keyName + " already exists.");
  }
  return newKeys.getPrivate();
}
