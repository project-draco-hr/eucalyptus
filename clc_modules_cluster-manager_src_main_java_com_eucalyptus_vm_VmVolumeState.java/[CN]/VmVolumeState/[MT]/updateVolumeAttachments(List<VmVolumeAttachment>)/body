{
  Set<String> remoteVolumes=Sets.newHashSet(Collections2.transform(ncAttachedVols,VmVolumeAttachmentName.INSTANCE));
  Set<String> localVolumes=Sets.newHashSet(Collections2.transform(this.getAttachments(),VmVolumeAttachmentName.INSTANCE));
  Set<String> intersection=Sets.intersection(remoteVolumes,localVolumes);
  Set<String> remoteOnly=Sets.difference(remoteVolumes,localVolumes);
  Set<String> localOnly=Sets.difference(localVolumes,remoteVolumes);
  if (!intersection.isEmpty() || !remoteOnly.isEmpty() || !localOnly.isEmpty()) {
    LOG.debug("Updating volume attachments for: " + this.getVmInstance().getInstanceId() + " intersection="+ intersection+ " local="+ localOnly+ " remote="+ remoteOnly);
  }
  final Map<String,VmVolumeAttachment> ncAttachedVolMap=new HashMap<String,VmVolumeAttachment>(){
{
      for (      final VmVolumeAttachment v : ncAttachedVols) {
        this.put(v.getVolumeId(),v);
      }
    }
  }
;
  for (  String volId : intersection) {
    try {
      VmVolumeAttachment ncVolumeAttachment=ncAttachedVolMap.get(volId);
      final AttachmentState localState=this.lookupVolumeAttachment(volId).getAttachmentState();
      final AttachmentState remoteState=AttachmentState.parse(ncVolumeAttachment.getStatus());
      if (!localState.isVolatile()) {
        if (AttachmentState.detached.equals(remoteState)) {
          this.removeVolumeAttachment(volId);
        }
      }
 else {
        if (AttachmentState.attaching_failed.equals(remoteState)) {
          this.removeVolumeAttachment(volId);
        }
 else         if (AttachmentState.detaching_failed.equals(remoteState) && !AttachmentState.attached.equals(localState)) {
          this.updateVolumeAttachment(volId,AttachmentState.attached);
        }
 else         if (AttachmentState.attached.equals(remoteState) && !localState.equals(remoteState)) {
          this.updateVolumeAttachment(volId,remoteState);
        }
      }
    }
 catch (    Exception ex) {
      LOG.error(ex);
    }
  }
  for (  String volId : remoteOnly) {
    try {
      VmVolumeAttachment ncVolumeAttachment=ncAttachedVolMap.get(volId);
      final AttachmentState remoteState=AttachmentState.parse(ncVolumeAttachment.getStatus());
      if (AttachmentState.attached.equals(remoteState) || AttachmentState.detaching_failed.equals(remoteState)) {
        LOG.warn("Restoring volume attachment state for " + this.getVmInstance().getInstanceId() + " with "+ ncVolumeAttachment.toString());
        this.addVolumeAttachment(ncVolumeAttachment);
      }
    }
 catch (    Exception ex) {
      LOG.error(ex);
    }
  }
  for (  String volId : localOnly) {
    try {
      final AttachmentState localState=this.lookupVolumeAttachment(volId).getAttachmentState();
      if (!localState.isVolatile()) {
      }
    }
 catch (    Exception ex) {
      LOG.error(ex);
    }
  }
}
