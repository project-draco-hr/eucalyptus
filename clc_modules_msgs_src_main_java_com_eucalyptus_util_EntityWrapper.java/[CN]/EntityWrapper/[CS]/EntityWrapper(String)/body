{
  EntityManagerFactoryImpl anemf=(EntityManagerFactoryImpl)EntityWrapper.getEntityManagerFactory(persistenceContext);
  if (doDebug) {
    anemf.getSessionFactory().getStatistics().setStatisticsEnabled(true);
    LOG.debug("Hibernate statistics: " + anemf.getSessionFactory().getStatistics());
  }
  try {
    this.em=anemf.createEntityManager();
    if (doDebug) {
      Exception e=new Exception();
      e.fillInStackTrace();
      for (      StackTraceElement ste : e.getStackTrace()) {
        if (ste.getClassName().equals(EntityWrapper.class.getCanonicalName()) || ste.getMethodName().matches("getEntityWrapper")) {
          continue;
        }
 else {
          LOG.debug("CREATE CONNECTION " + ste.toString());
          break;
        }
      }
      EntityWrapper.printStatus();
    }
    this.session=(Session)em.getDelegate();
    this.tx=em.getTransaction();
    tx.begin();
  }
 catch (  Throwable e) {
    EntityWrapper.exceptionCaught(e);
    throw new RuntimeException(e);
  }
}
