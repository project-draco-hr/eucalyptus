{
  try (final TransactionResource tx=Entities.transactionFor(CertificateEntity.class)){
    final List<CertificateEntity> entities=(List<CertificateEntity>)Entities.createCriteria(CertificateEntity.class).add(Restrictions.or(Restrictions.isNull("certificateHashId"),Restrictions.eq("revoked",true))).list();
    for (    final CertificateEntity entity : entities) {
      if (entity.revoked) {
        logger.info("Deleting revoked certificate: " + entity.getCertificateId());
        Entities.delete(entity);
      }
 else {
        try {
          entity.certificateHashId=Identifiers.generateCertificateIdentifier(X509CertHelper.toCertificate(entity.getPem()));
        }
 catch (        Exception e) {
          logger.error("Error generating fingerprint identifier for certificate",e);
        }
      }
    }
    tx.commit();
  }
   return true;
}
