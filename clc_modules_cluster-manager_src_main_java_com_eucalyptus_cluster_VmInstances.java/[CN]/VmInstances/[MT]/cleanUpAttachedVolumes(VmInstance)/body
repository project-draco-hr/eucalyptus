{
  Cluster cluster=Clusters.getInstance().lookup(vm.getPlacement());
  if (!vm.getVolumes().isEmpty()) {
    try {
      StorageControllerConfiguration sc=Configuration.lookupScHack(vm.getPlacement());
      for (      AttachedVolume volume : vm.getVolumes()) {
        try {
          ServiceDispatcher.lookup(Component.storage,sc.getHostName()).send(new DetachStorageVolumeType(cluster.getNode(vm.getServiceTag()).getIqn(),volume.getVolumeId()));
          vm.getVolumes().remove(volume);
        }
 catch (        Throwable e) {
          LOG.error("Failed sending Detach Storage Volume for: " + volume.getVolumeId() + ".  Will keep trying as long as instance is reported.  The request failed because of: "+ e.getMessage(),e);
        }
      }
    }
 catch (    Exception ex) {
      LOG.error("Failed to lookup Storage Controller configuration for: " + vm.getInstanceId() + " (placement="+ vm.getPlacement()+ ").  "+ "The the following volumes are attached: "+ Iterables.transform(vm.getVolumes(),new Function<AttachedVolume,String>(){
        @Override public String apply(        AttachedVolume arg0){
          return arg0.getVolumeId();
        }
      }
));
    }
  }
}
