{
  try {
    final Cluster cluster=Clusters.getInstance().lookup(vm.getPlacement());
    final StorageControllerConfiguration sc=Configuration.lookupSc(vm.getPlacement());
    vm.eachVolumeAttachment(new Predicate<AttachedVolume>(){
      @Override public boolean apply(      AttachedVolume arg0){
        try {
          vm.removeVolumeAttachment(arg0.getVolumeId());
          Dispatcher scDispatcher=ServiceDispatcher.lookup(Component.storage,sc.getHostName());
          scDispatcher.send(new DetachStorageVolumeType(cluster.getNode(vm.getServiceTag()).getIqn(),arg0.getVolumeId()));
          return true;
        }
 catch (        Throwable e) {
          LOG.error("Failed sending Detach Storage Volume for: " + arg0.getVolumeId() + ".  Will keep trying as long as instance is reported.  The request failed because of: "+ e.getMessage(),e);
          return false;
        }
      }
    }
);
  }
 catch (  Exception ex) {
    LOG.error("Failed to lookup Storage Controller configuration for: " + vm.getInstanceId() + " (placement="+ vm.getPlacement()+ ").  ");
  }
}
