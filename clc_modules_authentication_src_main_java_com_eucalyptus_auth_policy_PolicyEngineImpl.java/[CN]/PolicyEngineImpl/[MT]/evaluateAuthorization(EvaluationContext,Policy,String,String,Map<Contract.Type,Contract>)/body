{
  try {
    final EvaluationContextImpl evaluationContext=(EvaluationContextImpl)context;
    final ContractKeyEvaluator contractEval=new ContractKeyEvaluator(contracts);
    final CachedKeyEvaluator keyEval=new CachedKeyEvaluator();
    final String action=evaluationContext.getAction();
    final User requestUser=evaluationContext.getRequestUser();
    if (!evaluationContext.isSystemAdmin()) {
      verifyUser(requestUser);
      final Account account=evaluationContext.getRequestAccount();
      if (!requestUser.isAccountAdmin() || resourceAccountNumber == null || !resourceAccountNumber.equals(account.getAccountNumber())) {
        Decision decision=resourcePolicy == null ? Decision.ALLOW : processAuthorizations(resourcePolicy.getAuthorizations(),action,null,null,evaluationContext.getPrincipalType(),evaluationContext.getPrincipalName(),keyEval,contractEval);
        if (decision != Decision.ALLOW) {
          LOG.debug("Request is rejected by resource authorization check, due to decision " + decision);
          throw new AuthException(AuthException.ACCESS_DENIED);
        }
 else {
          decision=evaluateResourceAuthorization(evaluationContext,resourceAccountNumber,resourceName,contracts);
          if (Decision.DENY == decision || (Decision.ALLOW != decision && resourcePolicy == null)) {
            throw new AuthException(AuthException.ACCESS_DENIED);
          }
        }
      }
    }
  }
 catch (  AuthException e) {
    LOG.debug(e,e);
    throw e;
  }
catch (  Exception e) {
    LOG.debug(e,e);
    throw new AuthException("An error occurred while trying to evaluate policy for resource access",e);
  }
}
