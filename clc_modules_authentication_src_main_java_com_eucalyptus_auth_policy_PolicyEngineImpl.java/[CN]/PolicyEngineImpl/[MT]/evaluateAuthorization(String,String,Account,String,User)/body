{
  try {
    ContractKeyEvaluator contractEval=new ContractKeyEvaluator();
    CachedKeyEvaluator keyEval=new CachedKeyEvaluator();
    if (!requestUser.isSystemAdmin() && !requestUser.isSystemInternal()) {
      String userId=requestUser.getUserId();
      Account account=requestUser.getAccount();
      Decision decision=processAuthorizations(lookupGlobalAuthorizations(resourceType,account),action,resourceName,keyEval,contractEval);
      if ((decision == Decision.DENY) || (decision == Decision.DEFAULT && resourceAccount.getAccountNumber() != null && !resourceAccount.getAccountNumber().equals(account.getAccountNumber()))) {
        LOG.debug("Request is rejected by global authorization check, due to decision " + decision);
        throw new AuthException(AuthException.ACCESS_DENIED);
      }
      if (!requestUser.isAccountAdmin()) {
        decision=processAuthorizations(lookupLocalAuthorizations(resourceType,requestUser),action,resourceName,keyEval,contractEval);
        if (decision == Decision.DENY || decision == Decision.DEFAULT) {
          LOG.debug("Request is rejected by local authorization check, due to decision " + decision);
          throw new AuthException(AuthException.ACCESS_DENIED);
        }
      }
    }
    return contractEval.getContracts();
  }
 catch (  AuthException e) {
    throw e;
  }
catch (  Throwable e) {
    throw new AuthException("An error occurred while trying to evaluate policy for resource access",e);
  }
}
