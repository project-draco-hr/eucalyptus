{
  try {
    if (resourceClass == null) {
      throw new AuthException("Empty resource class");
    }
    if (request == null) {
      throw new AuthException("Empty request");
    }
    if (requestUser == null) {
      throw new AuthException("Empty request user");
    }
    ContractKeyEvaluator contractEval=new ContractKeyEvaluator();
    CachedKeyEvaluator keyEval=new CachedKeyEvaluator();
    if (requestUser.isSystemAdmin()) {
      return contractEval.getContracts();
    }
    String userId=requestUser.getUserId();
    String accountId=requestUser.getAccount().getAccountId();
    String resourceType=getResourceType(resourceClass);
    String action=getAction(request.getClass());
    Decision decision=processAuthorizations(lookupGlobalAuthorizations(resourceType,accountId),action,resourceName,keyEval,contractEval);
    if ((decision == Decision.DENY) || (decision == Decision.DEFAULT && resourceAccountId != null && !resourceAccountId.equals(accountId))) {
      LOG.debug(request + " is rejected by global authorization check, due to decision " + decision);
      throw new AuthException(AuthException.ACCESS_DENIED);
    }
    if (requestUser.isAccountAdmin()) {
      return contractEval.getContracts();
    }
    decision=processAuthorizations(lookupLocalAuthorizations(resourceType,userId),action,resourceName,keyEval,contractEval);
    if (decision == Decision.DENY || decision == Decision.DEFAULT) {
      LOG.debug(request + " is rejected by local authorization check, due to decision " + decision);
      throw new AuthException(AuthException.ACCESS_DENIED);
    }
    return contractEval.getContracts();
  }
 catch (  AuthException e) {
    throw e;
  }
catch (  IllegalContextAccessException e) {
    throw new AuthException("Cannot invoke without a corresponding service context available.",e);
  }
catch (  Throwable e) {
    throw new AuthException("An error occurred while trying to evaluate policy for resource access",e);
  }
}
