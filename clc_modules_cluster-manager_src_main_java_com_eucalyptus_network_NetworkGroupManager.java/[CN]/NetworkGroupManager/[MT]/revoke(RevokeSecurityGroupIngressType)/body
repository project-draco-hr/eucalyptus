{
  final Context ctx=Contexts.lookup();
  final RevokeSecurityGroupIngressResponseType reply=request.getReply();
  reply.markFailed();
  final List<IpPermissionType> ipPermissions=request.getIpPermissions();
  final List<NetworkRule> revokedRuleList=NetworkGroups.ipPermissionsAsNetworkRules(ipPermissions);
  EntityTransaction db=Entities.get(NetworkGroup.class);
  try {
    String lookUpGroup=request.getGroupName() != null ? request.getGroupName() : request.getGroupId();
    AccountFullName lookUpGroupAccount=ctx.getUserFullName().asAccountFullName();
    String groupName;
    try {
      groupName=NetworkGroups.lookup(lookUpGroupAccount,lookUpGroup).getDisplayName();
    }
 catch (    MetadataException ex) {
      try {
        groupName=NetworkGroups.lookupByGroupId(lookUpGroupAccount,lookUpGroup).getDisplayName();
      }
 catch (      NoSuchMetadataException ex1) {
        throw ex1;
      }
    }
    final List<NetworkGroup> networkGroupList=NetworkGroups.lookupAll(ctx.getUserFullName().asAccountFullName(),groupName);
    for (    NetworkGroup networkGroup : networkGroupList) {
      if (RestrictedTypes.filterPrivileged().apply(networkGroup)) {
        for (Iterator<NetworkRule> it=networkGroup.getNetworkRules().iterator(); it.hasNext(); ) {
          NetworkRule rule=it.next();
          if (revokedRuleList.contains(rule)) {
            it.remove();
          }
        }
      }
 else {
        throw new EucalyptusCloudException("Not authorized to revoke" + "network group " + request.getGroupName() + " for "+ ctx.getUser());
      }
    }
    reply.set_return(true);
    db.commit();
  }
 catch (  Exception ex) {
    Logs.exhaust().error(ex,ex);
    db.rollback();
    throw new EucalyptusCloudException("RevokeSecurityGroupIngress failed because: " + ex.getMessage(),ex);
  }
  return reply;
}
