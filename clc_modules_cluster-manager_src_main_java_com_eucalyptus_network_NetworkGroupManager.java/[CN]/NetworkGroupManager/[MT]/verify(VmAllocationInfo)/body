{
  RunInstancesType request=vmAllocInfo.getRequest();
  String action=PolicySpec.requestToAction(request);
  User requestUser=Permissions.getUserById(request.getUserId());
  Account account=Permissions.getAccountByUserId(request.getUserId());
  NetworkGroupUtil.makeDefault(account.getAccountId());
  ArrayList<String> networkNames=new ArrayList<String>(request.getGroupSet());
  if (networkNames.size() < 1) {
    networkNames.add("default");
  }
  for (  String networkName : networkNames) {
    NetworkRulesGroup networkGroup=NetworkGroupUtil.getUserNetworkRulesGroup(account.getAccountId(),networkName);
    if (!Permissions.isAuthorized(PolicySpec.EC2_RESOURCE_SECURITYGROUP,networkName,account,action,requestUser)) {
      throw new EucalyptusCloudException("Not authorized to use network group " + networkName + " for "+ requestUser.getName());
    }
    vmAllocInfo.getNetworks().add(networkGroup.getVmNetwork());
  }
  return vmAllocInfo;
}
