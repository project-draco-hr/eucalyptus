{
  final DescribeSecurityGroupsResponseType reply=request.getReply();
  final Context ctx=Contexts.lookup();
  boolean showAll=request.getSecurityGroupSet().remove("verbose");
  NetworkGroups.createDefault(ctx.getUserFullName());
  final List<String> groupNames=request.getSecurityGroupSet();
  final Predicate<NetworkGroup> argListFilter=new Predicate<NetworkGroup>(){
    @Override public boolean apply(    final NetworkGroup arg0){
      return groupNames.isEmpty() || groupNames.contains(arg0.getDisplayName());
    }
  }
;
  Predicate<NetworkGroup> netFilter=Predicates.and(argListFilter,RestrictedTypes.filterPrivileged());
  OwnerFullName ownerFn=AccountFullName.getInstance(ctx.getAccount());
  if (Contexts.lookup().hasAdministrativePrivileges()) {
    if (showAll) {
      ownerFn=null;
    }
    netFilter=argListFilter;
  }
  final EntityTransaction db=Entities.get(NetworkGroup.class);
  try {
    final List<NetworkGroup> networks=Entities.query(NetworkGroup.named(ownerFn,null));
    final Iterable<NetworkGroup> matches=Iterables.filter(networks,netFilter);
    final Iterable<SecurityGroupItemType> transformed=Iterables.transform(matches,TypeMappers.lookup(NetworkGroup.class,SecurityGroupItemType.class));
    Iterables.addAll(reply.getSecurityGroupInfo(),transformed);
    db.commit();
  }
 catch (  final Exception ex) {
    db.rollback();
  }
  return reply;
}
