{
  final Multimap<String,String> zoneToInstances=ArrayListMultimap.create();
  for (  final String instance : instancePromises.keySet()) {
    try {
      final LoadBalancerZone zone=LoadBalancingServoCache.getInstance().getLoadBalancerZone(instance);
      zoneToInstances.put(zone.getName(),instance);
    }
 catch (    final Exception ex) {
      ;
    }
  }
  final List<Promise<?>> orPromises=Lists.newArrayList();
  for (  final String zone : zoneToInstances.keys()) {
    Promise<?> orPromise=null;
    for (    final String instance : zoneToInstances.get(zone)) {
      final Promise<?> p=instancePromises.get(instance);
      if (orPromise == null)       orPromise=p;
 else       orPromise=new OrPromise(orPromise,p);
    }
    if (orPromise != null)     orPromises.add(orPromise);
  }
  Promise<?> andPromise=null;
  for (  Promise<?> p : orPromises) {
    if (andPromise == null)     andPromise=p;
 else     andPromise=new AndPromise(andPromise,p);
  }
  return andPromise;
}
