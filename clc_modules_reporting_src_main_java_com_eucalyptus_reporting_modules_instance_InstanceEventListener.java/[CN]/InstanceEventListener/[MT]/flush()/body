{
  final ReportingInstanceEventStore eventStore=getReportingInstanceEventStore();
  persistenceLock.writeLock().lock();
  try {
    transactional(ReportingInstanceUsageEvent.class,new Function<Collection<DatedInstanceEvent>,Void>(){
      @Override public Void apply(      final Collection<DatedInstanceEvent> datedInstanceEvents){
        for (        final DatedInstanceEvent datedEvent : datedInstanceEvents) {
          final InstanceEvent event=datedEvent.getInstanceEvent();
          eventStore.insertUsageEvent(event.getUuid(),datedEvent.getTimestamp(),event.getCumulativeDiskIoMegs(),event.getCpuUtilizationPercent(),event.getCumulativeNetIncomingMegsBetweenZones(),event.getCumulativeNetIncomingMegsWithinZone(),event.getCumulativeNetIncomingMegsPublicIp(),event.getCumulativeNetOutgoingMegsBetweenZones(),event.getCumulativeNetOutgoingMegsWithinZone(),event.getCumulativeNetOutgoingMegsPublicIp());
          log.debug("Wrote instance usage for: " + event.getUuid());
        }
        return null;
      }
    }
).apply(recentUsageEvents.values());
    recentUsageEvents.clear();
  }
  finally {
    persistenceLock.writeLock().unlock();
  }
}
