{
  DescribeSnapshotsResponseType reply=(DescribeSnapshotsResponseType)request.getReply();
  Context ctx=Contexts.lookup();
  boolean showAll=request.getSnapshotSet().remove("verbose");
  EntityWrapper<Snapshot> db=EntityWrapper.get(Snapshot.class);
  try {
    List<Snapshot> snapshots=db.query(Snapshot.named((ctx.hasAdministrativePrivileges() && showAll) ? null : AccountFullName.getInstance(ctx.getAccount()),null));
    for (    Snapshot snap : Iterables.filter(snapshots,RestrictedTypes.filterPrivileged())) {
      if (request.getSnapshotSet().isEmpty() || request.getSnapshotSet().contains(snap.getDisplayName())) {
        try {
          edu.ucsb.eucalyptus.msgs.Snapshot snapReply=snap.morph(new edu.ucsb.eucalyptus.msgs.Snapshot());
          snapReply.setVolumeId(snap.getParentVolume());
          snapReply.setOwnerId(snap.getOwnerAccountNumber());
          reply.getSnapshotSet().add(snapReply);
        }
 catch (        NoSuchElementException e) {
          LOG.warn("Error getting snapshot information from the Storage Controller: " + e);
          LOG.debug(e,e);
        }
      }
    }
    db.commit();
  }
 catch (  Exception e) {
    db.rollback();
  }
  return reply;
}
