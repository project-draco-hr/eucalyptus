{
  DescribeSnapshotsResponseType reply=(DescribeSnapshotsResponseType)request.getReply();
  EntityWrapper<Snapshot> db=SnapshotManager.getEntityWrapper();
  try {
    List<Snapshot> snapshots=db.query(Snapshot.ownedBy(request.getUserErn()));
    for (    Snapshot v : snapshots) {
      DescribeStorageSnapshotsType scRequest=new DescribeStorageSnapshotsType(Lists.newArrayList(v.getDisplayName()));
      if (request.getSnapshotSet().isEmpty() || request.getSnapshotSet().contains(v.getDisplayName())) {
        try {
          ServiceConfiguration sc=StorageUtil.getActiveSc(v.getCluster()).getServiceConfiguration();
          DescribeStorageSnapshotsResponseType snapshotInfo=StorageUtil.send(sc.getName(),scRequest);
          for (          StorageSnapshot storageSnapshot : snapshotInfo.getSnapshotSet()) {
            v.setMappedState(storageSnapshot.getStatus());
            edu.ucsb.eucalyptus.msgs.Snapshot snapReply=v.morph(new edu.ucsb.eucalyptus.msgs.Snapshot());
            if (storageSnapshot.getProgress() != null)             snapReply.setProgress(storageSnapshot.getProgress());
            snapReply.setVolumeId(storageSnapshot.getVolumeId());
            snapReply.setOwnerId(v.getOwnerAccountId());
            reply.getSnapshotSet().add(snapReply);
          }
        }
 catch (        NoSuchElementException e) {
          LOG.warn("Error getting snapshot information from the Storage Controller: " + e);
          LOG.debug(e,e);
        }
catch (        EucalyptusCloudException e) {
          LOG.warn("Error getting snapshot information from the Storage Controller: " + e);
          LOG.debug(e,e);
        }
      }
    }
    db.commit();
  }
 catch (  Throwable e) {
    db.rollback();
  }
  return reply;
}
