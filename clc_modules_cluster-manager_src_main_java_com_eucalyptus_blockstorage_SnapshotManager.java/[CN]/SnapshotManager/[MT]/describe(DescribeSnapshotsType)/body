{
  DescribeSnapshotsResponseType reply=(DescribeSnapshotsResponseType)request.getReply();
  Context ctx=Contexts.lookup();
  EntityWrapper<Snapshot> db=EntityWrapper.get(Snapshot.class);
  try {
    List<Snapshot> snapshots=db.query(Snapshot.ownedBy(ctx.getUserFullName()));
    for (    Snapshot v : snapshots) {
      if (!Lookups.checkPrivilege(request,PolicySpec.VENDOR_EC2,PolicySpec.EC2_RESOURCE_SNAPSHOT,v.getDisplayName(),v.getOwner())) {
        LOG.debug("Skip snapshot " + v.getDisplayName() + " due to access right");
        continue;
      }
      DescribeStorageSnapshotsType scRequest=new DescribeStorageSnapshotsType(Lists.newArrayList(v.getDisplayName()));
      if (request.getSnapshotSet().isEmpty() || request.getSnapshotSet().contains(v.getDisplayName())) {
        try {
          Service sc=StorageUtil.getActiveSc(v.getCluster());
          DescribeStorageSnapshotsResponseType snapshotInfo=sc.getDispatcher().send(scRequest);
          for (          StorageSnapshot storageSnapshot : snapshotInfo.getSnapshotSet()) {
            v.setMappedState(storageSnapshot.getStatus());
            edu.ucsb.eucalyptus.msgs.Snapshot snapReply=v.morph(new edu.ucsb.eucalyptus.msgs.Snapshot());
            if (storageSnapshot.getProgress() != null)             snapReply.setProgress(storageSnapshot.getProgress());
            snapReply.setVolumeId(storageSnapshot.getVolumeId());
            snapReply.setOwnerId(v.getOwnerAccountId());
            reply.getSnapshotSet().add(snapReply);
          }
        }
 catch (        NoSuchElementException e) {
          LOG.warn("Error getting snapshot information from the Storage Controller: " + e);
          LOG.debug(e,e);
        }
catch (        EucalyptusCloudException e) {
          LOG.warn("Error getting snapshot information from the Storage Controller: " + e);
          LOG.debug(e,e);
        }
      }
    }
    db.commit();
  }
 catch (  Throwable e) {
    db.rollback();
  }
  return reply;
}
