{
  final Context ctx=Contexts.lookup();
  Volume vol=Transactions.find(Volume.named(ctx.getUserFullName().asAccountFullName(),request.getVolumeId()));
  final ServiceConfiguration sc=Topology.lookup(Storage.class,Partitions.lookupByName(vol.getPartition()));
  final Volume volReady=Volumes.checkVolumeReady(vol);
  Supplier<Snapshot> allocator=new Supplier<Snapshot>(){
    @Override public Snapshot get(){
      try {
        return Snapshots.initializeSnapshot(ctx.getUserFullName(),volReady,sc,request.getDescription());
      }
 catch (      EucalyptusCloudException ex) {
        throw new RuntimeException(ex);
      }
    }
  }
;
  Snapshot snap=RestrictedTypes.allocateUnitlessResource(allocator);
  snap=Snapshots.startCreateSnapshot(volReady,snap);
  fireUsageEvent(snap,SnapShotEvent.forSnapShotCreate(snap.getVolumeSize().longValue()));
  CreateSnapshotResponseType reply=(CreateSnapshotResponseType)request.getReply();
  edu.ucsb.eucalyptus.msgs.Snapshot snapMsg=snap.morph(new edu.ucsb.eucalyptus.msgs.Snapshot());
  snapMsg.setProgress("0%");
  snapMsg.setOwnerId(snap.getOwnerAccountNumber());
  snapMsg.setVolumeSize(volReady.getSize().toString());
  reply.setSnapshot(snapMsg);
  return reply;
}
