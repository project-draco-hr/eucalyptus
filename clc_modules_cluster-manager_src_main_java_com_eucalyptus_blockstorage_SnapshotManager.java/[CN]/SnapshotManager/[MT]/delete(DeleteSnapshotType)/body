{
  DeleteSnapshotResponseType reply=(DeleteSnapshotResponseType)request.getReply();
  reply.set_return(false);
  Context ctx=Contexts.lookup();
  EntityWrapper<Snapshot> db=EntityWrapper.get(Snapshot.class);
  try {
    Snapshot snap=db.getUnique(Snapshot.named(ctx.getUserFullName(),request.getSnapshotId()));
    if (!State.EXTANT.equals(snap.getState())) {
      db.rollback();
      reply.set_return(false);
      return reply;
    }
    if (!Lookups.checkPrivilege(request,PolicySpec.EC2_RESOURCE_SNAPSHOT,request.getSnapshotId(),snap.getOwner())) {
      throw new EucalyptusCloudException("Not authorized to delete snapshot " + request.getSnapshotId() + " by "+ ctx.getUser().getName());
    }
    db.delete(snap);
    Service sc=null;
    try {
      sc=StorageUtil.getActiveSc(snap.getCluster());
    }
 catch (    NoSuchElementException e) {
      throw new EucalyptusCloudException("Failed to find the storage controller information for volume: " + snap.getDisplayName() + " at "+ snap.getCluster(),e);
    }
    DeleteStorageSnapshotResponseType scReply=sc.getDispatcher().send(new DeleteStorageSnapshotType(snap.getDisplayName()));
    if (scReply.get_return()) {
      StorageUtil.dispatchAll(new DeleteStorageSnapshotType(snap.getDisplayName()));
      db.commit();
      try {
        ListenerRegistry.getInstance().fireEvent(new StorageEvent(StorageEvent.EventType.EbsSnapshot,true,snap.getVolumeSize(),snap.getOwnerUserId(),snap.getOwnerAccountId(),snap.getVolumeCluster(),snap.getVolumePartition()));
      }
 catch (      EventFailedException ex) {
        LOG.error(ex,ex);
      }
    }
 else {
      db.rollback();
      throw new EucalyptusCloudException("Unable to delete snapshot.");
    }
  }
 catch (  EucalyptusCloudException e) {
    LOG.debug(e,e);
    db.rollback();
    throw new EucalyptusCloudException("Error deleting storage volume:" + e.getMessage(),e);
  }
  reply.set_return(true);
  return reply;
}
