{
  final DeleteSnapshotResponseType reply=(DeleteSnapshotResponseType)request.getReply();
  final Context ctx=Contexts.lookup();
  boolean result=false;
  try {
    result=Transactions.delete(Snapshots.named(ctx.getUserFullName(),request.getSnapshotId()),new Predicate<Snapshot>(){
      @Override public boolean apply(      Snapshot snap){
        if (!State.EXTANT.equals(snap.getRuntimeState())) {
          return false;
        }
 else         if (!Types.checkPrivilege(request,PolicySpec.VENDOR_EC2,PolicySpec.EC2_RESOURCE_SNAPSHOT,request.getSnapshotId(),snap.getOwner())) {
          throw Exceptions.undeclared("Not authorized to delete snapshot " + request.getSnapshotId() + " by "+ ctx.getUser().getName(),new EucalyptusCloudException());
        }
 else {
          ServiceConfiguration sc=Partitions.lookupService(Storage.class,snap.getVolumePartition());
          try {
            DeleteStorageSnapshotResponseType scReply=ServiceDispatcher.lookup(sc).send(new DeleteStorageSnapshotType(snap.getDisplayName()));
            if (scReply.get_return()) {
              StorageUtil.dispatchAll(new DeleteStorageSnapshotType(snap.getDisplayName()));
              try {
                ListenerRegistry.getInstance().fireEvent(new StorageEvent(StorageEvent.EventType.EbsSnapshot,true,snap.getVolumeSize(),snap.getOwnerUserId(),snap.getOwnerAccountNumber(),snap.getVolumeCluster(),snap.getVolumePartition()));
              }
 catch (              EventFailedException ex) {
                LOG.error(ex,ex);
              }
            }
 else {
              throw Exceptions.undeclared("Unable to delete snapshot: " + snap,new EucalyptusCloudException());
            }
          }
 catch (          EucalyptusCloudException ex1) {
            throw Exceptions.undeclared(ex1.getMessage(),ex1);
          }
          return true;
        }
      }
    }
);
  }
 catch (  ExecutionException ex1) {
    throw new EucalyptusCloudException(ex1.getCause());
  }
  reply.set_return(result);
  return reply;
}
