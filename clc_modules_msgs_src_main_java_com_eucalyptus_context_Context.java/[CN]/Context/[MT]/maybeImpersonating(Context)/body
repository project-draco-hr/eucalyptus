{
  ctx.initRequest();
  if (ctx.request != null) {
    final String userId=Optional.fromNullable(ctx.request.getUserId()).or(Optional.fromNullable(ctx.request.getEffectiveUserId())).orNull();
    if (userId != null && !Principals.isFakeIdentify(userId) && ctx.hasAdministrativePrivileges()) {
      try {
        final User user;
        if (Accounts.isRoleIdentifier(userId)) {
          Role role=Accounts.lookupRoleById(userId);
          user=Accounts.roleAsUser(role);
        }
 else {
          user=Accounts.lookupUserById(userId);
        }
        return createImpersona(ctx,user);
      }
 catch (      AuthException ex) {
        return ctx;
      }
    }
  }
  return ctx;
}
