{
  ctx.initRequest();
  if (ctx.request != null) {
    final String userId=Optional.fromNullable(ctx.request.getUserId()).or(Optional.fromNullable(ctx.request.getEffectiveUserId())).orNull();
    if (userId != null && !Principals.isFakeIdentify(userId) && ctx.hasAdministrativePrivileges()) {
      try {
        final UserPrincipal user;
        if (Accounts.isAccountNumber(userId)) {
          user=Accounts.lookupCachedPrincipalByAccountNumber(userId);
        }
 else         if (Accounts.isRoleIdentifier(userId)) {
          user=Accounts.lookupCachedPrincipalByRoleId(userId,null);
        }
 else {
          user=Accounts.lookupCachedPrincipalByUserId(userId,null);
        }
        return createImpersona(ctx,user);
      }
 catch (      AuthException ex) {
        return ctx;
      }
    }
  }
  return ctx;
}
