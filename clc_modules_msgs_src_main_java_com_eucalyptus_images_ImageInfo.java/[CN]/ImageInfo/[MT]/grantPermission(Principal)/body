{
  try {
    ImageInfo search=new ImageInfo();
    search.setImageId(this.imageId);
    Transactions.one(search,new JoinTx<ImageInfo>(){
      @Override public void fire(      EntityWrapper<ImageInfo> db,      ImageInfo t) throws Throwable {
        ImageAuthorization imgAuth=null;
        if (prin instanceof Group) {
          imgAuth=new ImageAuthorization(prin.getName());
          if (!t.getUserGroups().contains(imgAuth)) {
            db.recast(ImageAuthorization.class).add(imgAuth);
            t.getUserGroups().add(imgAuth);
          }
        }
 else         if (prin instanceof User) {
          imgAuth=new ImageAuthorization(((User)prin).getUserId());
          if (!t.getPermissions().contains(imgAuth)) {
            db.recast(ImageAuthorization.class).add(imgAuth);
            t.getPermissions().add(imgAuth);
          }
        }
        if (t.getUserGroups().contains(new ImageAuthorization("all"))) {
          t.setImagePublic(true);
        }
      }
    }
);
  }
 catch (  TransactionException e) {
    LOG.debug(e,e);
  }
  return this;
}
