{
  try {
    String evilJson="{\n" + "  \"key1\" : \"value1\",\n" + "  \"key2\" : \"value2\",\n"+ "  \"key3\" : {\"Ref\":\"AWS::NoValue\"},\n"+ "  \"key4\" : {\"Ref\":\"AWS::NoValue\",\"Ref2\":\"AWS::NoValue\"},\n"+ "  \"key5\" : {\"array1\":[\"a1\",\"a2\",[\"a3\",\"a4\",{\"Ref\":\"AWS::NoValue\"}]]},\n"+ "  \"key6\" : [{\"Ref\":\"AWS::NoValue\"},{\"Ref\":\"AWS::NoValue\"},{\"Ref\":\"AWS::NoValue\"},\"a1\",{\"Ref\":\"AWS::NoValue\"},{\"Ref\":\"AWS::NoValue\"},\"a2\",\"a3\",{\"Ref\":\"AWS::NoValue\"},{\"Ref\":\"AWS::NoValue\"}],\n"+ "  \"key7\": [{\"Ref\":\"AWS::NoValue\"},{\"Ref\":\"AWS::NoValue\"},{\"Ref\":\"AWS::NoValue\"},{\"Ref\":\"AWS::NoValue\"},{\"Ref\":\"AWS::NoValue\"},{\"Ref\":\"AWS::NoValue\"}],\n"+ "  \"key8\" : [],\n"+ "  \"key9\" : {\"Bob\":{\"Ref\":\"AWS::NoValue\"}},\n"+ "  \"key10\" : {\"Bob\":{\"Ref\":\"Ref3\"}},\n"+ "  \"key11\" : {\"Bob\":{\"Fn::Base64\":{\"Ref\":\"Ref2\"}}},\n"+ "  \"key12\" : {\"Bob\":{\"Fn::Select\":[\"1\",{\"Ref\":\"Ref3\"}]}},\n"+ "  \"key13\" : {\"Bob\":{\"Fn::Join\":[\"!!\",{\"Ref\":\"Ref3\"}]}}\n"+ "}";
    Template template=new Template();
    Template.Reference ref1=new Template.Reference();
    ref1.setReady(false);
    ref1.setReferenceName("Ref1");
    ref1.setReferenceType(Template.ReferenceType.Resource);
    Template.Reference ref2=new Template.Reference();
    ref2.setReady(true);
    ref2.setReferenceName("Ref2");
    ref2.setReferenceType(Template.ReferenceType.Resource);
    ref2.setReferenceValueJson(JsonHelper.getStringFromJsonNode(new TextNode("The bowels of hell")));
    Template.Reference ref3=new Template.Reference();
    ref3.setReady(true);
    ref3.setReferenceName("Ref3");
    ref3.setReferenceType(Template.ReferenceType.Parameter);
    ObjectMapper objectMapper=new ObjectMapper();
    ArrayNode arrayNode=objectMapper.createArrayNode();
    arrayNode.add("The");
    arrayNode.add("bowels");
    arrayNode.add("of");
    arrayNode.add("hell");
    ref3.setReferenceValueJson(JsonHelper.getStringFromJsonNode(arrayNode));
    template.getReferenceMap().put("Ref1",ref1);
    template.getReferenceMap().put("Ref2",ref2);
    template.getReferenceMap().put("Ref3",ref3);
    JsonNode evilJsonNode=objectMapper.readTree(evilJson);
    evilJsonNode=(JsonNode)evaluateFunctions(evilJsonNode,template);
    System.out.println(objectMapper.writer(new DefaultPrettyPrinter()).writeValueAsString(evilJsonNode));
  }
 catch (  Exception ex) {
    ex.printStackTrace();
  }
}
