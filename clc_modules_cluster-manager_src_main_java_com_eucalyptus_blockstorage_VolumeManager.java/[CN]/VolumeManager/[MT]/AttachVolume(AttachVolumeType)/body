{
  AttachVolumeResponseType reply=(AttachVolumeResponseType)request.getReply();
  final String deviceName=request.getDevice();
  final String volumeId=request.getVolumeId();
  final Context ctx=Contexts.lookup();
  if (request.getDevice() == null || request.getDevice().endsWith("sda") || request.getDevice().endsWith("sdb")) {
    throw new EucalyptusCloudException("Invalid device name specified: " + request.getDevice());
  }
  VmInstance vm=null;
  try {
    vm=RestrictedTypes.doPrivileged(request.getInstanceId(),VmInstance.class);
  }
 catch (  NoSuchElementException ex) {
    LOG.debug(ex,ex);
    throw new EucalyptusCloudException("Instance does not exist: " + request.getInstanceId(),ex);
  }
catch (  Exception ex) {
    LOG.debug(ex,ex);
    throw new EucalyptusCloudException(ex.getMessage(),ex);
  }
  AccountFullName ownerFullName=ctx.getUserFullName().asAccountFullName();
  Volume volume=Volumes.lookup(ownerFullName,volumeId);
  if (!RestrictedTypes.filterPrivileged().apply(volume)) {
    throw new EucalyptusCloudException("Not authorized to attach volume " + request.getVolumeId() + " by "+ ctx.getUser().getName());
  }
  try {
    vm.lookupVolumeAttachmentByDevice(deviceName);
    throw new EucalyptusCloudException("Already have a device attached to: " + request.getDevice());
  }
 catch (  NoSuchElementException ex1) {
  }
  try {
    VmInstances.lookupVolumeAttachment(volumeId);
    throw new EucalyptusCloudException("Volume already attached: " + request.getVolumeId());
  }
 catch (  NoSuchElementException ex1) {
  }
  Partition volPartition=Partitions.lookupByName(volume.getPartition());
  ServiceConfiguration sc=Topology.lookup(Storage.class,volPartition);
  ServiceConfiguration scVm=Topology.lookup(Storage.class,vm.lookupPartition());
  if (!sc.equals(scVm)) {
    throw new EucalyptusCloudException("Can only attach volumes in the same zone: " + request.getVolumeId());
  }
  ServiceConfiguration ccConfig=Topology.lookup(ClusterController.class,vm.lookupPartition());
  AttachStorageVolumeResponseType scAttachResponse;
  try {
    AttachStorageVolumeType req=new AttachStorageVolumeType(Nodes.lookupIqn(vm),volume.getDisplayName());
    scAttachResponse=AsyncRequests.sendSync(sc,req);
  }
 catch (  Exception e) {
    LOG.debug(e,e);
    throw new EucalyptusCloudException(e.getMessage(),e);
  }
  request.setRemoteDevice(scAttachResponse.getRemoteDeviceString());
  AttachedVolume attachVol=new AttachedVolume(volume.getDisplayName(),vm.getInstanceId(),request.getDevice(),request.getRemoteDevice());
  if ("/dev/sda1".equals(deviceName) && vm.getBootRecord().isBlockStorage()) {
    if (this.getDeleteOnTerminate(vm)) {
      vm.addPersistentVolume(deviceName,volume);
    }
 else {
      vm.addPermanentVolume(deviceName,volume);
    }
  }
 else {
    vm.addTransientVolume(deviceName,scAttachResponse.getRemoteDeviceString(),volume);
    AsyncRequests.newRequest(new VolumeAttachCallback(request)).dispatch(ccConfig);
  }
  EventRecord.here(VolumeManager.class,EventClass.VOLUME,EventType.VOLUME_ATTACH).withDetails(volume.getOwner().toString(),volume.getDisplayName(),"instance",vm.getInstanceId()).withDetails("partition",vm.getPartition().toString()).info();
  reply.setAttachedVolume(attachVol);
  Volumes.fireUsageEvent(volume,VolumeEvent.forVolumeAttach(vm.getInstanceUuid(),volume.getDisplayName()));
  return reply;
}
