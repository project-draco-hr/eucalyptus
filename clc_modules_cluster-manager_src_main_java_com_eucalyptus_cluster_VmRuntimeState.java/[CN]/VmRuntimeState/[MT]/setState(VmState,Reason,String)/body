{
  final VmState oldState=this.getVmInstance().getState();
  Runnable action=null;
  if (VmState.SHUTTING_DOWN.equals(newState) && VmState.SHUTTING_DOWN.equals(oldState) && Reason.USER_TERMINATED.equals(reason)) {
    action=this.cleanUpRunnable(SEND_USER_TERMINATE);
  }
 else   if (VmState.STOPPING.equals(newState) && VmState.STOPPING.equals(oldState) && Reason.USER_STOPPED.equals(reason)) {
    action=this.cleanUpRunnable(SEND_USER_STOP);
  }
 else   if ((VmState.TERMINATED.equals(newState) && VmState.TERMINATED.equals(oldState)) || VmState.BURIED.equals(newState)) {
    action=this.cleanUpRunnable(SEND_USER_TERMINATE);
  }
 else   if (!oldState.equals(newState)) {
    if (Reason.APPEND.equals(reason)) {
      reason=this.reason;
    }
    this.addReasonDetail(extra);
    LOG.info(String.format("%s state change: %s -> %s",this.getVmInstance().getInstanceId(),this.getVmInstance().getState(),newState));
    this.reason=reason;
    if ((oldState.ordinal() <= VmState.RUNNING.ordinal()) && (newState.ordinal() > VmState.RUNNING.ordinal())) {
      this.getVmInstance().setState(newState);
      action=this.cleanUpRunnable();
    }
 else     if (VmState.PENDING.equals(oldState) && VmState.RUNNING.equals(newState)) {
      this.getVmInstance().setState(newState);
    }
 else     if (VmState.TERMINATED.equals(newState) && (oldState.ordinal() <= VmState.RUNNING.ordinal())) {
      this.getVmInstance().setState(newState);
      action=this.cleanUpRunnable();
    }
 else     if (VmState.TERMINATED.equals(newState) && (oldState.ordinal() > VmState.RUNNING.ordinal())) {
      this.getVmInstance().setState(newState);
    }
 else     if (newState.ordinal() > oldState.ordinal()) {
      this.getVmInstance().setState(newState);
    }
    try {
      this.getVmInstance().store();
    }
 catch (    Exception ex1) {
      LOG.error(ex1,ex1);
    }
    if (action != null) {
      try {
        action.run();
      }
 catch (      final Exception ex) {
        LOG.error(ex,ex);
      }
    }
    if (!this.getVmInstance().getState().equals(oldState)) {
      EventRecord.caller(VmInstance.class,EventType.VM_STATE,this.getVmInstance().getInstanceId(),this.vmInstance.getOwner(),this.getVmInstance().getState().name());
    }
  }
}
