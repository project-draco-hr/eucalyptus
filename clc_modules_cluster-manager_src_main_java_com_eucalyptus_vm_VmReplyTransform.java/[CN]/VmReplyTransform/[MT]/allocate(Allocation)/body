{
  RunInstancesResponseType reply=allocInfo.getRequest().getReply();
  Context ctx=Contexts.lookup();
  List<String> networkNames=Lists.transform(allocInfo.getNetworkGroups(),new Function<NetworkGroup,String>(){
    @Override public String apply(    NetworkGroup arg0){
      return arg0.getDisplayName();
    }
  }
);
  ReservationInfoType reservation=new ReservationInfoType(allocInfo.getReservationId(),ctx.getUserFullName().getNamespace(),Lists.newArrayList(networkNames));
  for (  ResourceToken allocToken : allocInfo.getAllocationTokens()) {
    EntityTransaction db=Entities.get(VmInstance.class);
    try {
      VmInstance entity=Entities.merge(allocToken.getVmInstance());
      reservation.getInstancesSet().add(VmInstances.transform(entity));
      db.commit();
    }
 catch (    Exception ex) {
      Logs.exhaust().error(ex,ex);
      db.rollback();
    }
  }
  reply.setRsvInfo(reservation);
  return reply;
}
