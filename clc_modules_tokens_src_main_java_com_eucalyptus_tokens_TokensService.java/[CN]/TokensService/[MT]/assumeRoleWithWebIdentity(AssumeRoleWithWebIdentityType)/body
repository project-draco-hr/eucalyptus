{
  final AssumeRoleWithWebIdentityResponseType reply=request.getReply();
  reply.getResponseMetadata().setRequestId(reply.getCorrelationId());
  final Context ctx=Contexts.lookup();
  final Subject subject=ctx.getSubject();
  final Set<QueryIdCredential> queryIdCreds=subject == null ? Collections.<QueryIdCredential>emptySet() : subject.getPublicCredentials(QueryIdCredential.class);
  if (queryIdCreds.size() == 1 && Iterables.get(queryIdCreds,0).getType().isPresent() && Iterables.get(queryIdCreds,0).getType().get() != TemporaryAccessKey.TemporaryKeyType.Access) {
    throw new TokensException(TokensException.Code.MissingAuthenticationToken,"Temporary credential not permitted.");
  }
  rejectPasswordCredentials();
  final BaseRole role=lookupRole(request.getRoleArn());
  try {
    final String identityToken=request.getWebIdentityToken();
    final String[] jwtParts=identityToken.split("\\.");
    final JSONObject jwtBody=JSONObject.fromObject(new String(Base64.decodeBase64(jwtParts[1])));
    final String jwtSignature=jwtParts[2];
    final Ern roleArn=Ern.parse(request.getRoleArn());
    final String roleAccountId=roleArn.getAccount();
    final OpenIdConnectProvider provider=lookupOpenIdConnectProvider(roleAccountId,(String)jwtBody.get("iss"));
    final String configJson=readUrl((String)jwtBody.get("iss") + "/.well-known/openid-configuration");
    final JSONObject config=JSONObject.fromObject(configJson);
    final String keysJson=readUrl((String)config.get("jwks_uri"));
    final JSONObject keys=JSONObject.fromObject(keysJson);
    final JSONObject keyData=(JSONObject)((JSONArray)keys.get("keys")).get(0);
    final String jwks_n=(String)(keyData).get("n");
    final String jwks_e=(String)(keyData).get("e");
    final String jwks_alg=(String)(keyData).get("alg");
    final String thumbprint=getServerCertThumbprint((String)config.get("jwks_uri"));
    if (!provider.getThumbprints().contains(thumbprint.toLowerCase())) {
      throw new TokensException(TokensException.Code.ValidationError,"SSL Certificate thumbprint does not match");
    }
    final BigInteger modulus=new BigInteger(1,Base64.decodeBase64(jwks_n));
    final BigInteger publicExponent=new BigInteger(1,Base64.decodeBase64(jwks_e));
    final PublicKey key=KeyFactory.getInstance("RSA").generatePublic(new RSAPublicKeySpec(modulus,publicExponent));
    final byte[] sigBytes=new Base64(true).decode(jwtParts[2]);
    final byte[] bytesToSign=(jwtParts[0] + "." + jwtParts[1]).getBytes();
    final Signature sig=Signature.getInstance("SHA512withRSA","BC");
    sig.initVerify(key);
    sig.update(bytesToSign);
    if (!sig.verify(sigBytes)) {
      throw new TokensException(TokensException.Code.ValidationError,"signature not valid");
    }
    if (!(provider.getClientIds().contains(jwtBody.get("aud")))) {
      throw new TokensException(TokensException.Code.ValidationError,"clientID does not match");
    }
    final long expiration=(long)jwtBody.getLong("exp") * 1000;
    if (new Date(expiration).compareTo(new Date()) < 0) {
      throw new TokensException(TokensException.Code.ValidationError,"web token has expired");
    }
    final SecurityToken token=SecurityTokenManager.issueSecurityToken(role,Objects.firstNonNull(request.getDurationSeconds(),(int)TimeUnit.HOURS.toSeconds(1)));
    reply.getAssumeRoleWithWebIdentityResult().setCredentials(new CredentialsType(token.getAccessKeyId(),token.getSecretKey(),token.getToken(),token.getExpires()));
    reply.getAssumeRoleWithWebIdentityResult().setAssumedRoleUser(new AssumedRoleUserType(role.getRoleId() + ":" + request.getRoleSessionName(),assumedRoleArn(role,request.getRoleSessionName())));
  }
 catch (  CertificateEncodingException|NoSuchProviderException|NoSuchAlgorithmException|InvalidKeySpecException e) {
    throw new TokensException(TokensException.Code.ValidationError,e.getMessage());
  }
catch (  InvalidKeyException|SignatureException|IOException|JSONException|SecurityTokenValidationException e) {
    throw new TokensException(TokensException.Code.ValidationError,e.getMessage());
  }
catch (  final AuthException e) {
    throw new EucalyptusCloudException(e.getMessage(),e);
  }
  return reply;
}
