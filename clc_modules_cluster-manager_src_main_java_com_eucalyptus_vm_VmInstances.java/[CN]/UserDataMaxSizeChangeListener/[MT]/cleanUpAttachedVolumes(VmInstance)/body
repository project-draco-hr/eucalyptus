{
  if (VmStateSet.DONE.apply(vm)) {
    EntityTransaction db=Entities.get(VmInstance.class);
    try {
      VmInstance vmInstance=Entities.merge(vm);
      Set<VmVolumeAttachment> transientAttachments=Sets.newHashSet(vmInstance.getTransientVolumeState().getAttachments());
      Set<VmVolumeAttachment> persistentAttachments=Sets.newHashSet(vmInstance.getBootRecord().getPersistentVolumes());
      db.commit();
      if (persistentAttachments != null && !persistentAttachments.isEmpty()) {
        for (        VmVolumeAttachment attachment : persistentAttachments) {
          try {
            vmInstance.removePersistentVolumeAttachment(attachment);
          }
 catch (          Exception ex) {
            LOG.error(vm.getInstanceId() + ": Failed to remove persistent volume attachment for " + attachment.getVolumeId(),ex);
          }
        }
      }
      if (transientAttachments != null && !transientAttachments.isEmpty()) {
        for (        VmVolumeAttachment attachment : transientAttachments) {
          try {
            vmInstance.removeTransientVolumeAttachment(attachment);
          }
 catch (          Exception ex) {
            LOG.error(vm.getInstanceId() + ": Failed to remove transient volume attachment for " + attachment.getVolumeId(),ex);
          }
        }
      }
    }
 catch (    Exception ex) {
      LOG.error(vm.getInstanceId() + ": Failed to remove attached volumes",ex);
    }
 finally {
      if (db.isActive()) {
        db.rollback();
      }
    }
  }
}
