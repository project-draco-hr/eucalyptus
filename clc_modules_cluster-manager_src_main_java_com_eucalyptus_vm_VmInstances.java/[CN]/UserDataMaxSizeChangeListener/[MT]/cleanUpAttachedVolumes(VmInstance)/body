{
  if (VmStateSet.DONE.apply(vm)) {
    try {
      if (vm.getTransientVolumeState() != null && vm.getTransientVolumeState().getAttachments() != null && !vm.getTransientVolumeState().getAttachments().isEmpty()) {
        Set<VmVolumeAttachment> transientVolumes=new HashSet<VmVolumeAttachment>(vm.getTransientVolumeState().getAttachments());
        for (        VmVolumeAttachment attachment : transientVolumes) {
          try {
            final Volume volume=Volumes.lookup(null,attachment.getVolumeId());
            if (State.BUSY.equals(volume.getState())) {
              volume.setState(State.EXTANT);
            }
          }
 catch (          Exception ex) {
            LOG.error(vm.getInstanceId() + ": Failed to cleanup transient volume attachment for " + attachment.getVolumeId(),ex);
          }
        }
      }
      if (vm.getBootRecord() != null && vm.getBootRecord().getPersistentVolumes() != null && !vm.getBootRecord().getPersistentVolumes().isEmpty()) {
        Set<VmVolumeAttachment> persistentVolumes=new HashSet<VmVolumeAttachment>(vm.getBootRecord().getPersistentVolumes());
        final ServiceConfiguration sc=Topology.lookup(Storage.class,vm.lookupPartition());
        for (        VmVolumeAttachment attachment : persistentVolumes) {
          if (attachment.getDeleteOnTerminate()) {
            try {
              Volume volume=Volumes.lookup(null,attachment.getVolumeId());
              LOG.debug(vm.getInstanceId() + ": Firing delete request for " + attachment.getVolumeId());
              DeleteStorageVolumeResponseType reply=AsyncRequests.sendSync(sc,new DeleteStorageVolumeType(attachment.getVolumeId()));
              if (null != reply && reply.get_return()) {
                Volumes.annihilateStorageVolume(volume);
              }
 else {
                LOG.error(vm.getInstanceId() + ": Failed to delete volume " + attachment.getVolumeId());
              }
            }
 catch (            Exception ex) {
              LOG.error(vm.getInstanceId() + ": Failed to cleanup persistent volume attachment for " + attachment.getVolumeId(),ex);
            }
          }
        }
      }
    }
 catch (    Exception ex) {
      LOG.error(vm.getInstanceId() + ": Failed to cleanup attached volumes",ex);
    }
  }
}
