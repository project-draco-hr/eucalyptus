{
  final Function<VmVolumeAttachment,Boolean> attachmentFunction=new Function<VmVolumeAttachment,Boolean>(){
    public Boolean apply(    VmVolumeAttachment arg0){
      final VmInstance vm=Entities.merge(VmInstance.this);
      final Volume volume=Volumes.lookup(null,arg0.getVolumeId());
      try {
        vm.transientVolumeState.removeVolumeAttachment(arg0.getVolumeId());
      }
 catch (      NoSuchElementException ex) {
        LOG.debug(arg0.getVolumeId() + ": Unable to find volume attachment. Nothing to remove",ex);
      }
      if (State.BUSY.equals(volume.getState())) {
        volume.setState(State.EXTANT);
      }
      return true;
    }
  }
;
  Entities.asTransaction(VmInstance.class,attachmentFunction,VmInstances.TX_RETRIES).apply(attachment);
}
