{
  final TreeMultimap<String,String> listingMap=TreeMultimap.create();
  final Splitter pathSplitter=Splitter.on('/');
  final Joiner pathJoiner=Joiner.on('/');
  for (  final String path : metadataMap.keySet()) {
    final List<String> pathSegments=Lists.newArrayList(pathSplitter.split(path));
    for (int i=0; i < pathSegments.size(); i++) {
      listingMap.put(pathJoiner.join(pathSegments.subList(0,i)),pathSegments.get(i) + (i < pathSegments.size() - 1 ? "/" : ""));
    }
  }
  if (addRoots && instance != null) {
    for (    MetadataGroup group : MetadataGroup.values()) {
      if (group.isPresent(instance) && group.prefix.isPresent()) {
        listingMap.put("",group.prefix.get() + "/");
      }
    }
  }
  final Joiner listingJoiner=Joiner.on("\n");
  for (  final String key : listingMap.keySet()) {
    if (!metadataMap.containsKey(key)) {
      metadataMap.put(key,listingJoiner.join(listingMap.get(key)));
    }
  }
  return metadataMap;
}
