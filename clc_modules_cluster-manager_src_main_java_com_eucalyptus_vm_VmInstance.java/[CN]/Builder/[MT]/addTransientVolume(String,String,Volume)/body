{
  final Function<Volume,Volume> attachmentFunction=new Function<Volume,Volume>(){
    public Volume apply(    final Volume input){
      final VmInstance entity=Entities.merge(VmInstance.this);
      final Volume volEntity=Entities.merge(vol);
      VmVolumeAttachment attachVol=new VmVolumeAttachment(entity,volEntity.getDisplayName(),deviceName,remoteDevice,AttachmentState.attaching.name(),new Date(),false);
      volEntity.setState(State.BUSY);
      entity.getTransientVolumeState().addVolumeAttachment(attachVol);
      return volEntity;
    }
  }
;
  Entities.asTransaction(VmInstance.class,attachmentFunction,VmInstances.TX_RETRIES).apply(vol);
}
