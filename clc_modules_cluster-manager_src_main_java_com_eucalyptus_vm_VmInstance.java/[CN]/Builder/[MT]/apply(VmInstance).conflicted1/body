{
  if (!Entities.isPersistent(v) && !VmStateSet.DONE.apply(v)) {
    throw new TransientEntityException(v.toString());
  }
 else {
    final EntityTransaction db=Entities.get(VmInstance.class);
    try {
      final VmInstance input=!Entities.isPersistent(v) && VmStateSet.DONE.apply(v) ? v : Entities.merge(v);
      RunningInstancesItemType runningInstance;
      runningInstance=new RunningInstancesItemType();
      runningInstance.setAmiLaunchIndex(Integer.toString(input.getLaunchRecord().getLaunchIndex()));
      final VmState displayState=input.getDisplayState();
      runningInstance.setStateCode(Integer.toString(displayState.getCode()));
      runningInstance.setStateName(displayState.getName());
      runningInstance.setPlatform(input.getPlatform());
      runningInstance.setInstanceId(input.getVmId().getInstanceId());
      runningInstance.setProductCodes(new ArrayList<String>());
      runningInstance.setImageId(input.getImageId());
      runningInstance.setKernel(input.getKernelId());
      runningInstance.setRamdisk(input.getRamdiskId());
      runningInstance.setDnsName(input.getDisplayPublicDnsName());
      runningInstance.setIpAddress(input.getDisplayPublicAddress());
      runningInstance.setPrivateDnsName(input.getDisplayPrivateDnsName());
      runningInstance.setPrivateIpAddress(input.getDisplayPrivateAddress());
      runningInstance.setReason(input.runtimeState.getReason());
      if (input.getBootRecord().getSshKeyPair() != null)       runningInstance.setKeyName(input.getBootRecord().getSshKeyPair().getName());
 else       runningInstance.setKeyName("");
      runningInstance.setInstanceType(input.getVmType().getName());
      runningInstance.setPlacement(input.getPlacement().getPartitionName());
      runningInstance.setLaunchTime(input.getLaunchRecord().getLaunchTime());
      runningInstance.setClientToken(input.getClientToken());
      runningInstance.setNameOrArn(input.getNameOrArn());
      if (input.getMonitoring()) {
        runningInstance.setMonitoring("enabled");
      }
 else {
        runningInstance.setMonitoring("disabled");
      }
      if (input.isBlockStorage()) {
        runningInstance.setRootDeviceType(ROOT_DEVICE_TYPE_EBS);
      }
      if (input.getBootRecord().hasPersistentVolumes()) {
        for (        final VmVolumeAttachment attachedVol : input.getBootRecord().getPersistentVolumes()) {
          runningInstance.getBlockDevices().add(new InstanceBlockDeviceMapping(attachedVol.getDevice(),attachedVol.getVolumeId(),attachedVol.getStatus(),attachedVol.getAttachTime(),attachedVol.getDeleteOnTerminate()));
          if (attachedVol.getIsRootDevice()) {
            runningInstance.setRootDeviceName(attachedVol.getDevice());
          }
        }
      }
      for (      final VmVolumeAttachment attachedVol : input.getTransientVolumeState().getAttachments()) {
        runningInstance.getBlockDevices().add(new InstanceBlockDeviceMapping(attachedVol.getDevice(),attachedVol.getVolumeId(),attachedVol.getStatus(),attachedVol.getAttachTime(),Boolean.TRUE));
      }
      return runningInstance;
    }
 catch (    final NoSuchElementException ex) {
      throw ex;
    }
catch (    final Exception ex) {
      throw new NoSuchElementException("Failed to lookup vm instance: " + v);
    }
 finally {
      if (db.isActive())       db.rollback();
    }
  }
}
