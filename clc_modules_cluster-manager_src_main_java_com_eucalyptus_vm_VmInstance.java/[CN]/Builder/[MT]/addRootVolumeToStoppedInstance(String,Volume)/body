{
  final Function<Volume,Volume> attachmentFunction=new Function<Volume,Volume>(){
    public Volume apply(    final Volume input){
      final VmInstance entity=Entities.merge(VmInstance.this);
      final Volume volEntity=Entities.merge(vol);
      VmVolumeAttachment attachVol=new VmVolumeAttachment(entity,volEntity.getDisplayName(),Images.DEFAULT_ROOT_DEVICE,remoteDevice,AttachmentState.attached.name(),new Date(),Boolean.TRUE,Boolean.TRUE);
      volEntity.setState(State.BUSY);
      entity.getBootRecord().getPersistentVolumes().add(attachVol);
      return volEntity;
    }
  }
;
  Entities.asTransaction(VmInstance.class,attachmentFunction,VmInstances.TX_RETRIES).apply(vol);
}
