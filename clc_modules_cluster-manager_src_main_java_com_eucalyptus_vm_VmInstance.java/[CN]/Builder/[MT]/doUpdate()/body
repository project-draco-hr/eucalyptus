{
  return new Predicate<VmInfo>(){
    @Override public boolean apply(    final VmInfo runVm){
      if (!Entities.isPersistent(VmInstance.this)) {
        throw new TransientEntityException(this.toString());
      }
 else {
        final EntityTransaction db=Entities.get(VmInstance.class);
        try {
          final VmState runVmState=VmState.Mapper.get(runVm.getStateName());
          if (VmInstance.this.getRuntimeState().isBundling()) {
            final BundleState bundleState=BundleState.mapper.apply(runVm.getBundleTaskStateName());
            VmInstance.this.getRuntimeState().updateBundleTaskState(bundleState);
          }
 else           if (VmStateSet.RUN.apply(VmInstance.this) && VmStateSet.RUN.contains(runVmState)) {
            VmInstance.this.setState(runVmState,Reason.APPEND,"UPDATE");
            this.updateState(runVm);
          }
 else           if (VmState.SHUTTING_DOWN.apply(VmInstance.this) && VmState.SHUTTING_DOWN.equals(runVmState)) {
            VmInstance.this.setState(VmState.TERMINATED,Reason.APPEND,"DONE");
          }
 else           if (VmInstances.Timeout.SHUTTING_DOWN.apply(VmInstance.this)) {
            VmInstance.this.setState(VmState.TERMINATED,Reason.EXPIRED);
          }
 else           if (VmInstances.Timeout.STOPPING.apply(VmInstance.this)) {
            VmInstance.this.setState(VmState.STOPPED,Reason.EXPIRED);
          }
 else           if (VmStateSet.NOT_RUNNING.apply(VmInstance.this) && VmStateSet.RUN.contains(runVmState)) {
            VmInstance.this.setState(VmState.RUNNING,Reason.APPEND,"MISMATCHED");
          }
 else {
            this.updateState(runVm);
          }
          db.commit();
        }
 catch (        final Exception ex) {
          Logs.extreme().error(ex,ex);
        }
 finally {
          if (db.isActive())           db.rollback();
        }
      }
      return true;
    }
    private void updateState(    final VmInfo runVm){
      VmInstance.this.getRuntimeState().updateBundleTaskState(runVm.getBundleTaskStateName());
      VmInstance.this.setServiceTag(runVm.getServiceTag());
      VmInstance.this.getRuntimeState().setGuestState(runVm.getGuestStateName());
      if (VmStateSet.RUN.apply(VmInstance.this)) {
        if (!EdgeNetworking.isEnabled()) {
          VmInstance.this.updateAddresses(runVm.getNetParams().getIpAddress(),runVm.getNetParams().getIgnoredPublicIp());
        }
      }
      if (VmState.RUNNING.apply(VmInstance.this)) {
        VmInstance.this.updateVolumeAttachments(runVm.getVolumes());
        VmInstance.this.updateMigrationTaskState(runVm.getMigrationStateName(),Strings.nullToEmpty(runVm.getMigrationSource()),Strings.nullToEmpty(runVm.getMigrationDestination()));
      }
      if (VmInstances.Timeout.UNTOUCHED.apply(VmInstance.this)) {
        VmInstance.this.updateTimeStamps();
      }
    }
  }
;
}
