{
  final Function<Volume,Volume> attachmentFunction=new Function<Volume,Volume>(){
    public Volume apply(    final Volume input){
      final VmInstance entity=Entities.merge(VmInstance.this);
      final Volume volEntity=Entities.merge(vol);
      final VmVolumeAttachment volumeAttachment=new VmVolumeAttachment(entity,vol.getDisplayName(),deviceName,vol.getRemoteDevice(),AttachmentState.attached.name(),new Date(),false);
      entity.bootRecord.getPersistentVolumes().add(volumeAttachment);
      return volEntity;
    }
  }
;
  Entities.asTransaction(VmInstance.class,attachmentFunction,VmInstances.TX_RETRIES).apply(vol);
}
