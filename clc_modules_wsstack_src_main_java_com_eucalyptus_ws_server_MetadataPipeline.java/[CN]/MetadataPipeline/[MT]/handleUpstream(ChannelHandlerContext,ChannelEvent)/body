{
  if (e instanceof MessageEvent && ((MessageEvent)e).getMessage() instanceof MappingHttpRequest) {
    MappingHttpRequest request=(MappingHttpRequest)((MessageEvent)e).getMessage();
    String newUri=null;
    String uri=request.getUri();
    InetSocketAddress remoteAddr=((InetSocketAddress)ctx.getChannel().getRemoteAddress());
    String remoteHost=remoteAddr.getAddress().getHostAddress();
    if (uri.startsWith("/latest/"))     newUri=uri.replaceAll("/latest/",remoteHost + ":");
 else     newUri=uri.replaceAll("/\\d\\d\\d\\d-\\d\\d-\\d\\d/",remoteHost + ":");
    HttpResponse response=null;
    LOG.trace("Trying to get metadata: " + newUri);
    Object reply="".getBytes();
    try {
      if (Bootstrap.isShuttingDown()) {
        reply="System shutting down".getBytes();
      }
 else {
        reply=ServiceContext.send("VmMetadata",newUri);
      }
    }
 catch (    ServiceDispatchException e1) {
      LOG.debug(e1,e1);
      reply=e1.getMessage().getBytes();
    }
catch (    Exception e1) {
      LOG.debug(e1,e1);
      reply=e1.getMessage().getBytes();
    }
 finally {
      Contexts.clear(request.getCorrelationId());
    }
    if (reply != null && !(reply instanceof NullPayload)) {
      response=new DefaultHttpResponse(request.getProtocolVersion(),HttpResponseStatus.OK);
      response.setHeader(HttpHeaders.Names.CONTENT_TYPE,"text/plain");
      ChannelBuffer buffer=ChannelBuffers.wrappedBuffer((byte[])reply);
      response.setContent(buffer);
      response.addHeader(HttpHeaders.Names.CONTENT_LENGTH,Integer.toString(buffer.readableBytes()));
    }
 else     response=new DefaultHttpResponse(request.getProtocolVersion(),HttpResponseStatus.NOT_FOUND);
    ctx.getChannel().write(response).addListener(ChannelFutureListener.CLOSE);
  }
 else {
    ctx.sendUpstream(e);
  }
}
