{
  ByteArrayOutputStream bos=new ByteArrayOutputStream(source.length() * 2);
  for (int i=0; i < source.length(); i++) {
    int ch=source.charAt(i);
    if (notEncoded.get(ch)) {
      bos.write(ch);
    }
 else {
      bos.write('%');
      char hex1=Character.toUpperCase(Character.forDigit((ch >> 4) & 0xF,16));
      char hex2=Character.toUpperCase(Character.forDigit(ch & 0xF,16));
      bos.write(hex1);
      bos.write(hex2);
    }
  }
  return new String(bos.toByteArray(),encoding);
}
