{
  int length=source.length();
  ByteArrayOutputStream bos=new ByteArrayOutputStream(length);
  for (int i=0; i < length; i++) {
    int ch=source.charAt(i);
    if (ch == '%') {
      if ((i + 2) < length) {
        char hex1=source.charAt(i + 1);
        char hex2=source.charAt(i + 2);
        int u=Character.digit(hex1,16);
        int l=Character.digit(hex2,16);
        bos.write((char)((u << 4) + l));
        i+=2;
      }
 else {
        throw new IllegalArgumentException("Invalid encoded sequence \"" + source.substring(i) + "\"");
      }
    }
 else {
      bos.write(ch);
    }
  }
  return new String(bos.toByteArray(),encoding);
}
