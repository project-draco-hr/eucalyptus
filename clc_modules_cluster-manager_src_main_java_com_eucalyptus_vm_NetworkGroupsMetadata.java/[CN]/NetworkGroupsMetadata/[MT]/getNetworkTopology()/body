{
  if (topoString.get() != null && (lastTime + (1 * 1000l)) > System.currentTimeMillis()) {
    return topoString.get();
  }
 else {
    lock.lock();
    try {
      if (topoString.get() != null && (lastTime + (1 * 1000l)) > System.currentTimeMillis()) {
        return topoString.get();
      }
 else {
        lastTime=System.currentTimeMillis();
        StringBuilder buf=new StringBuilder();
        Multimap<String,String> networks=ArrayListMultimap.create();
        Multimap<String,String> rules=ArrayListMultimap.create();
        for (        VmInstance vm : VmInstances.getInstance().listValues()) {
          if (VmState.RUNNING.ordinal() < vm.getState().ordinal())           continue;
          for (          NetworkRulesGroup ruleGroup : vm.getNetworkRulesGroups()) {
            networks.put(ruleGroup.getPermanentUuid(),vm.getPrivateAddress());
            if (!rules.containsKey(ruleGroup.getPermanentUuid())) {
              for (              NetworkRule netRule : ruleGroup.getNetworkRules()) {
                String rule=String.format("-P %s -%s %d%s%d ",netRule.getProtocol(),("icmp".equals(netRule.getProtocol()) ? "t" : "p"),netRule.getLowPort(),("icmp".equals(netRule.getProtocol()) ? ":" : "-"),netRule.getHighPort());
                for (                NetworkPeer peer : netRule.getNetworkPeers()) {
                  rules.put(ruleGroup.getName(),String.format("%s -o %s -u %s",rule,peer.getGroupName(),peer.getUserQueryKey()));
                }
                for (                IpRange cidr : netRule.getIpRanges()) {
                  rules.put(ruleGroup.getName(),String.format("%s -s %s",rule,cidr.getValue()));
                }
              }
            }
          }
        }
        for (        String networkName : rules.keySet()) {
          for (          String rule : rules.get(networkName)) {
            buf.append("RULE ").append(networkName).append(" ").append(rule).append("\n");
          }
        }
        for (        String networkName : networks.keySet()) {
          buf.append("GROUP ").append(networkName);
          for (          String ip : networks.get(networkName)) {
            buf.append(" ").append(ip);
          }
          buf.append("\n");
        }
        topoString.set(buf.toString());
      }
      return topoString.get();
    }
  finally {
      lock.unlock();
    }
  }
}
