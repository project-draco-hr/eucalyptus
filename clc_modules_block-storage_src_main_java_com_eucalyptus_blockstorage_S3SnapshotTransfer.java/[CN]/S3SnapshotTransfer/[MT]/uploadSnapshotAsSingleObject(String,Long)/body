{
  SnapshotProgressCallback callback=new SnapshotProgressCallback(snapshotId,fileSize);
  FileInputStreamWithCallback snapInputStream=new FileInputStreamWithCallback(new File(compressedSnapFileName),callback);
  ObjectMetadata metadata=new ObjectMetadata();
  metadata.setContentLength(fileSize);
  return retryAfterRefresh(new Function<PutObjectRequest,PutObjectResult>(){
    @Override @Nullable public PutObjectResult apply(    @Nullable PutObjectRequest arg0){
      eucaS3Client.refreshEndpoint();
      return eucaS3Client.putObject(arg0);
    }
  }
,new PutObjectRequest(bucketName,keyName,snapInputStream,metadata),REFRESH_TOKEN_RETRIES);
}
