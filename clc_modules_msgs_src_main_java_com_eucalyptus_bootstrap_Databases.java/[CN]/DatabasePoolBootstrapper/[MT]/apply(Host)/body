{
  return new Function<String,Runnable>(){
    @Override public Runnable apply(    final String ctx){
      final String hostName=host.getBindAddress().getHostAddress();
      final String contextName=ctx;
      Runnable removeRunner=new Runnable(){
        @Override public void run(){
          try {
            final boolean fullSync=!Hosts.isCoordinator() && host.isLocalHost() && BootstrapArgs.isCloudController()&& !Databases.isSynchronized();
            final boolean passiveSync=!fullSync && host.hasSynced();
            if (!fullSync && !passiveSync) {
              throw Exceptions.toUndeclared("Host is not ready to be activated: " + host);
            }
 else {
              final DatabaseClusterMBean cluster=lookup(contextName,TimeUnit.SECONDS.toMillis(30));
              String syncStrategy="passive";
              final boolean activated=cluster.getactiveDatabases().contains(hostName);
              final boolean deactivated=cluster.getinactiveDatabases().contains(hostName);
              syncStrategy=(fullSync ? "full" : "passive");
              if (activated) {
                return;
              }
 else               if (deactivated) {
                ActivateHostFunction.prepareConnections(host,contextName);
              }
 else {
                LOG.info("Creating database " + ctx + " connections for: "+ host);
                try {
                  lookupDatabase(contextName,hostName);
                }
 catch (                NoSuchElementException e) {
                  try {
                    cluster.add(hostName);
                    Logs.extreme().debug("Added database " + ctx + " connections for host: "+ hostName);
                  }
 catch (                  IllegalArgumentException ex) {
                    Logs.extreme().debug("Skipping addition of database " + ctx + " connections for host which already exists: "+ hostName);
                  }
catch (                  IllegalStateException ex) {
                    if (Exceptions.isCausedBy(ex,InstanceAlreadyExistsException.class)) {
                      ManagementFactory.getPlatformMBeanServer().unregisterMBean(new ObjectName(jdbcJmxDomain,new Hashtable<>(ImmutableMap.of("cluster",ctx,"type","Database","database",hostName))));
                      cluster.add(hostName);
                    }
 else {
                      throw ex;
                    }
                  }
                }
                ActivateHostFunction.prepareConnections(host,contextName);
              }
              if (Hosts.isCoordinator(host)) {
                for (                Host secondaryHost : Hosts.listActiveDatabases())                 if (!secondaryHost.equals(host))                 try {
                  lookupDatabase(contextName,secondaryHost.getDisplayName()).setweight(DATABASE_WEIGHT_SECONDARY);
                }
 catch (                NoSuchElementException e) {
                }
catch (                Exception e) {
                  LOG.error("Error setting primary weight for host " + secondaryHost.getDisplayName() + " context "+ contextName,e);
                }
              }
              try {
                if (fullSync) {
                  LOG.info("Full sync of database " + ctx + " on: "+ host);
                }
 else {
                  LOG.info("Passive activation of database " + ctx + " connections to: "+ host);
                }
                cluster.activate(hostName,syncStrategy);
                if (fullSync) {
                  LOG.info("Full sync of database " + ctx + " on: "+ host+ " using "+ cluster.getactiveDatabases());
                }
 else {
                  LOG.info("Passive activation of database " + ctx + " on: "+ host+ " using "+ cluster.getactiveDatabases());
                }
              }
 catch (              Exception ex) {
                throw Exceptions.toUndeclared(ex);
              }
              try {
                LOG.debug("Refreshing idle pooled connections for context: " + contextName);
                ProxoolFacade.killAllConnections(contextName,"Database registered",true);
                LOG.debug("Refreshed idle pooled connections for context: " + contextName);
              }
 catch (              Exception ex) {
                LOG.error("Error refreshing connections on activation of context: " + contextName,ex);
              }
            }
          }
 catch (          final NoSuchElementException ex1) {
            LOG.error(ex1);
            Logs.extreme().error(ex1,ex1);
            return;
          }
catch (          final IllegalStateException ex1) {
            LOG.error(ex1);
            Logs.extreme().error(ex1,ex1);
            return;
          }
catch (          final Exception ex1) {
            LOG.error(ex1);
            Logs.extreme().error(ex1,ex1);
            throw Exceptions.toUndeclared("Failed to activate database " + ctx + " host "+ host+ " because of: "+ ex1.getMessage(),ex1);
          }
        }
        @Override public String toString(){
          return "Databases.enable(): " + host.getDisplayName() + " "+ contextName;
        }
      }
;
      return removeRunner;
    }
    @Override public String toString(){
      return "Databases.enable(): " + host;
    }
  }
;
}
