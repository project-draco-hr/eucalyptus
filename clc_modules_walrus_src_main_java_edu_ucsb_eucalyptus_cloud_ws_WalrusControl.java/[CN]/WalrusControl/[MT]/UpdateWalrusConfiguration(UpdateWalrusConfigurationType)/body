{
  UpdateWalrusConfigurationResponseType reply=(UpdateWalrusConfigurationResponseType)request.getReply();
  if (EucalyptusProperties.NAME.equals(request.getEffectiveUserId()))   throw new AccessDeniedException("Only admin can change walrus properties.");
  String rootDir=request.getBucketRootDirectory();
  if (rootDir != null) {
    WalrusProperties.bucketRootDirectory=rootDir;
    storageManager.setRootDirectory(rootDir);
  }
  Integer maxBucketsPerUser=request.getMaxBucketsPerUser();
  if (maxBucketsPerUser != null)   WalrusProperties.MAX_BUCKETS_PER_USER=maxBucketsPerUser;
  Long maxBucketSize=request.getMaxBucketSize();
  if (maxBucketSize != null)   WalrusProperties.MAX_BUCKET_SIZE=maxBucketSize;
  Long imageCacheSize=request.getImageCacheSize();
  if (imageCacheSize != null)   WalrusProperties.IMAGE_CACHE_SIZE=imageCacheSize;
  Integer totalSnapshotSize=request.getTotalSnapshotSize();
  if (totalSnapshotSize != null)   WalrusProperties.MAX_TOTAL_SNAPSHOT_SIZE=totalSnapshotSize;
  walrusManager.check();
  EntityWrapper<WalrusInfo> db=new EntityWrapper<WalrusInfo>();
  WalrusInfo walrusInfo;
  try {
    walrusInfo=db.getUnique(new WalrusInfo());
  }
 catch (  EucalyptusCloudException ex) {
    walrusInfo=new WalrusInfo(request.getName(),WalrusProperties.bucketRootDirectory,WalrusProperties.MAX_BUCKETS_PER_USER,WalrusProperties.MAX_BUCKET_SIZE,WalrusProperties.IMAGE_CACHE_SIZE,WalrusProperties.MAX_TOTAL_SNAPSHOT_SIZE);
    db.add(walrusInfo);
  }
 finally {
    db.commit();
  }
  return reply;
}
