{
  ConstraintViolationException cause=Exceptions.causedBy(e,ConstraintViolationException.class);
  if (cause != null) {
    throw cause;
  }
 else {
    Logs.exhaust().trace(e,e);
    if (e instanceof RuntimeException) {
      final ErrorCategory category=PersistenceExceptions.classify(e);
      final RuntimeException up=category.handleException((RuntimeException)e);
      if (!category.isRecoverable()) {
        throw up;
      }
 else {
        return new RecoverablePersistenceException("Error during transaction: " + Joiner.on('\n').join(Exceptions.causes(e)),e);
      }
    }
 else {
      throw ErrorCategory.APPLICATION.handleException(new PersistenceException("Error during transaction: " + e.getMessage(),e));
    }
  }
}
