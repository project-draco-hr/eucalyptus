{
  VmAllocationInfo vmAllocInfo=new VmAllocationInfo(request);
  if (vmAllocInfo.getRequest().getInstanceType() == null || "".equals(vmAllocInfo.getRequest().getInstanceType())) {
    vmAllocInfo.getRequest().setInstanceType(VmInstance.DEFAULT_TYPE);
  }
  vmAllocInfo.setReservationIndex(Counters.getIdBlock(request.getMaxCount()));
  String userData=vmAllocInfo.getRequest().getUserData();
  if (userData != null) {
    try {
      userData=new String(Base64.decode(vmAllocInfo.getRequest().getUserData()));
    }
 catch (    Exception e) {
      userData="";
    }
  }
 else {
    userData="";
  }
  vmAllocInfo.setUserData(userData);
  vmAllocInfo.getRequest().setUserData(new String(Base64.encode(userData.getBytes())));
  return vmAllocInfo;
}
