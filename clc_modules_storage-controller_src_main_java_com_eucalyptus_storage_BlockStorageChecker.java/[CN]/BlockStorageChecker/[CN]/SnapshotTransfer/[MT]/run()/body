{
  EntityWrapper<SnapshotInfo> db=StorageController.getEntityWrapper();
  SnapshotInfo snapshotInfo=new SnapshotInfo();
  snapshotInfo.setShouldTransfer(true);
  List<SnapshotInfo> snapshotInfos=db.query(snapshotInfo);
  if (snapshotInfos.size() > 0) {
    SnapshotInfo snapInfo=snapshotInfos.get(0);
    String snapshotId=snapInfo.getSnapshotId();
    List<String> returnValues;
    try {
      returnValues=blockManager.prepareForTransfer(snapshotId);
    }
 catch (    EucalyptusCloudException e) {
      db.rollback();
      LOG.error(e);
      return;
    }
    if (returnValues.size() > 0) {
      String snapshotFileName=returnValues.get(0);
      File snapshotFile=new File(snapshotFileName);
      Map<String,String> httpParamaters=new HashMap<String,String>();
      HttpWriter httpWriter;
      SnapshotProgressCallback callback=new SnapshotProgressCallback(snapshotId,snapshotFile.length(),StorageProperties.TRANSFER_CHUNK_SIZE);
      httpWriter=new HttpWriter("PUT",snapshotFile,String.valueOf(snapshotFile.length()),callback,"snapset-" + UUID.randomUUID(),snapshotId,"StoreSnapshot",null,httpParamaters);
      try {
        httpWriter.run();
      }
 catch (      Exception ex) {
        db.rollback();
        LOG.error(ex,ex);
        checker.cleanFailedSnapshot(snapshotId);
      }
    }
  }
  db.commit();
}
