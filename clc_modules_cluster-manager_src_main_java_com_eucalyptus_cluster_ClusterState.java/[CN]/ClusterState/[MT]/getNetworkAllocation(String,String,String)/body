{
  Network network=null;
  try {
    network=Networks.getInstance().lookup(networkName);
    Integer vlan=network.getVlan();
    if (vlan == null) {
      vlan=ClusterState.availableVlans.pollFirst();
      if (vlan == null)       throw new NotEnoughResourcesAvailable("Not enough resources available: vlan tags");
      network.setVlan(vlan);
    }
    NetworkToken token=new NetworkToken(clusterName,userName,network.getNetworkName(),network.getVlan());
    LOG.debug(String.format(EucalyptusProperties.DEBUG_FSTRING,EucalyptusProperties.TokenState.preallocate,token));
    network.addTokenIfAbsent(token);
    return token;
  }
 catch (  NoSuchElementException e) {
    LOG.debug(e,e);
    throw new NotEnoughResourcesAvailable("Failed to create registry entry for network named: " + networkName);
  }
}
