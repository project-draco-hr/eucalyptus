{
  Network network=Networks.getInstance().lookup(networkName);
  Integer vlan=network.getVlan();
  if (vlan == null || Integer.valueOf(0).equals(vlan)) {
    vlan=ClusterState.availableVlans.pollFirst();
    if (vlan == null) {
      throw new NotEnoughResourcesAvailable("Not enough resources available: vlan tags");
    }
 else     if (!network.initVlan(vlan)) {
      ClusterState.availableVlans.add(vlan);
      throw new NotEnoughResourcesAvailable("Not enough resources available: an error occured obtaining a usable vlan tag");
    }
 else {
      LOG.info(EventRecord.caller(NetworkToken.class,EventType.TOKEN_RESERVED,network.toString()));
    }
  }
  return network;
}
